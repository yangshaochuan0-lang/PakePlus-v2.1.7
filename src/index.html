<!DOCTYPE html>
<html lang="zh-CN"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>财务管理系统</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <!-- SheetJS for Excel parsing -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- jsPDF for PDF export -->
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <!-- html2canvas for PDF export -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <!-- LZ-String for data compression -->
    <script src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js"></script>
    
    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1a56db',
                        secondary: '#e2e8f0',
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444',
                        dark: '#1e293b',
                        light: '#f8fafc'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif']
                    },
                    boxShadow: {
                        card: '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)'
                    }
                }
            }
        }
    </script>

    <!-- Import SKU Costs Modal -->
    </head><body class="bg-gray-50 min-h-screen"><div id="import-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">导入规格编码成本</h3>
                    <button id="close-import-modal" class="text-gray-400 hover:text-gray-600">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">选择Excel文件</label>
                    <div class="flex items-center space-x-2">
                        <!-- 美化的文件输入框 -->
                        <div class="relative flex-1">
                            <input type="file" id="import-file-input" accept=".xlsx, .xls" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                            <div class="flex items-center justify-between px-4 py-2 border border-gray-300 rounded-md bg-white h-10">
                                <span id="file-name-display" class="text-sm text-gray-600 truncate flex-1">未选择文件</span>
                                <div class="flex items-center space-x-2">
                                    <span class="text-xs bg-primary/10 text-primary px-2 py-1 rounded">.xlsx, .xls</span>
                                    <button id="clear-file-btn" class="text-gray-400 hover:text-gray-600 transition-colors duration-200 hidden">
                                        <i class="fa fa-times-circle"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <button id="start-import" class="btn btn-primary h-10 px-4">
                            <i class="fa fa-upload"></i> 开始导入
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">支持 .xlsx 和 .xls 格式，请确保文件包含"规格编码"和"成本"列</p>
                </div>
                
                <!-- Loading State -->
                <div id="import-loading" class="hidden mb-6">
                    <div class="flex items-center justify-center py-4">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
                        <span class="ml-3 text-gray-600">正在解析文件...</span>
                    </div>
                </div>


                
                <!-- Preview Section -->
                <div id="import-preview-section" class="mb-6 hidden">
                    <h4 class="text-md font-medium text-gray-700 mb-3">数据预览</h4>
                    <div id="import-preview" class="max-h-60 overflow-y-auto border border-gray-200 rounded-lg">
                        <!-- Preview table will be inserted here -->
                    </div>
                    <div id="import-stats" class="mt-2">
                        <!-- Stats will be inserted here -->
                    </div>
                </div>


                
                <!-- Import Mode Selection -->
                <div id="import-mode-section" class="mb-6 hidden">
                    <h4 class="text-md font-medium text-gray-700 mb-3">导入模式</h4>
                    <div class="space-y-3">
                        <label class="flex items-center space-x-2">
                            <input type="radio" name="import-mode" value="merge" checked="" class="text-primary focus:ring-primary">
                            <span class="text-sm text-gray-700">合并模式：新增不存在的规格编码，更新已存在的规格编码</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="radio" name="import-mode" value="insert" class="text-primary focus:ring-primary">
                            <span class="text-sm text-gray-700">仅新增：只添加不存在的规格编码，跳过已存在的</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="radio" name="import-mode" value="update" class="text-primary focus:ring-primary">
                            <span class="text-sm text-gray-700">仅更新：只更新已存在的规格编码，跳过不存在的</span>
                        </label>
                    </div>
                </div>


                
                <!-- Confirmation Section -->
                <div id="import-confirm-section" class="flex justify-end space-x-3 hidden">
                    <button id="cancel-import" class="btn btn-secondary">取消</button>
                    <button id="import-confirm-btn" class="btn btn-primary">
                        <i class="fa fa-check"></i> 确认导入
                    </button>
                </div>
                
                <!-- Hidden field to store import data -->
                <input type="hidden" id="import-data">
            </div>
        </div>
    </div>




    
    <style type="text/tailwindcss">
        @layer utilities {
            .transition-all-300 {
                transition: all 0.3s ease;
            }
            .card {
                @apply bg-white rounded-lg shadow-card p-6 transition-all duration-300;
            }
            .card:hover {
                @apply transform scale-[1.000] shadow-lg;
            }
            .btn {
                @apply px-4 py-2 rounded-md font-medium transition-all-300 focus:outline-none focus:ring-2 focus:ring-offset-2;
            }
            .btn-primary {
                @apply bg-primary text-white hover:bg-primary/90 focus:ring-primary/50;
            }
            .btn-secondary {
                @apply bg-gray-300 text-dark hover:bg-gray-400 focus:ring-gray-300/50;
            }
            .btn-success {
                @apply bg-success text-white hover:bg-success/90 focus:ring-success/50;
            }
            .btn-danger {
                @apply bg-danger text-white hover:bg-danger/90 focus:ring-danger/50;
            }
            .input-field {
                @apply w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary;
            }
            .tab-active {
                @apply border-b-2 border-primary text-primary;
            }
            .tab {
                @apply px-4 py-2 font-medium text-gray-600 hover:text-primary transition-all-300;
            }
            .drag-area {
                @apply border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer transition-all-300;
            }
            .drag-area.active {
                @apply border-primary bg-primary/5;
            }
            .product-card {
                @apply border-2 border-gray-300 rounded-lg p-4 mb-4 hover:shadow-md transition-all-300;
            }
            
            /* 商品卡片分隔线样式 */
            .product-divider {
                transition: border-color 0.3s ease;
            }
            
            .normal-divider {
                @apply border-b border-primary/20;
            }
            
            .marked-divider {
                @apply border-b border-red-300;
            }
            /* 移动模式相关样式 */
            .move-mode-active {
                @apply bg-blue-50 border-2 border-blue-300;
            }
            .move-mode-active .link-header {
                @apply bg-gradient-to-r from-blue-600/30 to-blue-500/20 border-b-2 border-blue-400;
            }
            .move-mode-active .product-card {
                @apply cursor-move bg-white border-2 border-blue-200 hover:border-blue-400 hover:shadow-lg;
            }
            .move-mode-active .product-card.dragging {
                @apply opacity-75 bg-blue-100 border-dashed border-blue-500;
            }
            .move-mode-active .product-card.drag-over {
                @apply border-2 border-blue-500 bg-blue-50;
            }
            .move-mode-active .product-card.drag-between {
                @apply border-t-2 border-blue-500;
            }
            .move-mode-active .link-content {
                @apply border-2 border-blue-100 rounded-lg;
                transition: opacity 0.15s ease-out, max-height 0.15s ease-out;
                max-height: 1000px;
                opacity: 1;
            }
            .link-content {
                transition: opacity 0.15s ease-out, max-height 0.15s ease-out;
                max-height: 1000px;
                opacity: 1;
            }
            .link-content.hidden {
                max-height: 0;
                opacity: 0;
                overflow: hidden;
            }
            .move-mode-active .link-content.drag-over {
                @apply border-2 border-blue-500 bg-blue-50;
            }
            .move-mode-active .link-header.drag-over {
                @apply bg-gradient-to-r from-blue-600/50 to-blue-500/40 border-blue-400;
            }
            
            /* 链接高亮动画 */
            .link-highlight {
                animation: linkHighlight 0.3s ease-out forwards;
            }
            
            .link-highlight-pulse {
                animation: linkHighlightPulse 2s ease-in-out infinite;
            }
            
            .link-card-highlight {
                animation: linkCardHighlight 0.5s ease-out forwards;
            }
            
            @keyframes linkHighlight {
                0% {
                    transform: translateY(0);
                    box-shadow: 0 2px 10px rgba(59, 130, 246, 0.2);
                }
                100% {
                    transform: translateY(-2px);
                    box-shadow: 0 4px 20px rgba(59, 130, 246, 0.3);
                }
            }
            
            @keyframes linkHighlightPulse {
                0%, 100% {
                    transform: translateY(-2px);
                    box-shadow: 0 4px 20px rgba(59, 130, 246, 0.3);
                }
                50% {
                    transform: translateY(-1px);
                    box-shadow: 0 6px 25px rgba(59, 130, 246, 0.4);
                }
            }
            
            @keyframes linkCardHighlight {
                0% {
                    transform: translateY(0);
                    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
                }
                100% {
                    transform: translateY(-2px);
                    box-shadow: 0 8px 30px rgba(59, 130, 246, 0.4);
                }
            }
            .btn-info {
                @apply bg-gray-700 text-white hover:bg-gray-800 focus:ring-gray-700/50;
            }
            .move-mode-active .btn-info {
                @apply bg-blue-600 text-white;
            }
            .move-mode-active .btn-info:hover {
                @apply bg-blue-700;
            }
            .product-card-hover {
                @apply transition-all duration-300 hover:shadow-lg hover:translate-y-[-2px] hover:border-gray-300;
            }
            
            /* 商品卡片分隔线样式 */
            .product-divider {
                transition: border-color 0.3s ease;
            }
            
            .marked-divider-red {
                @apply border-b-2 border-red-400/60;
            }
            
            .marked-divider-green {
                border-bottom: 2px solid rgba(115, 220, 220, 0.6);
            }
            
            .marked-divider-forest {
                border-bottom: 2px solid rgba(104, 139, 102, 0.6);
            }
            
            .marked-divider-lavender {
                border-bottom: 2px solid rgba(160, 128, 200, 0.6);
            }
            
            .normal-divider {
                @apply border-b border-gray-300;
            }
            .badge {
                @apply px-2 py-1 text-xs font-medium rounded-full;
            }
            .badge-success {
                @apply bg-success/20 text-success;
            }
            .badge-warning {
                @apply bg-warning/20 text-warning;
            }
            .badge-danger {
                @apply bg-danger/20 text-danger;
            }
            .badge-shop {
                @apply bg-primary/20 text-primary border border-primary/30;
            }
            /* 自定义提示框样式 */
            .tooltip-container {
                @apply relative inline-block cursor-help;
            }
            .tooltip-content {
                @apply absolute z-50 px-4 py-3 text-sm text-white bg-gray-800 rounded-lg shadow-lg opacity-0 invisible transition-all duration-200;
                max-width: 250px;
                word-wrap: break-word;
                white-space: normal;
                z-index: 9999 !important;
                position: fixed !important;
                pointer-events: none;
                font-size: 13px;
                line-height: 1.4;
                transform: translateY(15px);
            }
            
            /* 搜索高亮样式 */
            .search-highlight {
                @apply bg-yellow-200 px-1 rounded text-gray-900 font-medium;
            }
            
            .tooltip-container:hover .tooltip-content {
                @apply opacity-100 visible;
            }
            .tooltip-arrow {
                @apply absolute border-4 border-transparent border-t-gray-800 opacity-0 invisible transition-all duration-200;
                top: -8px;
                left: 10px;
            }
            .tooltip-container:hover .tooltip-arrow {
                @apply opacity-100 visible;
            }
            .profit-display {
                @apply flex items-center space-x-3 px-5 py-3 rounded-lg border transition-all-300;
            }
            .profit-display:hover {
                @apply transform scale-105 shadow-md;
            }
            .profit-display.positive {
                @apply bg-gradient-to-r from-success/10 to-success/5 border-success/20;
            }
            .profit-display.negative {
                @apply bg-gradient-to-r from-danger/10 to-danger/5 border-danger/20;
            }
            .editing-breathing-bg {
                animation: breathing 2s ease-in-out infinite;
                font-weight: 900 !important;
                font-size: 14px !important;
                color: #000000 !important;
                background-color: #ffeb3b !important;
                text-shadow: 0 0 2px rgba(0,0,0,0.2);
                padding: 8px 6px !important;
                border-radius: 4px !important;
                border: 2px solid #f59e0b !important;
            }
            .category-editing {
                animation: breathing 2s ease-in-out infinite;
                font-weight: 600 !important;
                color: #000000 !important;
                background-color: transparent !important;
                border: 2px solid #3b82f6 !important;
                padding: 4px 8px !important;
                border-radius: 4px !important;
                outline: none !important;
            }
            .price-header-highlight {
                background-color: #3b82f6 !important;
                color: white !important;
                font-weight: 700 !important;
                font-size: 13px !important;
                padding: 8px 6px !important;
                border-radius: 4px !important;
                border: none !important;
                text-shadow: none !important;
                box-shadow: none !important;
                animation: none !important;
            }
            .category-name {
                font-size: 1.25rem;
                font-weight: 600;
            }
            /* 表格表头样式 */
            table {
                width: 100%;
                border-collapse: collapse;
            }
            th {
                font-weight: 800 !important;
                font-size: 14px !important;
                color: #000000 !important;
                background-color: #f8fafc !important;
                padding: 8px 6px !important;
                border: none !important;
                text-align: center !important;
                vertical-align: middle !important;
                white-space: nowrap !important;
            }
            td {
                padding: 6px !important;
                border: none !important;
                text-align: center !important;
                vertical-align: middle !important;
            }
            @keyframes breathing {
                0%, 100% {
                    opacity: 1;
                }
                50% {
                    opacity: 0.8;
                }
            }
        }
    </style>


    <!-- Header -->
    <header class="bg-gradient-to-r from-white to-blue-50 shadow-md transition-all duration-300">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-3 group">
                <div class="relative">
                    <img src="https://p26-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/2028ef37f7894197a54ddea1da88447b.png~tplv-a9rns2rl98-24:720:720.png?rcl=20260109013734FEAE7A41FD0BAF66E1C9&amp;rk3s=8e244e95&amp;rrcfp=8a172a1a&amp;x-expires=1768498655&amp;x-signature=dLPNGwRCsURHAiLiatNfOHSEn6Q%3D" alt="系统Logo" class="h-10 w-auto transition-all duration-300 group-hover:scale-110">
                </div>
                <div class="relative">
                    <h1 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-purple-600 transition-all duration-300 group-hover:scale-105">
                        财务管理系统
                    </h1>
                    <div class="absolute -bottom-1 left-0 w-full h-0.5 bg-gradient-to-r from-blue-600 to-purple-600 transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300"></div>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <button id="export-pdf" class="btn btn-secondary flex items-center space-x-1 opacity-0 invisible">
                    <i class="fa fa-file-pdf-o"></i>
                    <span>导出PDF</span>
                </button>
                <button id="export-excel" class="btn btn-secondary flex items-center space-x-1 opacity-0 invisible">
                    <i class="fa fa-file-excel-o"></i>
                    <span>导出Excel</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <nav class="bg-gradient-to-r from-blue-600/10 to-blue-500/5 border-b border-blue-200 shadow-md shadow-blue-200/50 transition-all duration-300 hover:shadow-lg hover:shadow-blue-300/30">
        <div class="container mx-auto px-4">
            <div class="flex justify-center">
                <ul class="flex space-x-6 items-center py-2">
                    <li>
                        <button class="tab tab-active px-6 py-3 text-lg font-bold text-primary transition-all duration-300 hover:bg-white/50 rounded-lg" data-tab="data-calculation" style="font-weight: bold; font-size: 20px;">数据计算区</button>
                    </li>
                    <li>
                        <button class="tab px-6 py-3 text-lg font-bold text-gray-700 transition-all duration-300 hover:bg-white/50 hover:text-primary rounded-lg" data-tab="dashboard" style="font-size: 20px; font-weight: bold;">数据看板</button>
                    </li>
                    <li>
                        <button class="tab px-6 py-3 text-lg font-bold text-gray-700 transition-all duration-300 hover:bg-white/50 hover:text-primary rounded-lg" data-tab="cost-records" style="font-size: 20px; font-weight: bold;">公司成本管理</button>
                    </li>
                    <li>
                        <button class="tab px-6 py-3 text-lg font-bold text-gray-700 transition-all duration-300 hover:bg-white/50 hover:text-primary rounded-lg" data-tab="sku-costs" style="font-size: 20px; font-weight: bold;">规格成本</button>
                    </li>
                    <li>
                        <button class="tab px-6 py-3 text-lg font-bold text-gray-700 transition-all duration-300 hover:bg-white/50 hover:text-primary rounded-lg" data-tab="shop-management" style="font-size: 20px; font-weight: bold;">店铺管理</button>
                    </li>
                    <li>
                        <button class="tab px-6 py-3 text-lg font-bold text-gray-700 transition-all duration-300 hover:bg-white/50 hover:text-primary rounded-lg" data-tab="pricing-tool" style="font-size: 20px; font-weight: bold;">新品定价工具</button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Cost Category Management Modal -->
    <div id="category-management-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 w-full max-w-xl">
            <div class="flex justify-between items-center mb-4">
                <h3 id="category-modal-title" class="text-lg font-semibold text-gray-800">分类管理</h3>
                <button class="close-modal text-gray-500 hover:text-gray-700">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="mb-4">
                <div class="flex space-x-2 items-center">
                    <input type="text" id="cost-category-name" class="input-field flex-1" placeholder="输入新分类名称">
                    <input type="color" id="cost-category-color" class="w-10 h-10 rounded border-0 cursor-pointer" value="#3B82F6">
                    <button id="add-category" class="btn btn-primary">
                        <i class="fa fa-plus"></i> 添加
                    </button>
                </div>
            </div>
            <div id="categories-list" class="max-h-60 overflow-y-auto">
                <!-- Categories will be added here -->
            </div>
            <div class="flex justify-end mt-4">
                <button class="btn btn-secondary close-modal">关闭</button>
            </div>
        </div>
    </div>
    <!-- Pricing Category Management Modal -->
    <div id="pricing-category-management-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-md">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">分类管理</h3>
                    <button onclick="closePricingCategoryModal()" class="text-gray-400 hover:text-gray-600 p-1 rounded-full hover:bg-gray-100 transition-colors">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
                <div class="mb-6">
                    <div class="flex space-x-2">
                        <input type="text" id="new-category-name" class="input-field flex-1" placeholder="输入新分类名称">
                        <button onclick="addNewPricingCategory()" class="btn btn-primary">
                            <i class="fa fa-plus"></i> 添加
                        </button>
                    </div>
                </div>
                <div id="pricing-categories-container" class="max-h-60 overflow-y-auto">
                    <!-- Pricing categories will be dynamically added here -->
                </div>
                <div class="flex justify-end mt-4">
                    <button onclick="closePricingCategoryModal()" class="btn btn-secondary">关闭</button>
                </div>
            </div>
        </div>
    </div> 
    

    <!-- Edit Link Modal -->
    <div id="edit-link-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="border-b border-gray-200 px-6 py-4">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-900">编辑链接</h3>
                    <button type="button" onclick="closeEditLinkModal()" class="text-gray-400 hover:text-gray-500">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
            </div>
            <form id="edit-link-form" class="px-6 py-4">
                <input type="hidden" id="edit-link-index">
                <div class="mb-4">
                    <label for="edit-link-name" class="block text-sm font-medium text-gray-700 mb-1">
                        链接名称 <span class="text-danger">*</span>
                    </label>
                    <input type="text" id="edit-link-name" class="input-field w-full" placeholder="请输入链接名称">
                </div>
                <div class="mb-4">
                    <label for="edit-link-category" class="block text-sm font-medium text-gray-700 mb-1">
                        分类
                    </label>
                    <select id="edit-link-category" class="input-field w-full">
                        <option value="电子产品">电子产品</option>
                        <option value="服装">服装</option>
                        <option value="家居">家居</option>
                        <option value="其他">其他</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label for="edit-link-shop" class="block text-sm font-medium text-gray-700 mb-1">
                        店铺归类
                    </label>
                    <select id="edit-link-shop" class="input-field w-full">
                        <option value="">选择店铺</option>
                    </select>
                </div>
                <div class="mb-6">
                    <label for="edit-link-note" class="block text-sm font-medium text-gray-700 mb-1">
                        备注
                    </label>
                    <textarea id="edit-link-note" class="input-field w-full" rows="3" placeholder="请输入备注信息（可选）"></textarea>
                </div>
                <div class="flex items-center justify-end space-x-3">
                    <button type="button" onclick="closeEditLinkModal()" class="btn btn-secondary">
                        取消
                    </button>
                    <button type="button" onclick="saveEditLink()" class="btn btn-primary">
                        保存
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Operation Log Modal -->
    <div id="operation-log-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden overflow-auto" style="z-index: 1000;">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4">
            <div class="border-b border-gray-200 px-6 py-4">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-900">运营操作记录</h3>
                    <button type="button" onclick="closeOperationLogModal()" class="text-gray-400 hover:text-gray-500">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="px-6 py-4">
                <input type="hidden" id="operation-log-link-index">
                <input type="hidden" id="operation-log-product-index">
                <input type="hidden" id="operation-log-edit-index" value="-1">
                
                <!-- 操作记录列表 -->
                <div class="mb-4">
                    <h4 class="text-md font-medium text-gray-700 mb-2">操作时间线</h4>
                    <div id="operation-log-list" class="space-y-3 max-h-80 overflow-y-auto p-3 border border-gray-200 rounded-lg">
                        <!-- 操作记录将通过JavaScript动态添加 -->
                    </div>
                </div>
                
                <!-- 添加新记录 -->
                <div class="border-t-4 border-indigo-500 pt-6 mt-6 bg-gradient-to-b from-white to-indigo-50 rounded-2xl p-6 shadow-xl animate-fadeIn">
                    <h4 class="text-md font-medium text-gray-700 mb-2">添加新记录</h4>
                    <div class="mb-3">
                        <label for="operation-log-content" class="block text-sm font-medium text-gray-700 mb-1">
                            操作内容
                        </label>
                        <textarea id="operation-log-content" class="input-field w-full" rows="3" placeholder="请输入操作步骤和内容..."></textarea>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="closeOperationLogModal()" class="btn btn-secondary">
                            取消
                        </button>
                        <button type="button" onclick="addOperationLog()" class="btn btn-primary" id="add-log-btn">
                            添加记录
                        </button>
                        <button type="button" onclick="saveOperationLog()" class="btn btn-success hidden" id="save-log-btn">
                            保存修改
                        </button>
                        <button type="button" onclick="cancelEditOperationLog()" class="btn btn-secondary hidden" id="cancel-edit-btn">
                            取消编辑
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Product Modal -->
    <div id="edit-product-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden overflow-auto" style="z-index: 1000;">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="border-b border-gray-200 px-6 py-4">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-900">编辑商品</h3>
                    <button type="button" onclick="closeEditProductModal()" class="text-gray-400 hover:text-gray-500">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
            </div>
            <form id="edit-product-form" class="px-6 py-4 overflow-y-auto flex-1">
                <input type="hidden" id="edit-product-link-index">
                <input type="hidden" id="edit-product-index">
                <div class="mb-4">
                    <label for="edit-product-id" class="block text-sm font-medium text-gray-700 mb-1">
                        商品ID <span class="text-danger">*</span>
                    </label>
                    <input type="text" id="edit-product-id" class="input-field w-full" placeholder="请输入商品ID">
                </div>
                <div class="mb-4">
                    <label for="edit-product-category" class="block text-sm font-medium text-gray-700 mb-1">
                        分类
                    </label>
                    <select id="edit-product-category" class="input-field w-full">
                        <option value="电子产品">电子产品</option>
                        <option value="服装">服装</option>
                        <option value="家居">家居</option>
                        <option value="其他">其他</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label for="edit-product-note" class="block text-sm font-medium text-gray-700 mb-1">
                        商品备注
                    </label>
                    <textarea id="edit-product-note" class="input-field w-full" rows="2" placeholder="请输入商品备注（可选）"></textarea>
                </div>
                
                <!-- 时间戳选择器 -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        上架时间记录
                    </label>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <input type="date" id="edit-product-date" class="input-field w-full" placeholder="选择日期">
                        </div>
                        <div>
                            <input type="time" id="edit-product-time" class="input-field w-full" placeholder="选择时间">
                        </div>
                    </div>
                </div>
                
                <!-- 规格信息 -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        规格信息
                    </label>
                    <div id="edit-product-specs" class="space-y-3 max-h-64 overflow-y-auto p-2 border border-gray-200 rounded-lg" style="max-height: 250px;">
                        <!-- 规格将通过JavaScript动态添加 -->
                    </div>
                </div>
                
                <div class="flex items-center justify-end space-x-3">
                    <button type="button" onclick="closeEditProductModal()" class="btn btn-secondary">
                        取消
                    </button>
                    <button type="button" onclick="saveEditProduct()" class="btn btn-primary">
                        保存
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6">
        
        <!-- 页面加载完成后初始化定价工具 -->
        <script>
            // 当页面加载完成时初始化定价工具
            window.addEventListener('load', function() {
                console.log('页面加载完成，初始化定价工具...');
                initPricingTool();
            });
        </script>
        
        <script>
            // 导出规格编码到Excel - 完全重写版
            function exportSkuCostsToExcel() {
                try {
                    console.log('=== 开始导出Excel ===');
                    
                    // 获取选中的字段
                    const selectedFields = [];
                    document.querySelectorAll('.export-field-checkbox:checked').forEach(checkbox => {
                        selectedFields.push(checkbox.value);
                    });
                    
                    console.log('选中的导出字段:', selectedFields);

                    if (selectedFields.length === 0) {
                        showToast('错误', '请至少选择一个导出字段', 'error');
                        return;
                    }

                    // 获取是否包含引用成本项目
                    const includeRefCosts = document.getElementById('export-include-ref-costs').checked;

                    // 获取规格编码数据
                    const skuKeys = Object.keys(skuCosts);

                    if (skuKeys.length === 0) {
                        showToast('错误', '暂无规格编码数据可导出', 'error');
                        return;
                    }

                    // 调试：打印原始数据结构
                    console.log('原始规格编码数据:', skuCosts);

                    // 分析数据结构并计算最大引用成本项目数量
                    let maxRefCount = 0;
                    const skuData = [];

                    skuKeys.forEach(skuCode => {
                        const sku = skuCosts[skuCode];
                        const manualCost = parseFloat(sku.cost) || 0;
                        const referencedCosts = sku.referencedCosts || [];
                        
                        // 调试：打印每个规格编码的引用成本数据
                        console.log(`规格编码 ${skuCode} 的引用成本数据:`, referencedCosts);
                        
                        // 计算引用成本总额
                        let referencedTotal = 0;
                        const refItems = [];
                        
                        // 处理引用成本项目
                        if (Array.isArray(referencedCosts)) {
                            referencedCosts.forEach((ref, index) => {
                                console.log(`  原始引用项目${index + 1}数据:`, JSON.stringify(ref));
                                
                                // 确保ref是对象
                                if (typeof ref === 'object' && ref !== null) {
                                    // 直接从引用成本数据中获取项目名称
                                    let itemName = '未知项目';
                                    
                                    // 首先检查是否有costType和costId，这是最直接的方式
                                    if (ref.costType && ref.costId) {
                                        const costItem = findCostItemById(ref.costType, ref.costId);
                                        if (costItem && costItem.name) {
                                            itemName = costItem.name;
                                            console.log(`  从costType=${ref.costType}, costId=${ref.costId}获取名称:`, itemName);
                                        }
                                    }
                                    
                                    // 如果上面的方法失败，尝试直接从对象属性获取
                                    if (itemName === '未知项目') {
                                        const nameFields = ['name', 'itemName', 'projectName', 'label', 'title', 'description'];
                                        for (const field of nameFields) {
                                            if (ref[field] && typeof ref[field] === 'string') {
                                                itemName = ref[field];
                                                console.log(`  从${field}字段获取名称:`, itemName);
                                                break;
                                            }
                                        }
                                    }
                                    
                                    // 如果仍然没有获取到名称，使用默认值
                                    if (itemName === '未知项目') {
                                        itemName = `项目${index + 1}`;
                                        console.log(`  使用默认名称:`, itemName);
                                    }
                                    
                                    // 获取数量
                                    let itemAmount = parseFloat(ref.quantity) || 0;
                                    console.log(`  从quantity字段获取数量:`, itemAmount);
                                    
                                    // 获取单价
                                    let itemCost = parseFloat(ref.unitCost) || 0;
                                    console.log(`  从unitCost字段获取成本:`, itemCost);
                                    
                                    // 如果没有找到单价但有总成本，尝试计算
                                    if (itemCost === 0 && itemAmount > 0 && ref.totalCost) {
                                        itemCost = parseFloat(ref.totalCost) / itemAmount;
                                        console.log(`  通过总成本和数量计算单价:`, itemCost);
                                    }
                                    
                                    // 计算该项目的总成本
                                    const itemTotal = itemAmount * itemCost;
                                    referencedTotal += itemTotal;
                                    
                                    // 存储项目信息
                                    refItems.push({
                                        name: itemName,
                                        amount: itemAmount,
                                        unitCost: itemCost,
                                        total: itemTotal
                                    });
                                    
                                    console.log(`  最终项目${index + 1}信息:`, {
                                        name: itemName,
                                        amount: itemAmount,
                                        unitCost: itemCost,
                                        total: itemTotal
                                    });
                                }
                            });
                        }
                        
                        // 更新最大引用成本项目数量
                        if (includeRefCosts && refItems.length > maxRefCount) {
                            maxRefCount = refItems.length;
                        }
                        
                        // 存储处理后的数据
                        skuData.push({
                            code: skuCode,
                            manualCost: manualCost,
                            referencedTotal: referencedTotal,
                            totalCost: manualCost + referencedTotal,
                            refItems: refItems,
                            note: sku.note || '',
                            createdAt: sku.createdAt,
                            updatedAt: sku.updatedAt
                        });
                        
                        console.log(`规格编码 ${skuCode} 处理后的数据:`, {
                            manualCost: manualCost,
                            referencedTotal: referencedTotal,
                            refItems: refItems
                        });
                    });

                    // 构建表头
                    const headers = ['规格编码', '手动成本(元)', '引用成本(元)'];
                    
                    // 添加引用成本项目表头
                    if (includeRefCosts && maxRefCount > 0) {
                        for (let i = 0; i < maxRefCount; i++) {
                            headers.push(`引用成本项目${i + 1}`);
                            headers.push(`数量${i + 1}`);
                            headers.push(`单价${i + 1}(元)`);
                            headers.push(`总成本${i + 1}(元)`);
                        }
                    }

                    // 添加其他选中的字段表头
                    const additionalFields = selectedFields.filter(field => 
                        !['skuCode', 'manualCost', 'referenceCost'].includes(field)
                    );
                    
                    const fieldMap = {
                        'totalCost': '总成本(元)',
                        'note': '备注'
                    };
                    
                    additionalFields.forEach(field => {
                        if (fieldMap[field]) {
                            headers.push(fieldMap[field]);
                        }
                    });

                    // 构建数据行
                    const dataRows = [];
                    skuData.forEach(sku => {
                        const row = [];
                        
                        // 添加固定字段
                        row.push(sku.code);          // 规格编码
                        row.push(sku.manualCost);    // 手动成本
                        row.push(sku.referencedTotal); // 引用成本
                        
                        // 添加引用成本项目
                        if (includeRefCosts && maxRefCount > 0) {
                            for (let i = 0; i < maxRefCount; i++) {
                                if (i < sku.refItems.length) {
                                    const item = sku.refItems[i];
                                    row.push(item.name);     // 项目名称
                                    row.push(item.amount);   // 项目数量
                                    row.push(item.unitCost); // 单价
                                    row.push(item.total);    // 总成本
                                    console.log(`  导出项目${i + 1}:`, item.name, item.amount, item.unitCost, item.total);
                                } else {
                                    row.push(''); // 空项目名称
                                    row.push(''); // 空数量
                                    row.push(''); // 空单价
                                    row.push(''); // 空总成本
                                }
                            }
                        }
                        
                        // 添加其他选中的字段
                        additionalFields.forEach(field => {
                            switch(field) {
                                case 'totalCost':
                                    row.push(sku.totalCost);
                                    break;
                                case 'note':
                                    row.push(sku.note);
                                    break;

                                default:
                                    row.push('');
                                    break;
                            }
                        });
                        
                        dataRows.push(row);
                    });

                    // 调试：打印最终导出数据
                    console.log('最终导出数据:', {
                        headers: headers,
                        dataRows: dataRows
                    });

                    // 创建Excel工作簿和工作表
                    const wb = XLSX.utils.book_new();
                    const ws = XLSX.utils.aoa_to_sheet([headers, ...dataRows]);

                    // 设置列宽
                    const colWidths = headers.map(header => ({ 
                        wch: Math.max(header.length * 1.5, 15) 
                    }));
                    ws['!cols'] = colWidths;

                    // 添加工作表到工作簿
                    XLSX.utils.book_append_sheet(wb, ws, '规格编码成本');

                    // 生成文件名并导出
                    const fileName = `规格编码成本_${new Date().toISOString().split('T')[0]}.xlsx`;
                    XLSX.writeFile(wb, fileName);

                    // 关闭模态框
                    document.getElementById('export-fields-modal').classList.add('hidden');

                    showToast('成功', '规格编码成本导出成功', 'success');
                    
                } catch (error) {
                    console.error('导出Excel时发生错误:', error);
                    showToast('错误', '导出失败，请重试', 'error');
                }
            }

            // 从Excel导入规格编码成本
            function importSkuCostsFromExcel() {
                try {
                    console.log('=== 开始导入Excel ===');
                    
                    // 获取上传的文件
                    const fileInput = document.getElementById('import-file-input');
                    const file = fileInput.files[0];
                    
                    if (!file) {
                        showToast('错误', '请选择要导入的Excel文件', 'error');
                        return;
                    }
                    
                    // 检查文件类型
                    if (!file.name.toLowerCase().match(/\.(xlsx|xls)$/)) {
                        showToast('错误', '请选择Excel文件（.xlsx或.xls格式）', 'error');
                        return;
                    }
                    
                    // 显示加载中状态
                    document.getElementById('import-loading').classList.remove('hidden');
                    document.getElementById('import-confirm-btn').disabled = true;
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            
                            // 获取第一个工作表
                            const firstSheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[firstSheetName];
                            
                            // 将工作表转换为JSON
                            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                            
                            console.log('Excel数据:', jsonData);
                            
                            if (jsonData.length < 2) {
                                throw new Error('Excel文件内容为空或格式不正确');
                            }
                            
                            // 解析表头
                            const headers = jsonData[0].map(header => header.toString().trim());
                            console.log('表头:', headers);
                            
                            // 验证必要的列
                            const skuCodeIndex = headers.findIndex(h => h.includes('规格编码') || h.includes('SKU'));
                            const manualCostIndex = headers.findIndex(h => h.includes('手动成本'));
                            
                            if (skuCodeIndex === -1) {
                                throw new Error('未找到"规格编码"列');
                            }
                            
                            if (manualCostIndex === -1) {
                                throw new Error('未找到"手动成本"列');
                            }
                            
                            // 查找引用成本项目相关列
                            const refCostColumns = [];
                            headers.forEach((header, index) => {
                                if (header.includes('引用成本项目') && index > manualCostIndex) {
                                    refCostColumns.push({
                                        nameIndex: index,
                                        quantityIndex: index + 1,
                                        unitCostIndex: index + 2,
                                        totalIndex: index + 3
                                    });
                                }
                            });
                            
                            console.log('找到引用成本项目列:', refCostColumns);
                            
                            // 解析数据
                            const importData = [];
                            let successCount = 0;
                            let skipCount = 0;
                            let errorCount = 0;
                            
                            for (let i = 1; i < jsonData.length; i++) {
                                const row = jsonData[i];
                                
                                // 跳过空行
                                if (!row[skuCodeIndex] || row[skuCodeIndex].toString().trim() === '') {
                                    skipCount++;
                                    continue;
                                }
                                
                                try {
                                    const skuCode = row[skuCodeIndex] ? 
                                        (typeof row[skuCodeIndex] === 'string' ? row[skuCodeIndex].trim() : String(row[skuCodeIndex]).trim()) : '';
                                    const manualCost = row[manualCostIndex] ? parseFloat(row[manualCostIndex]) || 0 : 0;
                                    
                                    // 获取备注（如果有）
                                    const noteIndex = headers.findIndex(h => h.includes('备注') || h.includes('说明'));
                                    const note = noteIndex !== -1 && row[noteIndex] ? row[noteIndex].toString().trim() : '';
                                    
                    // 解析引用成本项目
                                    const referencedCosts = [];
                                    refCostColumns.forEach((col, colIndex) => {
                                        try {
                                            // 检查列索引是否有效
                                            if (col.nameIndex >= row.length || 
                                                col.quantityIndex >= row.length || 
                                                col.unitCostIndex >= row.length) {
                                                console.warn(`行 ${i + 1} 列索引超出范围`);
                                                return;
                                            }
                                            
                                            // 安全获取单元格值
                                            const nameCell = row[col.nameIndex];
                                            const itemName = nameCell ? 
                                                (typeof nameCell === 'string' ? nameCell.trim() : String(nameCell).trim()) : '';
                                            
                                            const quantityCell = row[col.quantityIndex];
                                            const quantity = quantityCell ? parseFloat(quantityCell) || 0 : 0;
                                            
                                            const costCell = row[col.unitCostIndex];
                                            const unitCost = costCell ? parseFloat(costCell) || 0 : 0;
                                            
                                            console.log(`解析项目 ${colIndex + 1}: 名称="${itemName}", 数量=${quantity}, 单价=${unitCost}`);
                                            
                                            // 只有当项目名称和数量都存在时才添加
                                            if (itemName && quantity > 0) {
                                                // 查找对应的成本项目ID
                                                const costItem = findCostItemByName(itemName);
                                                if (costItem) {
                                                    referencedCosts.push({
                                                        costType: costItem.type,
                                                        costId: costItem.id,
                                                        quantity: quantity,
                                                        unitCost: unitCost,
                                                        totalCost: quantity * unitCost
                                                    });
                                                    console.log(`找到匹配的成本项目: ${costItem.name} (${costItem.type})`);
                                                } else {
                                                    console.warn(`未找到成本项目: ${itemName}`);
                                                    // 如果找不到匹配的成本项目，仍然添加但标记为未匹配
                                                    referencedCosts.push({
                                                        costType: 'unknown',
                                                        costId: `unknown_${Date.now()}_${colIndex}`,
                                                        quantity: quantity,
                                                        unitCost: unitCost,
                                                        totalCost: quantity * unitCost,
                                                        name: itemName // 保存原始名称
                                                    });
                                                }
                                            }
                                        } catch (err) {
                                            console.error(`解析引用成本项目 ${colIndex + 1} 时发生错误:`, err);
                                        }
                                    });
                                    
                                    importData.push({
                                        skuCode: skuCode,
                                        cost: manualCost,
                                        note: note,
                                        referencedCosts: referencedCosts
                                    });
                                    
                                    successCount++;
                                    
                                } catch (err) {
                                    console.error(`第${i + 1}行数据解析错误:`, err);
                                    errorCount++;
                                }
                            }
                            
                            console.log('解析后的数据:', importData);
                            
                            // 显示预览区域
                            document.getElementById('import-preview-section').classList.remove('hidden');
                            document.getElementById('import-mode-section').classList.remove('hidden');
                            
                            // 显示预览
                            const previewContainer = document.getElementById('import-preview');
                            previewContainer.innerHTML = '';
                            
                            if (importData.length === 0) {
                                throw new Error('未找到有效的数据');
                            }
                            
                            // 创建预览表格
                            const table = document.createElement('table');
                            table.className = 'min-w-full border border-gray-200 rounded-lg';
                            
                            // 表头
                            const thead = document.createElement('thead');
                            thead.className = 'bg-gray-50';
                            thead.innerHTML = `
                                <tr>
                                    <th class="px-4 py-2 border-b border-gray-200 text-left text-sm font-semibold text-gray-700">规格编码</th>
                                    <th class="px-4 py-2 border-b border-gray-200 text-right text-sm font-semibold text-gray-700">手动成本(元)</th>
                                    <th class="px-4 py-2 border-b border-gray-200 text-left text-sm font-semibold text-gray-700">引用成本项目数</th>
                                    <th class="px-4 py-2 border-b border-gray-200 text-left text-sm font-semibold text-gray-700">备注</th>
                                </tr>
                            `;
                            table.appendChild(thead);
                            
                            // 表体
                            const tbody = document.createElement('tbody');
                            importData.slice(0, 10).forEach(item => {
                                const tr = document.createElement('tr');
                                tr.className = 'hover:bg-gray-50';
                                tr.innerHTML = `
                                    <td class="px-4 py-2 border-b border-gray-200 text-sm">${item.skuCode}</td>
                                    <td class="px-4 py-2 border-b border-gray-200 text-sm text-right">${item.cost.toFixed(2)}</td>
                                    <td class="px-4 py-2 border-b border-gray-200 text-sm">${item.referencedCosts ? item.referencedCosts.length : 0}</td>
                                    <td class="px-4 py-2 border-b border-gray-200 text-sm">${item.note}</td>
                                `;
                                tbody.appendChild(tr);
                            });
                            table.appendChild(tbody);
                            
                            previewContainer.appendChild(table);
                            
                            // 显示统计信息
                            document.getElementById('import-stats').innerHTML = `
                                <div class="text-sm text-gray-600 mt-2">
                                    共解析 <span class="font-semibold text-primary">${successCount}</span> 条数据，
                                    跳过 <span class="text-gray-500">${skipCount}</span> 条空行，
                                    <span class="text-danger">${errorCount}</span> 条错误
                                </div>
                                ${importData.length > 10 ? `<div class="text-sm text-gray-500 mt-1">显示前10条数据预览</div>` : ''}
                            `;
                            
                            // 存储解析后的数据到隐藏字段
                            document.getElementById('import-data').value = JSON.stringify(importData);
                            
                            // 显示确认按钮
                            document.getElementById('import-confirm-section').classList.remove('hidden');
                            
                            console.log('导入预览准备完成，共', importData.length, '条数据');
                            
                        } catch (error) {
                            console.error('解析Excel文件时发生错误:', error);
                            showToast('错误', `解析文件失败: ${error.message}`, 'error');
                            // 隐藏所有相关区域
                            document.getElementById('import-preview-section').classList.add('hidden');
                            document.getElementById('import-mode-section').classList.add('hidden');
                            document.getElementById('import-confirm-section').classList.add('hidden');
                        } finally {
                            // 隐藏加载状态
                            document.getElementById('import-loading').classList.add('hidden');
                            document.getElementById('import-confirm-btn').disabled = false;
                        }
                    };
                    
                    reader.onerror = function() {
                        showToast('错误', '读取文件失败，请重试', 'error');
                        document.getElementById('import-loading').classList.add('hidden');
                        document.getElementById('import-confirm-btn').disabled = false;
                    };
                    
                    reader.readAsArrayBuffer(file);
                    
                } catch (error) {
                    console.error('导入Excel时发生错误:', error);
                    showToast('错误', '导入失败，请重试', 'error');
                    document.getElementById('import-loading').classList.add('hidden');
                    document.getElementById('import-confirm-btn').disabled = false;
                }
            }

            // 确认导入规格编码成本
            function confirmImportSkuCosts() {
                try {
                    console.log('=== 开始确认导入 ===');
                    
                    const importDataStr = document.getElementById('import-data').value;
                    if (!importDataStr) {
                        showToast('错误', '没有可导入的数据', 'error');
                        return;
                    }
                    
                    const importData = JSON.parse(importDataStr);
                    const importModeElements = document.querySelectorAll('input[name="import-mode"]');
                    let importMode = 'merge'; // 默认值
                    
                    for (let i = 0; i < importModeElements.length; i++) {
                        if (importModeElements[i].checked) {
                            importMode = importModeElements[i].value;
                            break;
                        }
                    }
                    
                    console.log('确认导入数据:', importData.length, '条');
                    console.log('导入模式:', importMode);
                    console.log('当前已存在的规格编码数量:', Object.keys(skuCosts || {}).length);
                    
                    let newCount = 0;
                    let updateCount = 0;
                    let errorCount = 0;
                    let skippedCount = 0;
                    
                    importData.forEach(item => {
                        try {
                            console.log('处理项目:', item);
                            
                            if (!item.skuCode) {
                                console.warn('跳过无效项目（无规格编码）:', item);
                                skippedCount++;
                                return;
                            }
                            
                            const existingSku = skuCosts && skuCosts[item.skuCode];
                            
                            console.log(`规格编码 ${item.skuCode} 已存在:`, !!existingSku);
                            
                            if (existingSku) {
                                // 已存在的规格编码
                                if (importMode === 'update' || importMode === 'merge') {
                                    // 计算总成本（与手动添加保持一致）
                                    const referencedTotal = calculateReferencedCostTotal(item.referencedCosts || []);
                                    const totalCost = item.cost + referencedTotal;
                                    
                                    // 更新模式或合并模式：更新成本和备注
                                    existingSku.cost = item.cost;
                                    existingSku.totalCost = totalCost; // 确保更新总成本
                                    if (item.note !== undefined && importMode === 'merge') {
                                        existingSku.note = item.note;
                                    } else if (importMode === 'update') {
                                        existingSku.note = item.note || '';
                                    }
                                    // 更新引用成本项目
                                    if (item.referencedCosts && (importMode === 'update' || importMode === 'merge')) {
                                        existingSku.referencedCosts = item.referencedCosts;
                                    }
                                    updateCount++;
                                    console.log(`更新规格编码: ${item.skuCode}, 总成本: ¥${totalCost.toFixed(2)}`);
                                } else {
                                    console.log(`跳过已存在的规格编码（${importMode}模式）: ${item.skuCode}`);
                                    skippedCount++;
                                }
                            } else {
                                // 新的规格编码
                                if (importMode === 'insert' || importMode === 'merge') {
                                    // 确保skuCosts对象存在
                                    if (!skuCosts) {
                                        skuCosts = {};
                                        console.log('初始化skuCosts对象');
                                    }
                                    
                                    // 计算总成本（与手动添加保持一致）
                                    const referencedTotal = calculateReferencedCostTotal(item.referencedCosts || []);
                                    const totalCost = item.cost + referencedTotal;
                                    
                                    // 使用与手动添加完全相同的数据结构
                                    skuCosts[item.skuCode] = {
                                        cost: item.cost,
                                        referencedCosts: item.referencedCosts || [],
                                        totalCost: totalCost, // 确保包含正确的总成本
                                        note: item.note || ''
                                    };
                                    newCount++;
                                    console.log(`新增规格编码: ${item.skuCode}`);
                                } else {
                                    console.log(`跳过不存在的规格编码（${importMode}模式）: ${item.skuCode}`);
                                    skippedCount++;
                                }
                            }
                        } catch (err) {
                            console.error(`处理规格编码 ${item.skuCode || '未知'} 时发生错误:`, err);
                            console.error('错误详情:', err.stack);
                            errorCount++;
                        }
                    });
                    
                    console.log('导入统计:', {
                        总记录数: importData.length,
                        新增: newCount,
                        更新: updateCount,
                        跳过: skippedCount,
                        错误: errorCount
                    });
                    
                    if (errorCount > 0) {
                        throw new Error(`处理过程中出现 ${errorCount} 个错误`);
                    }
                    
                    // 保存到localStorage
                    try {
                        console.log('准备保存导入的数据...');
                        console.log('导入后skuCosts数量:', Object.keys(skuCosts || {}).length);
                        
                        // 使用统一的saveData函数保存数据
                        saveData();
                        
                        console.log('数据已成功保存');
                    } catch (saveError) {
                        console.error('保存数据时发生错误:', saveError);
                        console.error('错误详情:', saveError.stack);
                        throw new Error('数据保存失败: ' + saveError.message);
                    }
                    
                    // 重新渲染表格
                    renderSkuCosts();
                    
                    // 重新计算产品利润
                    if (typeof calculateProfit === 'function') {
                        console.log('导入完成，重新计算利润...');
                        calculateProfit();
                    }
                    
                    // 关闭模态框
                    document.getElementById('import-modal').classList.add('hidden');
                    
                    // 重置文件输入
                    document.getElementById('import-file-input').value = '';
                    
                    // 显示导入结果
                    showToast('成功', `导入完成！新增 ${newCount} 条，更新 ${updateCount} 条，跳过 ${skippedCount} 条`, 'success');
                    
                } catch (error) {
                    console.error('确认导入时发生错误:', error);
                    showToast('错误', `导入失败: ${error.message}`, 'error');
                }
            }

            // 导出成本记录到Excel
            function exportCostsToExcel() {
                try {
                    console.log('=== 开始导出成本记录Excel ===');
                    
                    // 获取所有成本数据
                    const allCosts = [];
                    
                    // 遍历所有成本类型
                    for (const type in costRecords) {
                        if (costRecords.hasOwnProperty(type)) {
                            const items = costRecords[type] || [];
                            console.log(`成本类型 ${type} 有 ${items.length} 个项目`);
                            
                            items.forEach((item, index) => {
                                console.log(`项目 ${index + 1} 原始数据:`, JSON.stringify(item));
                                
                                // 尝试获取成本金额，支持不同的字段名
                                let costAmount = 0;
                                if (item.cost !== undefined && item.cost !== null) {
                                    costAmount = parseFloat(item.cost) || 0;
                                    console.log(`从 cost 字段获取金额: ${costAmount}`);
                                } else if (item.price !== undefined && item.price !== null) {
                                    costAmount = parseFloat(item.price) || 0;
                                    console.log(`从 price 字段获取金额: ${costAmount}`);
                                } else if (item.amount !== undefined && item.amount !== null) {
                                    costAmount = parseFloat(item.amount) || 0;
                                    console.log(`从 amount 字段获取金额: ${costAmount}`);
                                } else {
                                    console.warn(`项目 ${item.name} 没有找到成本金额字段`);
                                }
                                
                                // 按照要求的格式
                                const formattedItem = {
                                    '成本类型': getCostTypeName(type),
                                    '成本项目': item.name || '未知项目',
                                    '成本金额': costAmount,
                                    '备注': item.note || ''
                                };
                                
                                // 如果有分类信息也添加
                                if (item.category) {
                                    formattedItem['分类'] = item.category;
                                }
                                
                                allCosts.push(formattedItem);
                                console.log(`格式化后的项目数据:`, formattedItem);
                            });
                        }
                    }
                    
                    if (allCosts.length === 0) {
                        showToast('错误', '暂无成本数据可导出', 'error');
                        return;
                    }
                    
                    console.log('最终成本数据:', allCosts);
                    
                    // 创建Excel工作簿和工作表
                    const wb = XLSX.utils.book_new();
                    
                    // 创建主工作表 - 所有成本数据
                    const ws = XLSX.utils.json_to_sheet(allCosts);
                    
                    // 设置列宽
                    const colWidths = [
                        { wch: 15 }, // 成本类型
                        { wch: 30 }, // 成本项目
                        { wch: 15 }, // 成本金额
                        { wch: 20 }  // 备注
                    ];
                    
                    // 如果有分类列，添加列宽
                    if (allCosts[0] && allCosts[0]['分类']) {
                        colWidths.splice(2, 0, { wch: 15 }); // 在成本金额前插入分类列宽
                    }
                    
                    ws['!cols'] = colWidths;
                    
                    // 添加工作表到工作簿
                    XLSX.utils.book_append_sheet(wb, ws, '所有成本数据');
                    
                    // 按成本类型创建单独的工作表
                    const costTypes = ['express', 'platform', 'packaging', 'accessory'];
                    costTypes.forEach(type => {
                        const items = costRecords[type] || [];
                        if (items.length > 0) {
                            const typeData = items.map(item => {
                                // 尝试获取成本金额，支持不同的字段名
                                let costAmount = 0;
                                if (item.cost !== undefined && item.cost !== null) {
                                    costAmount = parseFloat(item.cost) || 0;
                                } else if (item.price !== undefined && item.price !== null) {
                                    costAmount = parseFloat(item.price) || 0;
                                } else if (item.amount !== undefined && item.amount !== null) {
                                    costAmount = parseFloat(item.amount) || 0;
                                }
                                
                                return {
                                    '成本项目': item.name || '未知项目',
                                    '成本金额': costAmount,
                                    '备注': item.note || ''
                                };
                            });
                            
                            const typeWs = XLSX.utils.json_to_sheet(typeData);
                            XLSX.utils.book_append_sheet(wb, typeWs, getCostTypeName(type));
                        }
                    });
                    
                    // 生成文件名并导出
                    const fileName = `成本记录_${new Date().toISOString().split('T')[0]}.xlsx`;
                    XLSX.writeFile(wb, fileName);
                    
                    showToast('成功', '成本记录导出成功', 'success');
                    
                } catch (error) {
                    console.error('导出成本记录Excel时发生错误:', error);
                    showToast('错误', '导出失败，请重试', 'error');
                }
            }
            
            // 获取成本类型名称
            function getCostTypeName(type) {
                const typeNames = {
                    'express': '快递成本',
                    'platform': '服务费售后人力成本',
                    'packaging': '包装成本',
                    'accessory': '产品成本'
                };
                return typeNames[type] || type;
            }
            
            // 查找成本项目
            function findCostItem(type, id) {
                const costItems = costRecords[type] || [];
                return costItems.find(item => item.id === id);
            }
            
            // 根据名称查找成本项目
            function findCostItemByName(name) {
                try {
                    console.log('查找成本项目:', name);
                    
                    // 检查name参数是否有效
                    if (!name || typeof name !== 'string') {
                        console.warn('查找成本项目时名称无效:', name);
                        return null;
                    }
                    
                    const searchName = name.toLowerCase().trim();
                    
                    // 遍历所有成本类型
                    for (const type in costRecords) {
                        if (costRecords.hasOwnProperty(type)) {
                            const items = costRecords[type] || [];
                            console.log(`检查类型 ${type}，共 ${items.length} 个项目`);
                            
                            // 精确匹配
                            const exactMatch = items.find(item => 
                                item.name && typeof item.name === 'string' && 
                                item.name.toLowerCase().trim() === searchName
                            );
                            if (exactMatch) {
                                console.log('找到精确匹配:', exactMatch.name);
                                return { ...exactMatch, type };
                            }
                            
                            // 包含匹配
                            const partialMatch = items.find(item => 
                                item.name && typeof item.name === 'string' && 
                                item.name.toLowerCase().trim().includes(searchName)
                            );
                            if (partialMatch) {
                                console.log('找到包含匹配:', partialMatch.name);
                                return { ...partialMatch, type };
                            }
                        }
                    }
                    
                    console.log('未找到匹配的成本项目:', name);
                    return null;
                } catch (error) {
                    console.error('查找成本项目时发生错误:', error);
                    return null;
                }
            }

            // 导航标签切换功能
            document.addEventListener('DOMContentLoaded', function() {
                const tabs = document.querySelectorAll('.tab');
                
                // 为所有标签添加点击事件
                tabs.forEach(tab => {
                    tab.addEventListener('click', function() {
                        // 移除所有标签的激活状态
                        tabs.forEach(t => {
                            t.classList.remove('tab-active');
                            t.style.color = 'rgb(0, 0, 0)';
                        });
                        
                        // 添加当前标签的激活状态
                        this.classList.add('tab-active');
                        this.style.color = 'rgb(59, 130, 246)';
                        
                        // 显示对应的内容区域
                        const tabId = this.getAttribute('data-tab');
                        document.querySelectorAll('.tab-content').forEach(content => {
                            content.classList.add('hidden');
                        });
                        const activeContent = document.getElementById(tabId);
                        if (activeContent) {
                            activeContent.classList.remove('hidden');
                        }
                        
                        // 如果切换到新品定价工具，初始化数据
                        if (tabId === 'pricing-tool') {
                            console.log('=== 切换到新品定价工具标签 ===');
                            loadPricingData();
                            // updatePricingCategorySelects 内部会调用 updateLinkShopFilter
                            updatePricingCategorySelects();
                            renderLinks();
                            renderDisplayLinks();
                        }
                    });
                });
                
                // 新品定价工具内部标签切换
                const pricingTabs = document.querySelectorAll('.pricing-tab');
                pricingTabs.forEach(tab => {
                    tab.addEventListener('click', function() {
                        // 移除所有标签的激活状态
                        pricingTabs.forEach(t => {
                            t.classList.remove('text-primary', 'bg-blue-50');
                            t.classList.add('text-gray-600', 'hover:text-gray-800', 'hover:bg-gray-50');
                        });
                        
                        // 添加当前标签的激活状态
                        this.classList.remove('text-gray-600', 'hover:text-gray-800', 'hover:bg-gray-50');
                        this.classList.add('text-primary', 'bg-blue-50');
                        
                        // 清理可能存在的旧元素（如下划线等）
                        document.querySelectorAll('.pricing-tab').forEach(tab => {
                            // 移除所有可能的边框和下划线元素
                            tab.querySelectorAll('.absolute, .border-b-2, .border-blue-200, .border-primary').forEach(element => {
                                element.remove();
                            });
                        });
                        
                        // 显示对应的内容区域
                        const tabId = this.getAttribute('data-pricing-tab');
                        document.querySelectorAll('.pricing-tab-content').forEach(content => {
                            content.classList.add('hidden');
                        });
                        const activeContent = document.getElementById(tabId);
                        if (activeContent) {
                            activeContent.classList.remove('hidden');
                        }
                        
                        // 如果切换到链接展示，重新渲染
                        if (tabId === 'link-display') {
                            // 检查是否是用户手动点击的标签（通过事件目标判断）
                            const isManualClick = event && event.isTrusted;
                            console.log('Switching to link display, is manual click:', isManualClick);
                            
                            // 只有在用户手动点击标签时才重置过滤状态
                            if (isManualClick) {
                                console.log('User manually clicked product details tab, resetting filter');
                                currentViewingLinkIndex = -1;
                                currentViewingProductIndex = -1;
                            } else {
                                console.log('Programmatic tab switch, preserving filter:', currentViewingLinkIndex);
                            }
                            
                            renderDisplayLinks();
                        }
                    });
                });
            });
            
            // 新品定价工具数据
            let pricingData = {
                links: [],
                categories: ['电子产品', '服装', '家居', '其他']
            };
            
            // 加载定价数据
            function loadPricingData() {
                const saved = localStorage.getItem('pricingData');
                if (saved) {
                    pricingData = JSON.parse(saved);
                }
            }
            
            // 新品定价工具分类管理功能
            function openPricingCategoryModal() {
                document.getElementById('pricing-category-management-modal').classList.remove('hidden');
                renderPricingCategoriesList();
            }
            
            function closePricingCategoryModal() {
                document.getElementById('pricing-category-management-modal').classList.add('hidden');
                document.getElementById('new-category-name').value = '';
            }
            
            function renderPricingCategoriesList() {
                const container = document.getElementById('pricing-categories-container');
                container.innerHTML = pricingData.categories.map((category, index) => `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg transition-all duration-300" id="category-item-${index}">
                        <div class="flex items-center space-x-3 flex-1">
                            <span class="text-sm font-medium text-gray-700 category-name">${category}</span>
                            <div class="hidden category-edit-form flex-1">
                                <input type="text" value="${category}" class="input-field text-sm" placeholder="请输入分类名称" 
                                       onkeypress="if(event.key === 'Enter') saveCategoryEdit(${index})"
                                       onblur="setTimeout(() => { if (!window.savingCategory) cancelCategoryEdit(${index}); window.savingCategory = false; }, 200)">
                            </div>
                        </div>
                        <div class="flex items-center space-x-2 category-actions">
                            <button onclick="startCategoryEdit(${index})" class="text-primary hover:text-primary/80 transition-colors">
                                <i class="fa fa-pencil"></i>
                            </button>
                            <button onclick="deletePricingCategory(${index})" class="text-danger hover:text-danger/80 transition-colors">
                                <i class="fa fa-trash"></i>
                            </button>
                        </div>
                        <div class="hidden category-edit-actions flex items-center space-x-2">
                            <button onclick="window.savingCategory = true; saveCategoryEdit(${index})" class="btn btn-primary btn-sm h-8 px-2" id="save-btn-${index}">
                                <i class="fa fa-check"></i>
                            </button>
                            <button onclick="cancelCategoryEdit(${index})" class="btn btn-secondary btn-sm h-8 px-2">
                                <i class="fa fa-times"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            }
            
            function addNewPricingCategory() {
                console.log('=== 开始添加新分类 ===');
                const categoryName = document.getElementById('new-category-name').value.trim();
                console.log('新分类名称:', categoryName);
                
                if (categoryName) {
                    if (!pricingData.categories.includes(categoryName)) {
                        // 添加新分类到数据中
                        pricingData.categories.push(categoryName);
                        console.log('分类已添加到数据，当前分类列表:', pricingData.categories);
                        
                        // 保存数据
                        savePricingData();
                        console.log('数据已保存到localStorage');
                        
                        // 更新分类管理模态框中的列表
                        renderPricingCategoriesList();
                        console.log('分类管理列表已更新');
                        
                        // 立即更新所有分类选择器
                        updatePricingCategorySelects();
                        console.log('分类选择器已更新');
                        
                        // 保存所有卡片的展开状态
                        const expandedStates = {};
                        document.querySelectorAll('.link-header').forEach(header => {
                            const index = header.getAttribute('data-index');
                            const isExpanded = !header.nextElementSibling.classList.contains('hidden');
                            expandedStates[index] = isExpanded;
                        });
                        console.log('保存的展开状态:', expandedStates);
                        
                        // 重新渲染链接列表以显示新的分类
                        renderLinks();
                        console.log('链接列表已重新渲染');
                        
                        // 恢复之前的展开状态
                        setTimeout(() => {
                            document.querySelectorAll('.link-header').forEach(header => {
                                const index = header.getAttribute('data-index');
                                const content = header.nextElementSibling;
                                const icon = header.querySelector('.link-toggle-icon');
                                
                                if (expandedStates[index]) {
                                    content.classList.remove('hidden');
                                    if (icon) {
                                        icon.style.transform = 'rotate(180deg)';
                                    }
                                }
                            });
                            console.log('已恢复展开状态');
                        }, 50);
                        
                        // 清空输入框并显示成功提示
                        document.getElementById('new-category-name').value = '';
                        showToast('成功', '分类已添加', 'success');
                        console.log('=== 添加分类完成 ===');
                    } else {
                        console.log('分类名称已存在:', categoryName);
                        showToast('错误', '分类名称已存在', 'error');
                    }
                } else {
                    console.log('分类名称为空');
                    showToast('错误', '请输入分类名称', 'error');
                }
            }
            
            function startCategoryEdit(index) {
                const item = document.getElementById(`category-item-${index}`);
                const nameSpan = item.querySelector('.category-name');
                const editForm = item.querySelector('.category-edit-form');
                const actions = item.querySelector('.category-actions');
                const editActions = item.querySelector('.category-edit-actions');
                const input = editForm.querySelector('input');
                
                // 隐藏显示的元素，显示编辑元素
                nameSpan.classList.add('hidden');
                actions.classList.add('hidden');
                editForm.classList.remove('hidden');
                editActions.classList.remove('hidden');
                
                // 添加编辑状态样式
                item.classList.add('category-editing');
                
                // 聚焦输入框并选中文本
                setTimeout(() => {
                    input.focus();
                    input.select();
                }, 100);
            }
            
            function saveCategoryEdit(index) {
                console.log('=== saveCategoryEdit 函数被调用 ===');
                console.log('调用来源:', event ? event.type : '未知');
                console.log('分类索引:', index);
                
                try {
                    const item = document.getElementById(`category-item-${index}`);
                    console.log('找到分类元素:', item ? '是' : '否');
                    
                    if (!item) {
                        showToast('错误', '系统错误', 'error');
                        return;
                    }
                    
                    const input = item.querySelector('.category-edit-form input');
                    console.log('找到输入框:', input ? '是' : '否');
                    
                    if (!input) {
                        showToast('错误', '系统错误', 'error');
                        return;
                    }
                    
                    const newName = input.value.trim();
                    console.log('新分类名称:', newName);
                    
                    if (!pricingData || !pricingData.categories) {
                        console.log('错误: 分类数据不存在');
                        showToast('错误', '系统数据异常', 'error');
                        return;
                    }
                    
                    console.log('分类数据:', pricingData.categories);
                    
                    if (index >= pricingData.categories.length) {
                        console.log('错误: 索引超出范围');
                        showToast('错误', '系统错误', 'error');
                        return;
                    }
                    
                    const oldName = pricingData.categories[index];
                    console.log('旧分类名称:', oldName);
                    
                    if (newName) {
                        if (newName !== oldName && pricingData.categories.includes(newName)) {
                            console.log('分类名称已存在');
                            showToast('错误', '分类名称已存在', 'error');
                            input.focus();
                            return;
                        }
                        
                        if (newName !== oldName) {
                            console.log('准备更新分类名称');
                            
                            // 同步更新所有使用该分类的链接和商品
                            let linkUpdatedCount = 0;
                            let productUpdatedCount = 0;
                            
                            pricingData.links.forEach(link => {
                                // 更新链接的分类
                                if (link.category === oldName) {
                                    link.category = newName;
                                    linkUpdatedCount++;
                                }
                                
                                // 更新商品的分类
                                if (link.products) {
                                    link.products.forEach(product => {
                                        if (product.category === oldName) {
                                            product.category = newName;
                                            productUpdatedCount++;
                                        }
                                    });
                                }
                            });
                            
                            console.log('更新了', linkUpdatedCount, '个链接的分类');
                            console.log('更新了', productUpdatedCount, '个商品的分类');
                            
                            // 更新分类名称
                            pricingData.categories[index] = newName;
                            console.log('分类数据已更新:', pricingData.categories);
                            
                            // 保存数据
                            localStorage.setItem('pricingData', JSON.stringify(pricingData));
                            console.log('数据已保存到localStorage');
                            
                            // 更新所有相关的分类选择框
                            updatePricingCategorySelects();
                            console.log('分类选择框已更新');
                            
                            showToast('成功', '分类已更新', 'success');
                        }
                        
                        // 退出编辑模式并重新渲染所有相关界面
                        renderPricingCategoriesList();
                        console.log('分类列表已重新渲染');
                        
                        // 重新渲染链接列表以显示更新后的分类名称
                        renderLinks();
                        console.log('链接列表已重新渲染');
                        
                        // 重新渲染显示链接列表
                        renderDisplayLinks();
                        console.log('显示链接列表已重新渲染');
                    } else {
                        console.log('分类名称不能为空');
                        showToast('错误', '分类名称不能为空', 'error');
                        input.focus();
                    }
                } catch (error) {
                    console.error('保存分类时出错:', error);
                    showToast('错误', '保存失败', 'error');
                }
                
                console.log('=== saveCategoryEdit 函数执行完成 ===');
            }
            
            function cancelCategoryEdit(index) {
                // 直接重新渲染列表来退出编辑模式
                renderPricingCategoriesList();
            }
            
            function deletePricingCategory(index) {
                const category = pricingData.categories[index];
                
                // 检查是否有链接或商品使用此分类
                const isUsed = pricingData.links.some(link => 
                    link.category === category || 
                    link.products.some(product => product.category === category)
                );
                
                if (isUsed) {
                    showToast('错误', '该分类正在使用中，无法删除', 'error');
                    return;
                }
                
                if (confirm(`确定要删除分类"${category}"吗？`)) {
                    pricingData.categories.splice(index, 1);
                    savePricingData();
                    renderPricingCategoriesList();
                    updatePricingCategorySelects();
                    showToast('成功', '分类已删除', 'success');
                }
            }
            
            function updatePricingCategorySelects() {
                console.log('=== 开始更新分类选择器 ===');
                console.log('当前分类数据:', pricingData.categories);
                
                // 定义需要更新的select元素ID列表
                const selectIds = ['link-category-filter', 'add-link-category', 'edit-link-category', 'edit-product-category'];
                
                selectIds.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (select) {
                        console.log(`更新选择器: ${selectId}`);
                        const currentValue = select.value;
                        const isFilterSelect = selectId === 'link-category-filter';
                        
                        // 清空现有选项
                        select.innerHTML = '';
                        
                        // 如果是筛选器，添加"全部分类"选项
                        if (isFilterSelect) {
                            const option = document.createElement('option');
                            option.value = '';
                            option.textContent = '全部分类';
                            select.appendChild(option);
                        }
                        
                        // 添加所有分类选项
                        pricingData.categories.forEach(category => {
                            const option = document.createElement('option');
                            option.value = category;
                            option.textContent = category;
                            select.appendChild(option);
                        });
                        
                        // 恢复当前选中值
                        if (currentValue && select.querySelector(`option[value="${currentValue}"]`)) {
                            select.value = currentValue;
                        } else if (pricingData.categories.length > 0) {
                            select.value = isFilterSelect ? '' : pricingData.categories[0];
                        }
                        
                        console.log(`选择器 ${selectId} 更新完成，当前值: ${select.value}`);
                    } else {
                        console.log(`警告: 选择器 ${selectId} 未找到`);
                    }
                });
                
                // 更新店铺筛选器
                updateLinkShopFilter();
                
                console.log('=== 分类选择器更新完成 ===');
            }
            
            // 更新链接管理的店铺筛选器
            function updateLinkShopFilter() {
                console.log('=== 开始更新链接管理店铺筛选器 ===');
                
                const shopFilter = document.getElementById('link-shop-filter');
                if (shopFilter) {
                    const currentValue = shopFilter.value;
                    console.log('当前筛选器值:', currentValue);
                    
                    // 清空现有选项
                    shopFilter.innerHTML = '<option value="">所有店铺</option>';
                    
                    try {
                        // 获取所有店铺数据
                        const shops = JSON.parse(localStorage.getItem('shops')) || [];
                        console.log('从localStorage获取的店铺数据:', shops);
                        
                        if (shops.length === 0) {
                            console.log('未找到店铺数据，添加提示选项');
                            const option = document.createElement('option');
                            option.value = '';
                            option.textContent = '暂无店铺数据';
                            option.disabled = true;
                            shopFilter.appendChild(option);
                        } else {
                            console.log('找到店铺数量:', shops.length);
                            // 添加店铺选项
                            shops.forEach(shop => {
                                if (shop && shop.id && shop.name) {
                                    const option = document.createElement('option');
                                    option.value = shop.id;
                                    option.textContent = shop.name;
                                    shopFilter.appendChild(option);
                                    console.log('添加店铺选项:', shop.name, '(', shop.id, ')');
                                }
                            });
                        }
                        
                        // 恢复当前选中值
                        if (currentValue && shopFilter.querySelector(`option[value="${currentValue}"]`)) {
                            shopFilter.value = currentValue;
                            console.log('恢复选中值:', currentValue);
                        }
                        
                    } catch (error) {
                        console.error('更新店铺筛选器时发生错误:', error);
                        const option = document.createElement('option');
                        option.value = '';
                        option.textContent = '加载店铺失败';
                        option.disabled = true;
                        shopFilter.appendChild(option);
                    }
                    
                    console.log('=== 链接管理店铺筛选器更新完成 ===');
                } else {
                    console.log('警告: 链接管理店铺筛选器 link-shop-filter 未找到');
                }
            }
            
            // 保存定价数据
            function savePricingData() {
                try {
                    const dataString = JSON.stringify(pricingData);
                    localStorage.setItem('pricingData', dataString);
                    console.log('=== 数据保存成功 ===');
                    console.log('保存的数据大小:', dataString.length, '字符');
                } catch (error) {
                    console.error('保存数据失败:', error);
                    showToast('错误', '保存数据失败', 'error');
                }
            }
            
            // 切换规格成本关联
            function toggleCostLink(linkIndex, productIndex, specIndex) {
                try {
                    console.log('=== 切换规格成本关联 ===', { linkIndex, productIndex, specIndex });
                    
                    // 简化版本 - 移除过度的错误检查
                    const link = pricingData.links[linkIndex];
                    const product = link.products[productIndex];
                    const spec = product.specs[specIndex];
                    
                    if (!spec.specCode) {
                        showToast('提示', '请先输入规格编码', 'warning');
                        return;
                    }
                    
                    // 如果已关联，则取消关联
                    if (spec.linkedCost) {
                        spec.linkedCost = false;
                        spec.cost = parseFloat(spec.cost) || 0; // 保留当前成本值
                        spec.linkedCostCode = null; // 清除关联编码
                        
                        // 立即保存数据
                        savePricingData();
                        
                        // 强制重新渲染显示链接
                        setTimeout(() => {
                            console.log('取消关联后重新渲染显示链接');
                            renderDisplayLinks();
                            showToast('成功', '已取消规格成本关联', 'success');
                        }, 50);
                        return;
                    }
                    
                    // 查找对应的规格成本
                    const skuCost = skuCosts[spec.specCode];
                    if (!skuCost) {
                        showToast('提示', `未找到规格编码"${spec.specCode}"的成本信息`, 'warning');
                        return;
                    }
                    
                    // 关联成本 - 使用总成本而不是手动成本
                    const totalCost = parseFloat(skuCost.totalCost) || parseFloat(skuCost.cost) || 0;
                    
                    spec.linkedCost = true;
                    spec.cost = totalCost;
                    spec.linkedCostCode = spec.specCode;
                    
                    // 立即保存数据
                    savePricingData();
                    
                    // 使用延迟执行确保DOM更新完成
                    setTimeout(() => {
                        console.log('关联成本后重新渲染显示链接');
                        // 强制重新渲染显示链接
                        renderDisplayLinks();
                        
                        // 确保UI完全更新后再显示成功消息
                        setTimeout(() => {
                            showToast('成功', '已关联规格成本', 'success');
                        }, 50);
                    }, 50);
                    
                } catch (error) {
                    console.error('切换规格成本关联时出错:', error);
                    console.error('错误详情:', error.stack);
                    
                    // 即使出错也尝试重新渲染以保持UI一致性
                    try {
                        console.log('出错后尝试重新渲染显示链接');
                        renderDisplayLinks();
                    } catch (renderError) {
                        console.error('重新渲染时也出错:', renderError);
                    }
                    
                    // 显示更友好的错误消息
                    showToast('错误', '操作失败: ' + error.message, 'error');
                }
            }
            
            // 移除成本关联
            function removeCostLink(linkIndex, productIndex, specIndex) {
                try {
                    const link = pricingData.links[linkIndex];
                    const product = link.products[productIndex];
                    const spec = product.specs[specIndex];
                    
                    if (spec.linkedCost) {
                        spec.linkedCost = false;
                        spec.linkedCostCode = null;
                        savePricingData();
                    }
                } catch (error) {
                    console.error('移除成本关联时出错:', error);
                }
            }
            
            // 更新所有关联的成本
            function updateLinkedCosts() {
                try {
                    console.log('=== 更新所有关联的成本 ===');
                    
                    let updatedCount = 0;
                    
                    // 检查定价数据是否存在
                    if (!pricingData || !pricingData.links) {
                        console.warn('定价数据未加载，跳过关联成本更新');
                        return;
                    }
                    
                    pricingData.links.forEach(link => {
                        link.products.forEach(product => {
                            product.specs.forEach(spec => {
                                if (spec.linkedCost && spec.linkedCostCode) {
                                    const skuCost = skuCosts[spec.linkedCostCode];
                                    if (skuCost) {
                                        const newCost = parseFloat(skuCost.totalCost) || parseFloat(skuCost.cost) || 0;
                                        if (parseFloat(spec.cost) !== newCost) {
                                            console.log(`更新规格 ${spec.specCode} 成本: ${spec.cost} -> ${newCost}`);
                                            spec.cost = newCost;
                                            updatedCount++;
                                        }
                                    } else {
                                        console.warn(`规格编码 ${spec.linkedCostCode} 的成本信息不存在`);
                                    }
                                }
                            });
                        });
                    });
                    
                    if (updatedCount > 0) {
                        savePricingData();
                        console.log('保存更新后的定价数据');
                        
                        // 使用正确的渲染函数
                        setTimeout(() => {
                            renderDisplayLinks();
                            showToast('成功', `已更新${updatedCount}个关联成本`, 'success');
                        }, 50);
                    } else {
                        console.log('没有需要更新的关联成本');
                    }
                    
                    console.log(`更新完成，更新了${updatedCount}个成本`);
                    
                } catch (error) {
                    console.error('更新关联成本时出错:', error);
                    console.error('错误详情:', error.stack);
                    showToast('错误', '更新失败: ' + error.message, 'error');
                }
            }
            
            // 手动触发更新关联成本的函数
            function manualUpdateLinkedCosts() {
                console.log('=== 手动触发更新关联成本 ===');
                updateLinkedCosts();
            }
            
            // 移动模式状态
            let moveModeLinks = new Set(); // 存储当前处于移动模式的链接索引

            // 初始化定价工具
            function initPricingTool() {
                console.log('=== 初始化定价工具 ===');
                loadPricingData();
                updatePricingCategorySelects();
                
                // 检查并更新关联成本
                if (typeof skuCosts !== 'undefined') {
                    updateLinkedCosts();
                }
                
                console.log('=== 定价工具初始化完成 ===');
            }

            // 切换移动模式 - 安全版本
            function toggleMoveMode(linkIndex) {
                console.log(`切换移动模式: 链接${linkIndex}`);
                
                // 步骤1: 获取链接头部元素（更精确的选择器）
                const indexElement = document.querySelector(`.link-header[data-index="${linkIndex}"]`);
                if (!indexElement) {
                    console.error(`❌ 错误: 未找到.link-header[data-index="${linkIndex}"]元素`);
                    console.error(`   可能原因: 1. 链接索引不存在 2. 链接头部元素未找到 3. 选择器不匹配`);
                    
                    // 调试信息：查看所有包含data-index的元素
                    const allIndexElements = document.querySelectorAll(`[data-index="${linkIndex}"]`);
                    console.error(`   找到的所有[data-index="${linkIndex}"]元素:`, allIndexElements);
                    
                    return;
                }
                
                console.log(`✅ 找到链接头部元素:`, indexElement);
                
                // 步骤2: 获取链接卡片元素
                const linkCard = indexElement.parentElement;
                if (!linkCard) {
                    console.error(`❌ 错误: 未找到链接卡片元素`);
                    console.error(`   可能原因: 1. DOM结构已改变 2. 元素层级关系错误`);
                    console.error(`   当前indexElement:`, indexElement);
                    return;
                }
                
                console.log(`✅ 找到链接卡片元素:`, linkCard);
                
                // 步骤3: 获取移动按钮
                const moveBtn = document.getElementById(`move-btn-${linkIndex}`);
                if (!moveBtn) {
                    console.error(`❌ 错误: 未找到移动按钮 move-btn-${linkIndex}`);
                    console.error(`   可能原因: 1. 按钮ID生成错误 2. 按钮尚未渲染 3. 按钮已被移除`);
                    return;
                }
                
                console.log(`✅ 成功获取所有必需元素:`);
                console.log(`   - indexElement:`, indexElement);
                console.log(`   - linkCard:`, linkCard);
                console.log(`   - moveBtn:`, moveBtn);
                
                // 检查是否要进入移动模式
                const enteringMoveMode = !moveModeLinks.has(linkIndex);
                
                // 如果要进入移动模式，先退出其他所有移动模式
                if (enteringMoveMode && moveModeLinks.size > 0) {
                    console.log(`🔄 检测到其他链接处于移动模式，先退出这些模式`);
                    const otherMoveModes = Array.from(moveModeLinks).filter(idx => idx !== linkIndex);
                    
                    otherMoveModes.forEach(otherLinkIndex => {
                        console.log(`   退出链接${otherLinkIndex}的移动模式`);
                        // 递归调用toggleMoveMode来退出其他模式
                        toggleMoveMode(otherLinkIndex);
                    });
                }
                
                if (moveModeLinks.has(linkIndex)) {
                    // 退出移动模式
                    moveModeLinks.delete(linkIndex);
                    linkCard.classList.remove('move-mode-active');
                    moveBtn.innerHTML = '<i class="fa fa-arrows"></i> 移动';
                    moveBtn.classList.remove('bg-blue-600', 'text-white');
                    moveBtn.classList.add('btn-info');
                    
                    // 如果没有任何卡片处于移动模式，移除全局监听器
                    if (moveModeLinks.size === 0 && window._moveModeListenersAdded) {
                        document.removeEventListener('click', handleGlobalClickForMoveMode, true);
                        document.removeEventListener('visibilitychange', handleVisibilityChangeForMoveMode);
                        window.removeEventListener('blur', exitAllMoveModes);
                        window.removeEventListener('popstate', exitAllMoveModes);
                        window._moveModeListenersAdded = false;
                    }
                    
                    // 恢复其他按钮和交互
                    const linkHeader = document.querySelector(`[data-index="${linkIndex}"]`);
                    
                    // 恢复链接头部所有按钮
                    const headerButtons = linkHeader.querySelectorAll('button');
                    headerButtons.forEach(btn => {
                        btn.disabled = false;
                        btn.classList.remove('opacity-50', 'cursor-not-allowed');
                        btn.style.pointerEvents = '';
                        btn.style.userSelect = '';
                    });
                    
                    // 恢复商品卡片的所有交互
                    const productCards = linkCard.querySelectorAll('.product-card');
                    productCards.forEach(card => {
                        // 恢复卡片点击
                        card.style.pointerEvents = '';
                        card.style.userSelect = '';
                        
                        // 恢复卡片头部样式
                        const cardHeader = card.querySelector('.card-header');
                        if (cardHeader) {
                            cardHeader.style.pointerEvents = '';
                            cardHeader.style.cursor = '';
                        }
                        
                        // 恢复卡片内的所有按钮
                        const cardButtons = card.querySelectorAll('button');
                        cardButtons.forEach(btn => {
                            btn.disabled = false;
                            btn.classList.remove('opacity-50', 'cursor-not-allowed');
                            btn.style.pointerEvents = '';
                            btn.style.userSelect = '';
                        });
                        
                        // 恢复卡片内的所有链接
                        const cardLinks = card.querySelectorAll('a');
                        cardLinks.forEach(link => {
                            link.disabled = false;
                            link.classList.remove('opacity-50', 'cursor-not-allowed');
                            link.style.pointerEvents = '';
                            link.style.userSelect = '';
                        });
                    });
                    
                    // 禁用该链接内商品的拖拽
                    disableProductDragAndDrop(linkIndex);
                    
                    showToast('提示', '已退出移动编辑状态', 'info');
                } else {
                    // 进入移动模式
                    moveModeLinks.add(linkIndex);
                    linkCard.classList.add('move-mode-active');
                    moveBtn.innerHTML = '<i class="fa fa-check"></i> 完成';
                    moveBtn.classList.remove('btn-info');
                    moveBtn.classList.add('bg-blue-600', 'text-white');
                    
                    // 添加全局事件监听器来检测页面跳转或切换
                    if (!window._moveModeListenersAdded) {
                        // 监听页面跳转
                        document.addEventListener('click', handleGlobalClickForMoveMode, true);
                        
                        // 监听页面可见性变化
                        document.addEventListener('visibilitychange', handleVisibilityChangeForMoveMode);
                        
                        // 监听窗口失焦
                        window.addEventListener('blur', exitAllMoveModes);
                        
                        // 监听历史状态变化
                        window.addEventListener('popstate', exitAllMoveModes);
                        
                        window._moveModeListenersAdded = true;
                    }
                    
                    // 禁用其他按钮和交互
                    const linkHeader = document.querySelector(`[data-index="${linkIndex}"]`);
                    
                    // 禁用链接头部除移动按钮外的所有按钮
                    const headerButtons = linkHeader.querySelectorAll('button');
                    headerButtons.forEach(btn => {
                        if (btn.id !== `move-btn-${linkIndex}`) {
                            btn.disabled = true;
                            btn.classList.add('opacity-50', 'cursor-not-allowed');
                            // 添加更强的禁用样式
                            btn.style.pointerEvents = 'none';
                            btn.style.userSelect = 'none';
                        }
                    });
                    
                    // 禁用商品卡片的非拖拽交互
                    const productCards = linkCard.querySelectorAll('.product-card');
                    productCards.forEach(card => {
                        // 启用卡片的拖拽功能
                        card.style.pointerEvents = 'auto';
                        card.style.userSelect = 'none';
                        card.style.cursor = 'move';
                        
                        // 禁用卡片内的所有按钮
                        const cardButtons = card.querySelectorAll('button');
                        cardButtons.forEach(btn => {
                            btn.disabled = true;
                            btn.classList.add('opacity-50', 'cursor-not-allowed');
                            btn.style.pointerEvents = 'none';
                            btn.style.userSelect = 'none';
                        });
                        
                        // 禁用卡片内的所有链接
                        const cardLinks = card.querySelectorAll('a');
                        cardLinks.forEach(link => {
                            link.disabled = true;
                            link.classList.add('opacity-50', 'cursor-not-allowed');
                            link.style.pointerEvents = 'none';
                            link.style.userSelect = 'none';
                        });
                    });
                    
                    // 确保链接已展开
                    const content = document.querySelector(`[data-index="${linkIndex}"]`).nextElementSibling;
                    const icon = document.querySelector(`[data-index="${linkIndex}"] .link-toggle-icon`);
                    if (content.classList.contains('hidden')) {
                        content.classList.remove('hidden');
                        if (icon) {
                            icon.style.transform = 'rotate(180deg)';
                        }
                    }
                    
                    // 启用该链接内商品的拖拽
                    setTimeout(() => {
                        enableProductDragAndDrop(linkIndex);
                    }, 100);
                    
                    showToast('提示', '已进入移动编辑状态，可拖拽调整商品顺序', 'success');
                }
            }

            // 启用商品拖拽功能
            function enableProductDragAndDrop(linkIndex) {
                console.log(`启用商品拖拽: 链接${linkIndex}`);
                
                // 安全获取链接卡片
                const linkHeader = document.querySelector(`.link-header[data-index="${linkIndex}"]`);
                if (!linkHeader) {
                    console.error(`❌ 错误: 未找到链接头部元素 .link-header[data-index="${linkIndex}"]`);
                    return;
                }
                
                const linkCard = linkHeader.parentElement;
                if (!linkCard) {
                    console.error(`❌ 错误: 未找到链接卡片元素`);
                    return;
                }
                
                const productCards = linkCard.querySelectorAll('.product-card');
                console.log(`✅ 找到 ${productCards.length} 个商品卡片`);
                
                productCards.forEach(card => {
                    card.setAttribute('draggable', 'true');
                    card.classList.add('cursor-move');
                    
                    // 添加拖拽事件监听器
                    card.addEventListener('dragstart', handleDragStart);
                    card.addEventListener('dragend', handleDragEnd);
                    card.addEventListener('dragenter', handleDragEnter);
                    card.addEventListener('dragleave', handleDragLeave);
                    card.addEventListener('dragover', handleDragOver);
                    card.addEventListener('drop', handleDrop);
                });
                
                // 启用其他链接作为放置目标
                enableLinkDropTargets();
                
                // 启用自动滚动
                enableAutoScroll();
            }
            
            // 启用链接作为放置目标
            function enableLinkDropTargets() {
                console.log('启用链接作为放置目标');
                
                // 为所有链接标题栏添加放置事件
                document.querySelectorAll('.link-header').forEach(header => {
                    header.addEventListener('dragover', handleLinkHeaderDragOver);
                    header.addEventListener('dragenter', handleLinkHeaderDragEnter);
                    header.addEventListener('dragleave', handleLinkHeaderDragLeave);
                    header.addEventListener('drop', handleLinkHeaderDrop);
                });
                
                // 为所有链接内容区域添加放置事件
                document.querySelectorAll('.link-content').forEach(content => {
                    content.addEventListener('dragover', handleLinkDragOver);
                    content.addEventListener('dragenter', handleLinkDragEnter);
                    content.addEventListener('dragleave', handleLinkDragLeave);
                    content.addEventListener('drop', handleLinkDrop);
                });
                
                // 为所有商品列表容器添加放置事件
                document.querySelectorAll('.space-y-3').forEach(container => {
                    container.addEventListener('dragover', handleLinkDragOver);
                    container.addEventListener('dragenter', handleLinkDragEnter);
                    container.addEventListener('dragleave', handleLinkDragLeave);
                    container.addEventListener('drop', handleLinkDrop);
                });
            }
            
            // 禁用链接作为放置目标
            function disableLinkDropTargets() {
                console.log('禁用链接作为放置目标');
                
                // 移除所有链接标题栏的放置事件
                document.querySelectorAll('.link-header').forEach(header => {
                    header.removeEventListener('dragover', handleLinkHeaderDragOver);
                    header.removeEventListener('dragenter', handleLinkHeaderDragEnter);
                    header.removeEventListener('dragleave', handleLinkHeaderDragLeave);
                    header.removeEventListener('drop', handleLinkHeaderDrop);
                });
                
                // 移除所有链接内容区域的放置事件
                document.querySelectorAll('.link-content').forEach(content => {
                    content.removeEventListener('dragover', handleLinkDragOver);
                    content.removeEventListener('dragenter', handleLinkDragEnter);
                    content.removeEventListener('dragleave', handleLinkDragLeave);
                    content.removeEventListener('drop', handleLinkDrop);
                });
                
                // 移除所有商品列表容器的放置事件
                document.querySelectorAll('.space-y-3').forEach(container => {
                    container.removeEventListener('dragover', handleLinkDragOver);
                    container.removeEventListener('dragenter', handleLinkDragEnter);
                    container.removeEventListener('dragleave', handleLinkDragLeave);
                    container.removeEventListener('drop', handleLinkDrop);
                });
            }

            // 自动滚动相关变量
            let autoScrollInterval;
            const SCROLL_BOUNDARY_SIZE = 100; // 边界感应区域大小（像素）
            const SCROLL_SPEED = 5; // 滚动速度
            
            // 启用自动滚动
            function enableAutoScroll() {
                console.log('启用自动滚动功能');
                
                // 监听dragover事件来检测鼠标位置
                document.addEventListener('dragover', handleAutoScroll);
            }
            
            // 禁用自动滚动
            function disableAutoScroll() {
                console.log('禁用自动滚动功能');
                
                // 移除自动滚动事件监听器
                document.removeEventListener('dragover', handleAutoScroll);
                
                // 清除滚动定时器
                if (autoScrollInterval) {
                    clearInterval(autoScrollInterval);
                    autoScrollInterval = null;
                }
            }
            
            // 处理自动滚动
            function handleAutoScroll(event) {
                // 检查是否正在拖拽
                if (!document.querySelector('.dragging')) {
                    return;
                }
                
                const mouseY = event.clientY;
                const windowHeight = window.innerHeight;
                
                // 清除之前的滚动定时器
                if (autoScrollInterval) {
                    clearInterval(autoScrollInterval);
                    autoScrollInterval = null;
                }
                
                // 优先检查商品列表容器的滚动
                const scrollContainers = document.querySelectorAll('.space-y-3.max-h-\\[900px\\].overflow-y-auto');
                let containerScrolled = false;
                
                for (const container of scrollContainers) {
                    const rect = container.getBoundingClientRect();
                    
                    // 大幅扩大检测区域，使触发更容易
                    if (mouseY >= rect.top - 50 && mouseY <= rect.bottom + 50) {
                        // 计算鼠标在容器内的相对位置
                        const relativeY = mouseY - rect.top;
                        const containerHeight = rect.height;
                        
                        // 根据鼠标位置计算滚动速度和方向
                        let scrollSpeed = 0;
                        
                        // 上边缘滚动区域 - 大幅扩大区域并显著提高速度
                        if (relativeY < 150) {
                            // 距离上边缘越近，滚动速度越快
                            const distanceFactor = (150 - relativeY) / 150;
                            scrollSpeed = -Math.max(SCROLL_SPEED * 2, Math.floor(distanceFactor * SCROLL_SPEED * 8));
                            containerScrolled = true;
                        }
                        // 下边缘滚动区域 - 大幅扩大区域并显著提高速度
                        else if (relativeY > containerHeight - 150) {
                            // 距离下边缘越近，滚动速度越快
                            const distanceFactor = (relativeY - (containerHeight - 150)) / 150;
                            scrollSpeed = Math.max(SCROLL_SPEED * 2, Math.floor(distanceFactor * SCROLL_SPEED * 8));
                            containerScrolled = true;
                        }
                        
                        // 如果需要滚动，设置滚动定时器
                        if (scrollSpeed !== 0) {
                            console.log(`触发商品列表容器滚动，速度: ${scrollSpeed}`);
                            autoScrollInterval = setInterval(() => {
                                container.scrollTop += scrollSpeed;
                                
                                // 检查是否到达滚动边界
                                if ((scrollSpeed < 0 && container.scrollTop <= 0) || 
                                    (scrollSpeed > 0 && container.scrollTop >= container.scrollHeight - container.clientHeight)) {
                                    clearInterval(autoScrollInterval);
                                    autoScrollInterval = null;
                                }
                            }, 16);
                            break; // 只处理第一个匹配的容器
                        }
                    }
                }
                
                // 如果没有触发容器滚动，再检查页面级滚动
                if (!containerScrolled) {
                    // 检查上边界
                    if (mouseY < SCROLL_BOUNDARY_SIZE) {
                        console.log('触发上边界滚动');
                        autoScrollInterval = setInterval(() => {
                            window.scrollBy(0, -SCROLL_SPEED * 2);
                        }, 16); // 约60fps
                    }
                    // 检查下边界
                    else if (mouseY > windowHeight - SCROLL_BOUNDARY_SIZE) {
                        console.log('触发下边界滚动');
                        autoScrollInterval = setInterval(() => {
                            window.scrollBy(0, SCROLL_SPEED * 2);
                        }, 16); // 约60fps
                    }
                }
            }
            
            // 禁用商品拖拽功能
            function disableProductDragAndDrop(linkIndex) {
                console.log(`禁用商品拖拽: 链接${linkIndex}`);
                
                // 安全获取链接卡片
                const linkHeader = document.querySelector(`.link-header[data-index="${linkIndex}"]`);
                if (!linkHeader) {
                    console.error(`❌ 错误: 未找到链接头部元素 .link-header[data-index="${linkIndex}"]`);
                    return;
                }
                
                const linkCard = linkHeader.parentElement;
                if (!linkCard) {
                    console.error(`❌ 错误: 未找到链接卡片元素`);
                    return;
                }
                
                const productCards = linkCard.querySelectorAll('.product-card');
                console.log(`✅ 找到 ${productCards.length} 个商品卡片`);
                
                productCards.forEach(card => {
                    card.setAttribute('draggable', 'false');
                    card.classList.remove('cursor-move', 'dragging', 'drag-over', 'drag-between');
                    
                    // 移除拖拽事件监听器
                    card.removeEventListener('dragstart', handleDragStart);
                    card.removeEventListener('dragend', handleDragEnd);
                    card.removeEventListener('dragenter', handleDragEnter);
                    card.removeEventListener('dragleave', handleDragLeave);
                    card.removeEventListener('dragover', handleDragOver);
                    card.removeEventListener('drop', handleDrop);
                });
            }

            // 拖拽状态变量
            let draggedElement = null;
            let draggedLinkIndex = -1;
            let tempExpandedLinks = new Set();
            let draggedProductIndex = -1;
            let dragGhost = null;
            let placeholder = null;
            let autoScrollTimer = null;
            let autoScrollSpeed = 0;
            let dragStartScrollPosition = 0;
            let dragStartContainerScrollPosition = 0;

            // 全局点击处理器 - 检测页面跳转或其他操作
            function handleGlobalClickForMoveMode(e) {
                console.log('全局点击事件触发，目标:', e.target);
                
                // 强制检查拖拽状态，确保draggedElement已正确重置
                const isActuallyDragging = document.querySelector('.dragging');
                if (isActuallyDragging) {
                    console.log('检测到实际拖拽元素，忽略全局点击');
                    return;
                }
                
                // 安全检查：如果draggedElement变量未重置，但实际没有拖拽元素，强制重置
                if (draggedElement && !isActuallyDragging) {
                    console.log('发现draggedElement变量未正确重置，强制重置');
                    draggedElement = null;
                    draggedLinkIndex = -1;
                    draggedProductIndex = -1;
                }
                
                // 如果点击的是移动按钮，不处理（由专门的事件处理器处理）
                const moveButton = e.target.closest('.move-btn');
                if (moveButton) {
                    console.log('点击的是移动按钮，忽略全局处理');
                    return;
                }
                
                // 检查是否点击在当前移动模式卡片内的商品卡片上
                let isClickInsideProductCard = false;
                moveModeLinks.forEach(linkIndex => {
                    const linkCard = document.querySelector(`[data-index="${linkIndex}"]`).closest('.border-2.border-gray-200');
                    if (linkCard) {
                        const productCards = linkCard.querySelectorAll('.product-card, .product-card-hover');
                        productCards.forEach(card => {
                            if (card.contains(e.target)) {
                                isClickInsideProductCard = true;
                            }
                        });
                    }
                });
                
                // 如果点击在商品卡片上，允许继续操作（拖拽）
                if (isClickInsideProductCard) {
                    console.log('点击在商品卡片上，允许继续操作');
                    return;
                }
                
                // 检查是否点击在当前移动模式卡片内但不是商品卡片
                let isClickInsideMoveModeCard = false;
                moveModeLinks.forEach(linkIndex => {
                    const linkCard = document.querySelector(`[data-index="${linkIndex}"]`).closest('.border-2.border-gray-200');
                    if (linkCard && linkCard.contains(e.target)) {
                        isClickInsideMoveModeCard = true;
                    }
                });
                
                // 如果点击在移动模式卡片内但不是商品卡片，退出移动模式
                if (isClickInsideMoveModeCard) {
                    console.log('点击在移动模式卡片内但不是商品卡片，退出移动模式');
                    exitAllMoveModes();
                    return;
                }
                
                // 其他情况（点击页面其他区域）自动退出所有移动模式
                if (moveModeLinks.size > 0) {
                    console.log('点击页面其他区域，触发自动退出移动模式');
                    exitAllMoveModes();
                }
            }

            // 处理页面可见性变化
            function handleVisibilityChangeForMoveMode() {
                if (document.hidden && moveModeLinks.size > 0) {
                    exitAllMoveModes();
                }
            }

            // 退出所有移动编辑模式
            function exitAllMoveModes() {
                if (moveModeLinks.size === 0) return;
                
                // 复制当前的移动模式链接索引
                const linksToExit = Array.from(moveModeLinks);
                
                // 退出每个链接的移动模式
                linksToExit.forEach(linkIndex => {
                    toggleMoveMode(linkIndex);
                });
                
                // 禁用链接放置目标
                disableLinkDropTargets();
                
                showToast('提示', '已自动退出移动编辑状态', 'info');
            }
            
            // 自动滚动函数
            function startAutoScroll(speed) {
                // 清除现有的自动滚动
                if (autoScrollTimer) {
                    clearInterval(autoScrollTimer);
                }
                
                autoScrollSpeed = speed;
                
                if (speed !== 0) {
                    autoScrollTimer = setInterval(() => {
                        window.scrollBy(0, speed);
                    }, 16); // 约60fps
                }
            }
            
            // 停止自动滚动
            function stopAutoScroll() {
                if (autoScrollTimer) {
                    clearInterval(autoScrollTimer);
                    autoScrollTimer = null;
                    autoScrollSpeed = 0;
                }
            }
            
            // 处理鼠标移动时的自动滚动
            function handleMouseMoveForAutoScroll(e) {
                if (!draggedElement) return;
                
                const viewportHeight = window.innerHeight;
                const mouseY = e.clientY;
                const edgeThreshold = 100; // 边缘触发区域高度
                const maxSpeed = 10; // 最大滚动速度
                
                // 检测是否在视口边缘
                if (mouseY < edgeThreshold) {
                    // 顶部边缘 - 向上滚动
                    const speed = -Math.max(1, Math.floor((edgeThreshold - mouseY) / edgeThreshold * maxSpeed));
                    startAutoScroll(speed);
                } else if (mouseY > viewportHeight - edgeThreshold) {
                    // 底部边缘 - 向下滚动
                    const speed = Math.max(1, Math.floor((mouseY - (viewportHeight - edgeThreshold)) / edgeThreshold * maxSpeed));
                    startAutoScroll(speed);
                } else {
                    // 不在边缘 - 停止滚动
                    stopAutoScroll();
                }
            }
            
            // 防止重复移动的标志位
            let isMovingProduct = false;

            // 跨链接移动商品
            function moveProductAcrossLinks(sourceLinkIndex, sourceProductIndex, targetLinkIndex) {
                // 防止重复调用
                if (isMovingProduct) {
                    console.log('⚠️  移动操作已在进行中，忽略重复调用');
                    return;
                }
                
                isMovingProduct = true;
                console.log(`跨链接移动商品: 从链接${sourceLinkIndex}到链接${targetLinkIndex}`);
                
                try {
                    // 检查数据是否存在
                    if (!pricingData.links[sourceLinkIndex] || !pricingData.links[targetLinkIndex]) {
                        console.error('链接数据不存在');
                        showToast('错误', '链接数据不存在', 'error');
                        return;
                    }
                    
                    // 检查索引是否有效
                    if (sourceProductIndex < 0 || sourceProductIndex >= pricingData.links[sourceLinkIndex].products.length) {
                        console.error('源商品索引无效:', sourceProductIndex);
                        showToast('错误', '源商品位置无效', 'error');
                        return;
                    }
                    
                    // 获取移动前的商品列表
                    console.log('移动前源链接商品列表:', pricingData.links[sourceLinkIndex].products.map(p => p.productId));
                    console.log('移动前目标链接商品列表:', pricingData.links[targetLinkIndex].products.map(p => p.productId));
                    
                    // 获取源商品（深拷贝以避免引用问题）
                    const sourceProduct = JSON.parse(JSON.stringify(pricingData.links[sourceLinkIndex].products[sourceProductIndex]));
                    console.log('移动的商品:', sourceProduct.productId);
                    
                    // 从源链接移除商品
                    pricingData.links[sourceLinkIndex].products.splice(sourceProductIndex, 1);
                    
                    // 添加到目标链接
                    pricingData.links[targetLinkIndex].products.push(sourceProduct);
                    
                    // 获取移动后的商品列表
                    console.log('移动后源链接商品列表:', pricingData.links[sourceLinkIndex].products.map(p => p.productId));
                    console.log('移动后目标链接商品列表:', pricingData.links[targetLinkIndex].products.map(p => p.productId));
                    
                    // 保存数据
                    savePricingData();
                    console.log('数据已保存');
                    
                    // 为目标链接添加高亮动画效果
                    setTimeout(() => {
                        const targetLinkHeader = document.querySelector(`[data-index="${targetLinkIndex}"]`);
                        if (targetLinkHeader) {
                            // 先移除可能存在的旧样式
                            targetLinkHeader.classList.remove('animate-pulse', 'link-highlight', 'link-highlight-pulse');
                            targetLinkHeader.style.backgroundColor = '';
                            targetLinkHeader.style.borderColor = '';
                            targetLinkHeader.style.transform = '';
                            
                            // 强制重排
                            targetLinkHeader.offsetHeight;
                            
                            // 添加明显的高亮效果
                            targetLinkHeader.classList.add('link-highlight');
                            targetLinkHeader.style.backgroundColor = 'rgba(59, 130, 246, 0.4)';
                            targetLinkHeader.style.borderColor = 'rgba(59, 130, 246, 0.8)';
                            targetLinkHeader.style.transform = 'scale(1.02)';
                            targetLinkHeader.style.boxShadow = '0 4px 20px rgba(59, 130, 246, 0.3)';
                            targetLinkHeader.style.zIndex = '10';
                            
                            // 2秒后开始脉冲动画
                            setTimeout(() => {
                                targetLinkHeader.classList.remove('link-highlight');
                                targetLinkHeader.classList.add('link-highlight-pulse');
                                
                                // 5秒后完全恢复
                                setTimeout(() => {
                                    targetLinkHeader.classList.remove('link-highlight-pulse');
                                    targetLinkHeader.style.backgroundColor = '';
                                    targetLinkHeader.style.borderColor = '';
                                    targetLinkHeader.style.transform = 'scale(1)';
                                    targetLinkHeader.style.boxShadow = '';
                                    targetLinkHeader.style.zIndex = '';
                                }, 5000);
                            }, 2000);
                        }
                        
                        // 同时高亮整个链接卡片
                        const targetLinkCard = document.querySelector(`[data-index="${targetLinkIndex}"]`).closest('.border-2.border-gray-200');
                        if (targetLinkCard) {
                            targetLinkCard.classList.add('link-card-highlight');
                            targetLinkCard.style.boxShadow = '0 8px 30px rgba(59, 130, 246, 0.4)';
                            
                            setTimeout(() => {
                                targetLinkCard.classList.remove('link-card-highlight');
                                targetLinkCard.style.boxShadow = '';
                            }, 7000);
                        }
                    }, 100);
                    
                    // 保存所有链接的展开状态
                    const expandedStates = {};
                    document.querySelectorAll('.link-header').forEach(header => {
                        const index = header.getAttribute('data-index');
                        const isExpanded = !header.nextElementSibling.classList.contains('hidden');
                        expandedStates[index] = isExpanded;
                    });
                    console.log('保存的展开状态:', expandedStates);
                    
                    // 在重新渲染前，将展开状态信息传递给renderLinks函数
                    // 这样renderLinks可以在渲染时直接保持展开状态，避免闪烁
                    renderLinksWithExpandedStates(expandedStates);
                    console.log('链接已重新渲染并保持展开状态');
                    
                    // 强制恢复滚动位置 - 使用更激进的方式
                    const restoreScroll = () => {
                        console.log('强制恢复滚动位置:', dragStartScrollPosition, dragStartContainerScrollPosition);
                        
                        // 使用scrollTo的behavior: 'auto'来强制立即滚动
                        window.scrollTo({
                            top: dragStartScrollPosition,
                            behavior: 'auto'
                        });
                        
                        if (document.getElementById('links-container')) {
                            document.getElementById('links-container').scrollTop = dragStartContainerScrollPosition;
                        }
                        
                        // 临时禁用所有可能导致滚动的事件
                        document.body.style.touchAction = 'none';
                        document.body.style.userSelect = 'none';
                    };
                    
                    // 立即恢复
                    restoreScroll();
                    
                    // 多次尝试恢复，间隔更长，确保DOM完全更新后再恢复
                    setTimeout(restoreScroll, 50);
                    setTimeout(restoreScroll, 200);
                    setTimeout(restoreScroll, 500);
                    setTimeout(restoreScroll, 1000);
                    
                    // 2秒后恢复正常行为
                    setTimeout(() => {
                        document.body.style.overflow = '';
                        document.documentElement.style.overflow = '';
                        document.body.style.touchAction = '';
                        document.body.style.userSelect = '';
                    }, 2000);
                    
                    // 立即恢复移动模式状态和展开状态，不使用setTimeout
                    // 恢复源链接的移动模式状态
                    if (moveModeLinks.has(sourceLinkIndex)) {
                            const sourceLinkHeader = document.querySelector(`[data-index="${sourceLinkIndex}"]`);
                            const sourceLinkCard = sourceLinkHeader?.closest('.border-2.border-gray-200');
                            const sourceContent = sourceLinkHeader?.nextElementSibling;
                            const sourceIcon = sourceLinkHeader?.querySelector('.link-toggle-icon');
                            
                            // 保持卡片展开状态
                            if (sourceContent) {
                                sourceContent.classList.remove('hidden');
                            }
                            if (sourceIcon) {
                                sourceIcon.style.transform = 'rotate(180deg)';
                            }
                            
                            // 恢复移动模式样式
                            if (sourceLinkCard) {
                                sourceLinkCard.classList.add('move-mode-active');
                            }
                            
                            const sourceMoveBtn = document.getElementById(`move-btn-${sourceLinkIndex}`);
                            if (sourceMoveBtn) {
                                sourceMoveBtn.innerHTML = '<i class="fa fa-check"></i> 完成';
                                sourceMoveBtn.classList.remove('btn-info');
                                sourceMoveBtn.classList.add('bg-blue-600', 'text-white');
                            }
                            
                            // 禁用其他按钮和交互
                            if (sourceLinkHeader) {
                                const headerButtons = sourceLinkHeader.querySelectorAll('button');
                                headerButtons.forEach(btn => {
                                    if (btn.id !== `move-btn-${sourceLinkIndex}`) {
                                        btn.disabled = true;
                                        btn.classList.add('opacity-50', 'cursor-not-allowed');
                                        btn.style.pointerEvents = 'none';
                                        btn.style.userSelect = 'none';
                                    }
                                });
                            }
                            
                            // 禁用商品卡片的非拖拽交互
                            if (sourceLinkCard) {
                                const productCards = sourceLinkCard.querySelectorAll('.product-card');
                                productCards.forEach(card => {
                                    // 启用卡片的拖拽功能
                                    card.style.pointerEvents = 'auto';
                                    card.style.userSelect = 'none';
                                    card.style.cursor = 'move';
                                    
                                    // 禁用卡片内的所有按钮
                                    const cardButtons = card.querySelectorAll('button');
                                    cardButtons.forEach(btn => {
                                        btn.disabled = true;
                                        btn.classList.add('opacity-50', 'cursor-not-allowed');
                                        btn.style.pointerEvents = 'none';
                                        btn.style.userSelect = 'none';
                                    });
                                    
                                    // 禁用卡片内的所有链接
                                    const cardLinks = card.querySelectorAll('a');
                                    cardLinks.forEach(link => {
                                        link.disabled = true;
                                        link.classList.add('opacity-50', 'cursor-not-allowed');
                                        link.style.pointerEvents = 'none';
                                        link.style.userSelect = 'none';
                                    });
                                });
                            }
                            
                            enableProductDragAndDrop(sourceLinkIndex);
                        }
                        
                        // 展开状态已在renderLinksWithExpandedStates中处理，无需额外恢复
                        
                        console.log('移动模式状态已恢复');
                    
                    showToast('成功', '商品已成功移动到新链接', 'success');
                    
                } catch (error) {
                    console.error('跨链接移动商品失败:', error);
                    showToast('错误', '商品移动失败: ' + error.message, 'error');
                } finally {
                    // 确保在操作完成后重置标志位
                    setTimeout(() => {
                        isMovingProduct = false;
                    }, 100);
                }
            }

            // 拖拽开始
            function handleDragStart(e) {
                const card = this;
                const linkIndex = parseInt(card.dataset.linkIndex);
                const productIndex = parseInt(card.dataset.productIndex);
                
                // 检查是否在移动模式下
                if (!moveModeLinks.has(linkIndex)) {
                    e.preventDefault();
                    return;
                }
                
                console.log(`拖拽开始: 链接${linkIndex}的商品${productIndex}`);
                
                // 在拖拽开始时就保存滚动位置
                dragStartScrollPosition = window.scrollY;
                dragStartContainerScrollPosition = document.getElementById('links-container')?.scrollTop || 0;
                console.log('拖拽开始时保存的滚动位置:', dragStartScrollPosition, dragStartContainerScrollPosition);
                
                draggedElement = card;
                draggedLinkIndex = linkIndex;
                draggedProductIndex = productIndex;
                
                // 添加拖拽中的样式
                card.classList.add('dragging');
                
                // 创建拖拽时的占位元素
                dragGhost = document.createElement('div');
                dragGhost.className = 'drag-ghost';
                dragGhost.style.height = card.offsetHeight + 'px';
                dragGhost.innerHTML = '<div class="flex items-center justify-center text-blue-500"><i class="fa fa-cube mr-2"></i> 拖动中...</div>';
                
                // 创建放置位置的占位框
                placeholder = document.createElement('div');
                placeholder.className = 'bg-blue-100 border-2 border-dashed border-blue-500 rounded-md p-3 mb-3 transition-all duration-200 cursor-pointer';
                placeholder.style.height = card.offsetHeight + 'px';
                placeholder.innerHTML = '<div class="flex items-center justify-center text-blue-600 font-medium"><i class="fa fa-long-arrow-right mr-2"></i> 放置于此</div>';
                placeholder.draggable = false; // 确保占位框不可拖拽
                
                // 设置拖拽数据
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', `${linkIndex},${productIndex}`);
                
                // 设置拖拽图像
                e.dataTransfer.setDragImage(card, 50, 25);
                
                // 添加鼠标移动事件监听器用于自动滚动
                document.addEventListener('mousemove', handleMouseMoveForAutoScroll);
                
                // 延迟显示占位符
                setTimeout(() => {
                    if (card.parentNode) {
                        card.parentNode.insertBefore(dragGhost, card);
                    }
                }, 0);
            }

            // 占位框拖拽悬停处理
            function handlePlaceholderDragOver(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                // 高亮占位框
                this.classList.add('bg-blue-200');
            }

            // 占位框拖拽放置处理
            function handlePlaceholderDrop(e) {
                e.preventDefault();
                console.log('=== 占位框放置事件 ===');
                
                // 移除占位框高亮
                this.classList.remove('bg-blue-200');
                
                if (draggedElement && draggedLinkIndex !== -1 && draggedProductIndex !== -1) {
                    // 获取占位框在容器中的位置
                    const container = this.parentNode;
                    const allElements = Array.from(container.children);
                    const placeholderIndex = allElements.indexOf(this);
                    
                    // 计算实际的目标产品索引（排除占位框和拖拽占位元素）
                    let targetProductIndex = 0;
                    for (let i = 0; i < placeholderIndex; i++) {
                        if (allElements[i] !== dragGhost && allElements[i] !== placeholder && allElements[i].classList.contains('product-card')) {
                            targetProductIndex++;
                        }
                    }
                    
                    console.log('占位框位置:', placeholderIndex);
                    console.log('计算的目标产品索引:', targetProductIndex);
                    
                    // 执行商品移动
                    moveProductWithinLink(draggedLinkIndex, draggedProductIndex, targetProductIndex);
                }
            }

            // 拖拽结束
            function handleDragEnd(e) {
                if (!draggedElement) return;
                
                console.log('拖拽结束');
                
                // 移除拖拽中的样式
                draggedElement.classList.remove('dragging');
                
                // 移除占位元素
                if (dragGhost && dragGhost.parentNode) {
                    dragGhost.parentNode.removeChild(dragGhost);
                }
                
                // 移除放置位置占位框
                if (placeholder && placeholder.parentNode) {
                    // 移除占位框的事件监听器
                    placeholder.removeEventListener('dragover', handlePlaceholderDragOver);
                    placeholder.removeEventListener('drop', handlePlaceholderDrop);
                    placeholder.parentNode.removeChild(placeholder);
                }
                
                // 禁用自动滚动
                disableAutoScroll();
                
                // 清理所有拖拽相关的样式
                document.querySelectorAll('.product-card.drag-over, .product-card.drag-between').forEach(el => {
                    el.classList.remove('drag-over', 'drag-between');
                });
                
                // 清理链接的拖拽样式
                document.querySelectorAll('.link-content.drag-over, .link-header.drag-over').forEach(el => {
                    el.classList.remove('drag-over');
                });
                
                // 移除鼠标移动事件监听器
                document.removeEventListener('mousemove', handleMouseMoveForAutoScroll);
                
                // 停止自动滚动
                stopAutoScroll();
                
                // 恢复临时展开的链接（如果没有实际放置商品）
                if (tempExpandedLinks.size > 0) {
                    tempExpandedLinks.forEach(linkIndex => {
                        const header = document.querySelector(`[data-index="${linkIndex}"]`);
                        if (header) {
                            const content = header.nextElementSibling;
                            if (content && !content.classList.contains('hidden')) {
                                content.classList.add('hidden');
                                const icon = header.querySelector('.link-toggle-icon');
                                if (icon) {
                                    icon.style.transform = 'rotate(0deg)';
                                }
                            }
                        }
                    });
                    tempExpandedLinks.clear();
                }
                
                // 重置变量
                draggedElement = null;
                draggedLinkIndex = -1;
                draggedProductIndex = -1;
                dragGhost = null;
                placeholder = null;
            }

            // 拖拽进入
            function handleDragEnter(e) {
                e.preventDefault();
                const card = this;
                
                // 检查是否在同一个链接内
                if (card !== draggedElement && parseInt(card.dataset.linkIndex) === draggedLinkIndex) {
                    card.classList.add('drag-over');
                }
            }

            // 拖拽离开
            function handleDragLeave(e) {
                e.preventDefault();
                const card = this;
                
                // 检查是否真的离开了元素
                if (!card.contains(e.relatedTarget)) {
                    card.classList.remove('drag-over', 'drag-between');
                }
            }

            // 拖拽悬停
            function handleDragOver(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                
                const card = this;
                
                // 检查是否在同一个链接内
                if (card !== draggedElement && parseInt(card.dataset.linkIndex) === draggedLinkIndex) {
                    // 计算鼠标位置，决定是放在上方还是下方
                    const rect = card.getBoundingClientRect();
                    const y = e.clientY - rect.top;
                    
                    // 移除所有卡片的高亮
                    document.querySelectorAll('.product-card').forEach(c => {
                        c.classList.remove('drag-over', 'drag-between');
                    });
                    
                    // 移除现有的占位框
                    if (placeholder && placeholder.parentNode) {
                        placeholder.parentNode.removeChild(placeholder);
                    }
                    
                    if (y < rect.height / 2) {
                        // 放在卡片上方
                        card.classList.add('drag-between');
                        // 插入占位框到卡片上方
                        if (card.parentNode) {
                            card.parentNode.insertBefore(placeholder, card);
                            // 为占位框添加拖拽事件
                            placeholder.addEventListener('dragover', handlePlaceholderDragOver);
                            placeholder.addEventListener('drop', handlePlaceholderDrop);
                        }
                    } else {
                        // 放在卡片下方
                        card.classList.add('drag-over');
                        // 插入占位框到卡片下方
                        if (card.parentNode && card.nextSibling) {
                            card.parentNode.insertBefore(placeholder, card.nextSibling);
                            // 为占位框添加拖拽事件
                            placeholder.addEventListener('dragover', handlePlaceholderDragOver);
                            placeholder.addEventListener('drop', handlePlaceholderDrop);
                        } else if (card.parentNode) {
                            card.parentNode.appendChild(placeholder);
                            // 为占位框添加拖拽事件
                            placeholder.addEventListener('dragover', handlePlaceholderDragOver);
                            placeholder.addEventListener('drop', handlePlaceholderDrop);
                        }
                    }
                }
                
                // 处理自动滚动
                handleMouseMoveForAutoScroll(e);
            }

            // 拖拽放置
            function handleDrop(e) {
                e.preventDefault();
                const card = this;
                
                console.log('=== 拖拽放置事件 ===');
                console.log('拖拽元素:', draggedElement ? draggedElement.dataset.productIndex : 'null');
                console.log('目标元素:', card.dataset.productIndex);
                
                // 检查是否在同一个链接内
                if (card !== draggedElement && parseInt(card.dataset.linkIndex) === draggedLinkIndex) {
                    const targetProductIndex = parseInt(card.dataset.productIndex);
                    const sourceProductIndex = parseInt(draggedElement.dataset.productIndex);
                    
                    console.log('源索引:', sourceProductIndex);
                    console.log('目标索引:', targetProductIndex);
                    
                    // 计算放置位置
                    const rect = card.getBoundingClientRect();
                    const y = e.clientY - rect.top;
                    let actualTargetIndex = targetProductIndex;
                    
                    if (y < rect.height / 2) {
                        // 放在卡片上方
                        actualTargetIndex = targetProductIndex;
                        console.log('放置在卡片上方');
                    } else {
                        // 放在卡片下方
                        actualTargetIndex = targetProductIndex + 1;
                        console.log('放置在卡片下方');
                    }
                    
                    console.log('实际目标索引:', actualTargetIndex);
                    
                    // 执行商品移动
                    moveProductWithinLink(draggedLinkIndex, sourceProductIndex, actualTargetIndex);
                } else {
                    console.log('不在同一链接内或拖拽自身');
                }
                
                // 清理样式
                card.classList.remove('drag-over', 'drag-between');
            }
            
            // 链接拖拽悬停处理
            function handleLinkDragOver(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                
                const content = this;
                const linkHeader = content.closest('.border-2.border-gray-200').querySelector('.link-header');
                const linkIndex = parseInt(linkHeader.getAttribute('data-index'));
                
                // 不允许放置到源链接
                if (linkIndex === draggedLinkIndex) {
                    return;
                }
                
                // 确保链接已展开
                if (content.classList.contains('hidden')) {
                    content.classList.remove('hidden');
                    const icon = linkHeader.querySelector('.link-toggle-icon');
                    if (icon) {
                        icon.style.transform = 'rotate(180deg)';
                    }
                }
                
                // 添加高亮样式
                content.classList.add('drag-over');
                
                // 处理自动滚动
                handleMouseMoveForAutoScroll(e);
            }
            
            // 链接拖拽进入处理
            function handleLinkDragEnter(e) {
                e.preventDefault();
                
                const content = this;
                const linkHeader = content.closest('.border-2.border-gray-200').querySelector('.link-header');
                const linkIndex = parseInt(linkHeader.getAttribute('data-index'));
                
                // 不允许放置到源链接
                if (linkIndex === draggedLinkIndex) {
                    return;
                }
                
                // 确保链接已展开
                if (content.classList.contains('hidden')) {
                    content.classList.remove('hidden');
                    const icon = linkHeader.querySelector('.link-toggle-icon');
                    if (icon) {
                        icon.style.transform = 'rotate(180deg)';
                    }
                }
                
                // 添加高亮样式
                content.classList.add('drag-over');
            }
            
            // 链接拖拽离开处理
            function handleLinkDragLeave(e) {
                e.preventDefault();
                
                const content = this;
                const relatedTarget = e.relatedTarget;
                
                // 检查是否真的离开了链接内容区域
                if (!content.contains(relatedTarget)) {
                    content.classList.remove('drag-over');
                }
            }
            
            // 链接拖拽放置处理
            function handleLinkDrop(e) {
                e.preventDefault();
                
                const content = this;
                const linkCard = content.closest('.border-2.border-gray-200');
                const linkHeader = linkCard.querySelector('.link-header');
                const linkIndex = parseInt(linkHeader.getAttribute('data-index'));
                
                console.log('=== 链接拖拽放置事件 ===');
                console.log('源链接索引:', draggedLinkIndex);
                console.log('目标链接索引:', linkIndex);
                
                // 不允许放置到源链接
                if (linkIndex === draggedLinkIndex) {
                    console.log('不能放置到源链接');
                    return;
                }
                
                // 获取源商品信息
                const sourceProductIndex = parseInt(draggedElement.dataset.productIndex);
                
                // 检查数据是否存在
                if (!pricingData.links[draggedLinkIndex] || 
                    !pricingData.links[draggedLinkIndex].products || 
                    sourceProductIndex < 0 || 
                    sourceProductIndex >= pricingData.links[draggedLinkIndex].products.length) {
                    console.error('源商品数据不存在或索引无效');
                    showToast('错误', '源商品数据不存在', 'error');
                    return;
                }
                
                const sourceProduct = pricingData.links[draggedLinkIndex].products[sourceProductIndex];
                
                console.log('移动的商品:', sourceProduct.productId);
                
                // 执行跨链接移动
                moveProductAcrossLinks(draggedLinkIndex, sourceProductIndex, linkIndex);
                
                // 清理样式
                content.classList.remove('drag-over');
            }
            
            // 链接标题栏拖拽悬停处理
            function handleLinkHeaderDragOver(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                
                const header = this;
                const linkIndex = parseInt(header.getAttribute('data-index'));
                
                // 不允许放置到源链接
                if (linkIndex === draggedLinkIndex) {
                    return;
                }
                
                // 添加高亮样式
                header.classList.add('drag-over');
                
                // 添加明显的动画效果
                header.style.transform = 'scale(1.03)';
                header.style.transition = 'all 0.15s ease-out';
                header.style.backgroundColor = 'rgba(59, 130, 246, 0.4)';
                header.style.borderColor = 'rgba(59, 130, 246, 0.8)';
                header.style.boxShadow = '0 4px 20px rgba(59, 130, 246, 0.3)';
                header.style.zIndex = '10';
                
                // 获取内容元素并记录临时展开的链接
                const content = header.nextElementSibling;
                if (content && content.classList.contains('hidden')) {
                    tempExpandedLinks.add(linkIndex);
                }
                
                // 处理自动滚动
                handleMouseMoveForAutoScroll(e);
            }
            
            // 链接标题栏拖拽进入处理
            function handleLinkHeaderDragEnter(e) {
                e.preventDefault();
                
                const header = this;
                const linkIndex = parseInt(header.getAttribute('data-index'));
                
                // 不允许放置到源链接
                if (linkIndex === draggedLinkIndex) {
                    return;
                }
                
                // 添加高亮样式
                header.classList.add('drag-over');
            }
            
            // 链接标题栏拖拽离开处理
            function handleLinkHeaderDragLeave(e) {
                e.preventDefault();
                
                const header = this;
                const relatedTarget = e.relatedTarget;
                
                // 检查是否真的离开了标题栏区域
                if (!header.contains(relatedTarget)) {
                    header.classList.remove('drag-over');
                    
                    // 移除所有添加的样式
                    header.style.transform = 'scale(1)';
                    header.style.backgroundColor = '';
                    header.style.borderColor = '';
                    header.style.boxShadow = '';
                    header.style.zIndex = '';
                    header.style.transition = 'all 0.2s ease';
                }
            }
            
            // 链接标题栏拖拽放置处理
            function handleLinkHeaderDrop(e) {
                e.preventDefault();
                
                const header = this;
                const linkIndex = parseInt(header.getAttribute('data-index'));
                const content = header.nextElementSibling;
                
                console.log('=== 链接标题栏拖拽放置事件 ===');
                console.log('源链接索引:', draggedLinkIndex);
                console.log('目标链接索引:', linkIndex);
                
                // 不允许放置到源链接
                if (linkIndex === draggedLinkIndex) {
                    console.log('不能放置到源链接');
                    return;
                }
                
                // 获取源商品信息
                const sourceProductIndex = parseInt(draggedElement.dataset.productIndex);
                const sourceProduct = pricingData.links[draggedLinkIndex].products[sourceProductIndex];
                
                console.log('移动的商品:', sourceProduct.productId);
                
                // 展开目标链接（如果已收起）
                if (content.classList.contains('hidden')) {
                    content.classList.remove('hidden');
                    const icon = header.querySelector('.link-toggle-icon');
                    if (icon) {
                        icon.style.transform = 'rotate(180deg)';
                    }
                }
                
                // 执行跨链接移动
                moveProductAcrossLinks(draggedLinkIndex, sourceProductIndex, linkIndex);
                
                // 清理样式
                header.classList.remove('drag-over');
            }

            // 在同一链接内移动商品
            function moveProductWithinLink(linkIndex, sourceProductIndex, targetProductIndex) {
                console.log(`移动商品: 链接${linkIndex}内从位置${sourceProductIndex}到${targetProductIndex}`);
                
                try {
                    // 检查数据是否存在
                    if (!pricingData.links[linkIndex] || !pricingData.links[linkIndex].products) {
                        console.error('链接数据不存在');
                        showToast('错误', '链接数据不存在', 'error');
                        return;
                    }
                    
                    // 检查索引是否有效
                    if (sourceProductIndex < 0 || sourceProductIndex >= pricingData.links[linkIndex].products.length) {
                        console.error('源索引无效:', sourceProductIndex);
                        showToast('错误', '源位置无效', 'error');
                        return;
                    }
                    
                    if (targetProductIndex < 0 || targetProductIndex > pricingData.links[linkIndex].products.length) {
                        console.error('目标索引无效:', targetProductIndex);
                        showToast('错误', '目标位置无效', 'error');
                        return;
                    }
                    
                    // 获取移动前的商品列表
                    console.log('移动前商品列表:', pricingData.links[linkIndex].products.map(p => p.productId));
                    
                    // 获取源商品
                    const sourceProduct = pricingData.links[linkIndex].products[sourceProductIndex];
                    console.log('移动的商品:', sourceProduct.productId);
                    
                    // 从源位置移除商品
                    pricingData.links[linkIndex].products.splice(sourceProductIndex, 1);
                    
                    // 调整目标索引
                    let adjustedTargetIndex = targetProductIndex;
                    if (sourceProductIndex < targetProductIndex) {
                        adjustedTargetIndex--;
                    }
                    console.log('调整后的目标索引:', adjustedTargetIndex);
                    
                    // 确保目标索引在有效范围内
                    adjustedTargetIndex = Math.max(0, Math.min(adjustedTargetIndex, pricingData.links[linkIndex].products.length));
                    
                    // 添加到目标位置
                    pricingData.links[linkIndex].products.splice(adjustedTargetIndex, 0, sourceProduct);
                    
                    // 获取移动后的商品列表
                    console.log('移动后商品列表:', pricingData.links[linkIndex].products.map(p => p.productId));
                    
                    // 保存数据
                    savePricingData();
                    console.log('数据已保存');
                    
                    // 使用拖拽开始时保存的滚动位置
                    console.log('使用拖拽开始时保存的滚动位置:', dragStartScrollPosition, dragStartContainerScrollPosition);
                    
                    // 禁用浏览器默认的滚动行为
                    document.body.style.overflow = 'hidden';
                    document.documentElement.style.overflow = 'hidden';
                    
                    // 立即恢复滚动位置，不等待渲染
                    window.scrollTo(0, dragStartScrollPosition);
                    if (document.getElementById('links-container')) {
                        document.getElementById('links-container').scrollTop = dragStartContainerScrollPosition;
                    }
                    
                    // 重新渲染所有链接
                    renderLinks();
                    console.log('链接已重新渲染');
                    
                    // 强制恢复滚动位置 - 使用更激进的方式
                    const restoreScroll = () => {
                        console.log('强制恢复滚动位置:', dragStartScrollPosition, dragStartContainerScrollPosition);
                        
                        // 使用scrollTo的behavior: 'auto'来强制立即滚动
                        window.scrollTo({
                            top: dragStartScrollPosition,
                            behavior: 'auto'
                        });
                        
                        if (document.getElementById('links-container')) {
                            document.getElementById('links-container').scrollTop = dragStartContainerScrollPosition;
                        }
                        
                        // 临时禁用所有可能导致滚动的事件
                        document.body.style.touchAction = 'none';
                        document.body.style.userSelect = 'none';
                    };
                    
                    // 立即恢复
                    restoreScroll();
                    
                    // 多次尝试恢复，间隔更长，确保DOM完全更新后再恢复
                    setTimeout(restoreScroll, 50);
                    setTimeout(restoreScroll, 200);
                    setTimeout(restoreScroll, 500);
                    setTimeout(restoreScroll, 1000);
                    
                    // 2秒后恢复正常行为
                    setTimeout(() => {
                        document.body.style.overflow = '';
                        document.documentElement.style.overflow = '';
                        document.body.style.touchAction = '';
                        document.body.style.userSelect = '';
                    }, 2000);
                    
                    // 立即恢复移动模式状态和展开状态，不使用setTimeout
                    if (moveModeLinks.has(linkIndex)) {
                        console.log(`恢复移动模式状态: 链接${linkIndex}`);
                        
                        // 安全获取链接头部元素
                            const linkHeader = document.querySelector(`.link-header[data-index="${linkIndex}"]`);
                            if (!linkHeader) {
                                console.error(`❌ 错误: 未找到链接头部元素 .link-header[data-index="${linkIndex}"]`);
                                return;
                            }
                            
                            console.log(`✅ 找到链接头部元素:`, linkHeader);
                            
                            // 安全获取链接卡片
                            const linkCard = linkHeader.parentElement;
                            if (!linkCard) {
                                console.error(`❌ 错误: 未找到链接卡片元素`);
                                return;
                            }
                            
                            console.log(`✅ 找到链接卡片元素:`, linkCard);
                            
                            // 安全获取内容元素和图标
                            const content = linkHeader.nextElementSibling;
                            const icon = linkHeader.querySelector('.link-toggle-icon');
                            
                            // 保持卡片展开状态
                            if (content) {
                                content.classList.remove('hidden');
                                console.log('✅ 卡片内容已展开');
                            }
                            
                            if (icon) {
                                icon.style.transform = 'rotate(180deg)';
                                console.log('✅ 图标已旋转');
                            }
                            
                            // 恢复移动模式样式
                            linkCard.classList.add('move-mode-active');
                            console.log('✅ 移动模式样式已恢复');
                            
                            // 恢复移动按钮状态
                            const moveBtn = document.getElementById(`move-btn-${linkIndex}`);
                            if (moveBtn) {
                                moveBtn.innerHTML = '<i class="fa fa-check"></i> 完成';
                                moveBtn.classList.remove('btn-info');
                                moveBtn.classList.add('bg-blue-600', 'text-white');
                                console.log('✅ 移动按钮状态已恢复');
                            }
                            
                            // 禁用其他按钮和交互
                            
                            // 禁用链接头部除移动按钮外的所有按钮
                            const headerButtons = linkHeader.querySelectorAll('button');
                            console.log(`✅ 找到 ${headerButtons.length} 个头部按钮`);
                            
                            headerButtons.forEach(btn => {
                                if (btn.id !== `move-btn-${linkIndex}`) {
                                    btn.disabled = true;
                                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                                    btn.style.pointerEvents = 'none';
                                    btn.style.userSelect = 'none';
                                }
                            });
                            
                            // 禁用商品卡片的非拖拽交互
                            const productCards = linkCard.querySelectorAll('.product-card');
                            console.log(`✅ 找到 ${productCards.length} 个商品卡片`);
                            
                            productCards.forEach(card => {
                                // 启用卡片的拖拽功能
                                card.style.pointerEvents = 'auto';
                                card.style.userSelect = 'none';
                                card.style.cursor = 'move';
                                
                                // 禁用卡片内的所有按钮
                                const cardButtons = card.querySelectorAll('button');
                                cardButtons.forEach(btn => {
                                    btn.disabled = true;
                                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                                    btn.style.pointerEvents = 'none';
                                    btn.style.userSelect = 'none';
                                });
                                
                                // 禁用卡片内的所有链接
                                const cardLinks = card.querySelectorAll('a');
                                cardLinks.forEach(link => {
                                    link.disabled = true;
                                    link.classList.add('opacity-50', 'cursor-not-allowed');
                                    link.style.pointerEvents = 'none';
                                    link.style.userSelect = 'none';
                                });
                            });
                            
                            enableProductDragAndDrop(linkIndex);
                            console.log('✅ 移动模式状态已完全恢复，卡片保持展开，其他交互已禁用');
                        }
                    
                    showToast('成功', '商品顺序调整成功', 'success');
                    
                } catch (error) {
                    console.error('移动商品失败:', error);
                    showToast('错误', '商品移动失败: ' + error.message, 'error');
                }
            }
            
            // 渲染链接管理
            // 带展开状态的链接渲染函数
            function renderLinksWithExpandedStates(expandedStates) {
                // 保存当前滚动位置
                const scrollPosition = window.scrollY;
                const containerScrollPosition = document.getElementById('links-container')?.scrollTop || 0;
                
                const container = document.getElementById('links-container');
                const empty = document.getElementById('links-empty');
                
                if (pricingData.links.length === 0) {
                    container.classList.add('hidden');
                    empty.classList.remove('hidden');
                    return;
                }
                
                container.classList.remove('hidden');
                empty.classList.add('hidden');
                
                // 获取所有店铺数据
                const shops = JSON.parse(localStorage.getItem('shops')) || [];
                const shopsMap = {};
                shops.forEach(shop => {
                    shopsMap[shop.id] = shop.name;
                });
                
                // 生成完整的HTML内容，确保结构正确
                let html = '';
                pricingData.links.forEach((link, index) => {
                    const isExpanded = expandedStates && expandedStates[index] === true;
                    const contentClass = isExpanded ? '' : 'hidden';
                    const iconTransform = isExpanded ? 'rotate(180deg)' : 'rotate(0deg)';
                    
                    html += `
                    <div class="border-2 border-gray-200 rounded-xl overflow-hidden shadow-md hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1 mb-6 bg-white">
                        <div class="bg-gradient-to-r from-blue-700/20 to-blue-600/10 px-4 py-3 flex justify-between items-center cursor-pointer link-header border-b border-blue-500/30" data-index="${index}">
                            <div class="flex items-center space-x-4">
                                <div class="flex items-center">
                                    <i class="fa fa-chevron-down mr-2 text-gray-500 transition-transform duration-150 link-toggle-icon" style="transform: ${iconTransform}"></i>
                                    <span class="font-medium">${link.name || '未命名链接'}</span>
                                    <span class="ml-2 badge badge-shop">${link.category || '未分类'}</span>
                                    ${link.shopId && shopsMap[link.shopId] ? `<span class="ml-2 inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-gradient-to-r from-primary to-blue-500 text-white shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105">
${shopsMap[link.shopId]}
                                    </span>` : ''}
                                </div>
                                <div class="flex items-center space-x-2">
                                    <i class="fa fa-cubes text-primary"></i>
                                    <span class="text-sm font-semibold text-primary">${link.products ? link.products.length : 0} 个商品</span>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button class="btn btn-secondary text-sm" onclick="viewLinkDetails(${index}); event.stopPropagation();">
                                    <i class="fa fa-eye"></i> 查看详情
                                </button>
                                <button class="btn btn-info text-sm move-btn" onclick="handleMoveButtonClick(${index}, event);" id="move-btn-${index}">
                                    <i class="fa fa-arrows"></i> 移动
                                </button>
                                <button class="btn btn-primary text-sm" onclick="editLink(${index}); event.stopPropagation();">
                                    <i class="fa fa-edit"></i> 编辑
                                </button>
                                <button class="btn btn-danger text-sm" onclick="deleteLink(${index}); event.stopPropagation();">
                                    <i class="fa fa-trash"></i> 删除
                                </button>
                            </div>
                        </div>
                        <div class="link-content px-4 py-3 ${contentClass}">
                            <div class="mb-4">
                                <div class="flex items-start justify-between">
                                    <div class="flex-1">
                                        ${link.note ? `
                                        <label class="block text-sm font-medium text-gray-700 mb-1">备注</label>
                                        <div class="text-sm text-gray-900">${link.note}</div>
                                        ` : ''}
                                    </div>
                                    ${link.note ? `
                                    <div class="flex items-center space-x-2 ml-4 whitespace-nowrap">
                                        <i class="fa fa-cubes text-primary"></i>
                                        <span class="text-sm font-semibold text-primary">${link.products ? link.products.length : 0} 个商品</span>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                            <div class="mb-4">
                                <div class="flex justify-between items-center mb-2">
                                    <label class="block text-md font-bold text-gray-900">商品列表</label>
                                    <button class="btn btn-primary text-sm" onclick="addProductToLink(${index})">
                                        <i class="fa fa-plus"></i> 添加商品
                                    </button>
                                </div>
                                <div class="space-y-3 max-h-[900px] overflow-y-auto pr-2">
                                    ${link.products && link.products.length > 0 ? link.products.map((product, productIndex) => `
                                        <div class="border border-gray-200 rounded-md p-3 product-card-hover cursor-pointer product-card" 
                                             data-link-index="${index}"
                                             data-product-index="${productIndex}"
                                             onclick="handleProductCardClick(event, ${index}, ${productIndex})"
                                             data-marked="${product.marked || false}">
                                            <div class="flex justify-between items-center mb-2 border-b pb-2 product-divider ${product.marked === 'red' ? 'marked-divider-red' : product.marked === 'green' ? 'marked-divider-green' : product.marked === 'forest' ? 'marked-divider-forest' : product.marked === 'lavender' ? 'marked-divider-lavender' : 'normal-divider'}">
                                                <div class="flex items-center">
                                                    <span class="font-bold text-gray-900">商品ID: ${product.productId}</span>
                                                    <span class="ml-2 badge badge-shop">${product.category || '未分类'}</span>
                                                </div>
                                                <div class="flex items-center space-x-2">
                                                    <button class="btn btn-secondary text-sm" onclick="copyProduct(${index}, ${productIndex})">
                                                        <i class="fa fa-copy"></i> 复制
                                                    </button>
                                                    <button class="btn btn-primary text-sm" onclick="editProduct(${index}, ${productIndex})">
                                                        <i class="fa fa-edit"></i> 编辑
                                                    </button>
                                                    <button class="btn btn-danger text-sm" onclick="removeProductFromLink(${index}, ${productIndex})">
                                                        <i class="fa fa-trash"></i> 删除
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="text-sm text-gray-600">${product.note || '无备注'}</div>
                                        </div>
                                    `).join('') : '<div class="text-center py-4 text-gray-500">暂无商品</div>'}
                                </div>
                            </div>
                        </div>
                    </div>
                    `;
                });
                
                // 一次性设置innerHTML，避免多次DOM操作
                container.innerHTML = html;
                
                // 添加链接头部点击事件
                document.querySelectorAll('.link-header').forEach(header => {
                    header.addEventListener('click', function() {
                        const index = this.getAttribute('data-index');
                        const content = this.nextElementSibling;
                        const icon = this.querySelector('.link-toggle-icon');
                        
                        content.classList.toggle('hidden');
                        icon.style.transform = content.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(180deg)';
                    });
                });
                
                // 恢复滚动位置
                setTimeout(() => {
                    window.scrollTo(0, scrollPosition);
                    if (document.getElementById('links-container')) {
                        document.getElementById('links-container').scrollTop = containerScrollPosition;
                    }
                }, 10);
            }

            function renderLinks() {
                // 保存当前滚动位置
                const scrollPosition = window.scrollY;
                const containerScrollPosition = document.getElementById('links-container')?.scrollTop || 0;
                
                const container = document.getElementById('links-container');
                const empty = document.getElementById('links-empty');
                
                if (pricingData.links.length === 0) {
                    container.classList.add('hidden');
                    empty.classList.remove('hidden');
                    return;
                }
                
                container.classList.remove('hidden');
                empty.classList.add('hidden');
                
                // 获取所有店铺数据
                const shops = JSON.parse(localStorage.getItem('shops')) || [];
                const shopsMap = {};
                shops.forEach(shop => {
                    shopsMap[shop.id] = shop.name;
                });
                
                container.innerHTML = pricingData.links.map((link, index) => `
                    <div class="border-2 border-gray-200 rounded-xl overflow-hidden shadow-md hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1 mb-6 bg-white">
                        <div class="bg-gradient-to-r from-blue-700/20 to-blue-600/10 px-4 py-3 flex justify-between items-center cursor-pointer link-header border-b border-blue-500/30" data-index="${index}">
                            <div class="flex items-center space-x-4">
                                <div class="flex items-center">
                                    <i class="fa fa-chevron-down mr-2 text-gray-500 transition-transform duration-150 link-toggle-icon"></i>
                                    <span class="font-medium">${link.name || '未命名链接'}</span>
                                    <span class="ml-2 badge badge-shop">${link.category || '未分类'}</span>
                                    ${link.shopId && shopsMap[link.shopId] ? `<span class="ml-2 inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-gradient-to-r from-primary to-blue-500 text-white shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105">
${shopsMap[link.shopId]}
                                    </span>` : ''}
                                </div>
                                <div class="flex items-center space-x-2">
                                    <i class="fa fa-cubes text-primary"></i>
                                    <span class="text-sm font-semibold text-primary">${link.products ? link.products.length : 0} 个商品</span>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button class="btn btn-secondary text-sm" onclick="viewLinkDetails(${index}); event.stopPropagation();">
                                    <i class="fa fa-eye"></i> 查看详情
                                </button>
                                <button class="btn btn-info text-sm move-btn" onclick="handleMoveButtonClick(${index}, event);" id="move-btn-${index}">
                                    <i class="fa fa-arrows"></i> 移动
                                </button>
                                <button class="btn btn-primary text-sm" onclick="editLink(${index}); event.stopPropagation();">
                                    <i class="fa fa-edit"></i> 编辑
                                </button>
                                <button class="btn btn-danger text-sm" onclick="deleteLink(${index}); event.stopPropagation();">
                                    <i class="fa fa-trash"></i> 删除
                                </button>
                            </div>
                        </div>
                        <div class="link-content px-4 py-3 hidden">
                            <div class="mb-4">
                                <div class="flex items-start justify-between">
                                    <div class="flex-1">
                                        ${link.note ? `
                                        <label class="block text-sm font-medium text-gray-700 mb-1">备注</label>
                                        <div class="text-sm text-gray-900">${link.note}</div>
                                        ` : ''}
                                    </div>
                                    ${link.note ? `
                                    <div class="flex items-center space-x-2 ml-4 whitespace-nowrap">
                                        <i class="fa fa-cubes text-primary"></i>
                                        <span class="text-sm font-semibold text-primary">${link.products ? link.products.length : 0} 个商品</span>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                            <div class="mb-4">
                                <div class="flex justify-between items-center mb-2">
                                    <label class="block text-md font-bold text-gray-900">商品列表</label>
                                    <button class="btn btn-primary text-sm" onclick="addProductToLink(${index})">
                                        <i class="fa fa-plus"></i> 添加商品
                                    </button>
                                </div>
                                <div class="space-y-3 max-h-[900px] overflow-y-auto pr-2">
                                    ${link.products && link.products.length > 0 ? link.products.map((product, productIndex) => `
                                        <div class="border border-gray-200 rounded-md p-3 product-card-hover cursor-pointer product-card" 
                                             data-link-index="${index}"
                                             data-product-index="${productIndex}"
                                             onclick="handleProductCardClick(event, ${index}, ${productIndex})"
                                             data-marked="${product.marked || false}">
                                            <div class="flex justify-between items-center mb-2 border-b pb-2 product-divider ${product.marked === 'red' ? 'marked-divider-red' : product.marked === 'green' ? 'marked-divider-green' : product.marked === 'forest' ? 'marked-divider-forest' : product.marked === 'lavender' ? 'marked-divider-lavender' : 'normal-divider'}">
                                                <div class="flex items-center">
                                                    <span class="font-bold text-gray-900">商品ID: ${product.productId}</span>
                                                    <span class="ml-2 badge badge-shop">${product.category || '未分类'}</span>
                                                </div>
                                                <div class="flex items-center space-x-2">
                                                    <button class="btn btn-secondary text-sm" onclick="copyProduct(${index}, ${productIndex})">
                                                        <i class="fa fa-copy"></i> 复制
                                                    </button>
                                                    <button class="btn btn-primary text-sm" onclick="editProduct(${index}, ${productIndex})">
                                                        <i class="fa fa-edit"></i> 编辑
                                                    </button>
                                                    <button class="btn btn-danger text-sm" onclick="removeProductFromLink(${index}, ${productIndex})">
                                                        <i class="fa fa-trash"></i> 删除
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="text-sm text-gray-600">${product.note || '无备注'}</div>
                                        </div>
                                    `).join('') : '<div class="text-center py-4 text-gray-500">暂无商品</div>'}
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                // 添加链接头部点击事件
                document.querySelectorAll('.link-header').forEach(header => {
                    header.addEventListener('click', function() {
                        const index = this.getAttribute('data-index');
                        const content = this.nextElementSibling;
                        const icon = this.querySelector('.link-toggle-icon');
                        
                        content.classList.toggle('hidden');
                        icon.style.transform = content.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(180deg)';
                    });
                });
                
                // 恢复滚动位置
                setTimeout(() => {
                    window.scrollTo(0, scrollPosition);
                    if (document.getElementById('links-container')) {
                        document.getElementById('links-container').scrollTop = containerScrollPosition;
                    }
                }, 10);
            }
            
            // 渲染链接展示
            function renderDisplayLinks() {
                try {
                    console.log('=== Starting renderDisplayLinks ===');
                    console.log('Pricing data:', pricingData);
                    
                    const container = document.getElementById('display-links-container');
                    const empty = document.getElementById('display-links-empty');
                    
                    if (!container || !empty) {
                        console.error('Display container elements not found');
                        showToast('错误', '页面元素未找到', 'error');
                        return;
                    }
                    
                    // 检查数据是否存在
                    if (!pricingData || !pricingData.links) {
                        console.error('Pricing data or links not available');
                        container.classList.add('hidden');
                        empty.classList.remove('hidden');
                        return;
                    }
                    
                    console.log('Links count:', pricingData.links.length);
                    console.log('Current viewing link index:', currentViewingLinkIndex);
                    
                    if (pricingData.links.length === 0) {
                        console.log('No links to display');
                        container.classList.add('hidden');
                        empty.classList.remove('hidden');
                        return;
                    }
                    
                    // 根据当前查看的链接索引过滤链接
                    let linksToDisplay = [];
                    if (currentViewingLinkIndex >= 0 && currentViewingLinkIndex < pricingData.links.length) {
                        console.log('Filtering to show only link index:', currentViewingLinkIndex);
                        linksToDisplay = [pricingData.links[currentViewingLinkIndex]];
                    } else {
                        console.log('No specific link selected, showing empty state');
                        // 默认不显示任何链接
                    }
                    
                    if (linksToDisplay.length === 0) {
                        console.log('No links to display after filtering');
                        container.classList.add('hidden');
                        empty.classList.remove('hidden');
                        return;
                    }
                    
                    container.classList.remove('hidden');
                    empty.classList.add('hidden');
                    
                    // 获取所有店铺数据
                    const shops = JSON.parse(localStorage.getItem('shops')) || [];
                    const shopsMap = {};
                    shops.forEach(shop => {
                        shopsMap[shop.id] = shop.name;
                    });
                    
                    // 生成HTML内容
                    const linksHtml = linksToDisplay.map((link, displayIndex) => {
                        // 计算原始索引
                        const linkIndex = currentViewingLinkIndex >= 0 ? currentViewingLinkIndex : displayIndex;
                        console.log(`Processing link ${linkIndex}:`, link.name);
                        
                        const productsHtml = link.products && link.products.length > 0 ? link.products.map((product, productIndex) => {
                            console.log(`  Processing product ${productIndex}:`, product.productId);
                            
                            const specsHtml = product.specs && product.specs.length > 0 ? product.specs.map((spec, specIndex) => {
                                try {
                                    console.log(`Calculating for spec ${specIndex}:`, spec);
                                    
                                    // 确保所有计算值都是有效数字
                                    const sellingPrice = parseFloat(spec.sellingPrice || product.sellingPrice || 0) || 0;
                                    const activityDiscount = parseFloat(spec.activityDiscount || product.activityDiscount || 1) || 1;
                                    const couponAmount = parseFloat(spec.couponAmount !== undefined ? spec.couponAmount : (product.couponAmount || 0)) || 0;
                                    const cost = parseFloat(spec.cost || 0) || 0;
                                    
                                    console.log(`Calculation values - sellingPrice: ${sellingPrice}, activityDiscount: ${activityDiscount}, couponAmount: ${couponAmount}, cost: ${cost}`);
                                    
                                    // 避免除以0
                                    const safeActivityDiscount = activityDiscount > 0 ? activityDiscount : 1;
                                    
                                    const pricingPrice = (sellingPrice / safeActivityDiscount) + couponAmount;
                                    const profit = sellingPrice - cost;
                                    const grossProfitRate = sellingPrice > 0 ? (profit / sellingPrice * 100) : 0;
                                    
                                    console.log(`Results - pricingPrice: ${pricingPrice}, profit: ${profit}, grossProfitRate: ${grossProfitRate}`);
                                    
                                    return `
                                        <tr>
                                            <td class="px-3 py-2 whitespace-nowrap">
                                                <div class="relative flex items-center space-x-2">
                                                    <div class="tooltip-container">
                                                        <div class="w-3 h-3 rounded-full" style="background-color: ${spec.color || '#9ca3af'};"></div>
                                                        ${spec.note ? `<div class="tooltip-content max-w-xs">${spec.note.replace(/\n/g, '<br>')}</div><div class="tooltip-arrow"></div>` : ''}
                                                    </div>
                                                    <input type="text" 
                                                           class="input-field text-sm py-1 px-2 sku-input" 
                                                           value="${spec.skuCode || ''}" 
                                                           maxlength="32"
                                                           placeholder="请输入SKU" 
                                                           style="min-width: 120px;"
                                                           onchange="updateSpecField(${linkIndex}, ${productIndex}, ${specIndex}, 'skuCode', this.value)">
                                                    ${spec.skuCode ? `<button type="button" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600" onclick="clearSKU(this, ${linkIndex}, ${productIndex}, ${specIndex})">
                                                        <i class="fa fa-times-circle"></i>
                                                    </button>` : ''}
                                                </div>
                                            </td>
                                            <td class="px-3 py-2 whitespace-nowrap">
                                                <input type="text" class="input-field text-sm py-1 px-2" value="${spec.specCode || ''}" 
                                                       onchange="updateSpecFieldWithUnlink(${linkIndex}, ${productIndex}, ${specIndex}, 'specCode', this.value)"
                                                       placeholder="请输入规格编码" style="min-width: 180px;" pattern=".*" title="可以输入任何字符">
                                            </td>
                                            <td class="px-3 py-2 whitespace-nowrap text-center">
                                                <div class="flex items-center justify-center space-x-1">
                                                    <input type="number" class="input-field text-sm py-1 px-2 text-center" value="${parseFloat(cost).toFixed(2)}" 
                                                           step="0.01" min="0" 
                                                           onchange="updateSpecField(${linkIndex}, ${productIndex}, ${specIndex}, 'cost', this.value); removeCostLink(${linkIndex}, ${productIndex}, ${specIndex})" 
                                                           style="max-width: 90px;"
                                                           data-linked="${spec.linkedCost ? 'true' : 'false'}"
                                                           ${spec.linkedCost ? 'readonly' : ''}>
                                                    <button type="button" 
                                                            class="btn btn-secondary text-xs py-0 px-0" 
                                                            onclick="toggleCostLink(${linkIndex}, ${productIndex}, ${specIndex})"
                                                            title="${spec.linkedCost ? '取消关联规格成本' : '关联规格成本'}"
                                                            style="width: 28px; height: 28px; display: flex; align-items: center; justify-content: center;">
                                                        <i class="fa fa-link" style="font-size: 14px; color: ${spec.linkedCost ? '#10b981' : ''};"></i>
                                                    </button>
                                                </div>
                                            </td>
                                            <td class="px-3 py-2 whitespace-nowrap text-center">
                                                <input type="number" class="input-field text-sm py-1 px-2 text-center" 
                                                       value="${couponAmount}" 
                                                       step="0.01" min="0" 
                                                       onchange="updateSpecField(${linkIndex}, ${productIndex}, ${specIndex}, 'couponAmount', this.value)" style="max-width: 70px;">
                                            </td>
                                            <td class="px-3 py-2 whitespace-nowrap text-center">
                                                <input type="number" class="input-field text-sm py-1 px-2 text-center" 
                                                       value="${safeActivityDiscount}" 
                                                       step="0.01" min="0.01" max="1" 
                                                       onchange="updateSpecField(${linkIndex}, ${productIndex}, ${specIndex}, 'activityDiscount', this.value)" style="max-width: 90px;">
                                            </td>
                                            <td class="px-3 py-2 whitespace-nowrap text-center">
                                                <input type="number" class="input-field text-sm py-1 px-2 text-center" 
                                                       value="${parseFloat(spec.signRate || 100).toFixed(2)}" 
                                                       step="0.01" min="0" max="100" 
                                                       onchange="updateSpecField(${linkIndex}, ${productIndex}, ${specIndex}, 'signRate', this.value)" style="max-width: 100px;">
                                            </td>
                                            <td class="px-3 py-2 whitespace-nowrap text-center">
                                                <input type="number" class="input-field text-sm py-1 px-2 text-center" 
                                                       value="${parseFloat(sellingPrice).toFixed(2)}" 
                                                       step="0.01" min="0" 
                                                       onchange="updateSpecField(${linkIndex}, ${productIndex}, ${specIndex}, 'sellingPrice', this.value)" style="max-width: 110px;">
                                            </td>
                                            <td class="px-3 py-2 whitespace-nowrap text-center text-sm font-medium ${profit >= 0 ? 'text-success' : 'text-danger'}">
                                                ${profit.toFixed(2)}
                                            </td>
                                            <td class="px-3 py-2 whitespace-nowrap text-center text-sm font-medium ${grossProfitRate >= 0 ? 'text-success' : 'text-danger'}">
                                                ${grossProfitRate.toFixed(2)}%
                                            </td>
                                            <td class="px-3 py-2 whitespace-nowrap text-center">
                                                <span class="text-sm font-medium cursor-pointer hover:bg-primary/10 px-1 py-0.5 rounded transition-colors duration-200 ${grossProfitRate > 0 ? 'text-primary' : 'text-danger'}" 
                                                      onclick="toggleBreakEvenCalculation(${linkIndex}, ${productIndex}, ${specIndex})"
                                                      title="${breakEvenAutoCalculation[`${linkIndex}-${productIndex}-${specIndex}`] ? '点击开启计算' : '点击关闭计算'}">
                                                    ${breakEvenAutoCalculation[`${linkIndex}-${productIndex}-${specIndex}`] ? '🔒' : 
                                                      (grossProfitRate > 0 ? calculateBreakEven(parseFloat(spec.sellingPrice || 0) || 0, parseFloat(spec.cost || 0) || 0, parseFloat(spec.signRate || 100)).toFixed(2) : '-')}
                                                </span>
                                            </td>
                                            <td class="px-3 py-2 whitespace-nowrap text-center text-sm font-bold ${pricingPrice >= 0 ? 'text-primary' : 'text-danger'} bg-primary/5 rounded-lg">
                                                ¥${pricingPrice.toFixed(2)}
                                            </td>
                                            <td class="py-2 whitespace-nowrap text-center" style="padding: 2px 0 2px 8px; min-width: 40px;">
                                                <button class="btn btn-secondary text-xs py-0 px-0" 
                                                        onclick="editSpecNote(${linkIndex}, ${productIndex}, ${specIndex})"
                                                        title="编辑备注"
                                                        style="width: 28px; height: 28px; display: flex; align-items: center; justify-content: center;">
                                                    <i class="fa fa-sticky-note" style="font-size: 14px; color: ${spec.note ? '#000000' : '#9ca3af'};"></i>
                                                </button>
                                            </td>
                                            <td class="py-2 whitespace-nowrap text-right" style="padding: 2px 0 2px 4px; min-width: 40px;">
                                                <button class="btn btn-danger text-xs py-0 px-0" 
                                                        onclick="removeSpec(${linkIndex}, ${productIndex}, ${specIndex})"
                                                        title="删除规格"
                                                        style="width: 28px; height: 28px; display: flex; align-items: center; justify-content: center;">
                                                    <i class="fa fa-trash" style="font-size: 14px;"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `;
                                } catch (calcError) {
                                    console.error(`Error calculating for spec ${specIndex}:`, calcError);
                                    return `
                                        <tr class="bg-red-50">
                                            <td colspan="12" class="px-4 py-2 text-center text-danger">
                                                计算错误: ${calcError.message}
                                            </td>
                                        </tr>
                                    `;
                                }
                            }).join('') : `
                                <tr>
                                    <td colspan="12" class="px-4 py-4 text-center text-gray-500">暂无规格，请添加</td>
                                </tr>
                            `;
                            
                            return `
                                <div class="border border-gray-200 rounded-lg mb-4 product-card-hover">
                                    <div class="bg-gradient-to-r ${product.marked === 'red' ? 'from-red-500/40 to-red-400/30 border-red-300/50' : product.marked === 'green' ? 'from-[rgba(115,220,220,0.4)] to-[rgba(115,220,220,0.3)] border-[rgba(115,220,220,0.5)]' : product.marked === 'forest' ? 'from-[rgba(104,139,102,0.4)] to-[rgba(104,139,102,0.3)] border-[rgba(104,139,102,0.5)]' : product.marked === 'lavender' ? 'from-[rgba(160,128,200,0.4)] to-[rgba(160,128,200,0.3)] border-[rgba(160,128,200,0.5)]' : 'from-blue-500/15 to-blue-400/5 border-blue-300/30'} px-4 py-2 flex justify-between items-center border-b">
                                        <div class="flex items-center">
                                            <span class="font-bold text-gray-900">商品ID: ${product.productId}</span>
                                            <span class="ml-2 badge badge-shop">${product.category || '未分类'}</span>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <button class="btn bg-gray-200 text-gray-800 hover:bg-gray-300 text-sm" onclick="copyProduct(${linkIndex}, ${productIndex})" title="复制商品">
                                                <i class="fa fa-copy"></i>
                                            </button>
                                            <button class="btn btn-secondary text-sm" onclick="toggleProductMark(${linkIndex}, ${productIndex})" title="标记商品">
                                                <i class="fa fa-flag"></i>
                                            </button>
                                            <button class="btn btn-info text-sm" onclick="openOperationLogModal(${linkIndex}, ${productIndex})" title="运营操作记录">
                                                <i class="fa fa-history"></i>
                                            </button>
                                            <button class="btn btn-primary text-sm" onclick="editProduct(${linkIndex}, ${productIndex})" title="编辑商品">
                                                <i class="fa fa-edit"></i>
                                            </button>
                                            <button class="btn btn-danger text-sm" onclick="removeProductFromLink(${linkIndex}, ${productIndex})" title="删除商品">
                                                <i class="fa fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="px-4 py-2 flex justify-between items-center min-h-[24px]">
                                        <div class="text-sm text-gray-600">${product.note || ''}</div>
                                    </div>
                                    <div class="px-4 py-2 ${product.marked === 'red' ? 'bg-red-500/10 border-red-300/20' : product.marked === 'green' ? 'bg-[rgba(115,220,220,0.1)] border-[rgba(115,220,220,0.2)]' : product.marked === 'forest' ? 'bg-[rgba(104,139,102,0.1)] border-[rgba(104,139,102,0.2)]' : product.marked === 'lavender' ? 'bg-[rgba(160,128,200,0.1)] border-[rgba(160,128,200,0.2)]' : 'bg-primary/5 border-primary/20'} flex justify-end items-center">
                                        <div class="flex items-center space-x-2 bg-white px-3 py-1 rounded-full shadow-sm border border-primary/20">
                                            <span class="text-xs font-medium text-gray-600">平均保本投产</span>
                                            <span class="text-base font-bold text-primary">${calculateAverageBreakEven(product.specs || [])}</span>
                                        </div>
                                    </div>
                                    
                                    <!-- 批量填写区域 -->
                                    <div class="px-4 py-3 border-t border-gray-200">
                                        <div class="flex items-end gap-4">
                                            <div class="flex-1">
                                                <label class="block text-sm font-medium text-gray-700 mb-1">优惠券金额 (元)</label>
                                                <input type="number" class="input-field text-sm" 
                                                       value="${parseFloat(product.couponAmount || 0) || 0}" 
                                                       step="0.01" min="0" 
                                                       data-field="couponAmount"
                                                       data-link-index="${linkIndex}"
                                                       data-product-index="${productIndex}">
                                            </div>
                                            <div class="flex-1">
                                                <label class="block text-sm font-medium text-gray-700 mb-1">活动折扣</label>
                                                <input type="number" class="input-field text-sm" 
                                                       value="${parseFloat(product.activityDiscount || 1) || 1}" 
                                                       step="0.01" min="0.01" max="1" 
                                                       data-field="activityDiscount"
                                                       data-link-index="${linkIndex}"
                                                       data-product-index="${productIndex}">
                                            </div>
                                            <div class="flex-1">
                                                <label class="block text-sm font-medium text-gray-700 mb-1">签收率 (%)</label>
                                                <input type="number" class="input-field text-sm" 
                                                       value="${parseFloat(product.signRate || 100) || 100}" 
                                                       step="0.01" min="0" max="100" 
                                                       data-field="signRate"
                                                       data-link-index="${linkIndex}"
                                                       data-product-index="${productIndex}">
                                            </div>
                                            <div class="flex-1">
                                                <label class="block text-sm font-medium text-gray-700 mb-1">售卖价浮动 (%)</label>
                                                <input type="number" class="input-field text-sm" 
                                                       value="" 
                                                       step="0.01" 
                                                       data-field="sellingPricePercentChange"
                                                       data-link-index="${linkIndex}"
                                                       data-product-index="${productIndex}"
                                                       placeholder="如: 10 或 -5">
                                            </div>
                                            <div class="flex-1">
                                                <label class="block text-sm font-medium text-gray-700 mb-1">售卖价浮动 (元)</label>
                                                <input type="number" class="input-field text-sm" 
                                                       value="" 
                                                       step="0.01" 
                                                       data-field="sellingPriceAmountChange"
                                                       data-link-index="${linkIndex}"
                                                       data-product-index="${productIndex}"
                                                       placeholder="如: 5.5 或 -2.5">
                                            </div>
                                            <div>
                                                <button class="btn btn-primary text-sm flex items-center justify-center" 
                                                        onclick="applyBulkChanges(${linkIndex}, ${productIndex})"
                                                        title="批量应用更改到所有规格">
                                                    <i class="fa fa-check mr-1"></i> 批量应用
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- 规格表格 -->
                                    <div class="px-4 py-3 border-t border-gray-200">
                                        <div class="overflow-x-auto overflow-y-hidden">
                                            <table class="min-w-full divide-y divide-gray-200">
                                                <thead>
                                                    <tr>
                                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap min-w-[120px]">SKU</th>
                                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap min-w-[100px]">规格编码</th>
                                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap min-w-[100px]">规格成本(元)</th>
                                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap min-w-[100px]">优惠券(元)</th>
                                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap min-w-[80px]">活动折扣</th>
                                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap min-w-[80px]">
                                                            <div class="tooltip-container">
                                                                签收率(%)
                                                                <div class="tooltip-content">当签收率填写为90%则退货率为10%</div>
                                                                <div class="tooltip-arrow"></div>
                                                            </div>
                                                        </th>
                                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap min-w-[100px]">售卖价(元)</th>
                                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap min-w-[80px]">利润(元)</th>
                                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap min-w-[80px]">毛利率</th>
                                                        <th class="px-3 py-2 text-left text-xs font-medium text-primary uppercase tracking-wider whitespace-nowrap min-w-[80px]">
                                                            <div class="tooltip-container">
                                                                保本投产
                                                                <div class="tooltip-content">计算公式：售卖价/（售卖价-规格成本）/签收率（同退货率）</div>
                                                                <div class="tooltip-arrow"></div>
                                                            </div>
                                                        </th>
                                                        <th class="px-3 py-2 text-right text-xs font-medium text-primary uppercase tracking-wider bg-primary/5 whitespace-nowrap min-w-[100px] price-header-highlight">定价价格(元)</th>
                                                        <th class="py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap" style="padding: 2px 0 2px 8px; min-width: 40px;">备注</th>
                                                        <th class="py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap" style="padding: 2px 0 2px 4px; min-width: 40px;">操作</th>
                                                    </tr>
                                                </thead>
                                                <tbody class="bg-white divide-y divide-gray-200">
                                                    ${specsHtml}
                                                </tbody>
                                            </table>
                                        </div>
                                        <div class="flex items-center justify-between mt-3">
                                            <button class="btn btn-primary text-sm" 
                                                    onclick="addSpec(${linkIndex}, ${productIndex})"
                                                    title="添加新规格">
                                                <i class="fa fa-plus"></i> 添加规格
                                            </button>
                                            ${product.timestamp ? `
                                            <div class="text-xs text-gray-500 flex items-center">
                                                <i class="fa fa-clock-o mr-1"></i> 
                                                上架时间: ${new Date(product.timestamp).toLocaleString('zh-CN', { 
                                                    year: 'numeric', 
                                                    month: '2-digit', 
                                                    day: '2-digit',
                                                    hour: '2-digit', 
                                                    minute: '2-digit'
                                                })}
                                            </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('') : '<div class="text-center py-4 text-gray-500">暂无商品</div>';
                        
                        return `
                            <div class="border border-gray-200 rounded-lg overflow-hidden mb-6 product-card-hover" data-link-index="${linkIndex}">
                                <div class="bg-gradient-to-r from-primary/15 to-primary/5 px-4 py-3 border-b border-primary/30">
                                    <div class="flex justify-between items-center">
                                        <div class="flex items-center">
                                            <h3 class="text-lg font-semibold">${link.name || '未命名链接'}</h3>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            ${link.shopId && shopsMap[link.shopId] ? `<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-gradient-to-r from-primary to-blue-500 text-white shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105">
${shopsMap[link.shopId]}
                                            </span>` : ''}
                                            <span class="badge badge-shop">${link.category || '未分类'}</span>
                                            <div class="flex items-center space-x-2">
                                    <i class="fa fa-cubes text-primary"></i>
                                    <span class="text-sm font-semibold text-primary">${link.products ? link.products.length : 0} 个商品</span>
                                </div>
                                        </div>
                                    </div>
                                    ${link.note ? `<p class="text-sm text-gray-600 mt-1">${link.note}</p>` : ''}
                                </div>
                                <div class="p-4">
                                    ${productsHtml}
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    container.innerHTML = linksHtml;
                    console.log('=== renderDisplayLinks completed ===');
                    
                } catch (error) {
                    console.error('Error in renderDisplayLinks:', error);
                    showToast('错误', '渲染链接展示失败: ' + error.message, 'error');
                }
            }
            
            // 计算定价价格
            function calculatePricingPrice(sellingPrice, activityDiscount, couponAmount) {
                return (sellingPrice / activityDiscount) + couponAmount;
            }
            
            // 计算利润
            function calculateProfit(sellingPrice, cost) {
                return sellingPrice - cost;
            }
            
            // 计算毛利率
            function calculateProfitRate(profit, cost) {
                return cost > 0 ? (profit / cost * 100) : 0;
            }
            
            // 编辑规格备注
            function editSpecNote(linkIndex, productIndex, specIndex) {
                try {
                    const link = pricingData.links[linkIndex];
                    const product = link.products[productIndex];
                    const spec = product.specifications[specIndex];
                    
                    const currentNote = spec.note || '';
                    const newNote = prompt('请输入备注内容:', currentNote);
                    
                    if (newNote !== null) {
                        spec.note = newNote.trim();
                        savePricingData();
                        renderPricingTable();
                    }
                } catch (error) {
                    console.error('编辑备注时出错:', error);
                    showToast('编辑备注失败', 'error');
                }
            }
            
            // 计算保本投产（新公式）
            function calculateBreakEven(sellingPrice, cost, signRate) {
                try {
                    // 签收率转换为小数（100 = 1，85 = 0.85）
                    const signRateDecimal = parseFloat(signRate) / 100;
                    
                    // 新公式：1 / (毛利率 * 签收率)，其中毛利率 = 利润 / 售卖价
                    const profit = sellingPrice - cost;
                    const grossProfitRateDecimal = sellingPrice > 0 ? (profit / sellingPrice) : 0;
                    if (grossProfitRateDecimal <= 0) return 0;
                    
                    const breakEven = 1 / (grossProfitRateDecimal * signRateDecimal);
                    
                    return breakEven;
                } catch (error) {
                    console.error('Error calculating break-even:', error);
                    return 0;
                }
            }
            
            // 切换保本投产比的自动计算状态
            function toggleBreakEvenCalculation(linkIndex, productIndex, specIndex) {
                const key = `${linkIndex}-${productIndex}-${specIndex}`;
                // 切换状态（默认是自动计算）
                breakEvenAutoCalculation[key] = !breakEvenAutoCalculation[key];
                
                // 如果关闭自动计算，保存当前计算值作为固定值
                if (breakEvenAutoCalculation[key]) {
                    const spec = pricingData.links[linkIndex].products[productIndex].specs[specIndex];
                    const sellingPrice = parseFloat(spec.sellingPrice || 0) || 0;
                    const cost = parseFloat(spec.cost || 0) || 0;
                    const signRate = parseFloat(spec.signRate || 100);
                    spec.fixedBreakEven = calculateBreakEven(sellingPrice, cost, signRate).toFixed(2);
                    savePricingData();
                }
                
                // 重新渲染显示链接
                renderDisplayLinks();
                
                // 显示提示
                const status = breakEvenAutoCalculation[key] ? '已关闭自动计算' : '已开启自动计算';
                showToast('提示', `保本投产比${status}`, 'info');
            }
            
            // 计算平均保本投产
            function calculateAverageBreakEven(specs) {
                try {
                    if (!specs || specs.length === 0) {
                        return '-';
                    }
                    
                    let totalBreakEven = 0;
                    let validCount = 0;
                    
                    specs.forEach((spec, specIndex) => {
                        try {
                            // 检查是否关闭了自动计算（支持所有商品卡）
                            let isCalculationDisabled = false;
                            // 尝试查找所有可能的键格式
                            for (let linkIdx = 0; linkIdx < 10; linkIdx++) { // 假设最多10个链接
                                for (let productIdx = 0; productIdx < 10; productIdx++) { // 假设每个链接最多10个商品
                                    const key = `${linkIdx}-${productIdx}-${specIndex}`;
                                    if (breakEvenAutoCalculation[key]) {
                                        isCalculationDisabled = true;
                                        break;
                                    }
                                }
                                if (isCalculationDisabled) break;
                            }
                            
                            if (isCalculationDisabled) return; // 跳过已关闭计算的规格
                            
                            const cost = parseFloat(spec.cost || 0) || 0;
                            const sellingPrice = parseFloat(spec.sellingPrice || 0) || 0;
                            const profit = sellingPrice - cost;
                            const grossProfitRate = sellingPrice > 0 ? (profit / sellingPrice * 100) : 0;
                            const signRate = parseFloat(spec.signRate || 100) || 100;
                            
                            if (grossProfitRate > 0) {
                                const breakEven = calculateBreakEven(sellingPrice, cost, signRate);
                                totalBreakEven += breakEven;
                                validCount++;
                            }
                        } catch (specError) {
                            console.warn('Error calculating break-even for spec:', specError);
                        }
                    });
                    
                    return validCount > 0 ? (totalBreakEven / validCount).toFixed(2) : '-';
                } catch (error) {
                    console.error('Error in calculateAverageBreakEven:', error);
                    return '-';
                }
            }
            
            // 打开新增链接模态框
            function openAddLinkModal() {
                document.getElementById('add-link-name').value = '';
                document.getElementById('add-link-category').value = 'other';
                document.getElementById('add-link-note').value = '';
                document.getElementById('add-link-modal').classList.remove('hidden');
            }
            
            // 关闭新增链接模态框
            function closeAddLinkModal() {
                document.getElementById('add-link-modal').classList.add('hidden');
            }
            
            // 保存新增链接
            function saveAddLink() {
                const name = document.getElementById('add-link-name').value.trim();
                const category = document.getElementById('add-link-category').value;
                const note = document.getElementById('add-link-note').value.trim();
                
                if (!name) {
                    showToast('错误', '请输入链接名称', 'error');
                    return;
                }
                
                const newLink = {
                    id: Date.now().toString(),
                    name: name,
                    category: category,
                    products: [],
                    note: note
                };
                
                pricingData.links.unshift(newLink);
                savePricingData();
                renderLinks();
                showToast('成功', '链接添加成功', 'success');
                closeAddLinkModal();
            }
            
            // 全部展开链接
            window.expandAllLinks = function() {
                console.log('Expand all links clicked');
                const links = document.querySelectorAll('#links-container > div');
                console.log('Found links:', links.length);
                links.forEach((link) => {
                    const content = link.querySelector('.link-content');
                    const toggleIcon = link.querySelector('.link-toggle-icon');
                    console.log('Link content:', content, 'Toggle icon:', toggleIcon);
                    if (content && toggleIcon) {
                        content.classList.remove('hidden');
                        toggleIcon.style.transform = 'rotate(180deg)';
                    }
                });
                showToast('操作', '已展开所有链接', 'success');
            };
            
            // 全部收起链接
            window.collapseAllLinks = function() {
                console.log('Collapse all links clicked');
                const links = document.querySelectorAll('#links-container > div');
                console.log('Found links:', links.length);
                links.forEach((link) => {
                    const content = link.querySelector('.link-content');
                    const toggleIcon = link.querySelector('.link-toggle-icon');
                    console.log('Link content:', content, 'Toggle icon:', toggleIcon);
                    if (content && toggleIcon) {
                        content.classList.add('hidden');
                        toggleIcon.style.transform = 'rotate(0deg)';
                    }
                });
                showToast('操作', '已收起所有链接', 'success');
            };
            
            // 编辑链接
            function editLink(index) {
                const link = pricingData.links[index];
                const modal = document.getElementById('edit-link-modal');
                const form = document.getElementById('edit-link-form');
                
                // 填充表单数据
                document.getElementById('edit-link-index').value = index;
                document.getElementById('edit-link-name').value = link.name || '';
                document.getElementById('edit-link-category').value = link.category || pricingData.categories[0];
                document.getElementById('edit-link-note').value = link.note || '';
                
                // 加载店铺列表到店铺归类筛选器
                const shopSelect = document.getElementById('edit-link-shop');
                shopSelect.innerHTML = '<option value="">选择店铺</option>';
                
                // 获取店铺数据
                const shops = JSON.parse(localStorage.getItem('shops')) || [];
                shops.forEach(shop => {
                    const option = document.createElement('option');
                    option.value = shop.id;
                    option.textContent = shop.name;
                    shopSelect.appendChild(option);
                });
                
                // 设置当前选中的店铺
                if (link.shopId) {
                    shopSelect.value = link.shopId;
                }
                
                // 显示模态框 - 确保正确设置显示样式
                modal.style.display = 'flex';
                modal.classList.remove('hidden');
                
                // 聚焦到第一个输入框
                setTimeout(() => {
                    document.getElementById('edit-link-name').focus();
                }, 100);
            }
            
            // 保存编辑的链接
            function saveEditLink() {
                try {
                    // 保存所有卡片的展开状态和滚动位置
                    const expandedStates = {};
                    const scrollPosition = window.scrollY;
                    const containerScrollPosition = document.getElementById('links-container')?.scrollTop || 0;
                    
                    document.querySelectorAll('.link-header').forEach(header => {
                        const index = header.getAttribute('data-index');
                        const isExpanded = !header.nextElementSibling.classList.contains('hidden');
                        expandedStates[index] = isExpanded;
                    });
                    
                    const index = parseInt(document.getElementById('edit-link-index').value);
                    const name = document.getElementById('edit-link-name').value.trim();
                    const category = document.getElementById('edit-link-category').value;
                    const shopId = document.getElementById('edit-link-shop').value;
                    const note = document.getElementById('edit-link-note').value.trim();
                    
                    if (!name) {
                        showToast('错误', '链接名称不能为空', 'error');
                        return;
                    }
                    
                    // 记录当前链接的展开状态
                    const linkHeader = document.querySelector(`[data-index="${index}"]`);
                    const wasExpanded = linkHeader && !linkHeader.nextElementSibling.classList.contains('hidden');
                    
                    // 更新链接数据
                    const link = pricingData.links[index];
                    link.name = name;
                    link.category = category;
                    link.shopId = shopId || null;
                    link.note = note;
                    
                    savePricingData();
                    renderLinks();
                    renderDisplayLinks();
                    
                    // 立即恢复之前的展开状态和滚动位置，不使用setTimeout
                    document.querySelectorAll('.link-header').forEach(header => {
                        const idx = header.getAttribute('data-index');
                        const content = header.nextElementSibling;
                        const icon = header.querySelector('.link-toggle-icon');
                        
                        if (expandedStates[idx]) {
                            content.classList.remove('hidden');
                            if (icon) {
                                icon.style.transform = 'rotate(180deg)';
                            }
                        }
                    });
                    
                    // 立即恢复滚动位置
                    window.scrollTo(0, scrollPosition);
                    if (document.getElementById('links-container')) {
                        document.getElementById('links-container').scrollTop = containerScrollPosition;
                    }
                    
                    // 关闭模态框
                    closeEditLinkModal();
                    
                    showToast('成功', '链接更新成功', 'success');
                    
                } catch (error) {
                    console.error('Error saving edited link:', error);
                    showToast('错误', '保存失败: ' + error.message, 'error');
                }
            }
            
            // 关闭编辑模态框
            function closeEditLinkModal() {
                const modal = document.getElementById('edit-link-modal');
                modal.style.display = 'none';
                modal.classList.add('hidden');
                
                // 重置表单
                document.getElementById('edit-link-form').reset();
            }
            
            // 编辑商品
            function editProduct(linkIndex, productIndex) {
                try {
                    const link = pricingData.links[linkIndex];
                    const product = link.products[productIndex];
                    const modal = document.getElementById('edit-product-modal');
                    
                    // 填充表单数据
                    document.getElementById('edit-product-link-index').value = linkIndex;
                    document.getElementById('edit-product-index').value = productIndex;
                    document.getElementById('edit-product-id').value = product.productId || '';
                    document.getElementById('edit-product-category').value = product.category || pricingData.categories[0];
                    document.getElementById('edit-product-note').value = product.note || '';
                    
                    // 填充时间戳信息
                    if (product.timestamp) {
                        const timestamp = new Date(product.timestamp);
                        document.getElementById('edit-product-date').value = timestamp.toISOString().split('T')[0];
                        document.getElementById('edit-product-time').value = timestamp.toTimeString().slice(0, 5);
                    } else {
                        // 如果没有时间戳，清空输入框
                        document.getElementById('edit-product-date').value = '';
                        document.getElementById('edit-product-time').value = '';
                    }
                    
                    // 填充规格信息
                    const specsContainer = document.getElementById('edit-product-specs');
                    specsContainer.innerHTML = '';
                    
                    if (product.specs && product.specs.length > 0) {
                        product.specs.forEach((spec, specIndex) => {
                            const specHtml = `
                                <div class="border border-gray-200 rounded-md p-3">
                                    <div class="grid grid-cols-1 gap-3 mb-2">
                                        <div class="grid grid-cols-2 gap-3">
                                            <div>
                                                <label class="block text-xs font-medium text-gray-700 mb-1">SKU</label>
                                                <input type="text" class="input-field w-full text-sm" value="${spec.skuCode || ''}" 
                                                    maxlength="32" placeholder="请输入SKU">
                                            </div>
                                            <div>
                                                <label class="block text-xs font-medium text-gray-700 mb-1">规格编码</label>
                                                <input type="text" class="input-field w-full text-sm" value="${spec.specCode || ''}" 
                                                    onchange="this.dataset.value = this.value">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">成本</label>
                                            <input type="number" class="input-field w-full text-sm" value="${spec.cost || 0}" 
                                                step="0.01" min="0" onchange="this.dataset.value = this.value">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">优惠券</label>
                                            <input type="number" class="input-field w-full text-sm" value="${spec.couponAmount || 0}" 
                                                step="0.01" min="0" onchange="this.dataset.value = this.value">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">活动折扣</label>
                                            <input type="number" class="input-field w-full text-sm" value="${spec.activityDiscount || 0}" 
                                                step="0.01" min="0" onchange="this.dataset.value = this.value">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">售卖价</label>
                                            <input type="number" class="input-field w-full text-sm" value="${spec.sellingPrice || 0}" 
                                                step="0.01" min="0" onchange="this.dataset.value = this.value">
                                        </div>
                                    </div>
                                </div>
                            `;
                            specsContainer.innerHTML += specHtml;
                        });
                    } else {
                        specsContainer.innerHTML = '<div class="text-center py-2 text-gray-500 text-sm">暂无规格信息</div>';
                    }
                    
                    // 显示模态框
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                    
                    // 聚焦到第一个输入框
                    setTimeout(() => {
                        document.getElementById('edit-product-id').focus();
                    }, 100);
                    
                } catch (error) {
                    console.error('Error opening edit product modal:', error);
                    showToast('错误', '打开编辑窗口失败: ' + error.message, 'error');
                }
            }
            
            // 关闭编辑商品模态框
            function closeEditProductModal() {
                const modal = document.getElementById('edit-product-modal');
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                
                // 重置表单
                document.getElementById('edit-product-form').reset();
                document.getElementById('edit-product-specs').innerHTML = '';
            }
            

            
            // 保存编辑的商品
            function saveEditProduct() {
                // 保存所有卡片的展开状态和滚动位置
                const expandedStates = {};
                const scrollPosition = window.scrollY;
                const containerScrollPosition = document.getElementById('links-container')?.scrollTop || 0;
                
                document.querySelectorAll('.link-header').forEach(header => {
                    const index = header.getAttribute('data-index');
                    const isExpanded = !header.nextElementSibling.classList.contains('hidden');
                    expandedStates[index] = isExpanded;
                });
                try {
                    console.log('=== 开始保存编辑的商品 ===');
                    
                    const linkIndex = parseInt(document.getElementById('edit-product-link-index').value);
                    const productIndex = parseInt(document.getElementById('edit-product-index').value);
                    const productId = document.getElementById('edit-product-id').value.trim();
                    const category = document.getElementById('edit-product-category').value;
                    const note = document.getElementById('edit-product-note').value.trim();
                    
                    // 获取时间戳信息
                    const dateValue = document.getElementById('edit-product-date').value;
                    const timeValue = document.getElementById('edit-product-time').value;
                    
                    console.log('链接索引:', linkIndex, '商品索引:', productIndex);
                    
                    if (!productId) {
                        showToast('错误', '商品ID不能为空', 'error');
                        return;
                    }
                    
                    // 验证数据结构
                    if (!pricingData.links || !pricingData.links[linkIndex]) {
                        console.error('链接数据不存在');
                        showToast('错误', '数据保存失败', 'error');
                        return;
                    }
                    
                    if (!pricingData.links[linkIndex].products || !pricingData.links[linkIndex].products[productIndex]) {
                        console.error('商品数据不存在');
                        showToast('错误', '数据保存失败', 'error');
                        return;
                    }
                    
                    // 更新商品基本信息
                    const product = pricingData.links[linkIndex].products[productIndex];
                    product.productId = productId;
                    product.category = category;
                    product.note = note;
                    
                    // 更新时间戳信息
                    if (dateValue || timeValue) {
                        // 如果提供了日期或时间，创建时间戳
                        let timestamp = null;
                        
                        if (dateValue && timeValue) {
                            // 同时有日期和时间，使用本地时间
                            const [year, month, day] = dateValue.split('-').map(Number);
                            const [hours, minutes] = timeValue.split(':').map(Number);
                            const date = new Date(year, month - 1, day, hours, minutes, 0, 0);
                            timestamp = date.toISOString();
                        } else if (dateValue) {
                            // 只有日期，使用本地时间的中午12点
                            const [year, month, day] = dateValue.split('-').map(Number);
                            const date = new Date(year, month - 1, day, 12, 0, 0, 0);
                            timestamp = date.toISOString();
                        } else if (timeValue) {
                            // 只有时间，使用当前日期的本地时间
                            const [hours, minutes] = timeValue.split(':').map(Number);
                            const date = new Date();
                            date.setHours(hours, minutes, 0, 0);
                            timestamp = date.toISOString();
                        }
                        
                        if (timestamp) {
                            console.log(`设置商品时间戳: ${timestamp} (原始日期: ${dateValue}, 时间: ${timeValue})`);
                            product.timestamp = timestamp;
                        }
                    }
                    
                    // 更新规格信息
                    const specContainers = document.querySelectorAll('#edit-product-specs > div');
                    specContainers.forEach((container, specIndex) => {
                        if (product.specs && product.specs[specIndex]) {
                            const inputs = container.querySelectorAll('input');
                            if (inputs.length >= 6) {
                                // SKU (第一个输入框)
                                product.specs[specIndex].skuCode = (inputs[0].dataset.value || inputs[0].value).trim();
                                // 规格编码 (第二个输入框)
                                product.specs[specIndex].specCode = (inputs[1].dataset.value || inputs[1].value).trim();
                                // 成本 (第三个输入框)
                                product.specs[specIndex].cost = parseFloat(inputs[2].dataset.value || inputs[2].value) || 0;
                                // 优惠券 (第四个输入框)
                                product.specs[specIndex].couponAmount = parseFloat(inputs[3].dataset.value || inputs[3].value) || 0;
                                // 活动折扣 (第五个输入框)
                                product.specs[specIndex].activityDiscount = parseFloat(inputs[4].dataset.value || inputs[4].value) || 0;
                                // 售卖价 (第六个输入框)
                                product.specs[specIndex].sellingPrice = parseFloat(inputs[5].dataset.value || inputs[5].value) || 0;
                            }
                        }
                    });
                    
                    console.log('基本信息和规格信息已更新');
                    
                    // 保存数据到localStorage
                    savePricingData();
                    
                    // 重新渲染界面
                    renderLinks();
                    
                    // 立即恢复之前的展开状态，不使用setTimeout
                    document.querySelectorAll('.link-header').forEach(header => {
                        const index = header.getAttribute('data-index');
                        const content = header.nextElementSibling;
                        const icon = header.querySelector('.link-toggle-icon');
                        
                        if (expandedStates[index]) {
                            content.classList.remove('hidden');
                            if (icon) {
                                icon.style.transform = 'rotate(180deg)';
                            }
                        }
                    });
                    
                    // 立即恢复滚动位置
                    window.scrollTo(0, scrollPosition);
                    if (document.getElementById('links-container')) {
                        document.getElementById('links-container').scrollTop = containerScrollPosition;
                    }
                    
                    renderDisplayLinks();
                    
                    console.log('数据已保存并重新渲染');
                    
                    // 关闭模态框
                    closeEditProductModal();
                    
                    showToast('成功', '商品更新成功', 'success');
                    console.log('=== 保存编辑的商品完成 ===');
                    
                } catch (error) {
                    console.error('Error saving edited product:', error);
                    showToast('错误', '保存失败: ' + error.message, 'error');
                }
            }
            

            
            // 删除链接（带冷却时间和模态框确认）
            let isDeleteLinkOnCooldown = false;
            function deleteLink(index) {
                // 检查是否在冷却中
                if (isDeleteLinkOnCooldown) {
                    showToast('提示', '删除功能正在冷却中，请稍后再试', 'warning');
                    return;
                }
                
                // 设置冷却状态
                isDeleteLinkOnCooldown = true;
                const linkName = pricingData.links[index]?.name || '该链接';
                let countdown = 3;
                
                // 显示倒计时提示
                const countdownToast = document.createElement('div');
                countdownToast.className = 'fixed top-4 right-4 bg-warning text-white px-4 py-2 rounded-lg z-50 flex items-center';
                countdownToast.innerHTML = `<i class="fa fa-clock-o mr-2"></i> 删除冷却中，${countdown}秒后可操作`;
                document.body.appendChild(countdownToast);
                
                // 倒计时
                const timer = setInterval(() => {
                    countdown--;
                    if (countdown > 0) {
                        countdownToast.innerHTML = `<i class="fa fa-clock-o mr-2"></i> 删除冷却中，${countdown}秒后可操作`;
                    } else {
                        clearInterval(timer);
                        document.body.removeChild(countdownToast);
                        
                        // 显示删除确认模态框
                        openDeleteConfirmModal(
                            '确认删除链接',
                            `确定要删除"${linkName}"吗？此操作无法撤销。`,
                            function() {
                                // 保存滚动位置
                                const scrollPosition = window.scrollY;
                                const containerScrollPosition = document.getElementById('links-container')?.scrollTop || 0;
                                
                                pricingData.links.splice(index, 1);
                                savePricingData();
                                renderLinks();
                                renderDisplayLinks();
                                
                                // 恢复滚动位置
                                setTimeout(() => {
                                    window.scrollTo(0, scrollPosition);
                                    if (document.getElementById('links-container')) {
                                        document.getElementById('links-container').scrollTop = containerScrollPosition;
                                    }
                                }, 10);
                                
                                showToast('成功', '链接删除成功', 'success');
                            }
                        );
                        
                        // 恢复冷却状态
                        isDeleteLinkOnCooldown = false;
                    }
                }, 1000);
            }
            
            // 当前查看的链接索引和商品索引
            let currentViewingLinkIndex = -1;
            let currentViewingProductIndex = -1;
            
            // 存储每个规格的保本投产比自动计算状态
            let breakEvenAutoCalculation = {};
            
            // 查看链接详情
            function viewLinkDetails(index) {
                // 记录当前查看的链接索引
                currentViewingLinkIndex = index;
                console.log('查看链接详情，索引:', index);
                
                // 获取链接展示标签并模拟点击，触发完整的标签切换逻辑
                const linkDisplayTab = document.querySelector('[data-pricing-tab="link-display"]');
                if (linkDisplayTab) {
                    // 模拟点击事件
                    const clickEvent = new MouseEvent('click', {
                        bubbles: true,
                        cancelable: true
                    });
                    linkDisplayTab.dispatchEvent(clickEvent);
                }
                
                // 滚动到对应的链接
                setTimeout(() => {
                    const linkElement = document.querySelector(`[data-link-index="${index}"]`);
                    if (linkElement) {
                        linkElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        // 确保链接卡片是展开状态
                        const content = linkElement.nextElementSibling;
                        if (content && content.classList.contains('hidden')) {
                            toggleLinkCard(index);
                        }
                    }
                }, 100);
                
                // 切换到商品详细标签并显示该链接的商品
                setTimeout(() => {
                    const productDetailsTab = document.querySelector('[data-pricing-tab="product-details"]');
                    if (productDetailsTab) {
                        const clickEvent = new MouseEvent('click', {
                            bubbles: true,
                            cancelable: true
                        });
                        productDetailsTab.dispatchEvent(clickEvent);
                    }
                }, 200);
            }
            
            // 处理移动按钮点击事件
            function handleMoveButtonClick(linkIndex, event) {
                console.log('移动按钮点击 - 链接索引:', linkIndex, '当前状态:', moveModeLinks.has(linkIndex));
                
                // 阻止事件冒泡，避免触发全局点击处理器
                event.stopPropagation();
                event.preventDefault();
                
                // 直接调用toggleMoveMode函数
                toggleMoveMode(linkIndex);
            }

            // 处理商品卡片点击事件
            function handleProductCardClick(event, linkIndex, productIndex) {
                // 检查点击的目标是否是按钮或按钮内的元素
                let target = event.target;
                while (target && target !== event.currentTarget) {
                    if (target.tagName === 'BUTTON' || target.closest('button')) {
                        // 如果点击的是按钮，不执行跳转
                        return;
                    }
                    target = target.parentElement;
                }
                
                // 如果点击的不是按钮，执行跳转
                viewProductCardDetails(linkIndex, productIndex);
            }
            
            // 查看商品详情（从商品卡片点击）
            function viewProductCardDetails(linkIndex, productIndex) {
                // 记录当前查看的链接索引和商品索引
                currentViewingLinkIndex = linkIndex;
                currentViewingProductIndex = productIndex;
                console.log('查看商品详情，链接索引:', linkIndex, '商品索引:', productIndex);
                
                // 检查是否处于移动编辑模式，如果是则自动退出
                if (moveModeLinks.size > 0) {
                    console.log('检测到移动编辑模式，自动退出');
                    // 退出所有移动编辑模式
                    moveModeLinks.forEach(activeLinkIndex => {
                        toggleMoveMode(activeLinkIndex);
                    });
                }
                
                // 直接切换到商品详细标签（link-display）
                const linkDisplayTab = document.querySelector('[data-pricing-tab="link-display"]');
                if (linkDisplayTab) {
                    console.log('切换到商品详细标签');
                    // 模拟点击事件
                    const clickEvent = new MouseEvent('click', {
                        bubbles: true,
                        cancelable: true
                    });
                    linkDisplayTab.dispatchEvent(clickEvent);
                    
                    // 等待标签切换完成后，直接滚动到对应的商品
                    setTimeout(() => {
                        console.log('尝试滚动到商品卡片 - 链接索引:', linkIndex, '商品索引:', productIndex);
                        
                        // 方法1: 在商品详细页面中查找
                        console.log('方法1: 在商品详细页面中查找');
                        const detailLinkElement = document.querySelector(`[data-link-index="${linkIndex}"]`);
                        console.log('找到详细页面链接元素:', detailLinkElement);
                        
                        if (detailLinkElement) {
                            // 使用更通用的选择器查找商品卡片
                            const detailProductCards = detailLinkElement.querySelectorAll('.product-card-hover, .product-card');
                            console.log('在详细页面找到商品卡片数量:', detailProductCards.length);
                            
                            if (detailProductCards.length > productIndex) {
                                const targetCard = detailProductCards[productIndex];
                                if (targetCard) {
                                    console.log('找到目标商品卡片:', targetCard);
                                    scrollToAndHighlightCard(targetCard);
                                    return;
                                }
                            }
                        }
                        
                        // 方法2: 在原始链接卡片中查找
                        console.log('方法2: 在原始链接卡片中查找');
                        const originalLinkCard = document.querySelector(`[data-index="${linkIndex}"]`);
                        console.log('找到原始链接卡片:', originalLinkCard);
                        
                        if (originalLinkCard) {
                            const originalProductCards = originalLinkCard.querySelectorAll('.product-card-hover, .product-card');
                            console.log('在原始卡片中找到商品卡片数量:', originalProductCards.length);
                            
                            if (originalProductCards.length > productIndex) {
                                const targetCard = originalProductCards[productIndex];
                                if (targetCard) {
                                    console.log('找到目标商品卡片:', targetCard);
                                    scrollToAndHighlightCard(targetCard);
                                    return;
                                }
                            }
                        }
                        
                        // 方法3: 全局搜索
                        console.log('方法3: 全局搜索商品卡片');
                        const allProductCards = document.querySelectorAll(`[data-link-index="${linkIndex}"] .product-card-hover, [data-link-index="${linkIndex}"] .product-card`);
                        console.log('全局找到商品卡片数量:', allProductCards.length);
                        
                        if (allProductCards.length > productIndex) {
                            const targetCard = allProductCards[productIndex];
                            if (targetCard) {
                                console.log('找到目标商品卡片:', targetCard);
                                scrollToAndHighlightCard(targetCard);
                                return;
                            }
                        }
                        
                        console.error('无法找到目标商品卡片进行滚动');
                        
                    }, 500); // 增加延迟时间，确保DOM完全渲染
                }
                
                // 滚动并高亮商品卡片的辅助函数
                function scrollToAndHighlightCard(card) {
                    if (!card) return;
                    
                    console.log('准备滚动到卡片，当前位置:', card.getBoundingClientRect());
                    
                    // 确保卡片在视口中
                    card.scrollIntoView({
                        behavior: 'smooth',
                        block: 'center',
                        inline: 'nearest'
                    });
                    
                    // 备用滚动方法
                    setTimeout(() => {
                        const rect = card.getBoundingClientRect();
                        console.log('卡片位置:', rect);
                        
                        if (rect.top < 0 || rect.bottom > window.innerHeight) {
                            console.log('卡片不在视口中，使用备用滚动方法');
                            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                            const targetScroll = scrollTop + rect.top - window.innerHeight / 2;
                            console.log('备用滚动到位置:', targetScroll);
                            
                            window.scrollTo({
                                top: targetScroll,
                                behavior: 'smooth'
                            });
                        }
                    }, 200);
                    
                    // 高亮显示商品卡片
                    card.style.boxShadow = '0 0 20px 5px rgba(59, 130, 246, 0.5)';
                    card.style.transform = 'scale(1.02)';
                    card.style.transition = 'all 0.3s ease';
                    
                    // 移除高亮效果
                    setTimeout(() => {
                        card.style.boxShadow = '';
                        card.style.transform = '';
                        card.style.transition = '';
                    }, 2000);
                }
            }
            
            // 添加商品到链接
            let currentLinkIndex = -1;

            function openAddProductToLinkModal(linkIndex) {
                currentLinkIndex = linkIndex;
                document.getElementById('product-id-input').value = '';
                document.getElementById('product-note-input').value = '';
                document.getElementById('add-product-to-link-modal').classList.remove('hidden');
            }

            function closeAddProductToLinkModal() {
                document.getElementById('add-product-to-link-modal').classList.add('hidden');
                currentLinkIndex = -1;
            }

            function addProductToLink(linkIndex) {
                openAddProductToLinkModal(linkIndex);
            }

            // 处理添加商品表单提交
            function handleAddProductFormSubmit(e) {
                e.preventDefault();
                console.log('Form submitted, currentLinkIndex:', currentLinkIndex);
                if (currentLinkIndex === -1) return;

                const productId = document.getElementById('product-id-input').value.trim();
                const note = document.getElementById('product-note-input').value.trim();

                console.log('Product ID:', productId, 'Note:', note);

                if (productId) {
                    if (!pricingData.links[currentLinkIndex].products) {
                        pricingData.links[currentLinkIndex].products = [];
                    }
                    
                    const newProduct = {
                        id: Date.now().toString(),
                        productId: productId,
                        category: '未分类',
                        specs: [],
                        couponAmount: 0,
                        activityDiscount: 1,
                        sellingPrice: 0,
                        note: note
                    };
                    
                    pricingData.links[currentLinkIndex].products.push(newProduct);
                    console.log('Product added, total products:', pricingData.links[currentLinkIndex].products.length);
                    
                    savePricingData();
                    
                    // 添加详细的调试信息
                    console.log('=== 添加商品后更新UI ===');
                    console.log('当前链接索引:', currentLinkIndex);
                    console.log('商品数据:', pricingData.links[currentLinkIndex].products);
                    
                    // 保存当前卡片的展开状态
                    const headerBefore = document.querySelector(`[data-index="${currentLinkIndex}"]`);
                    const wasExpanded = headerBefore && !headerBefore.nextElementSibling.classList.contains('hidden');
                    console.log('添加商品前卡片状态:', wasExpanded ? '展开' : '折叠');
                    
                    // 直接更新DOM而不重新渲染整个列表
                    console.log('直接更新DOM元素...');
                    
                    // 更新头部的商品数量显示
                    if (headerBefore) {
                        const productCountBadge = headerBefore.querySelector('.badge-primary');
                        if (productCountBadge) {
                            productCountBadge.textContent = `${pricingData.links[currentLinkIndex].products.length} 个商品`;
                        }
                    }
                    
                    // 更新内容区域
                    const contentBefore = headerBefore ? headerBefore.nextElementSibling : null;
                    if (contentBefore) {
                        // 更新卡片内的商品数量显示
                        const cardProductCount = contentBefore.querySelector('.text-primary.font-semibold');
                        if (cardProductCount) {
                            cardProductCount.textContent = `${pricingData.links[currentLinkIndex].products.length} 个商品`;
                        }
                        
                        // 更新商品列表
                        const productsListContainer = contentBefore.querySelector('.space-y-3');
                        if (productsListContainer) {
                            const newProduct = pricingData.links[currentLinkIndex].products[pricingData.links[currentLinkIndex].products.length - 1];
                            const productIndex = pricingData.links[currentLinkIndex].products.length - 1;
                            
                            // 如果列表为空，清空并添加新商品
                            if (productsListContainer.querySelector('.text-gray-500')) {
                                productsListContainer.innerHTML = '';
                            }
                            
                            // 创建新商品元素
                            const productElement = document.createElement('div');
                            productElement.className = 'border border-gray-200 rounded-md p-3 product-card-hover';
                            
                            // 使用模板字符串创建HTML内容，确保与渲染时的结构完全一致
                            const productHTML = `
                                <div class="flex justify-between items-center mb-2 border-b border-primary/20 pb-2">
                                    <div class="flex items-center">
                                        <span class="font-medium">商品ID: ${newProduct.productId}</span>
                                        <span class="ml-2 badge badge-shop">${newProduct.category || '未分类'}</span>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <button class="btn btn-secondary text-sm" onclick="copyProduct(${currentLinkIndex}, ${productIndex})">
                                            <i class="fa fa-copy"></i> 复制
                                        </button>
                                        <button class="btn btn-primary text-sm" onclick="editProduct(${currentLinkIndex}, ${productIndex})">
                                            <i class="fa fa-edit"></i> 编辑
                                        </button>
                                        <button class="btn btn-danger text-sm" onclick="removeProductFromLink(${currentLinkIndex}, ${productIndex})">
                                            <i class="fa fa-trash"></i> 删除
                                        </button>
                                    </div>
                                </div>
                                <div class="text-sm text-gray-600">${newProduct.note || '无备注'}</div>
                            `;
                            
                            productElement.innerHTML = productHTML;
                            
                            // 添加到列表
                            productsListContainer.appendChild(productElement);
                            console.log('新商品元素已添加到DOM');
                            
                            // 确保卡片是展开状态
                            if (contentBefore.classList.contains('hidden')) {
                                console.log('确保卡片展开显示新添加的商品');
                                contentBefore.classList.remove('hidden');
                                // 更新箭头方向
                                const toggleBtn = headerBefore.querySelector('.toggle-btn');
                                if (toggleBtn) {
                                    toggleBtn.innerHTML = '<i class="fa fa-chevron-down"></i>';
                                }
                            }
                        }
                    }
                    
                    // 保存所有卡片的展开状态和滚动位置
                    const expandedStates = {};
                    const scrollPosition = window.scrollY;
                    const containerScrollPosition = document.getElementById('links-container')?.scrollTop || 0;
                    
                    document.querySelectorAll('.link-header').forEach(header => {
                        const index = header.getAttribute('data-index');
                        const isExpanded = !header.nextElementSibling.classList.contains('hidden');
                        expandedStates[index] = isExpanded;
                    });
                    console.log('保存的展开状态:', expandedStates);
                    
                    // 重新渲染链接列表以确保数据一致性
                    renderLinks();
                    
                    // 立即恢复之前的展开状态和滚动位置，不使用setTimeout
                    document.querySelectorAll('.link-header').forEach(header => {
                        const idx = header.getAttribute('data-index');
                        const content = header.nextElementSibling;
                        const icon = header.querySelector('.link-toggle-icon');
                        
                        if (expandedStates[idx]) {
                            content.classList.remove('hidden');
                            if (icon) {
                                icon.style.transform = 'rotate(180deg)';
                            }
                        }
                    });
                    
                    // 立即恢复滚动位置
                    window.scrollTo(0, scrollPosition);
                    if (document.getElementById('links-container')) {
                        document.getElementById('links-container').scrollTop = containerScrollPosition;
                    }
                    setTimeout(() => {
                        document.querySelectorAll('.link-header').forEach(header => {
                            const index = header.getAttribute('data-index');
                            const content = header.nextElementSibling;
                            const icon = header.querySelector('.link-toggle-icon');
                            
                            if (expandedStates[index]) {
                                content.classList.remove('hidden');
                                if (icon) {
                                    icon.style.transform = 'rotate(180deg)';
                                }
                            }
                        });
                        console.log('已恢复展开状态');
                    }, 50);
                    
                    // 如果当前正在查看商品详细信息，也重新渲染显示
                    if (currentViewingLinkIndex >= 0) {
                        renderDisplayLinks();
                    }
                    
                    // 显示成功提示并关闭模态框
                    showToast('成功', '商品添加成功', 'success');
                    closeAddProductToLinkModal();
                } else {
                    alert('请输入商品ID！');
                }
            }

            // 确保DOM加载完成后绑定事件监听器
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function() {
                    const form = document.getElementById('add-product-form');
                    if (form) {
                        form.addEventListener('submit', handleAddProductFormSubmit);
                        console.log('Add product form event listener bound');
                    }
                });
            } else {
                const form = document.getElementById('add-product-form');
                if (form) {
                    form.addEventListener('submit', handleAddProductFormSubmit);
                    console.log('Add product form event listener bound');
                }
            }
            
            // 从链接中移除商品（带冷却时间和模态框确认）
            let isRemoveProductOnCooldown = false;
            function removeProductFromLink(linkIndex, productIndex) {
                // 检查是否在冷却中
                if (isRemoveProductOnCooldown) {
                    showToast('提示', '删除功能正在冷却中，请稍后再试', 'warning');
                    return;
                }
                
                // 设置冷却状态
                isRemoveProductOnCooldown = true;
                const productName = pricingData.links[linkIndex]?.products[productIndex]?.productName || '该商品';
                let countdown = 3;
                
                // 显示倒计时提示
                const countdownToast = document.createElement('div');
                countdownToast.className = 'fixed top-4 right-4 bg-warning text-white px-4 py-2 rounded-lg z-50 flex items-center';
                countdownToast.innerHTML = `<i class="fa fa-clock-o mr-2"></i> 删除冷却中，${countdown}秒后可操作`;
                document.body.appendChild(countdownToast);
                
                // 倒计时
                const timer = setInterval(() => {
                    countdown--;
                    if (countdown > 0) {
                        countdownToast.innerHTML = `<i class="fa fa-clock-o mr-2"></i> 删除冷却中，${countdown}秒后可操作`;
                    } else {
                        clearInterval(timer);
                        document.body.removeChild(countdownToast);
                        
                        // 显示删除确认模态框
                        openDeleteConfirmModal(
                            '确认删除商品',
                            `确定要删除"${productName}"吗？此操作无法撤销。`,
                            function() {
                                // 保存所有卡片的展开状态和滚动位置
                                const expandedStates = {};
                                const scrollPosition = window.scrollY;
                                const containerScrollPosition = document.getElementById('links-container')?.scrollTop || 0;
                                
                                document.querySelectorAll('.link-header').forEach(header => {
                                    const index = header.getAttribute('data-index');
                                    const isExpanded = !header.nextElementSibling.classList.contains('hidden');
                                    expandedStates[index] = isExpanded;
                                });
                                
                                pricingData.links[linkIndex].products.splice(productIndex, 1);
                                savePricingData();
                                renderLinks();
                                
                                // 立即恢复之前的展开状态和滚动位置，不使用setTimeout
                                document.querySelectorAll('.link-header').forEach(header => {
                                    const index = header.getAttribute('data-index');
                                    const content = header.nextElementSibling;
                                    const icon = header.querySelector('.link-toggle-icon');
                                    
                                    if (expandedStates[index]) {
                                        content.classList.remove('hidden');
                                        if (icon) {
                                            icon.style.transform = 'rotate(180deg)';
                                        }
                                    }
                                });
                                
                                // 立即恢复滚动位置
                                window.scrollTo(0, scrollPosition);
                                if (document.getElementById('links-container')) {
                                    document.getElementById('links-container').scrollTop = containerScrollPosition;
                                }
                                
                                renderDisplayLinks();
                                showToast('成功', '商品删除成功', 'success');
                            }
                        );
                        
                        // 恢复冷却状态
                        isRemoveProductOnCooldown = false;
                    }
                }, 1000);
            }
            
            // 标记商品 - 实现多色循环标记
            function toggleProductMark(linkIndex, productIndex) {
                const link = pricingData.links[linkIndex];
                if (link.products && link.products.length > productIndex) {
                    const product = link.products[productIndex];
                    
                    // 循环切换标记状态：red -> green -> forest -> lavender -> none
                    if (!product.marked || product.marked === 'none') {
                        product.marked = 'red';
                    } else if (product.marked === 'red') {
                        product.marked = 'green';
                    } else if (product.marked === 'green') {
                        product.marked = 'forest';
                    } else if (product.marked === 'forest') {
                        product.marked = 'lavender';
                    } else {
                        product.marked = 'none';
                    }
                    
                    savePricingData();
                    renderLinks();
                    renderDisplayLinks();
                }
            }

            // 复制商品
            // 运营操作记录相关函数
            function openOperationLogModal(linkIndex, productIndex) {
                document.getElementById('operation-log-link-index').value = linkIndex;
                document.getElementById('operation-log-product-index').value = productIndex;
                
                // 加载现有的操作记录
                loadOperationLogs(linkIndex, productIndex);
                
                // 清空新记录输入框和编辑状态
                document.getElementById('operation-log-content').value = '';
                document.getElementById('operation-log-edit-index').value = '-1';
                
                // 确保按钮状态正确
                document.getElementById('add-log-btn').classList.remove('hidden');
                document.getElementById('save-log-btn').classList.add('hidden');
                document.getElementById('cancel-edit-btn').classList.add('hidden');
                
                // 显示模态框
                document.getElementById('operation-log-modal').classList.remove('hidden');
            }
            
            function closeOperationLogModal() {
                document.getElementById('operation-log-modal').classList.add('hidden');
            }
            
            function loadOperationLogs(linkIndex, productIndex) {
                const product = pricingData.links[linkIndex].products[productIndex];
                const logList = document.getElementById('operation-log-list');
                logList.innerHTML = '';
                
                if (!product.operationLogs || product.operationLogs.length === 0) {
                    logList.innerHTML = '<div class="text-gray-500 text-center py-4">暂无操作记录</div>';
                    return;
                }
                
                // 按时间倒序显示记录
                const logs = [...product.operationLogs].reverse();
                logs.forEach((log, logIndex) => {
                    // 实际的日志索引（从原始数组中）
                    const actualLogIndex = product.operationLogs.length - 1 - logIndex;
                    
                    const logItem = document.createElement('div');
                    logItem.className = 'bg-gray-50 p-3 rounded-lg border border-gray-200 relative';
                    logItem.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-sm font-medium text-primary">${formatDateTime(log.timestamp)}</span>
                            <div class="flex items-center space-x-2">
                                <span class="text-xs text-gray-500">${log.operator || ''}</span>
                                <div class="flex space-x-1">
                                    <button class="text-xs text-blue-600 hover:text-blue-800" onclick="editOperationLog(${linkIndex}, ${productIndex}, ${actualLogIndex})" title="编辑记录">
                                        <i class="fa fa-pencil"></i>
                                    </button>
                                    <button class="text-xs text-red-600 hover:text-red-800" onclick="deleteOperationLog(${linkIndex}, ${productIndex}, ${actualLogIndex})" title="删除记录">
                                        <i class="fa fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="text-sm text-gray-700 whitespace-pre-wrap">${log.content}</div>
                    `;
                    logList.appendChild(logItem);
                });
            }
            
            function addOperationLog() {
                const linkIndex = parseInt(document.getElementById('operation-log-link-index').value);
                const productIndex = parseInt(document.getElementById('operation-log-product-index').value);
                const content = document.getElementById('operation-log-content').value.trim();
                
                if (!content) {
                    alert('请输入操作内容');
                    return;
                }
                
                const product = pricingData.links[linkIndex].products[productIndex];
                
                // 初始化操作记录数组
                if (!product.operationLogs) {
                    product.operationLogs = [];
                }
                
                // 添加新记录
                const newLog = {
                    timestamp: new Date().toISOString(),
                    content: content,
                    operator: '' // 可以根据实际情况从用户信息中获取
                };
                
                product.operationLogs.push(newLog);
                
                // 重新加载记录列表
                loadOperationLogs(linkIndex, productIndex);
                
                // 清空输入框
                document.getElementById('operation-log-content').value = '';
                
                // 显示成功提示
                showToast('操作记录添加成功');
                
                // 保存数据到localStorage
                savePricingData();
            }
            
            function formatDateTime(dateTimeString) {
                const date = new Date(dateTimeString);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                const seconds = String(date.getSeconds()).padStart(2, '0');
                
                return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
            }
            
            // 编辑操作记录
            function editOperationLog(linkIndex, productIndex, logIndex) {
                const product = pricingData.links[linkIndex].products[productIndex];
                const log = product.operationLogs[logIndex];
                
                // 填充编辑表单
                document.getElementById('operation-log-content').value = log.content;
                document.getElementById('operation-log-edit-index').value = logIndex;
                
                // 切换按钮状态
                document.getElementById('add-log-btn').classList.add('hidden');
                document.getElementById('save-log-btn').classList.remove('hidden');
                document.getElementById('cancel-edit-btn').classList.remove('hidden');
                
                // 滚动到输入框
                document.getElementById('operation-log-content').scrollIntoView({ behavior: 'smooth' });
                document.getElementById('operation-log-content').focus();
            }
            
            // 保存编辑后的操作记录
            function saveOperationLog() {
                const linkIndex = parseInt(document.getElementById('operation-log-link-index').value);
                const productIndex = parseInt(document.getElementById('operation-log-product-index').value);
                const logIndex = parseInt(document.getElementById('operation-log-edit-index').value);
                const content = document.getElementById('operation-log-content').value.trim();
                
                if (!content) {
                    alert('请输入操作内容');
                    return;
                }
                
                const product = pricingData.links[linkIndex].products[productIndex];
                const log = product.operationLogs[logIndex];
                
                // 更新记录内容
                log.content = content;
                log.lastModified = new Date().toISOString(); // 记录最后修改时间
                
                // 重新加载记录列表
                loadOperationLogs(linkIndex, productIndex);
                
                // 重置编辑状态
                cancelEditOperationLog();
                
                // 显示成功提示
                showToast('操作记录修改成功');
                
                // 保存数据到localStorage
                savePricingData();
            }
            
            // 取消编辑
            function cancelEditOperationLog() {
                // 清空输入框
                document.getElementById('operation-log-content').value = '';
                document.getElementById('operation-log-edit-index').value = '-1';
                
                // 恢复按钮状态
                document.getElementById('add-log-btn').classList.remove('hidden');
                document.getElementById('save-log-btn').classList.add('hidden');
                document.getElementById('cancel-edit-btn').classList.add('hidden');
            }
            
            // 删除操作记录
            function deleteOperationLog(linkIndex, productIndex, logIndex) {
                const product = pricingData.links[linkIndex].products[productIndex];
                const log = product.operationLogs[logIndex];
                
                // 显示删除确认模态框
                openDeleteConfirmModal(
                    '删除操作记录',
                    `确定要删除这条操作记录吗？此操作不可撤销。\n\n操作时间：${formatDateTime(log.timestamp)}\n操作内容：${log.content.substring(0, 50)}${log.content.length > 50 ? '...' : ''}`,
                    function() {
                        // 确认删除
                        product.operationLogs.splice(logIndex, 1);
                        
                        // 重新加载记录列表
                        loadOperationLogs(linkIndex, productIndex);
                        
                        // 显示成功提示
                        showToast('操作记录删除成功');
                        
                        // 保存数据到localStorage
                        savePricingData();
                    }
                );
            }
            
            function copyProduct(linkIndex, productIndex) {
                // 保存所有卡片的展开状态和滚动位置
                const expandedStates = {};
                const scrollPosition = window.scrollY;
                const containerScrollPosition = document.getElementById('links-container')?.scrollTop || 0;
                
                document.querySelectorAll('.link-header').forEach(header => {
                    const index = header.getAttribute('data-index');
                    const isExpanded = !header.nextElementSibling.classList.contains('hidden');
                    expandedStates[index] = isExpanded;
                });
                
                const originalProduct = pricingData.links[linkIndex].products[productIndex];
                const copiedProduct = JSON.parse(JSON.stringify(originalProduct));
                copiedProduct.id = Date.now().toString();
                copiedProduct.productId = originalProduct.productId + '_copy';
                copiedProduct.note = originalProduct.note ? originalProduct.note + ' (复制)' : '复制的商品';
                
                pricingData.links[linkIndex].products.push(copiedProduct);
                savePricingData();
                renderLinks();
                
                // 立即恢复之前的展开状态和滚动位置，不使用setTimeout
                document.querySelectorAll('.link-header').forEach(header => {
                    const index = header.getAttribute('data-index');
                    const content = header.nextElementSibling;
                    const icon = header.querySelector('.link-toggle-icon');
                    
                    if (expandedStates[index]) {
                        content.classList.remove('hidden');
                        if (icon) {
                            icon.style.transform = 'rotate(180deg)';
                        }
                    }
                });
                
                // 立即恢复滚动位置
                window.scrollTo(0, scrollPosition);
                if (document.getElementById('links-container')) {
                    document.getElementById('links-container').scrollTop = containerScrollPosition;
                }
                
                renderDisplayLinks();
                showToast('成功', '商品复制成功', 'success');
            }
            
            // 添加规格
            function addSpec(linkIndex, productIndex) {
                try {
                    console.log('Adding spec for linkIndex:', linkIndex, 'productIndex:', productIndex);
                    
                    // 验证数据结构
                    if (!pricingData || !pricingData.links) {
                        console.error('Pricing data not initialized');
                        showToast('错误', '数据未初始化', 'error');
                        return;
                    }
                    
                    if (!pricingData.links[linkIndex]) {
                        console.error('Link not found at index:', linkIndex);
                        showToast('错误', '链接不存在', 'error');
                        return;
                    }
                    
                    if (!pricingData.links[linkIndex].products || !pricingData.links[linkIndex].products[productIndex]) {
                        console.error('Product not found at index:', productIndex);
                        showToast('错误', '商品不存在', 'error');
                        return;
                    }
                    
                    // 初始化规格数组
                    if (!pricingData.links[linkIndex].products[productIndex].specs) {
                        pricingData.links[linkIndex].products[productIndex].specs = [];
                    }
                    
                    // 创建新规格
                    const newSpec = {
                        skuCode: '',
                        specCode: '',
                        cost: 0,
                        couponAmount: undefined,
                        activityDiscount: undefined,
                        sellingPrice: undefined
                    };
                    
                    // 添加规格并保存
                    pricingData.links[linkIndex].products[productIndex].specs.push(newSpec);
                    savePricingData();
                    
                    // 重新渲染
                    renderDisplayLinks();
                    
                    // 高亮显示新添加的规格（不自动滚动）
                    setTimeout(() => {
                        const specRows = document.querySelectorAll(`#display-links-container tr`);
                        if (specRows.length > 0) {
                            const lastRow = specRows[specRows.length - 1];
                            // 高亮显示新添加的规格
                            lastRow.classList.add('bg-primary/10');
                            setTimeout(() => {
                                lastRow.classList.remove('bg-primary/10');
                            }, 2000);
                        }
                    }, 100);
                    
                    showToast('成功', '规格添加成功', 'success');
                    
                } catch (error) {
                    console.error('Error adding spec:', error);
                    showToast('错误', '添加规格失败: ' + error.message, 'error');
                }
            }
            
            // 移除规格（带冷却时间和模态框确认）
            let isRemoveSpecOnCooldown = false;
            function removeSpec(linkIndex, productIndex, specIndex) {
                // 检查是否在冷却中
                if (isRemoveSpecOnCooldown) {
                    showToast('提示', '删除功能正在冷却中，请稍后再试', 'warning');
                    return;
                }
                
                // 设置冷却状态
                isRemoveSpecOnCooldown = true;
                const specName = pricingData.links[linkIndex]?.products[productIndex]?.specs[specIndex]?.specName || '该规格';
                let countdown = 3;
                
                // 显示倒计时提示
                const countdownToast = document.createElement('div');
                countdownToast.className = 'fixed top-4 right-4 bg-warning text-white px-4 py-2 rounded-lg z-50 flex items-center';
                countdownToast.innerHTML = `<i class="fa fa-clock-o mr-2"></i> 删除冷却中，${countdown}秒后可操作`;
                document.body.appendChild(countdownToast);
                
                // 倒计时
                const timer = setInterval(() => {
                    countdown--;
                    if (countdown > 0) {
                        countdownToast.innerHTML = `<i class="fa fa-clock-o mr-2"></i> 删除冷却中，${countdown}秒后可操作`;
                    } else {
                        clearInterval(timer);
                        document.body.removeChild(countdownToast);
                        
                        // 显示删除确认模态框
                        openDeleteConfirmModal(
                            '确认删除规格',
                            `确定要删除"${specName}"吗？此操作无法撤销。`,
                            function() {
                                pricingData.links[linkIndex].products[productIndex].specs.splice(specIndex, 1);
                                savePricingData();
                                renderDisplayLinks();
                                showToast('成功', '规格删除成功', 'success');
                            }
                        );
                        
                        // 恢复冷却状态
                        isRemoveSpecOnCooldown = false;
                    }
                }, 1000);
            }
            

            // 更新商品字段
            function updateProductField(linkIndex, productIndex, field, value) {
                pricingData.links[linkIndex].products[productIndex][field] = parseFloat(value) || 0;
                savePricingData();
                renderDisplayLinks();
            }
            
            // 批量应用更改到当前商品的所有规格
            function applyBulkChanges(linkIndex, productIndex) {
                try {
                    console.log('=== Starting applyBulkChanges ===');
                    console.log('Link index:', linkIndex, 'Product index:', productIndex);
                    
                    // 获取当前商品的优惠券金额、活动折扣、签收率
                    const couponAmount = parseFloat(document.querySelector(`[data-link-index="${linkIndex}"][data-product-index="${productIndex}"][data-field="couponAmount"]`).value) || 0;
                    const activityDiscount = parseFloat(document.querySelector(`[data-link-index="${linkIndex}"][data-product-index="${productIndex}"][data-field="activityDiscount"]`).value) || 1;
                    const signRate = parseFloat(document.querySelector(`[data-link-index="${linkIndex}"][data-product-index="${productIndex}"][data-field="signRate"]`).value) || 100;
                    
                    // 获取售卖价浮动值
                    const percentChange = parseFloat(document.querySelector(`[data-link-index="${linkIndex}"][data-product-index="${productIndex}"][data-field="sellingPricePercentChange"]`).value);
                    const amountChange = parseFloat(document.querySelector(`[data-link-index="${linkIndex}"][data-product-index="${productIndex}"][data-field="sellingPriceAmountChange"]`).value);
                    
                    console.log('Input values - couponAmount:', couponAmount, 'activityDiscount:', activityDiscount);
                    console.log('Price change values - percentChange:', percentChange, 'amountChange:', amountChange);
                    
                    // 只应用到当前商品的所有规格
                    const currentProduct = pricingData.links[linkIndex].products[productIndex];
                    
                    // 更新商品本身的字段
                    currentProduct.couponAmount = couponAmount;
                    currentProduct.activityDiscount = activityDiscount;
                    currentProduct.signRate = signRate;
                    
                    // 同时更新该商品下所有规格的相应字段
                    if (currentProduct.specs) {
                        currentProduct.specs.forEach((spec, specIndex) => {
                            // 更新优惠券、折扣和签收率
                            spec.couponAmount = couponAmount;
                            spec.activityDiscount = activityDiscount;
                            spec.signRate = signRate;
                            
                            // 计算新的售卖价
                            let currentSellingPrice = parseFloat(spec.sellingPrice || 0) || 0;
                            let newSellingPrice = currentSellingPrice;
                            
                            console.log(`Spec ${specIndex} - Current selling price:`, currentSellingPrice);
                            
                            // 应用百分比浮动
                            if (!isNaN(percentChange)) {
                                const percentAdjustment = currentSellingPrice * (percentChange / 100);
                                newSellingPrice += percentAdjustment;
                                console.log(`  Applying ${percentChange}% change: +${percentAdjustment.toFixed(2)}`);
                            }
                            
                            // 应用金额浮动
                            if (!isNaN(amountChange)) {
                                newSellingPrice += amountChange;
                                console.log(`  Applying ${amountChange.toFixed(2)} yuan change`);
                            }
                            
                            // 确保价格不为负数
                            newSellingPrice = Math.max(0, newSellingPrice);
                            spec.sellingPrice = parseFloat(newSellingPrice.toFixed(2));
                            
                            console.log(`  New selling price:`, newSellingPrice.toFixed(2));
                        });
                    }
                    
                    savePricingData();
                    renderDisplayLinks();
                    
                    // 显示成功提示
                    showToast('成功', '批量应用成功！', 'success');
                    console.log('=== applyBulkChanges completed ===');
                    
                } catch (error) {
                    console.error('Error in applyBulkChanges:', error);
                    showToast('错误', '批量应用失败: ' + error.message, 'error');
                }
            }
            
            // 格式化SKU输入
            function formatSKU(input) {
                // 不再限制字符类型，只限制长度为32个字符
                let value = input.value.substring(0, 32);
                input.value = value;
                // 同步到dataset
                input.dataset.value = value;
            }
            
            // 清除SKU输入
            function clearSKU(button, linkIndex, productIndex, specIndex) {
                const input = button.previousElementSibling;
                input.value = '';
                input.dataset.value = '';
                // 更新数据
                if (pricingData.links[linkIndex] && 
                    pricingData.links[linkIndex].products[productIndex] && 
                    pricingData.links[linkIndex].products[productIndex].specs[specIndex]) {
                    pricingData.links[linkIndex].products[productIndex].specs[specIndex].skuCode = '';
                    savePricingData();
                    renderDisplayLinks();
                }
                button.style.display = 'none';
            }
            
            // 编辑规格备注
            function editSpecNote(linkIndex, productIndex, specIndex) {
                try {
                    console.log('=== 打开编辑规格备注模态框 ===');
                    console.log('链接索引:', linkIndex, '商品索引:', productIndex, '规格索引:', specIndex);
                    
                    // 验证数据结构
                    if (!pricingData.links[linkIndex] || 
                        !pricingData.links[linkIndex].products[productIndex] || 
                        !pricingData.links[linkIndex].products[productIndex].specs[specIndex]) {
                        console.error('数据结构不存在');
                        showToast('错误', '数据加载失败', 'error');
                        return;
                    }
                    
                    const spec = pricingData.links[linkIndex].products[productIndex].specs[specIndex];
                    const product = pricingData.links[linkIndex].products[productIndex];
                    
                    // 填充规格信息
                    const infoDiv = document.getElementById('spec-note-info');
                    const specInfo = `
                        商品ID: ${product.productId} | 
                        SKU: ${spec.skuCode || '未设置'} | 
                        规格编码: ${spec.specCode || '未设置'}
                    `;
                    infoDiv.innerHTML = specInfo;
                    
                    // 填充现有备注
                    const noteTextarea = document.getElementById('spec-note-content');
                    noteTextarea.value = spec.note || '';
                    
                    // 设置颜色选择器
                    const colorPicker = document.getElementById('spec-color-picker');
                    const colorPreview = document.getElementById('color-preview');
                    colorPicker.value = spec.color || '#9ca3af';
                    colorPreview.textContent = spec.color || '#9ca3af';
                    colorPreview.style.color = spec.color || '#9ca3af';
                    
                    // 存储索引信息
                    document.getElementById('edit-spec-note-modal').dataset.linkIndex = linkIndex;
                    document.getElementById('edit-spec-note-modal').dataset.productIndex = productIndex;
                    document.getElementById('edit-spec-note-modal').dataset.specIndex = specIndex;
                    
                    // 显示模态框
                    const modal = document.getElementById('edit-spec-note-modal');
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                    
                    // 聚焦到备注输入框
                    setTimeout(() => {
                        noteTextarea.focus();
                    }, 100);
                    
                    // 添加颜色选择器事件监听
                    colorPicker.addEventListener('input', function() {
                        colorPreview.textContent = this.value;
                        colorPreview.style.color = this.value;
                    });
                    
                    console.log('=== 编辑规格备注模态框打开完成 ===');
                    
                } catch (error) {
                    console.error('Error opening edit spec note modal:', error);
                    showToast('错误', '打开编辑窗口失败: ' + error.message, 'error');
                }
            }
            
            // 关闭规格备注模态框
            function closeSpecNoteModal() {
                const modal = document.getElementById('edit-spec-note-modal');
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                
                // 重置表单
                document.getElementById('spec-note-content').value = '';
                document.getElementById('spec-note-info').innerHTML = '';
            }
            
            // 保存规格备注
            function saveSpecNote() {
                try {
                    console.log('=== 开始保存规格备注 ===');
                    
                    const modal = document.getElementById('edit-spec-note-modal');
                    const linkIndex = parseInt(modal.dataset.linkIndex);
                    const productIndex = parseInt(modal.dataset.productIndex);
                    const specIndex = parseInt(modal.dataset.specIndex);
                    const noteContent = document.getElementById('spec-note-content').value.trim();
                    const colorValue = document.getElementById('spec-color-picker').value;
                    
                    console.log('链接索引:', linkIndex, '商品索引:', productIndex, '规格索引:', specIndex);
                    
                    // 验证数据结构
                    if (!pricingData.links[linkIndex] || 
                        !pricingData.links[linkIndex].products[productIndex] || 
                        !pricingData.links[linkIndex].products[productIndex].specs[specIndex]) {
                        console.error('数据结构不存在');
                        showToast('错误', '数据保存失败', 'error');
                        return;
                    }
                    
                    // 更新备注和颜色
                    pricingData.links[linkIndex].products[productIndex].specs[specIndex].note = noteContent;
                    pricingData.links[linkIndex].products[productIndex].specs[specIndex].color = colorValue;
                    
                    console.log('备注已更新:', noteContent);
                    
                    // 保存数据
                    savePricingData();
                    
                    // 重新渲染界面
                    renderDisplayLinks();
                    
                    console.log('数据已保存并重新渲染');
                    
                    // 关闭模态框
                    closeSpecNoteModal();
                    
                    showToast('成功', '备注保存成功', 'success');
                    console.log('=== 保存规格备注完成 ===');
                    
                } catch (error) {
                    console.error('Error saving spec note:', error);
                    showToast('错误', '保存失败: ' + error.message, 'error');
                }
            }
            
            // 更新规格字段
            function updateSpecField(linkIndex, productIndex, specIndex, field, value) {
                // 确保数据结构存在
                if (!pricingData.links[linkIndex] || 
                    !pricingData.links[linkIndex].products[productIndex] || 
                    !pricingData.links[linkIndex].products[productIndex].specs[specIndex]) {
                    console.error('数据结构不存在:', linkIndex, productIndex, specIndex);
                    return;
                }
                
                const numValue = ['cost', 'couponAmount', 'activityDiscount', 'sellingPrice'].includes(field) ? (parseFloat(value) || 0) : value;
                pricingData.links[linkIndex].products[productIndex].specs[specIndex][field] = numValue;
                savePricingData();
                renderDisplayLinks();
            }
            
            // 更新规格字段并在修改规格编码时自动取消关联
            function updateSpecFieldWithUnlink(linkIndex, productIndex, specIndex, field, value) {
                // 确保数据结构存在
                if (!pricingData.links[linkIndex] || 
                    !pricingData.links[linkIndex].products[productIndex] || 
                    !pricingData.links[linkIndex].products[productIndex].specs[specIndex]) {
                    console.error('数据结构不存在:', linkIndex, productIndex, specIndex);
                    return;
                }
                
                const spec = pricingData.links[linkIndex].products[productIndex].specs[specIndex];
                const oldSpecCode = spec.specCode;
                const newSpecCode = value.trim();
                
                // 如果是修改规格编码，且之前有关联，则自动取消关联
                if (field === 'specCode' && spec.linkedCost && (oldSpecCode !== newSpecCode || !newSpecCode)) {
                    // 取消关联
                    spec.linkedCost = false;
                    // 显示提示
                    showToast('提示', '规格编码已修改，已自动取消成本关联', 'info');
                }
                
                const numValue = ['cost', 'couponAmount', 'activityDiscount', 'sellingPrice'].includes(field) ? (parseFloat(value) || 0) : value;
                spec[field] = numValue;
                savePricingData();
                renderDisplayLinks();
            }
            
            // 绑定新品定价工具按钮事件
            document.addEventListener('DOMContentLoaded', function() {
                // 添加链接按钮
                const addLinkBtn = document.getElementById('add-link');
                if (addLinkBtn) {
                    addLinkBtn.addEventListener('click', openAddLinkModal);
                }
                
                // 全部收起按钮
                const collapseAllBtn = document.getElementById('collapse-all-links');
                if (collapseAllBtn) {
                    collapseAllBtn.addEventListener('click', function() {
                        document.querySelectorAll('.link-content').forEach(content => {
                            content.classList.add('hidden');
                        });
                        document.querySelectorAll('.link-toggle-icon').forEach(icon => {
                            icon.style.transform = 'rotate(0deg)';
                        });
                    });
                }
                
                // 全部展开按钮
                const expandAllBtn = document.getElementById('expand-all-links');
                if (expandAllBtn) {
                    expandAllBtn.addEventListener('click', function() {
                        document.querySelectorAll('.link-content').forEach(content => {
                            content.classList.remove('hidden');
                        });
                        document.querySelectorAll('.link-toggle-icon').forEach(icon => {
                            icon.style.transform = 'rotate(180deg)';
                        });
                    });
                }
                
                // 综合筛选功能
                function filterLinks() {
                    const searchTerm = document.getElementById('link-search')?.value.toLowerCase() || '';
                    const selectedCategory = document.getElementById('link-category-filter')?.value || '';
                    const selectedShopId = document.getElementById('link-shop-filter')?.value || '';
                    const links = document.querySelectorAll('#links-container > div');
                    
                    console.log('=== 执行链接筛选 ===');
                    console.log('搜索词:', searchTerm);
                    console.log('选中分类:', selectedCategory);
                    console.log('选中店铺:', selectedShopId);
                    
                    links.forEach((link, index) => {
                        const linkData = pricingData.links[index];
                        
                        // 搜索筛选
                        const linkName = (linkData.name || '').toLowerCase();
                        const hasMatchingProduct = linkData.products && linkData.products.some(product => 
                            product.productId.toLowerCase().includes(searchTerm)
                        );
                        const matchesSearch = searchTerm === '' || linkName.includes(searchTerm) || hasMatchingProduct;
                        
                        // 分类筛选
                        const matchesCategory = selectedCategory === '' || linkData.category === selectedCategory;
                        
                        // 店铺筛选
                        const matchesShop = selectedShopId === '' || linkData.shopId === selectedShopId;
                        
                        // 综合筛选条件
                        const shouldShow = matchesSearch && matchesCategory && matchesShop;
                        console.log(`链接 ${index}: 搜索=${matchesSearch}, 分类=${matchesCategory}, 店铺=${matchesShop}, 显示=${shouldShow}`);
                        
                        if (shouldShow) {
                            link.classList.remove('hidden');
                        } else {
                            link.classList.add('hidden');
                        }
                    });
                    
                    // 检查是否有可见的链接
                    const visibleLinks = Array.from(links).filter(link => !link.classList.contains('hidden'));
                    const emptyState = document.getElementById('links-empty');
                    const container = document.getElementById('links-container');
                    
                    console.log('可见链接数量:', visibleLinks.length);
                    
                    if (visibleLinks.length === 0) {
                        emptyState.classList.remove('hidden');
                        container.classList.add('hidden');
                    } else {
                        emptyState.classList.add('hidden');
                        container.classList.remove('hidden');
                    }
                }
                
                // 搜索功能
                const linkSearch = document.getElementById('link-search');
                if (linkSearch) {
                    linkSearch.addEventListener('input', filterLinks);
                }
                
                // 分类筛选
                const categoryFilter = document.getElementById('link-category-filter');
                if (categoryFilter) {
                    categoryFilter.addEventListener('change', filterLinks);
                }
                
                // 店铺筛选
                const shopFilter = document.getElementById('link-shop-filter');
                if (shopFilter) {
                    shopFilter.addEventListener('change', filterLinks);
                }


            });
        </script>

    <!-- Import SKU Costs Modal -->
    <div id="import-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">导入规格编码成本</h3>
                    <button id="close-import-modal" class="text-gray-400 hover:text-gray-600">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">选择Excel文件</label>
                    <div class="flex items-center space-x-2">
                        <!-- 美化的文件输入框 -->
                        <div class="relative flex-1">
                            <input type="file" id="import-file-input" accept=".xlsx, .xls" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                            <div class="flex items-center justify-between px-4 py-2 border border-gray-300 rounded-md bg-white h-10">
                                <span id="file-name-display" class="text-sm text-gray-600 truncate flex-1">未选择文件</span>
                                <div class="flex items-center space-x-2">
                                    <span class="text-xs bg-primary/10 text-primary px-2 py-1 rounded">.xlsx, .xls</span>
                                    <button id="clear-file-btn" class="text-gray-400 hover:text-gray-600 transition-colors duration-200 hidden">
                                        <i class="fa fa-times-circle"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <button id="start-import" class="btn btn-primary h-10 px-4">
                            <i class="fa fa-upload"></i> 开始导入
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">支持 .xlsx 和 .xls 格式，请确保文件包含"规格编码"和"成本"列</p>
                </div>
                
                <!-- Loading State -->
                <div id="import-loading" class="hidden mb-6">
                    <div class="flex items-center justify-center py-4">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
                        <span class="ml-3 text-gray-600">正在解析文件...</span>
                    </div>
                </div>


                
                <!-- Preview Section -->
                <div id="import-preview-section" class="mb-6 hidden">
                    <h4 class="text-md font-medium text-gray-700 mb-3">数据预览</h4>
                    <div id="import-preview" class="max-h-60 overflow-y-auto border border-gray-200 rounded-lg">
                        <!-- Preview table will be inserted here -->
                    </div>
                    <div id="import-stats" class="mt-2">
                        <!-- Stats will be inserted here -->
                    </div>
                </div>


                
                <!-- Import Mode Selection -->
                <div id="import-mode-section" class="mb-6 hidden">
                    <h4 class="text-md font-medium text-gray-700 mb-3">导入模式</h4>
                    <div class="space-y-3">
                        <label class="flex items-center space-x-2">
                            <input type="radio" name="import-mode" value="merge" checked="" class="text-primary focus:ring-primary">
                            <span class="text-sm text-gray-700">合并模式：新增不存在的规格编码，更新已存在的规格编码</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="radio" name="import-mode" value="insert" class="text-primary focus:ring-primary">
                            <span class="text-sm text-gray-700">仅新增：只添加不存在的规格编码，跳过已存在的</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="radio" name="import-mode" value="update" class="text-primary focus:ring-primary">
                            <span class="text-sm text-gray-700">仅更新：只更新已存在的规格编码，跳过不存在的</span>
                        </label>
                    </div>
                </div>


                
                <!-- Confirmation Section -->
                <div id="import-confirm-section" class="flex justify-end space-x-3 hidden">
                    <button id="cancel-import" class="btn btn-secondary">取消</button>
                    <button id="import-confirm-btn" class="btn btn-primary">
                        <i class="fa fa-check"></i> 确认导入
                    </button>
                </div>
                
                <!-- Hidden field to store import data -->
                <input type="hidden" id="import-data">
            </div>
        </div>
    </div>




        
        <div id="shop-management" class="tab-content hidden">
            <div class="card">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-gray-800 flex items-center">店铺管理 <span id="shop-count" class="ml-3 text-sm text-primary px-3 py-1 flex items-center"><img src="https://p26-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/bb09d3d67de241a4b848bbf8b73706eb.png~tplv-a9rns2rl98-24:720:720.png?lk3s=8e244e95&amp;rcl=202601302354276E262CC09AFF1B31FC4B&amp;rrcfp=8a172a1a&amp;x-expires=1770393267&amp;x-signature=JPidBvw6XD56vlr9D2SkLolRZTM%3D" alt="店铺" class="w-8 h-8 mr-1"> <span id="shop-count-number" class="text-lg mr-1">6</span> <span class="text-lg">家店铺</span></span></h2>
                    <div class="flex items-center space-x-3">
                        <div class="relative">
                            <input type="text" id="shop-search" placeholder="搜索店铺名称和商品ID..." class="w-64 px-4 py-2 pl-10 border-2 border-gray-200 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-100 focus:border-blue-500 transition-all duration-200 text-gray-700 placeholder-gray-400" style="padding-left: 2rem;">
                            <i class="fa fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        </div>
                        <button id="add-shop" class="btn btn-primary">
                            <i class="fa fa-plus"></i> 添加店铺
                        </button>
                    </div>
                </div>
                
                <div id="shops-container" class="space-y-6">
                    <!-- Shops will be added here -->
                </div>
                
                <div id="shops-empty" class="text-center py-8 text-gray-500">
                    <i class="fa fa-info-circle text-3xl mb-2"></i>
                    <p>暂无店铺，请添加</p>
                </div>
                
                <script>
                    // 高亮显示匹配的文本
                    function highlightSearchText(element, searchTerm) {
                        try {
                            // 保存原始内容
                            if (!element._originalHTML) {
                                element._originalHTML = element.innerHTML;
                            }
                            
                            // 清除之前的高亮
                            element.innerHTML = element._originalHTML;
                            
                            if (searchTerm) {
                                // 查找所有文本节点并高亮匹配的内容
                                const walk = document.createTreeWalker(
                                    element,
                                    NodeFilter.SHOW_TEXT,
                                    null,
                                    false
                                );
                                
                                let node;
                                const textNodes = [];
                                
                                // 收集所有文本节点
                                while (node = walk.nextNode()) {
                                    if (node.textContent.trim() && 
                                        !node.parentNode.classList.contains('search-highlight') &&
                                        node.parentNode.tagName !== 'SCRIPT' &&
                                        node.parentNode.tagName !== 'STYLE') {
                                        textNodes.push(node);
                                    }
                                }
                                
                                // 处理每个文本节点
                                textNodes.forEach(node => {
                                    const text = node.textContent;
                                    const lowerText = text.toLowerCase();
                                    const lowerSearchTerm = searchTerm.toLowerCase();
                                    
                                    if (lowerText.includes(lowerSearchTerm)) {
                                        const index = lowerText.indexOf(lowerSearchTerm);
                                        const before = text.substring(0, index);
                                        const match = text.substring(index, index + searchTerm.length);
                                        const after = text.substring(index + searchTerm.length);
                                        
                                        // 创建新的文本节点和高亮节点
                                        const beforeNode = document.createTextNode(before);
                                        const matchNode = document.createElement('span');
                                        matchNode.className = 'search-highlight';
                                        matchNode.textContent = match;
                                        const afterNode = document.createTextNode(after);
                                        
                                        // 替换原始节点
                                        node.parentNode.insertBefore(beforeNode, node);
                                        node.parentNode.insertBefore(matchNode, node);
                                        node.parentNode.insertBefore(afterNode, node);
                                        node.parentNode.removeChild(node);
                                    }
                                });
                            }
                        } catch (error) {
                            console.error('高亮显示时出错:', error);
                            // 出错时恢复原始内容
                            if (element._originalHTML) {
                                element.innerHTML = element._originalHTML;
                            }
                        }
                    }
                    
                    // 清除高亮显示
                    function clearSearchHighlight(element) {
                        if (element._originalHTML) {
                            element.innerHTML = element._originalHTML;
                            delete element._originalHTML;
                        }
                    }
                    
                    // 店铺搜索功能 - 增强版本
                    document.addEventListener('DOMContentLoaded', function() {
                        const shopSearch = document.getElementById('shop-search');
                        const shopsContainer = document.getElementById('shops-container');
                        const shopsEmpty = document.getElementById('shops-empty');
                        
                        if (shopSearch) {
                            shopSearch.addEventListener('input', function() {
                                const searchTerm = this.value.toLowerCase().trim();
                                console.log('=== 执行店铺搜索 ===');
                                console.log('搜索词:', searchTerm);
                                
                                // 获取所有店铺卡片（使用更精确的选择器，获取容器的直接子元素）
                                const shopCards = Array.from(shopsContainer.children).filter(child => child.tagName === 'DIV');
                                let visibleCount = 0;
                                
                                console.log('找到的店铺卡片数量:', shopCards.length);
                                
                                shopCards.forEach((card, index) => {
                                    // 获取卡片内的所有文本内容进行搜索
                                    const cardText = card.textContent.toLowerCase();
                                    console.log(`卡片 ${index} 文本内容: "${cardText}"`);
                                    
                                    const matchesSearch = searchTerm === '' || 
                                                        cardText.includes(searchTerm);
                                    
                                    console.log(`卡片 ${index} 匹配: ${matchesSearch}`);
                                    
                                    if (matchesSearch) {
                                        card.classList.remove('hidden');
                                        visibleCount++;
                                        
                                        // 根据是否有搜索词决定是否高亮
                                        if (searchTerm) {
                                            // 高亮显示匹配的文本
                                            highlightSearchText(card, searchTerm);
                                        } else {
                                            // 清除高亮
                                            clearSearchHighlight(card);
                                        }
                                    } else {
                                        card.classList.add('hidden');
                                        // 清除隐藏卡片的高亮
                                        clearSearchHighlight(card);
                                    }
                                });
                                
                                console.log('可见店铺数量:', visibleCount);
                                
                                // 更新空状态显示
                                if (visibleCount === 0 && searchTerm !== '') {
                                    shopsEmpty.innerHTML = `
                                        <i class="fa fa-search text-3xl mb-2"></i>
                                        <p>未找到匹配"${searchTerm}"的店铺</p>
                                    `;
                                    shopsEmpty.classList.remove('hidden');
                                } else if (shopCards.length === 0) {
                                    shopsEmpty.innerHTML = `
                                        <i class="fa fa-info-circle text-3xl mb-2"></i>
                                        <p>暂无店铺，请添加</p>
                                    `;
                                    shopsEmpty.classList.remove('hidden');
                                } else {
                                    shopsEmpty.classList.add('hidden');
                                }
                            });
                        }
                    });
                </script>
            </div>
        </div>

        <!-- Data Calculation Tab -->
        <div id="data-calculation" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                <!-- File Upload Section -->
                <div class="lg:col-span-3">
                    <div class="card">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4" style="font-size: 22px;">上传数据文件</h2>
                        <div id="drag-area" class="drag-area">
                            <div class="flex flex-col items-center justify-center">
                                <i class="fa fa-cloud-upload text-4xl text-gray-400 mb-4"></i>
                                <p class="text-gray-600 mb-2" style="color: rgb(36, 40, 43); font-size: 20px;">拖拽Excel文件到此处</p>
                                <p class="text-gray-500 text-sm mb-4" style="text-decoration: none; color: rgb(128, 128, 128); font-size: 12px; text-align: center;">温馨提示：数据仅识别字段 “商品ID”、“规格编码”、“数量”、“实收(元)”，若无法识别请修改表头标题，务必确保文字和符号完全相同！</p>
                                <label for="file-input" class="btn btn-primary cursor-pointer">
                                    <span>选择文件</span>
                                    <input type="file" id="file-input" accept=".xlsx, .xls" class="hidden">
                                </label>
                            </div>
                        </div>
                        <div id="file-info" class="mt-4 hidden">
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-md">
                                <div class="flex items-center">
                                    <i class="fa fa-file-excel-o text-success mr-2"></i>
                                    <span id="file-name" class="text-sm truncate"></span>
                                </div>
                                <button id="remove-file" class="text-gray-500 hover:text-danger">
                                    <i class="fa fa-times"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <div class="mb-4">
                                <label for="report-month" class="block text-sm font-medium text-gray-700 mb-1">报表年月</label>
                                <div class="flex space-x-2">
                                    <input type="month" id="report-month" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-100 focus:border-blue-500 transition-all duration-200 text-gray-700 flex-1">
                                    <button id="start-calculation" class="btn btn-primary flex items-center justify-center space-x-2">
                                        <i class="fa fa-calculator"></i>
                                        <span>开始计算</span>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- 新增筛选控件 -->
                            <div class="space-y-4">
                                <div>
                                    <label for="calculation-shop-filter" class="block text-sm font-medium text-gray-700 mb-1">店铺筛选</label>
                                    <div class="relative">
                                    <select id="calculation-shop-filter" class="w-full px-4 py-2 pr-8 border-2 border-gray-200 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-100 focus:border-blue-500 transition-all duration-200 appearance-none bg-white text-gray-700 cursor-pointer">
                                        <option value="">全部店铺</option>
                                        <option value="uncategorized">未分类</option>
                                    </select>
                                    <i class="fa fa-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                                </div>
                                </div>
                                
                                <div>
                                    <label for="profit-status-filter" class="block text-sm font-medium text-gray-700 mb-1">盈利状态筛选</label>
                                    <div class="relative">
                                    <select id="profit-status-filter" class="w-full px-4 py-2 pr-8 border-2 border-gray-200 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-100 focus:border-blue-500 transition-all duration-200 appearance-none bg-white text-gray-700 cursor-pointer">
                                        <option value="">全部</option>
                                        <option value="profit">盈利</option>
                                        <option value="loss">亏损</option>
                                    </select>
                                    <i class="fa fa-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                                </div>
                                </div>
                                
                                <div>
                                    <label for="product-id-search" class="block text-sm font-medium text-gray-700 mb-1">商品ID搜索</label>
                                    <div class="flex space-x-2">
                                        <input type="text" id="product-id-search" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-100 focus:border-blue-500 transition-all duration-200 text-gray-700 placeholder-gray-400 flex-1" placeholder="输入商品ID...">
                                        <button id="search-product-btn" class="btn btn-secondary flex items-center space-x-1">
                                            <i class="fa fa-search"></i>
                                            <span>搜索</span>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="flex space-x-2">
                                    <button id="apply-filters" class="btn btn-primary flex-1 flex items-center justify-center space-x-1">
                                        <i class="fa fa-filter"></i>
                                        <span>应用筛选</span>
                                    </button>
                                    <button id="clear-filters" class="btn btn-secondary flex-1 flex items-center justify-center space-x-1">
                                        <i class="fa fa-refresh"></i>
                                        <span>清除筛选</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Data Save Section -->
                    <div class="card mt-6">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-lg font-semibold text-gray-800">数据中心</h2>
                            <div class="relative" id="recycle-bin-container">
                                <button id="recycle-bin-btn" class="btn btn-secondary text-sm flex items-center justify-center" title="回收站">
                                    <i class="fa fa-trash"></i>
                                    <span id="recycle-bin-count" class="absolute -top-2 -right-2 bg-danger text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">0</span>
                                </button>
                                <div id="recycle-bin-list" class="absolute right-0 mt-2 w-80 bg-white border border-gray-200 rounded-md shadow-lg z-50 hidden">
                                    <div class="p-3 border-b border-gray-200">
                                        <h4 class="font-medium text-gray-700 flex items-center justify-between">
                                            <span>回收站</span>
                                            <button id="empty-recycle-bin" class="text-sm text-danger hover:text-danger/80">清空</button>
                                        </h4>
                                        <p class="text-xs text-gray-500">点击项目可恢复，或选择彻底删除</p>
                                    </div>
                                    <div id="recycle-bin-items" class="max-h-60 overflow-y-auto">
                                        <!-- Recycle bin items will be inserted here -->
                                    </div>
                                    <div id="recycle-bin-empty" class="p-4 text-center text-gray-500 text-sm hidden">
                                        <i class="fa fa-info-circle mb-2"></i>
                                        <p>回收站为空</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mb-4">
                            <div class="flex space-x-2 mb-4">
                                <input type="text" id="save-name" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-100 focus:border-blue-500 transition-all duration-200 text-gray-700 placeholder-gray-400 flex-1" placeholder="输入保存名称（可选）">
                                <button id="save-data" class="btn btn-primary flex items-center space-x-1" disabled="">
                                    <i class="fa fa-save"></i>
                                    <span>保存</span>
                                </button>
                            </div>
                            
                            <div class="flex space-x-2 mb-4">
                                <input type="text" id="search-saved-data" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-100 focus:border-blue-500 transition-all duration-200 text-gray-700 placeholder-gray-400 flex-1" placeholder="搜索已保存的数据...">
                                <button id="search-data-btn" class="btn btn-secondary flex items-center space-x-1">
                                    <i class="fa fa-search"></i>
                                    <span>搜索</span>
                                </button>
                            </div>
                        </div>
                        
                        <div id="saved-data-container">
                            <div id="saved-data-list" class="space-y-3">
                                <!-- Saved data items will be added here -->
                            </div>
                            
                            <div id="saved-data-empty" class="text-center py-4 text-gray-500">
                                <i class="fa fa-database text-2xl mb-2"></i>
                                <p>暂无保存的数据</p>
                            </div>
                            
                            <div id="pagination" class="mt-4 flex justify-between items-center hidden">
                                <button id="prev-page" class="btn btn-secondary text-sm" disabled="">
                                    <i class="fa fa-chevron-left"></i> 上一页
                                </button>
                                <span id="page-info" class="text-sm text-gray-600">第 1 页，共 1 页</span>
                                <button id="next-page" class="btn btn-secondary text-sm" disabled="">
                                    下一页 <i class="fa fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>


                
                <!-- Results Section -->
                <div class="lg:col-span-9">
                    <div class="card">
                        <div class="flex justify-between items-center mb-2">
                            <h2 class="text-lg font-semibold text-gray-800" style="font-size: 22px;">计算结果</h2>
                            <div class="flex items-center space-x-4">
                                <div class="relative">
                                    <select id="results-sort" class="w-full px-4 py-2 pr-8 border-2 border-gray-200 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-100 focus:border-blue-500 transition-all duration-200 appearance-none bg-white text-gray-700 cursor-pointer text-sm">
                                        <option value="profit-desc">净利润从高到低</option>
                                        <option value="profit-asc">净利润从低到高</option>
                                        <option value="quantity-desc">销量从高到低</option>
                                        <option value="quantity-asc">销量从低到高</option>
                                    </select>
                                    <i class="fa fa-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none text-xs"></i>
                                </div>
                                <button id="collapse-all" class="btn btn-secondary text-sm">
                                    <i class="fa fa-compress"></i> 全部收起
                                </button>
                                <button id="expand-all" class="btn btn-secondary text-sm">
                                    <i class="fa fa-expand"></i> 全部展开
                                </button>
                            </div>
                        </div>
                        <div class="flex justify-end items-center mb-4">
                            <div class="bg-gray-50 rounded-lg p-3 shadow-sm border border-gray-100 transition-all duration-300 hover:shadow-md">
                                <div class="flex items-center space-x-3">
                                    <div class="flex items-center space-x-2">
                                        <i class="fa fa-truck text-primary/80"></i>
                                        <label for="additional-shipping-fee" class="text-sm font-medium text-gray-700 whitespace-nowrap">快递续重费:</label>
                                    </div>
                                    <div class="relative">
                                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 text-sm">¥</span>
                                        <input type="number" id="additional-shipping-fee" class="input-field w-36 pl-16 pr-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-300" step="0.01" min="0" placeholder="0.00" style="text-indent: 10px;">
                                    </div>
                                    <button id="update-shipping-fee" class="btn btn-primary text-sm px-3 py-2 rounded-lg hover:shadow-md transform hover:-translate-y-0.5 transition-all duration-300" title="更新快递续重费">
                                        <i class="fa fa-refresh"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div id="results-container" class="space-y-4">
                            <div class="text-center py-8 text-gray-500">
                                <i class="fa fa-info-circle text-3xl mb-2"></i>
                                <p>请上传Excel文件并点击"开始计算"</p>
                            </div>
                        </div>
                    </div>
                </div>


            </div>
        </div>
        
        <!-- Cost Records Tab -->
        <div id="cost-records" class="tab-content hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-800" style="font-size: 22px;">细化成本管理</h2>
                <div class="flex items-center space-x-2">
                    <div class="relative">
                        <div class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">
                            <i class="fa fa-search"></i>
                        </div>
                        <input type="text" id="cost-search" placeholder="搜索成本项目..." class="w-64 px-4 py-2 pl-10 border-2 border-gray-200 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-100 focus:border-blue-500 transition-all duration-200 text-gray-700 placeholder-gray-400" style="padding-left: 2rem;">
                    </div>
                    <script>
                        // 为搜索框绑定输入事件
                        document.getElementById('cost-search').addEventListener('input', function() {
                            renderCostRecords();
                        });
                        
                        // 简单的tooltip功能
                        document.addEventListener('mouseover', function(e) {
                            const target = e.target;
                            if (target.hasAttribute('data-tooltip')) {
                                // 移除已存在的tooltip
                                const existingTooltip = document.querySelector('.simple-tooltip');
                                if (existingTooltip) {
                                    existingTooltip.remove();
                                }
                                
                                // 创建新的tooltip
                                const tooltip = document.createElement('div');
                                tooltip.className = 'simple-tooltip';
                                tooltip.textContent = target.getAttribute('data-tooltip');
                                tooltip.style.cssText = `
                                    position: fixed;
                                    background-color: rgba(0, 0, 0, 0.8);
                                    color: white;
                                    padding: 8px 12px;
                                    border-radius: 4px;
                                    font-size: 12px;
                                    white-space: pre-wrap;
                                    max-width: 300px;
                                    z-index: 9999;
                                    pointer-events: none;
                                    opacity: 0;
                                    transition: opacity 0.2s ease-in-out;
                                `;
                                document.body.appendChild(tooltip);
                                
                                // 显示tooltip
                                setTimeout(() => {
                                    const rect = target.getBoundingClientRect();
                                    tooltip.style.left = `${rect.left + rect.width / 2}px`;
                                    tooltip.style.top = `${rect.bottom + 10}px`;
                                    tooltip.style.transform = 'translateX(-50%)';
                                    tooltip.style.opacity = '1';
                                }, 10);
                                
                                // 鼠标离开时隐藏
                                const hideTooltip = function() {
                                    tooltip.style.opacity = '0';
                                    setTimeout(() => {
                                        if (tooltip.parentNode) {
                                            tooltip.parentNode.removeChild(tooltip);
                                        }
                                    }, 200);
                                    target.removeEventListener('mouseleave', hideTooltip);
                                };
                                
                                target.addEventListener('mouseleave', hideTooltip);
                            }
                        });
                    </script>

    <!-- Import SKU Costs Modal -->
    <div id="import-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">导入规格编码成本</h3>
                    <button id="close-import-modal" class="text-gray-400 hover:text-gray-600">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">选择Excel文件</label>
                    <div class="flex items-center space-x-2">
                        <!-- 美化的文件输入框 -->
                        <div class="relative flex-1">
                            <input type="file" id="import-file-input" accept=".xlsx, .xls" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                            <div class="flex items-center justify-between px-4 py-2 border border-gray-300 rounded-md bg-white h-10">
                                <span id="file-name-display" class="text-sm text-gray-600 truncate flex-1">未选择文件</span>
                                <div class="flex items-center space-x-2">
                                    <span class="text-xs bg-primary/10 text-primary px-2 py-1 rounded">.xlsx, .xls</span>
                                    <button id="clear-file-btn" class="text-gray-400 hover:text-gray-600 transition-colors duration-200 hidden">
                                        <i class="fa fa-times-circle"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <button id="start-import" class="btn btn-primary h-10 px-4">
                            <i class="fa fa-upload"></i> 开始导入
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">支持 .xlsx 和 .xls 格式，请确保文件包含"规格编码"和"成本"列</p>
                </div>
                
                <!-- Loading State -->
                <div id="import-loading" class="hidden mb-6">
                    <div class="flex items-center justify-center py-4">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
                        <span class="ml-3 text-gray-600">正在解析文件...</span>
                    </div>
                </div>


                
                <!-- Preview Section -->
                <div id="import-preview-section" class="mb-6 hidden">
                    <h4 class="text-md font-medium text-gray-700 mb-3">数据预览</h4>
                    <div id="import-preview" class="max-h-60 overflow-y-auto border border-gray-200 rounded-lg">
                        <!-- Preview table will be inserted here -->
                    </div>
                    <div id="import-stats" class="mt-2">
                        <!-- Stats will be inserted here -->
                    </div>
                </div>


                
                <!-- Import Mode Selection -->
                <div id="import-mode-section" class="mb-6 hidden">
                    <h4 class="text-md font-medium text-gray-700 mb-3">导入模式</h4>
                    <div class="space-y-3">
                        <label class="flex items-center space-x-2">
                            <input type="radio" name="import-mode" value="merge" checked="" class="text-primary focus:ring-primary">
                            <span class="text-sm text-gray-700">合并模式：新增不存在的规格编码，更新已存在的规格编码</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="radio" name="import-mode" value="insert" class="text-primary focus:ring-primary">
                            <span class="text-sm text-gray-700">仅新增：只添加不存在的规格编码，跳过已存在的</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="radio" name="import-mode" value="update" class="text-primary focus:ring-primary">
                            <span class="text-sm text-gray-700">仅更新：只更新已存在的规格编码，跳过不存在的</span>
                        </label>
                    </div>
                </div>


                
                <!-- Confirmation Section -->
                <div id="import-confirm-section" class="flex justify-end space-x-3 hidden">
                    <button id="cancel-import" class="btn btn-secondary">取消</button>
                    <button id="import-confirm-btn" class="btn btn-primary">
                        <i class="fa fa-check"></i> 确认导入
                    </button>
                </div>
                
                <!-- Hidden field to store import data -->
                <input type="hidden" id="import-data">
            </div>
        </div>
    </div>




                    <button id="export-cost-excel" class="btn btn-success text-sm mr-2" onclick="exportCostsToExcel()">
                        <i class="fa fa-file-excel-o"></i> 导出Excel
                    </button>
                    <button id="collapse-all-costs" class="btn btn-secondary text-sm">
                        <i class="fa fa-compress"></i> 全部收起
                    </button>
                    <button id="expand-all-costs" class="btn btn-secondary text-sm ml-2">
                        <i class="fa fa-expand"></i> 全部展开
                    </button>
                </div>
            </div>
            <div class="grid grid-cols-1 gap-6">
                <!-- Express Cost -->
                <div class="card">
                    <div class="flex justify-between items-center mb-4 cursor-pointer cost-header" data-target="express-costs-content">
                        <div class="flex items-center">
                            <i class="fa fa-chevron-down mr-2 text-gray-500 transition-transform duration-300 cost-toggle-icon"></i>
                            <h2 class="text-lg font-semibold text-gray-800">快递成本</h2>
                            <div class="flex items-center space-x-2 ml-2">
                                <i class="fa fa-cubes text-primary"></i>
                                <span id="express-count" class="text-sm font-semibold text-primary">0 项</span>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2" onclick="event.stopPropagation();">
                            <button id="add-express" class="btn btn-primary text-sm">
                                <i class="fa fa-plus"></i> 添加快递
                            </button>
                        </div>
                    </div>
                    <div id="express-costs-content" class="space-y-4 cost-content">
                        <div id="express-costs" class="space-y-4">
                            <!-- Express cost items will be added here -->
                        </div>
                    </div>
                </div>


                
                <!-- Service Fee and After-sales Labor Cost -->
                <div class="card">
                    <div class="flex justify-between items-center mb-4 cursor-pointer cost-header" data-target="platform-costs-content">
                        <div class="flex items-center">
                            <i class="fa fa-chevron-down mr-2 text-gray-500 transition-transform duration-300 cost-toggle-icon"></i>
                            <h2 class="text-lg font-semibold text-gray-800">管理成本</h2>
                            <div class="flex items-center space-x-2 ml-2">
                                <i class="fa fa-cubes text-primary"></i>
                                <span id="platform-count" class="text-sm font-semibold text-primary">0 项</span>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2" onclick="event.stopPropagation();">
                            <button id="add-platform" class="btn btn-primary text-sm">
                                <i class="fa fa-plus"></i> 添加管理
                            </button>
                        </div>
                    </div>
                    <div id="platform-costs-content" class="space-y-4 cost-content">
                        <div id="platform-costs" class="space-y-4">
                            <!-- Platform cost items will be added here -->
                        </div>
                    </div>
                </div>


                
                <!-- Packaging Cost -->
                <div class="card">
                    <div class="flex justify-between items-center mb-4 cursor-pointer cost-header" data-target="packaging-costs-content">
                        <div class="flex items-center">
                            <i class="fa fa-chevron-down mr-2 text-gray-500 transition-transform duration-300 cost-toggle-icon"></i>
                            <h2 class="text-lg font-semibold text-gray-800">包装成本</h2>
                            <div class="flex items-center space-x-2 ml-2">
                                <i class="fa fa-cubes text-primary"></i>
                                <span id="packaging-count" class="text-sm font-semibold text-primary">0 项</span>
                            </div>
                        </div>
                        <div class="flex items-center space-x-3" onclick="event.stopPropagation();">
                            <div class="relative">
                                <select id="packaging-category-filter" class="w-[120px] px-3 py-2 pr-8 border-2 border-gray-200 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-100 focus:border-blue-500 transition-all duration-200 appearance-none bg-white text-gray-700 cursor-pointer text-sm">
                                    <option value="">全部分类</option>
                                </select>
                                <i class="fa fa-chevron-down absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none text-xs"></i>
                            </div>
                            <button id="manage-packaging-categories" class="w-9 h-9 flex items-center justify-center rounded-lg bg-gradient-to-br from-gray-100 to-gray-200 border-2 border-gray-200 text-gray-600 shadow-sm hover:from-gray-200 hover:to-gray-300 hover:shadow-md transition-all duration-200" title="分类管理">
                                <i class="fa fa-cog"></i>
                            </button>
                            <button id="add-packaging" class="btn btn-primary text-sm h-9 px-3 flex items-center justify-center rounded-lg hover:bg-primary/90 transition-colors duration-200">
                                <i class="fa fa-plus mr-1"></i> 添加包装
                            </button>
                        </div>
                    </div>
                    <div id="packaging-costs-content" class="space-y-4 cost-content">
                        <div id="packaging-costs" class="space-y-4">
                            <!-- Packaging cost items will be added here -->
                        </div>
                    </div>
                </div>


                
                <!-- Product Cost -->
                <div class="card">
                    <div class="flex justify-between items-center mb-4 cursor-pointer cost-header" data-target="accessory-costs-content">
                        <div class="flex items-center">
                            <i class="fa fa-chevron-down mr-2 text-gray-500 transition-transform duration-300 cost-toggle-icon"></i>
                            <h2 class="text-lg font-semibold text-gray-800">产品成本</h2>
                            <div class="flex items-center space-x-2 ml-2">
                                <i class="fa fa-cubes text-primary"></i>
                                <span id="accessory-count" class="text-sm font-semibold text-primary">0 项</span>
                            </div>
                        </div>
                        <div class="flex items-center space-x-3" onclick="event.stopPropagation();">
                            <div class="relative">
                                <select id="accessory-category-filter" class="w-[120px] px-3 py-2 pr-8 border-2 border-gray-200 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-100 focus:border-blue-500 transition-all duration-200 appearance-none bg-white text-gray-700 cursor-pointer text-sm">
                                    <option value="">全部分类</option>
                                </select>
                                <i class="fa fa-chevron-down absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none text-xs"></i>
                            </div>
                            <button id="manage-accessory-categories" class="w-9 h-9 flex items-center justify-center rounded-lg bg-gradient-to-br from-gray-100 to-gray-200 border-2 border-gray-200 text-gray-600 shadow-sm hover:from-gray-200 hover:to-gray-300 hover:shadow-md transition-all duration-200" title="分类管理">
                                <i class="fa fa-cog"></i>
                            </button>
                            <button id="add-accessory" class="btn btn-primary text-sm h-9 px-3 flex items-center justify-center rounded-lg hover:bg-primary/90 transition-colors duration-200">
                                <i class="fa fa-plus mr-1"></i> 添加配件
                            </button>
                        </div>
                    </div>
                    <div id="accessory-costs-content" class="space-y-4 cost-content">
                        <div id="accessory-costs" class="space-y-4">
                            <!-- Accessory cost items will be added here -->
                        </div>
                    </div>
                </div>


            </div>
        </div>
        
        <!-- SKU Costs Tab -->
        <div id="sku-costs" class="tab-content hidden">
            <div class="card">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold text-gray-800" style="font-size: 22px;">规格成本管理</h2>
                    <div class="flex items-center space-x-2">
                        <div class="relative">
                            <input type="text" id="sku-search" placeholder="搜索规格编码..." class="w-64 px-4 py-2 pl-10 border-2 border-gray-200 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-100 focus:border-blue-500 transition-all duration-200 text-gray-700 placeholder-gray-400" style="padding-left: 2rem;">
                            <i class="fa fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        </div>
                        <button id="export-sku-excel" class="btn btn-success text-sm">
                            <i class="fa fa-file-excel-o"></i> 导出Excel
                        </button>                
                        <button id="import-sku-excel" class="btn btn-secondary text-sm">
                            <i class="fa fa-upload"></i> 导入Excel
                        </button>
                       <button id="add-sku" class="btn btn-primary text-sm">
                            <i class="fa fa-plus"></i> 添加规格
                        </button>
                        <button id="batch-delete-skus" class="btn btn-danger text-sm" disabled="">
                            <i class="fa fa-trash"></i> 批量删除
                        </button>
                    </div>
                </div>


                
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="overflow-x-auto max-h-[calc(100vh-300px)] overflow-y-auto" style="scrollbar-width: thin; scrollbar-color: #cbd5e1 #f1f5f9;">
                        <table class="min-w-full">
                            <thead class="sticky top-0 z-30 shadow-md bg-gradient-to-r from-blue-100 to-indigo-100">
                                <tr>
                                    <th class="px-6 py-5 bg-gradient-to-r from-blue-100 to-indigo-100 text-left text-base font-semibold text-gray-800 border-b border-gray-200">
                                        <input type="checkbox" id="select-all-skus" class="h-4 w-4 text-primary focus:ring-primary">
                                    </th>
                                    <th class="px-6 py-5 bg-gradient-to-r from-blue-100 to-indigo-100 text-left text-base font-semibold text-gray-800 border-b border-gray-200">规格编码</th>
                                    <th class="px-6 py-5 bg-gradient-to-r from-blue-100 to-indigo-100 text-right text-base font-semibold text-gray-800 border-b border-gray-200">手动成本 (元)</th>
                                    <th class="px-6 py-5 bg-gradient-to-r from-blue-100 to-indigo-100 text-right text-base font-semibold text-gray-800 border-b border-gray-200">引用成本 (元)</th>
                                    <th class="px-6 py-5 bg-gradient-to-r from-blue-100 to-indigo-100 text-right text-base font-semibold text-gray-800 border-b border-gray-200">总成本 (元)</th>
                                    <th class="px-6 py-5 bg-gradient-to-r from-blue-100 to-indigo-100 text-left text-base font-semibold text-gray-800 border-b border-gray-200">备注</th>
                                    <th class="px-6 py-5 bg-gradient-to-r from-blue-100 to-indigo-100 text-right text-base font-semibold text-gray-800 border-b border-gray-200">操作</th>
                                </tr>
                            </thead>
                            <tbody id="sku-costs-table" class="divide-y divide-gray-100">
                                <!-- SKU cost items will be added here -->
                            </tbody>
                        </table>
                    </div>
                </div>


                
                <div id="sku-costs-empty" class="text-center py-8 text-gray-500">
                    <i class="fa fa-info-circle text-3xl mb-2"></i>
                    <p>暂无规格成本数据，请添加</p>
                </div>
                
                <!-- 数量统计 -->
                <div class="mt-4 text-sm text-gray-600">
                    共 <span id="sku-count">0</span> 条规格编码记录
                </div>
            </div>
        </div>
        
        <!-- New Product Pricing Tool Tab -->
        <div id="pricing-tool" class="tab-content hidden">
            <div class="card">
                <div class="flex justify-between items-center mb-4">

                </div>
                
                <!-- Tab Navigation -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-100 mb-6 overflow-hidden">
                    <div class="flex p-1">
                        <button class="pricing-tab flex-1 py-3 px-4 text-center rounded-md transition-all duration-300 font-bold text-lg bg-blue-50 text-primary" data-pricing-tab="link-management">
                            <span class="relative inline-block" style="font-size: 24px;">
                                链接管理
                            </span>
                        </button>
                        <button class="pricing-tab flex-1 py-3 px-4 text-center rounded-md transition-all duration-300 font-bold text-lg text-gray-600 hover:text-gray-800 hover:bg-gray-50" data-pricing-tab="link-display" style="font-size: 24px;">
                            商品详细
                        </button>
                    </div>
                </div>
                
                <!-- Link Management Section -->
                <div id="link-management" class="pricing-tab-content">
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center space-x-2 flex-wrap gap-2">
                            <div class="relative flex-grow max-w-md">
                                <input type="text" id="link-search" placeholder="搜索链接或商品ID..." class="w-full px-4 py-2 pl-10 border-2 border-gray-200 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-100 focus:border-blue-500 transition-all duration-200 text-gray-700 placeholder-gray-400" style="padding-left: 2rem;">
                                <i class="fa fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                            </div>
                            <div class="flex items-center space-x-2 flex-wrap gap-2">
                                <div class="relative">
                                    <select id="link-shop-filter" class="w-40 px-4 py-2 pr-8 border-2 border-gray-200 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-100 focus:border-blue-500 transition-all duration-200 appearance-none bg-white text-gray-700 cursor-pointer">
                                        <option value="">所有店铺</option>
                                        <!-- 店铺选项将通过JavaScript动态生成 -->
                                    </select>
                                    <i class="fa fa-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                                </div>
                                <div class="relative">
                                    <select id="link-category-filter" class="w-40 px-4 py-2 pr-8 border-2 border-gray-200 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-100 focus:border-blue-500 transition-all duration-200 appearance-none bg-white text-gray-700 cursor-pointer">
                                        <!-- 分类选项将通过JavaScript动态生成 -->
                                    </select>
                                    <i class="fa fa-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                                </div>
                                <button id="manage-categories" class="w-10 h-10 flex items-center justify-center rounded-lg bg-gradient-to-br from-gray-100 to-gray-200 border-2 border-gray-200 text-gray-600 shadow-sm hover:from-gray-200 hover:to-gray-300 hover:shadow-md transition-all duration-200" onclick="openPricingCategoryModal()" title="分类管理">
                                    <i class="fa fa-cog"></i>
                                </button>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button id="add-link" class="btn btn-primary" onclick="openAddLinkModal()">
                                <i class="fa fa-plus"></i> 新增链接
                            </button>
                            <button id="collapse-all-links" class="btn btn-secondary" onclick="collapseAllLinks()">
                                <i class="fa fa-compress"></i> 全部收起
                            </button>
                            <button id="expand-all-links" class="btn btn-secondary" onclick="expandAllLinks()">
                                <i class="fa fa-expand"></i> 全部展开
                            </button>
                        </div>
                    </div>
                    
                    <div id="links-container" class="space-y-4">
                        <!-- Link cards will be added here -->
                    </div>
                    
                    <div id="links-empty" class="text-center py-8 text-gray-500">
                        <i class="fa fa-info-circle text-3xl mb-2"></i>
                        <p>暂无链接，请添加</p>
                    </div>
                    
                </div>
                
                <!-- Link Display Section -->
                <div id="link-display" class="pricing-tab-content hidden">
                    <div id="display-links-container" class="space-y-6">
                        <!-- Display link cards will be added here -->
                    </div>
                    
                    <div id="display-links-empty" class="text-center py-8 text-gray-500">
                        <i class="fa fa-info-circle text-3xl mb-2"></i>
                        <p>暂无链接可展示</p>
                    </div>
                </div>
                



                <!-- 编辑商品模态框 -->
                
            </div>
        </div>
        
        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-6">
                <!-- Total Profit Card -->
                <div class="bg-white rounded-xl shadow-card border border-gray-100 hover:shadow-lg transition-all-300 overflow-hidden">
                    <div class="p-4">
                        <div class="flex items-center mb-3">
                            <div class="mr-3">
                                <img src="https://p11-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/6b20d9cc66804f5893bca25ac10af836.png~tplv-a9rns2rl98-24:720:720.png?lk3s=8e244e95&amp;rcl=20260131014505FA1E3826EF42B12FAECE&amp;rrcfp=8a172a1a&amp;x-expires=1770399905&amp;x-signature=zv4DIIR%2BcwVgSHFVNf%2B9lwhTv4E%3D" alt="利润图标" class="w-8 h-8 transition-transform duration-300 hover:scale-110">
                            </div>
                            <h3 class="text-base font-semibold text-gray-700">总净利润</h3>
                        </div>
                        <div class="mb-3">
                            <p id="total-profit" class="text-3xl font-bold text-gray-800">¥0.00</p>
                        </div>
                        <div class="flex items-center justify-between text-xs">
                            <span class="text-gray-400">较上期</span>
                            <span id="profit-change" class="flex items-center text-success">
                                <i class="fa fa-arrow-up mr-1"></i>
                                <span>0.00%</span>
                            </span>
                        </div>
                    </div>
                </div>


                
                <!-- Total Quantity Card -->
                <div class="bg-white rounded-xl shadow-card border border-gray-100 hover:shadow-lg transition-all-300 overflow-hidden">
                    <div class="p-4">
                        <div class="flex items-center mb-3">
                            <div class="mr-3">
                                <img src="https://p11-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/52ee37bba3964c00a3d5c6075faaee16.png~tplv-a9rns2rl98-24:720:720.png?lk3s=8e244e95&amp;rcl=2026013101462102A99EA93DCDD2296CD6&amp;rrcfp=8a172a1a&amp;x-expires=1770399981&amp;x-signature=8eVQBrPJkoNFrmiF5fkZEfVdSgg%3D" alt="销售数量图标" class="w-8 h-8 transition-transform duration-300 hover:scale-110">
                            </div>
                            <h3 class="text-base font-semibold text-gray-700">总销售数量</h3>
                        </div>
                        <div class="mb-3">
                            <p id="total-quantity" class="text-3xl font-bold text-gray-800">0</p>
                        </div>
                        <div class="flex items-center justify-between text-xs">
                            <span class="text-gray-400">较上期</span>
                            <span id="quantity-change" class="flex items-center text-success">
                                <i class="fa fa-arrow-up mr-1"></i>
                                <span>0.00%</span>
                            </span>
                        </div>
                    </div>
                </div>


                
                <!-- Total Revenue Card -->
                <div class="bg-white rounded-xl shadow-card border border-gray-100 hover:shadow-lg transition-all-300 overflow-hidden">
                    <div class="p-4">
                        <div class="flex items-center mb-3">
                            <div class="mr-3">
                                <img src="https://p3-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/38615d74888c451c87a897887fc5fef7.png~tplv-a9rns2rl98-24:720:720.png?lk3s=8e244e95&amp;rcl=2026013101470718A5718339CB19296A02&amp;rrcfp=8a172a1a&amp;x-expires=1770400027&amp;x-signature=gPwEM7YzKysT%2Fms%2BoVdPBHyGOi0%3D" alt="实收金额图标" class="w-8 h-8 transition-transform duration-300 hover:scale-110">
                            </div>
                            <h3 class="text-base font-semibold text-gray-700">总实收金额</h3>
                        </div>
                        <div class="mb-3">
                            <p id="total-revenue" class="text-3xl font-bold text-gray-800">¥0.00</p>
                        </div>
                        <div class="flex items-center justify-between text-xs">
                            <span class="text-gray-400">较上期</span>
                            <span id="revenue-change" class="flex items-center text-success">
                                <i class="fa fa-arrow-up mr-1"></i>
                                <span>0.00%</span>
                            </span>
                        </div>
                    </div>
                </div>


                
                <!-- Total Express Fee Card -->
                <div class="bg-white rounded-xl shadow-card border border-gray-100 hover:shadow-lg transition-all-300 overflow-hidden">
                    <div class="p-4">
                        <div class="flex items-center mb-3">
                            <div class="mr-3">
                                <img src="https://p11-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/e65ace37d46645dfb00c6aceeabefcf2.png~tplv-a9rns2rl98-24:720:720.png?lk3s=8e244e95&amp;rcl=2026013101554729BDB7DFD926E532DAE4&amp;rrcfp=8a172a1a&amp;x-expires=1770400547&amp;x-signature=JweCyvEHuAGwpLGuN7vI1zjlQ7M%3D" alt="快递续重费图标" class="w-8 h-8 transition-transform duration-300 hover:scale-110">
                            </div>
                            <h3 class="text-base font-semibold text-gray-700">总快递续重费</h3>
                        </div>
                        <div class="mb-3">
                            <p id="total-express-fee" class="text-3xl font-bold text-gray-800">¥0.00</p>
                        </div>
                        <div class="flex items-center justify-between text-xs">
                            <span class="text-gray-400">较上期</span>
                            <span id="express-fee-change" class="flex items-center text-danger">
                                <i class="fa fa-arrow-down mr-1"></i>
                                <span>0.00%</span>
                            </span>
                        </div>
                    </div>
                </div>


                
                <!-- Total Advertising Fee Card -->
                <div class="bg-white rounded-xl shadow-card border border-gray-100 hover:shadow-lg transition-all-300 overflow-hidden">
                    <div class="p-4">
                        <div class="flex items-center mb-3">
                            <div class="mr-3">
                                <img src="https://p11-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/deda26f3d90946e89be090736a1e28d4.png~tplv-a9rns2rl98-24:720:720.png?lk3s=8e244e95&amp;rcl=202601310152490EF7FE52D1ACE52ABE37&amp;rrcfp=8a172a1a&amp;x-expires=1770400369&amp;x-signature=izc9NAEvzy1EOF3iB37HWiPsRQ0%3D" alt="广告费图标" class="w-8 h-8 transition-transform duration-300 hover:scale-110">
                            </div>
                            <h3 class="text-base font-semibold text-gray-700">总广告费</h3>
                        </div>
                        <div class="mb-3">
                            <p id="total-advertising" class="text-3xl font-bold text-gray-800">¥0.00</p>
                        </div>
                        <div class="flex items-center justify-between text-xs">
                            <span class="text-gray-400">较上期</span>
                            <span id="advertising-change" class="flex items-center text-danger">
                                <i class="fa fa-arrow-down mr-1"></i>
                                <span>0.00%</span>
                            </span>
                        </div>
                    </div>
                </div>


            </div>
            
            <!-- Shop Stats Cards -->
            <div id="shop-stats-container" class="mb-6">
                <div class="card">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-semibold text-gray-800" style="font-size: 20px;">店铺数据统计</h2>
                        <div class="relative">
                        <select id="shop-filter" class="w-36 px-4 py-2 pr-8 border-2 border-gray-200 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-100 focus:border-blue-500 transition-all duration-200 appearance-none bg-white text-gray-700 cursor-pointer text-sm">
                            <option value="">全部店铺</option>
                        </select>
                        <i class="fa fa-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none text-xs"></i>
                    </div>
                    </div>
                    <div id="shop-stats-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <!-- Shop stats cards will be added here -->
                    </div>
                </div>


            </div>
            

            
            <!-- Product Ranking -->
            <div class="bg-white rounded-xl shadow-lg border border-gray-200 mt-6 overflow-hidden transition-all duration-300 hover:shadow-xl">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center p-6 border-b border-gray-100">
                    <div class="flex items-center mb-4 md:mb-0">
                        <div class="bg-gradient-to-r from-yellow-400 to-orange-500 text-white w-10 h-10 flex items-center justify-center rounded-md shadow-md mr-3">
                            <i class="fa fa-trophy text-xl"></i>
                        </div>
                        <h2 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-gray-800 to-gray-600">商品排行榜</h2>
                    </div>
                    <div class="flex items-center space-x-3 w-full md:w-auto">
                        <div class="relative w-full md:w-auto">
                        <select id="ranking-sort" class="w-full md:w-auto px-4 py-2 pr-8 border-2 border-gray-200 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-100 focus:border-blue-500 transition-all duration-200 appearance-none bg-white text-gray-700 cursor-pointer">
                            <option value="profit-desc">净利润从高到低</option>
                            <option value="profit-asc">净利润从低到高</option>
                            <option value="quantity-desc">销量从高到低</option>
                            <option value="revenue-desc">收入从高到低</option>
                            <option value="profit-rate-desc">毛利率从高到低</option>
                        </select>
                        <i class="fa fa-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                        </div>
                        <div class="relative w-full md:w-auto">
                        <select id="ranking-limit" class="w-full md:w-auto px-4 py-2 pr-8 border-2 border-gray-200 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-100 focus:border-blue-500 transition-all duration-200 appearance-none bg-white text-gray-700 cursor-pointer">
                            <option value="10">显示前10名</option>
                            <option value="20">显示前20名</option>
                            <option value="50">显示前50名</option>
                            <option value="all">显示全部</option>
                        </select>
                        <i class="fa fa-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                        </div>
                    </div>
                </div>


                
                <div class="overflow-x-auto overflow-y-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="sticky top-0 z-10">
                            <tr class="bg-gradient-to-r from-gray-50 to-gray-100">
                                <th class="px-6 py-4 text-left text-sm font-bold text-gray-700 uppercase tracking-wider border-b-2 border-gray-200">排名</th>
                                <th class="px-6 py-4 text-left text-sm font-bold text-gray-700 uppercase tracking-wider border-b-2 border-gray-200">商品ID</th>
                                <th class="px-6 py-4 text-left text-sm font-bold text-gray-700 uppercase tracking-wider border-b-2 border-gray-200">所属店铺</th>
                                <th class="px-6 py-4 text-left text-sm font-bold text-gray-700 uppercase tracking-wider border-b-2 border-gray-200">销量</th>
                                <th class="px-6 py-4 text-left text-sm font-bold text-gray-700 uppercase tracking-wider border-b-2 border-gray-200">收入 (元)</th>
                                <th class="px-6 py-4 text-left text-sm font-bold text-gray-700 uppercase tracking-wider border-b-2 border-gray-200">净利润 (元)</th>
                                <th class="px-6 py-4 text-left text-sm font-bold text-gray-700 uppercase tracking-wider border-b-2 border-gray-200">毛利率</th>
                                <th class="px-6 py-4 text-left text-sm font-bold text-gray-700 uppercase tracking-wider border-b-2 border-gray-200">操作</th>
                            </tr>
                        </thead>
                        <tbody id="ranking-table" class="bg-white divide-y divide-gray-100">
                            <!-- Ranking items will be added here -->
                        </tbody>
                    </table>
                </div>
                
                <div id="ranking-empty" class="text-center py-8 text-gray-500">
                    <i class="fa fa-trophy text-3xl mb-2"></i>
                    <p>暂无数据，请先上传Excel文件并计算</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Edit Spec Note Modal -->
    <div id="edit-spec-note-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="border-b border-gray-200 px-6 py-4 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-900">编辑规格备注</h3>
                <button type="button" class="text-gray-400 hover:text-gray-500" onclick="closeSpecNoteModal()">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="px-6 py-4">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">规格信息</label>
                    <div id="spec-note-info" class="text-sm text-gray-600"></div>
                </div>
                <div class="mb-4">
                    <label for="spec-color-picker" class="block text-sm font-medium text-gray-700 mb-1">SKU颜色标记</label>
                    <div class="flex items-center space-x-3">
                        <input type="color" id="spec-color-picker" class="w-10 h-10 rounded border-0 cursor-pointer" value="#9ca3af">
                        <span id="color-preview" class="text-sm text-gray-600">选择颜色</span>
                    </div>
                </div>
                <div class="mb-4">
                    <label for="spec-note-content" class="block text-sm font-medium text-gray-700 mb-1">备注内容</label>
                    <textarea id="spec-note-content" rows="4" class="input-field w-full text-sm" placeholder="请输入备注内容"></textarea>
                </div>
            </div>
            <div class="border-t border-gray-200 px-6 py-4 flex justify-end space-x-3">
                <button type="button" class="btn btn-secondary" onclick="closeSpecNoteModal()">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveSpecNote()">保存</button>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Add SKU Modal -->
    <!-- 新增链接模态框 -->
    <div id="add-link-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden" style="z-index: 9999; position: fixed; top: 0; left: 0; right: 0; bottom: 0;">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="border-b border-gray-200 px-6 py-4">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-900">新增链接</h3>
                    <button type="button" onclick="closeAddLinkModal()" class="text-gray-400 hover:text-gray-500">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
            </div>
            <form id="add-link-form" class="px-6 py-4">
                <div class="mb-4">
                    <label for="add-link-name" class="block text-sm font-medium text-gray-700 mb-1">
                        链接名称 <span class="text-danger">*</span>
                    </label>
                    <input type="text" id="add-link-name" class="input-field w-full" placeholder="请输入链接名称">
                </div>
                <div class="mb-4">
                    <label for="add-link-category" class="block text-sm font-medium text-gray-700 mb-1">
                        分类
                    </label>
                    <select id="add-link-category" class="input-field w-full">
                        <option value="electronics">电子产品</option>
                        <option value="clothing">服装</option>
                        <option value="home">家居</option>
                        <option value="other">其他</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label for="add-link-note" class="block text-sm font-medium text-gray-700 mb-1">
                        备注
                    </label>
                    <textarea id="add-link-note" class="input-field w-full" rows="2" placeholder="请输入备注（可选）"></textarea>
                </div>
                
                <div class="flex items-center justify-end space-x-3">
                    <button type="button" onclick="closeAddLinkModal()" class="btn btn-secondary">
                        取消
                    </button>
                    <button type="button" onclick="saveAddLink()" class="btn btn-primary">
                        保存
                    </button>
                </div>
            </form>
        </div>
    </div>
    <!-- 导出字段选择模态框 -->
    <div id="export-fields-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">选择导出字段</h3>
                    <button class="text-gray-400 hover:text-gray-600 close-modal" data-modal="export-fields-modal">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
                <div class="mb-4">
                    <label class="flex items-center space-x-2 mb-2">
                        <input type="checkbox" id="export-include-ref-costs" class="rounded text-primary focus:ring-primary">
                        <span class="text-sm font-medium text-gray-700">包含引用成本项目</span>
                    </label>
                    <p class="text-xs text-gray-500">选择后将在导出文件中包含每个规格编码关联的引用成本项目</p>
                </div>
                <div class="space-y-2">
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" class="export-field-checkbox rounded text-primary focus:ring-primary" value="skuCode" checked="">
                        <span class="text-sm font-medium text-gray-700">规格编码</span>
                    </label>
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" class="export-field-checkbox rounded text-primary focus:ring-primary" value="manualCost" checked="">
                        <span class="text-sm font-medium text-gray-700">手动成本</span>
                    </label>
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" class="export-field-checkbox rounded text-primary focus:ring-primary" value="referenceCost" checked="">
                        <span class="text-sm font-medium text-gray-700">引用成本</span>
                    </label>
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" class="export-field-checkbox rounded text-primary focus:ring-primary" value="totalCost" checked="">
                        <span class="text-sm font-medium text-gray-700">总成本</span>
                    </label>
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" class="export-field-checkbox rounded text-primary focus:ring-primary" value="note">
                        <span class="text-sm font-medium text-gray-700">备注</span>
                    </label>

                </div>
                <div class="mt-6 flex space-x-3">
                    <button id="select-all-fields" class="btn btn-secondary text-sm flex-1">
                        <i class="fa fa-check-square-o"></i> 全选
                    </button>
                    <button id="select-none-fields" class="btn btn-secondary text-sm flex-1">
                        <i class="fa fa-square-o"></i> 全不选
                    </button>
                </div>
                <div class="mt-4 flex space-x-3">
                    <button class="btn btn-secondary text-sm flex-1 close-modal" data-modal="export-fields-modal">
                        取消
                    </button>
                    <button id="confirm-export" class="btn btn-primary text-sm flex-1">
                        <i class="fa fa-file-excel-o"></i> 确认导出
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="add-sku-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 w-full max-w-xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800">添加规格成本</h3>
                <button class="close-modal text-gray-500 hover:text-gray-700">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <form id="add-sku-form">
                <div class="mb-4">
                    <label for="sku-code" class="block text-sm font-medium text-gray-700 mb-1">规格编码</label>
                    <input type="text" id="sku-code" class="input-field" required="">
                </div>
                <div class="mb-4">
                    <label for="sku-cost" class="block text-sm font-medium text-gray-700 mb-1">手动填写成本 (元)</label>
                    <input type="number" id="sku-cost" class="input-field" step="0.01" min="0" value="0">
                </div>
                
                <!-- 引用成本项目区域 -->
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-sm font-medium text-gray-700">引用成本项目</label>
                        <button type="button" id="add-referenced-cost" class="btn btn-sm btn-secondary flex items-center space-x-1">
                            <i class="fa fa-plus"></i>
                            <span>添加项目</span>
                        </button>
                    </div>
                    <div id="referenced-costs-container" class="space-y-2 max-h-60 overflow-y-auto pr-2" style="scrollbar-width: thin; scrollbar-color: #cbd5e1 #f1f5f9;">
                        <!-- 引用的成本项目将在这里动态添加 -->
                    </div>
                </div>


                
                <!-- 总成本预览 -->
                <div class="mb-4 p-3 bg-blue-50 rounded-md">
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-medium text-blue-800">总成本预览:</span>
                        <span id="total-cost-preview" class="text-lg font-bold text-blue-800">¥0.00</span>
                    </div>
                </div>


                
                <div class="mb-4">
                    <label for="sku-note" class="block text-sm font-medium text-gray-700 mb-1">备注</label>
                    <textarea id="sku-note" class="input-field" rows="2"></textarea>
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" class="btn btn-secondary close-modal">取消</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Cost Modal (for express, packaging, platform, accessory) -->
    <div id="add-cost-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 w-full max-w-xl">
            <div class="flex justify-between items-center mb-4">
                <h3 id="cost-modal-title" class="text-lg font-semibold text-gray-800">添加管理项目</h3>
                <button class="close-modal text-gray-500 hover:text-gray-700">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <form id="add-cost-form">
                <input type="hidden" id="cost-type">
                <div class="mb-4">
                    <label id="cost-name-label" for="cost-name" class="block text-sm font-medium text-gray-700 mb-1">包装名称</label>
                    <input type="text" id="cost-name" class="input-field" required="">
                </div>
                <div id="cost-category-container" class="mb-4 hidden">
                    <label for="cost-category" class="block text-sm font-medium text-gray-700 mb-1">分类</label>
                    <select id="cost-category" class="input-field">
                        <option value="">无分类</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label for="cost-unit" class="block text-sm font-medium text-gray-700 mb-1">单位</label>
                    <select id="cost-unit" class="input-field">
                        <option value="">请选择单位</option>
                        <option value="个">个</option>
                        <option value="件">件</option>
                        <option value="只">只</option>
                        <option value="支">支</option>
                        <option value="张">张</option>
                        <option value="颗">颗</option>
                        <option value="粒">粒</option>
                        <option value="枚">枚</option>
                        <option value="本">本</option>
                        <option value="台">台</option>
                        <option value="部">部</option>
                        <option value="套">套</option>
                        <option value="副">副</option>
                        <option value="包">包</option>
                        <option value="袋">袋</option>
                        <option value="盒">盒</option>
                        <option value="瓶">瓶</option>
                        <option value="罐">罐</option>
                        <option value="桶">桶</option>
                        <option value="管">管</option>
                        <option value="听">听</option>
                        <option value="箱">箱</option>
                        <option value="捆">捆</option>
                        <option value="扎">扎</option>
                        <option value="单">单</option>
                        <option value="份">份</option>
                        <option value="批">批</option>
                        <option value="卡">卡</option>
                        <option value="片">片</option>
                        <option value="斤">斤</option>
                        <option value="两">两</option>
                        <option value="米(m)">米(m)</option>
                        <option value="厘米(cm)">厘米(cm)</option>
                        <option value="平方米(㎡)">平方米(㎡)</option>
                        <option value="平方厘米(cm²)">平方厘米(cm²)</option>
                        <option value="斗">斗</option>
                        <option value="升(L)">升(L)</option>
                        <option value="克(g)">克(g)</option>
                        <option value="千克(kg)">千克(kg)</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label for="cost-amount" class="block text-sm font-medium text-gray-700 mb-1">金额 (元)</label>
                    <input type="number" id="cost-amount" class="input-field" step="0.01" min="0" required="">
                </div>
                <div class="mb-4">
                    <label for="cost-note" class="block text-sm font-medium text-gray-700 mb-1">备注</label>
                    <textarea id="cost-note" class="input-field" rows="2"></textarea>
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" class="btn btn-secondary close-modal">取消</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Cost Category Management Modal -->
    <div id="category-management-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 w-full max-w-xl">
            <div class="flex justify-between items-center mb-4">
                <h3 id="category-modal-title" class="text-lg font-semibold text-gray-800">分类管理</h3>
                <button class="close-modal text-gray-500 hover:text-gray-700">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="mb-4">
                <div class="flex space-x-2 items-center">
                    <input type="text" id="cost-category-name" class="input-field flex-1" placeholder="输入新分类名称">
                    <input type="color" id="cost-category-color" class="w-10 h-10 rounded border-0 cursor-pointer" value="#3B82F6">
                    <button id="add-category" class="btn btn-primary">
                        <i class="fa fa-plus"></i> 添加
                    </button>
                </div>
            </div>
            <div id="categories-list" class="max-h-60 overflow-y-auto">
                <!-- Categories will be added here -->
            </div>
            <div class="flex justify-end mt-4">
                <button class="btn btn-secondary close-modal">关闭</button>
            </div>
        </div>
    </div>
    <!-- Pricing Category Management Modal -->
    <div id="pricing-category-management-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 w-full max-w-xl">
            <div class="flex justify-between items-center mb-4">
                <h3 id="category-modal-title" class="text-lg font-semibold text-gray-800">分类管理</h3>
                <button class="close-modal text-gray-500 hover:text-gray-700">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="mb-4">
                <div class="flex space-x-2 items-center">
                    <input type="text" id="cost-category-name" class="input-field flex-1" placeholder="输入新分类名称">
                    <input type="color" id="cost-category-color" class="w-10 h-10 rounded border-0 cursor-pointer" value="#3B82F6">
                    <button id="add-category" class="btn btn-primary">
                        <i class="fa fa-plus"></i> 添加
                    </button>
                </div>
            </div>
            <div id="categories-list" class="max-h-60 overflow-y-auto">
                <!-- Categories will be added here -->
            </div>
            <div class="flex justify-end mt-4">
                <button class="btn btn-secondary close-modal">关闭</button>
            </div>
        </div>
    </div>

    <!-- Add Product to Link Modal -->
    <div id="add-product-to-link-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-md">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">添加商品</h3>
                    <button onclick="closeAddProductToLinkModal()" class="text-gray-400 hover:text-gray-600 p-1 rounded-full hover:bg-gray-100 transition-colors">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
                <form id="add-product-form">
                    <div class="mb-4">
                        <label for="product-id-input" class="block text-sm font-medium text-gray-700 mb-1">商品ID <span class="text-danger">*</span></label>
                        <input type="text" id="product-id-input" class="input-field w-full" placeholder="请输入商品ID" required="">
                    </div>
                    <div class="mb-4">
                        <label for="product-note-input" class="block text-sm font-medium text-gray-700 mb-1">备注信息</label>
                        <textarea id="product-note-input" class="input-field w-full" rows="3" placeholder="请输入备注信息（可选）"></textarea>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" onclick="closeAddProductToLinkModal()" class="btn btn-secondary">取消</button>
                        <button type="submit" class="btn btn-primary">确定添加</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Shop Modal -->
    <!-- 删除确认模态框 -->
    <div id="delete-confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden" style="z-index: 1001;">
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
            <div class="text-center mb-6">
                <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-red-100 text-red-500 mb-4">
                    <i class="fa fa-exclamation-triangle text-2xl"></i>
                </div>
                <h3 id="delete-modal-title" class="text-xl font-semibold text-gray-800 mb-2">确认删除</h3>
                <p id="delete-modal-message" class="text-gray-600">您确定要执行此删除操作吗？此操作无法撤销。</p>
            </div>
            <div class="flex justify-center space-x-4">
                <button id="delete-cancel-btn" class="btn btn-secondary px-6 py-2">
                    取消
                </button>
                <button id="delete-confirm-btn" class="btn btn-danger px-6 py-2">
                    确认删除
                </button>
            </div>
        </div>
    </div>

    <div id="add-shop-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-9 w-full max-w-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 id="shop-modal-title" class="text-lg font-semibold text-gray-800">添加店铺</h3>
                <button class="close-modal text-gray-500 hover:text-gray-700">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <form id="add-shop-form">
                <input type="hidden" id="shop-id">
                <div class="mb-4">
                    <label for="shop-name" class="block text-sm font-medium text-gray-700 mb-1">店铺名称</label>
                    <input type="text" id="shop-name" class="input-field" required="">
                </div>
                <div class="mb-4">
                    <label for="shop-display-id" class="block text-sm font-medium text-gray-700 mb-1">店铺ID</label>
                    <input type="text" id="shop-display-id" class="input-field" placeholder="请输入店铺显示ID">
                </div>
                <div class="mb-4">
                    <label for="shop-products" class="block text-sm font-medium text-gray-700 mb-1">商品ID（每行一个）</label>
                    <textarea id="shop-products" class="input-field" rows="6" placeholder="请输入商品ID，每行一个"></textarea>
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" class="btn btn-secondary close-modal">取消</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-4 right-4 bg-white rounded-lg shadow-lg p-4 max-w-sm transform translate-y-10 opacity-0 transition-all duration-300 z-50 hidden">
        <div class="flex items-start">
            <div id="toast-icon" class="flex-shrink-0 text-success mr-3">
                <i class="fa fa-check-circle text-xl"></i>
            </div>
            <div class="flex-1">
                <h4 id="toast-title" class="text-sm font-medium text-gray-800"></h4>
                <p id="toast-message" class="text-sm text-gray-600 mt-1"></p>
            </div>
            <button id="close-toast" class="text-gray-400 hover:text-gray-600 ml-4">
                <i class="fa fa-times"></i>
            </button>
        </div>
    </div>

    <script>
        // 全局变量
        let excelData = [];
        let productData = [];
        let skuCosts = {};
        let costCategories = {
            packaging: [],
            accessory: []
        };
        let costRecords = {
            express: [],
            packaging: [],
            platform: [],
            accessory: []
        };
        
        // 动态定位悬浮窗 - 完全重写的解决方案
        document.addEventListener('DOMContentLoaded', function() {
            // 获取所有tooltip容器
            const tooltipContainers = document.querySelectorAll('.tooltip-container');
            
            // 为每个容器添加事件监听
            tooltipContainers.forEach(container => {
                // 获取悬浮窗和箭头元素
                const tooltip = container.querySelector('.tooltip-content');
                const arrow = container.querySelector('.tooltip-arrow');
                
                if (tooltip && arrow) {
                    // 鼠标进入时显示悬浮窗
                    container.addEventListener('mouseenter', function(e) {
                        // 确保使用fixed定位
                        tooltip.style.position = 'fixed';
                        tooltip.style.zIndex = '9999';
                        tooltip.style.transform = 'none';
                        tooltip.style.margin = '0';
                        
                        // 立即定位到鼠标位置
                        updateTooltipPosition(e);
                    });
                    
                    // 鼠标移动时更新位置
                    container.addEventListener('mousemove', updateTooltipPosition);
                    
                    // 鼠标离开时隐藏悬浮窗
                    container.addEventListener('mouseleave', function() {
                        tooltip.style.opacity = '0';
                        tooltip.style.visibility = 'hidden';
                        arrow.style.opacity = '0';
                        arrow.style.visibility = 'hidden';
                    });
                }
                
                // 更新悬浮窗位置的函数
                function updateTooltipPosition(e) {
                    // 强制更新位置，确保始终基于当前鼠标坐标
                    tooltip.style.left = (e.clientX - 40) + 'px'; // 调整水平偏移
                    tooltip.style.top = (e.clientY + 15) + 'px';  // 调整垂直偏移，确保在鼠标下方
                    
                    // 确保箭头位置正确
                    arrow.style.left = '10px';
                    
                    // 显示悬浮窗
                    tooltip.style.opacity = '1';
                    tooltip.style.visibility = 'visible';
                    arrow.style.opacity = '1';
                    arrow.style.visibility = 'visible';
                }
            });
        });

        let shops = JSON.parse(localStorage.getItem('shops')) || [];
        // 从localStorage加载数据，使用LZ-String解压缩
        let savedData = [];
        try {
            const compressedData = localStorage.getItem('savedData');
            if (compressedData) {
                console.log('找到保存的数据，大小:', compressedData.length, '字符');
                
                // 尝试使用标准的decompress方法
                let decompressedData = LZString.decompress(compressedData);
                
                // 如果失败，尝试使用其他方法
                if (!decompressedData) {
                    console.log('尝试使用decompressFromUTF16方法解压');
                    decompressedData = LZString.decompressFromUTF16(compressedData);
                }
                
                if (decompressedData) {
                    savedData = JSON.parse(decompressedData);
                    console.log('数据解压成功，包含', savedData.length, '条记录');
                } else {
                    console.warn('数据解压失败，尝试直接解析');
                    // 尝试直接解析（可能是未压缩的数据）
                    try {
                        savedData = JSON.parse(compressedData);
                        console.log('直接解析成功，包含', savedData.length, '条记录');
                    } catch (parseError) {
                        console.error('直接解析也失败:', parseError);
                        savedData = [];
                    }
                }
            } else {
                console.log('未找到保存的数据');
            }
        } catch (error) {
            console.error('加载保存数据时发生错误:', error);
            console.error('错误详情:', error.stack);
            savedData = [];
        }
        // 加载回收站数据
        let recycleBin = [];
        try {
            const recycleBinData = localStorage.getItem('recycleBin');
            if (recycleBinData) {
                recycleBin = JSON.parse(recycleBinData);
                console.log('回收站数据加载成功，包含', recycleBin.length, '条记录');
            }
        } catch (error) {
            console.error('加载回收站数据失败:', error);
            recycleBin = [];
        }
        let currentPage = 1;
        let itemsPerPage = 20;
        let filteredSavedData = [];
        
        // 全局变量，用于跟踪当前是否处于编辑模式
        let isEditMode = false;
        let currentEditIndex = -1;
        let currentEditCostType = '';
        
        // 添加成本表单提交处理函数
        function handleAddCostSubmit(e) {
            e.preventDefault();
            
            const costType = document.getElementById('cost-type').value;
            const costName = document.getElementById('cost-name').value.trim();
            const costAmount = parseFloat(document.getElementById('cost-amount').value);
            const costNote = document.getElementById('cost-note').value.trim();
            const costCategory = (costType === 'packaging' || costType === 'accessory') ? 
                document.getElementById('cost-category').value : '';
            const costUnit = document.getElementById('cost-unit').value || '';
            
            if (!costName || isNaN(costAmount)) {
                showToast('错误', '请填写有效的名称和金额', 'error');
                return;
            }
            
            if (isEditMode && currentEditIndex !== -1 && currentEditCostType) {
                // 验证编辑模式的状态
                if (!['express', 'packaging', 'platform', 'accessory'].includes(currentEditCostType)) {
                    showToast('错误', '编辑的成本类型无效', 'error');
                    // 重置编辑模式状态
                    isEditMode = false;
                    currentEditIndex = -1;
                    currentEditCostType = '';
                    return;
                }
                
                // 验证索引是否有效
                if (currentEditIndex < 0 || currentEditIndex >= costRecords[currentEditCostType].length) {
                    showToast('错误', '编辑的项目索引无效', 'error');
                    // 重置编辑模式状态
                    isEditMode = false;
                    currentEditIndex = -1;
                    currentEditCostType = '';
                    return;
                }
                
                console.log(`编辑项目: ${currentEditCostType}[${currentEditIndex}]`);
                
                // 编辑模式：检查是否存在重复名称（排除当前编辑的项目）
                const isDuplicate = costRecords[currentEditCostType].some((item, index) => 
                    index !== currentEditIndex && 
                    item.name.toLowerCase().trim() === costName.toLowerCase().trim()
                );
                
                if (isDuplicate) {
                    showToast('错误', `已存在名为"${costName}"的成本项目`, 'error');
                    return;
                }
                
                // 更新现有项目
                const existingItem = costRecords[currentEditCostType][currentEditIndex];
                costRecords[currentEditCostType][currentEditIndex] = {
                    name: costName,
                    amount: costAmount,
                    note: costNote,
                    category: costCategory,
                    unit: costUnit,
                    id: existingItem.id,
                    createdAt: existingItem.createdAt || new Date().toISOString(),
                    updatedAt: new Date().toISOString() // 添加更新时间
                };
                
                console.log(`项目已更新: ${currentEditCostType}[${currentEditIndex}]`);
                
                // 如果有新的分类，添加到分类列表中
                if (costCategory && costCategory.trim() !== '') {
                    if (!costCategories[currentEditCostType].includes(costCategory.trim())) {
                        costCategories[currentEditCostType].push(costCategory.trim());
                    }
                }
                
                showToast('成功', '成本记录已更新', 'success');
                
                // 重置编辑模式状态
                isEditMode = false;
                currentEditIndex = -1;
                currentEditCostType = '';
            } else {
                // 添加模式：创建新项目
                // 获取用户实际选择的成本类型
                const userSelectedType = document.getElementById('cost-type').value;
                
                // 验证成本类型是否有效
                if (!userSelectedType || !['express', 'packaging', 'platform', 'accessory'].includes(userSelectedType)) {
                    showToast('错误', '成本类型无效', 'error');
                    return;
                }
                
                // 使用用户选择的类型
                const targetCostType = userSelectedType;
                
                console.log(`添加新项目到类型: ${targetCostType}`);
                
                // 检查是否存在重复名称的成本项目
                const isDuplicate = costRecords[targetCostType].some(item => 
                    item.name.toLowerCase().trim() === costName.toLowerCase().trim()
                );
                
                if (isDuplicate) {
                    showToast('错误', `已存在名为"${costName}"的成本项目`, 'error');
                    return;
                }
                
                const newItem = {
                    name: costName,
                    amount: costAmount,
                    note: costNote,
                    category: costCategory,
                    unit: costUnit,
                    id: Date.now().toString() + Math.random().toString(36).substr(2, 9), // 确保ID唯一
                    createdAt: new Date().toISOString() // 添加创建时间
                };
                
                // 确保目标数组存在
                if (!costRecords[targetCostType]) {
                    costRecords[targetCostType] = [];
                }
                
                costRecords[targetCostType].push(newItem);
                console.log(`新项目已添加到 ${targetCostType}，当前数量: ${costRecords[targetCostType].length}`);
                
                // 如果有新的分类，添加到分类列表中
                if (costCategory && costCategory.trim() !== '') {
                    if (!costCategories[targetCostType].includes(costCategory.trim())) {
                        costCategories[targetCostType].push(costCategory.trim());
                    }
                }
                
                showToast('成功', '成本记录已添加', 'success');
            }
            
            // 保存数据并更新UI
            saveData();
            renderCostRecords();
            closeModal('add-cost-modal');
            resetForm('add-cost-form');
        }
        
        // DOM 加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化日期为当前月份
            const today = new Date();
            const yearMonth = today.toISOString().substr(0, 7);
            document.getElementById('report-month').value = yearMonth;
            
            // 加载本地存储的数据
            loadData();
            
            // 初始化事件监听
            initEventListeners();
            
            // 初始化图表
            initCharts();
            
            // 更新数据计算区店铺筛选器
            updateCalculationShopFilter();
            
            // 初始化店铺管理
            renderShops();
            
            // 初始化数据保存功能
            searchSavedData();
            updateSaveButtonState();
        });
        
        // 初始化事件监听
        function initEventListeners() {
            // 标签页切换
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    // 更新标签页状态
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('tab-active'));
                    this.classList.add('tab-active');
                    
                    // 更新内容显示
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
                    document.getElementById(tabId).classList.remove('hidden');
                    
                    // 如果切换到数据看板，更新仪表板
                    if (tabId === 'dashboard') {
                        updateDashboard();
                        updateShopFilter();
                    }
                });
            });

            // 添加快递续重费更新事件
            document.getElementById('update-shipping-fee').addEventListener('click', function() {
                const shippingFeeInput = document.getElementById('additional-shipping-fee');
                const shippingFee = parseFloat(shippingFeeInput.value) || 0;
                
                // 保存快递续重费
                window.additionalShippingFee = shippingFee;
                
                // 重新计算所有商品的净利润
                recalculateNetProfit();
                
                // 重新渲染结果
                renderResults();
                
                // 更新数据看板
                updateDashboard();
                
                showToast('成功', '快递续重费已更新', 'success');
            });
            
            // 重新计算净利润函数
            function recalculateNetProfit() {
                const shippingFee = window.additionalShippingFee || 0;
                const totalQuantity = productData.reduce((sum, product) => sum + product.totalQuantity, 0);
                
                if (totalQuantity > 0 && shippingFee > 0) {
                    // 按销量比例分摊快递续重费
                    productData.forEach(product => {
                        const allocatedShippingFee = (product.totalQuantity / totalQuantity) * shippingFee;
                        product.allocatedShippingFee = allocatedShippingFee; // 存储分摊的快递续重费
                        product.netProfit = product.totalRevenue - product.totalCost - product.advertisingFee - allocatedShippingFee;
                    });
                } else {
                    // 没有快递续重费或总销量为0，只扣除广告费
                    productData.forEach(product => {
                        product.allocatedShippingFee = 0; // 重置分摊的快递续重费
                        product.netProfit = product.totalRevenue - product.totalCost - product.advertisingFee;
                    });
                }


            }
            
            // 店铺管理相关事件
            document.getElementById('add-shop').addEventListener('click', function() {
                showAddShopModal();
            });
            
            document.getElementById('add-shop-form').addEventListener('submit', function(e) {
                e.preventDefault();
                saveShop();
            });
            
            // 关闭模态框的事件监听已在下方实现
            
            // 数据保存相关事件
            document.getElementById('save-data').addEventListener('click', function() {
                saveCurrentData();
            });
            
            document.getElementById('search-data-btn').addEventListener('click', function() {
                searchSavedData();
            });
            
            document.getElementById('search-saved-data').addEventListener('input', function() {
                searchSavedData();
            });
            
            document.getElementById('prev-page').addEventListener('click', function() {
                if (currentPage > 1) {
                    currentPage--;
                    renderSavedData();
                }
            });
            
            document.getElementById('next-page').addEventListener('click', function() {
                const totalPages = Math.ceil(filteredSavedData.length / itemsPerPage);
                if (currentPage < totalPages) {
                    currentPage++;
                    renderSavedData();
                }
            });
            
            // 回收站相关事件
            bindRecycleBinEvents();
            updateRecycleBinCount();
            
            // 文件上传相关事件
            const dragArea = document.getElementById('drag-area');
            const fileInput = document.getElementById('file-input');
            const removeFileBtn = document.getElementById('remove-file');
            
            // 拖拽上传
            dragArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('active');
            });
            
            dragArea.addEventListener('dragleave', function() {
                this.classList.remove('active');
            });
            
            dragArea.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('active');
                
                const file = e.dataTransfer.files[0];
                if (file && (file.name.endsWith('.xlsx') || file.name.endsWith('.xls'))) {
                    handleFileUpload(file);
                } else {
                    showToast('错误', '请上传Excel文件(.xlsx或.xls格式)', 'error');
                }
            });
            
            // 点击上传
            dragArea.addEventListener('click', function(e) {
                // 检查点击目标是否是选择文件按钮，如果是则不做处理（让label的for属性正常工作）
                if (e.target.closest('label[for="file-input"]')) {
                    return;
                }
                
                e.preventDefault();
                e.stopPropagation();
                // 确保文件输入框被重置，这样可以选择相同的文件
                fileInput.value = '';
                // 触发文件选择对话框
                fileInput.click();
            });
            
            fileInput.addEventListener('change', function() {
                if (this.files.length > 0) {
                    handleFileUpload(this.files[0]);
                }
            });
            
            // 移除文件
            removeFileBtn.addEventListener('click', function() {
                fileInput.value = '';
                document.getElementById('file-info').classList.add('hidden');
                excelData = [];
                productData = [];
                document.getElementById('results-container').innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fa fa-info-circle text-3xl mb-2"></i>
                        <p>请上传Excel文件并点击"开始计算"</p>
                    </div>
                `;
                updateDashboard();
            });
            
            // 开始计算按钮
            document.getElementById('start-calculation').addEventListener('click', function() {
                if (excelData.length === 0) {
                    showToast('错误', '请先上传Excel文件', 'error');
                    return;
                }
                
                calculateProfit();
            });
            
            // 全部展开/收起按钮
            document.getElementById('expand-all').addEventListener('click', function() {
                document.querySelectorAll('.product-card .collapse-content').forEach(content => {
                    content.classList.remove('hidden');
                });
                document.querySelectorAll('.product-card .toggle-btn i').forEach(icon => {
                    icon.className = 'fa fa-chevron-up';
                });
            });
            
            document.getElementById('collapse-all').addEventListener('click', function() {
                document.querySelectorAll('.product-card .collapse-content').forEach(content => {
                    content.classList.add('hidden');
                });
                document.querySelectorAll('.product-card .toggle-btn i').forEach(icon => {
                    icon.className = 'fa fa-chevron-down';
                });
            });
            
            // 添加规格成本按钮
            // 导出规格编码Excel
            document.getElementById('export-sku-excel').addEventListener('click', function() {
                const modal = document.getElementById('export-fields-modal');
                modal.classList.remove('hidden');
            });

            // 字段选择相关事件
            document.getElementById('select-all-fields').addEventListener('click', function() {
                document.querySelectorAll('.export-field-checkbox').forEach(checkbox => {
                    checkbox.checked = true;
                });
            });

            document.getElementById('select-none-fields').addEventListener('click', function() {
                document.querySelectorAll('.export-field-checkbox').forEach(checkbox => {
                    checkbox.checked = false;
                });
            });

            // 确认导出
            document.getElementById('confirm-export').addEventListener('click', function() {
                exportSkuCostsToExcel();
            });

            document.getElementById('add-sku').addEventListener('click', function() {
                const modal = document.getElementById('add-sku-modal');
                modal.classList.remove('hidden');
                modal.classList.add('scale-in');
                // 清空引用成本项目容器
                document.getElementById('referenced-costs-container').innerHTML = '';
                // 更新总成本预览
                updateTotalCostPreview();
            });
            
            // 添加引用成本项目按钮
            document.getElementById('add-referenced-cost').addEventListener('click', function() {
                addReferencedCostItem();
            });
            
            // 基础成本输入变化时更新预览
            document.getElementById('sku-cost').addEventListener('input', function() {
                updateTotalCostPreview();
            });
            
            // 搜索框事件监听
            document.getElementById('sku-search').addEventListener('input', function() {
                renderSkuCosts();
            });
            
            // 添加规格成本表单提交
            document.getElementById('add-sku-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const skuCode = document.getElementById('sku-code').value.trim();
                const skuCost = parseFloat(document.getElementById('sku-cost').value);
                const skuNote = document.getElementById('sku-note').value.trim();
                
                if (skuCode && !isNaN(skuCost)) {
                    // 收集引用的成本项目
                    const referencedCosts = [];
                    const container = document.getElementById('referenced-costs-container');
                    
                    for (let i = 0; i < container.children.length; i++) {
                        const item = container.children[i];
                        const costType = item.querySelector('.cost-type-select').value;
                        const costId = item.querySelector('.cost-item-select').value;
                        const quantity = parseInt(item.querySelector('.quantity-input').value) || 0;
                        
                        if (costType && costId && quantity > 0) {
                            const costItem = findCostItemById(costType, costId);
                            if (costItem) {
                                referencedCosts.push({
                                    costType: costType,
                                    costId: costId,
                                    quantity: quantity,
                                    unitCost: costItem.amount,
                                    totalCost: costItem.amount * quantity
                                });
                            }
                        }
                    }
                    
                    // 计算总成本
                    const referencedTotal = calculateReferencedCostTotal(referencedCosts);
                    const totalCost = skuCost + referencedTotal;
                    
                    skuCosts[skuCode] = {
                        cost: skuCost,
                        referencedCosts: referencedCosts,
                        totalCost: totalCost,
                        note: skuNote
                    };
                    
                    saveData();
                    renderSkuCosts();
                    closeModal('add-sku-modal');
                    resetForm('add-sku-form');
                    
                    showToast('成功', '规格成本已添加', 'success');
                    
                    // 重新计算产品利润
                    if (productData.length > 0) {
                        calculateProfit();
                    }
                }
            });
            
            // 添加成本按钮（快递、包装、平台、配件）
            document.getElementById('add-express').addEventListener('click', function() {
                openCostModal('express', '快递公司');
            });
            
            document.getElementById('add-packaging').addEventListener('click', function() {
                openCostModal('packaging', '包装材料');
            });
            
            document.getElementById('add-platform').addEventListener('click', function() {
                openCostModal('platform', '管理项目');
            });
            
            document.getElementById('add-accessory').addEventListener('click', function() {
                openCostModal('accessory', '配件名称');
            });
            
            // 添加成本表单提交
            document.getElementById('add-cost-form').addEventListener('submit', handleAddCostSubmit);
            
            // 分类管理按钮事件
            document.getElementById('manage-packaging-categories').addEventListener('click', function() {
                openCategoryManagementModal('packaging', '包装材料');
            });
            
            document.getElementById('manage-accessory-categories').addEventListener('click', function() {
                openCategoryManagementModal('accessory', '配件');
            });
            
            // 添加分类按钮事件
            document.getElementById('add-category').addEventListener('click', function() {
                const categoryName = document.getElementById('cost-category-name').value.trim();
                const categoryColor = document.getElementById('cost-category-color').value;
                const costType = this.getAttribute('data-cost-type');
                
                if (categoryName) {
                    // 检查分类名称是否已存在（只比较名称，不比较颜色）
                    const categoryExists = costCategories[costType].some(cat => 
                        typeof cat === 'string' ? cat === categoryName : cat.name === categoryName
                    );
                    
                    if (!categoryExists) {
                        // 添加包含名称和颜色的对象
                        costCategories[costType].push({ name: categoryName, color: categoryColor });
                        saveData();
                        renderCategoriesList(costType);
                        updateCategoryFilters();
                        document.getElementById('cost-category-name').value = '';
                        document.getElementById('cost-category-color').value = '#3B82F6'; // 重置为默认颜色
                        showToast('成功', '分类已添加', 'success');
                    } else {
                        showToast('错误', '分类名称已存在', 'error');
                    }
                }
            });
            
            // 分类筛选器事件
            document.getElementById('packaging-category-filter').addEventListener('change', function() {
                renderCostRecords();
            });
            
            document.getElementById('accessory-category-filter').addEventListener('change', function() {
                renderCostRecords();
            });
            
            // 成本记录区域折叠/展开功能
            document.querySelectorAll('.cost-header').forEach(header => {
                header.addEventListener('click', function() {
                    const targetId = this.getAttribute('data-target');
                    const content = document.getElementById(targetId);
                    const icon = this.querySelector('.cost-toggle-icon');
                    
                    content.classList.toggle('hidden');
                    icon.classList.toggle('rotate-180');
                });
            });
            
            // 成本记录全部展开/收起按钮
            document.getElementById('expand-all-costs').addEventListener('click', function() {
                document.querySelectorAll('.cost-content').forEach(content => {
                    content.classList.remove('hidden');
                });
                document.querySelectorAll('.cost-toggle-icon').forEach(icon => {
                    icon.classList.add('rotate-180');
                });
            });
            
            document.getElementById('collapse-all-costs').addEventListener('click', function() {
                document.querySelectorAll('.cost-content').forEach(content => {
                    content.classList.add('hidden');
                });
                document.querySelectorAll('.cost-toggle-icon').forEach(icon => {
                    icon.classList.remove('rotate-180');
                });
            });
            
            // 关闭模态框
            document.querySelectorAll('.close-modal').forEach(btn => {
                btn.addEventListener('click', function() {
                    const modalId = this.closest('.fixed').id;
                    closeModal(modalId);
                    
                    // 对于成本编辑模态框，不重置表单以保留分类选择
                    if (modalId !== 'add-cost-modal') {
                        resetForm(modalId.replace('-modal', '-form'));
                    }
                });
            });
            
            // 导出按钮
            document.getElementById('export-pdf').addEventListener('click', function() {
                if (productData.length === 0) {
                    showToast('错误', '暂无数据可导出', 'error');
                    return;
                }
                exportToPDF();
            });
            
            document.getElementById('export-excel').addEventListener('click', function() {
                if (productData.length === 0) {
                    showToast('错误', '暂无数据可导出', 'error');
                    return;
                }
                exportToExcel();
            });
            
            // 关闭提示框
            document.getElementById('close-toast').addEventListener('click', function() {
                document.getElementById('toast').classList.add('hidden');
            });
            
            // 店铺筛选器事件
            document.getElementById('shop-filter').addEventListener('change', function() {
                const selectedShopId = this.value;
                updateDashboard(selectedShopId);
            });
            
            // 排行榜排序和限制事件
            document.getElementById('ranking-sort').addEventListener('change', function() {
                const selectedShopId = document.getElementById('shop-filter').value;
                updateDashboard(selectedShopId);
            });
            
            document.getElementById('ranking-limit').addEventListener('change', function() {
                const selectedShopId = document.getElementById('shop-filter').value;
                updateDashboard(selectedShopId);
            });
            
            // 数据计算区筛选事件
            document.getElementById('apply-filters').addEventListener('click', function() {
                applyCalculationFilters();
            });
            
            document.getElementById('clear-filters').addEventListener('click', function() {
                clearCalculationFilters();
            });
            
            // 结果排序控件事件
            document.getElementById('results-sort').addEventListener('change', function() {
                if (productData.length > 0) {
                    renderResults();
                }
            });
            
            document.getElementById('search-product-btn').addEventListener('click', function() {
                applyCalculationFilters();
            });
            
            document.getElementById('product-id-search').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    applyCalculationFilters();
                }
            });
        }
        
        // 更新店铺筛选器选项
        function updateShopFilter() {
            const shopFilter = document.getElementById('shop-filter');
            const currentValue = shopFilter.value;
            
            // 清空现有选项（保留"全部店铺"）
            shopFilter.innerHTML = '<option value="">全部店铺</option>';
            
            // 添加所有店铺选项
            shops.forEach(shop => {
                const option = document.createElement('option');
                option.value = shop.id;
                option.textContent = shop.name;
                shopFilter.appendChild(option);
            });
            
            // 添加未分类选项
            const uncategorizedOption = document.createElement('option');
            uncategorizedOption.value = 'uncategorized';
            uncategorizedOption.textContent = '未分类';
            shopFilter.appendChild(uncategorizedOption);
            
            // 恢复之前的选择
            shopFilter.value = currentValue || '';
        }
        
        // 店铺管理相关函数
        function showAddShopModal(shopId = null) {
            const modal = document.getElementById('add-shop-modal');
            const title = document.getElementById('shop-modal-title');
            const form = document.getElementById('add-shop-form');
            
            if (shopId) {
                const shop = shops.find(s => s.id === shopId);
                title.textContent = '编辑店铺';
                document.getElementById('shop-id').value = shop.id;
                document.getElementById('shop-name').value = shop.name;
                document.getElementById('shop-display-id').value = shop.displayId || '';
                document.getElementById('shop-products').value = shop.productIds.join('\n');
            } else {
                title.textContent = '添加店铺';
                form.reset();
                document.getElementById('shop-id').value = '';
            }
            
            modal.classList.remove('hidden');
        }
        
        function hideAddShopModal() {
            document.getElementById('add-shop-modal').classList.add('hidden');
        }
        
        function saveShop() {
            const shopId = document.getElementById('shop-id').value;
            const shopName = document.getElementById('shop-name').value.trim();
            const shopDisplayId = document.getElementById('shop-display-id').value.trim();
            const shopProducts = document.getElementById('shop-products').value.trim();
            
            if (!shopName) {
                showToast('错误', '请输入店铺名称', 'error');
                return;
            }
            
            const productIds = shopProducts ? shopProducts.split('\n').map(id => id.trim()).filter(id => id) : [];
            
            if (shopId) {
                // 编辑现有店铺
                const shopIndex = shops.findIndex(s => s.id === shopId);
                shops[shopIndex] = {
                    ...shops[shopIndex],
                    name: shopName,
                    displayId: shopDisplayId,
                    productIds: productIds
                };
                showToast('成功', '店铺更新成功');
            } else {
                // 添加新店铺
                shops.push({
                    id: Date.now().toString(),
                    name: shopName,
                    displayId: shopDisplayId,
                    productIds: productIds,
                    createdAt: new Date().toISOString()
                });
                showToast('成功', '店铺添加成功');
            }
            
            // 保存到本地存储
            localStorage.setItem('shops', JSON.stringify(shops));
            
            // 重新渲染店铺列表
            renderShops();
            
            // 更新数据计算区店铺筛选器
            updateCalculationShopFilter();
            
            // 隐藏模态框
            hideAddShopModal();
            
            // 更新数据计算区的店铺显示
            if (!document.getElementById('data-calculation').classList.contains('hidden')) {
                renderDataCalculation();
            }
        }
        
        function deleteShop(shopId) {
            const shop = shops.find(s => s.id === shopId);
            if (!shop) return;
            
            // 显示删除确认模态框
            openDeleteConfirmModal(
                '确认删除店铺',
                `确定要删除"${shop.name}"店铺吗？此操作无法撤销。`,
                function() {
                    shops = shops.filter(s => s.id !== shopId);
                    localStorage.setItem('shops', JSON.stringify(shops));
                    renderShops();
                    showToast('成功', '店铺删除成功');
                    
                    // 更新数据计算区的店铺显示
                    if (!document.getElementById('data-calculation').classList.contains('hidden')) {
                        renderDataCalculation();
                    }
                }
            );
        }
        
        function renderShops() {
            const container = document.getElementById('shops-container');
            const empty = document.getElementById('shops-empty');
            
            // 更新店铺数量显示
            const shopCountElement = document.getElementById('shop-count-number');
            if (shopCountElement) {
                shopCountElement.textContent = shops.length;
            }
            
            if (shops.length === 0) {
                container.innerHTML = '';
                empty.classList.remove('hidden');
                return;
            }
            
            empty.classList.add('hidden');
            
            container.innerHTML = shops.map(shop => `
                <div class="bg-white rounded-xl border border-gray-100 p-6 mb-6 shadow-sm hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1">
                    <div class="flex justify-between items-center mb-6">
                        <div class="flex items-center space-x-4">
                            <h3 class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-4 py-3 rounded-lg shadow-md text-lg font-bold">${shop.name}</h3>
                            <span class="inline-flex items-center px-3 py-1.5 rounded-full text-sm font-medium bg-blue-100 text-blue-800 border border-blue-200">
                                <i class="fa fa-cubes mr-1.5"></i> ${shop.productIds.length} 个商品
                            </span>
                        </div>
                        <div class="flex space-x-2">
                            <button class="btn btn-sm btn-secondary hover:bg-gray-200 transition-colors duration-300" onclick="showAddShopModal('${shop.id}')" title="编辑店铺">
                                <i class="fa fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger hover:bg-red-600 transition-colors duration-300" onclick="deleteShop('${shop.id}')" title="删除店铺">
                                <i class="fa fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <label class="block text-sm font-semibold text-gray-700">关联商品ID</label>
                            <span class="text-xs text-gray-500">点击标签可移除</span>
                        </div>
                        <div class="flex flex-wrap gap-2 max-h-40 overflow-y-auto p-2 border border-gray-100 rounded-lg bg-gray-50" style="scrollbar-width: thin; scrollbar-color: #cbd5e1 #f8fafc;">
                            ${shop.productIds.length > 0 ? shop.productIds.map(productId => `
                                <span class="inline-flex items-center px-3 py-1.5 rounded-full text-sm font-medium bg-blue-100 text-blue-800 hover:bg-blue-200 transition-colors duration-200">
                                    <i class="fa fa-tag mr-1.5"></i> ${productId}
                                    <i class="fa fa-times ml-1.5 text-blue-600 hover:text-blue-800 cursor-pointer hover:bg-blue-300 hover:rounded-full p-0.5 transition-colors duration-200" onclick="removeProductFromShop('${shop.id}', '${productId}'); event.stopPropagation();" title="移除商品ID"></i>
                                </span>
                            `).join('') : '<span class="text-sm text-gray-500 italic">暂无关联商品</span>'}
                        </div>
                    </div>
                    
                    <div class="flex justify-between items-center pt-4 border-t border-gray-100">
                        <button class="btn btn-sm btn-secondary hover:bg-gray-500 transition-colors duration-300 flex items-center space-x-1" onclick="showAddShopModal('${shop.id}')">
                            <i class="fa fa-plus"></i>
                            <span>添加商品ID</span>
                        </button>
                        <div class="text-xs text-gray-400">
                            ID: ${shop.displayId || shop.id}
                        </div>
                    </div>
                </div>


            `).join('');
        }
        
        function removeProductFromShop(shopId, productId) {
            const shop = shops.find(s => s.id === shopId);
            if (shop) {
                shop.productIds = shop.productIds.filter(id => id !== productId);
                localStorage.setItem('shops', JSON.stringify(shops));
                renderShops();
                
                // 更新数据计算区的店铺显示
                if (!document.getElementById('data-calculation').classList.contains('hidden')) {
                    renderDataCalculation();
                }
            }
        }
        
        // 根据商品ID获取店铺名称
        function getShopNameByProductId(productId) {
            for (const shop of shops) {
                if (shop.productIds.includes(productId)) {
                    return shop.name;
                }
            }
            return '未分类';
        }
        
        // 回收站相关函数
        function bindRecycleBinEvents() {
            const recycleBinBtn = document.getElementById('recycle-bin-btn');
            const recycleBinList = document.getElementById('recycle-bin-list');
            const recycleBinContainer = document.getElementById('recycle-bin-container');
            const emptyRecycleBinBtn = document.getElementById('empty-recycle-bin');
            
            // 点击回收站按钮显示/隐藏列表
            recycleBinBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                recycleBinList.classList.toggle('hidden');
                if (!recycleBinList.classList.contains('hidden')) {
                    renderRecycleBin();
                }
            });
            
            // 点击清空回收站
            emptyRecycleBinBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                if (recycleBin.length > 0) {
                    if (confirm('确定要清空回收站吗？此操作不可撤销。')) {
                        recycleBin = [];
                        localStorage.setItem('recycleBin', JSON.stringify(recycleBin));
                        updateRecycleBinCount();
                        renderRecycleBin();
                        showToast('成功', '回收站已清空', 'success');
                    }
                }
            });
            
            // 点击其他地方隐藏回收站列表
            document.addEventListener('click', function(e) {
                if (!recycleBinContainer.contains(e.target)) {
                    recycleBinList.classList.add('hidden');
                }
            });
        }
        
        function updateRecycleBinCount() {
            const countElement = document.getElementById('recycle-bin-count');
            const count = recycleBin.length;
            countElement.textContent = count;
            countElement.style.display = count > 0 ? 'flex' : 'none';
        }
        
        function renderRecycleBin() {
            const itemsContainer = document.getElementById('recycle-bin-items');
            const emptyContainer = document.getElementById('recycle-bin-empty');
            
            if (recycleBin.length === 0) {
                itemsContainer.innerHTML = '';
                itemsContainer.classList.add('hidden');
                emptyContainer.classList.remove('hidden');
                return;
            }
            
            itemsContainer.classList.remove('hidden');
            emptyContainer.classList.add('hidden');
            
            let html = '';
            recycleBin.forEach((item, index) => {
                const deletedDate = new Date(item.deletedAt).toLocaleString('zh-CN');
                html += `
                    <div class="recycle-bin-item p-3 border-b border-gray-100 hover:bg-gray-50">
                        <div class="flex items-center justify-between mb-1">
                            <span class="font-medium text-gray-800 text-sm cursor-pointer hover:text-primary restore-item" data-index="${index}">
                                ${item.name}
                            </span>
                            <button class="text-gray-400 hover:text-danger delete-forever" data-index="${index}" title="彻底删除">
                                <i class="fa fa-times"></i>
                            </button>
                        </div>
                        <div class="flex items-center justify-between text-xs text-gray-500">
                            <span>删除时间: ${deletedDate}</span>
                            <span class="text-primary cursor-pointer hover:underline restore-item" data-index="${index}">
                                恢复
                            </span>
                        </div>
                    </div>
                `;
            });
            
            itemsContainer.innerHTML = html;
            
            // 绑定恢复事件
            itemsContainer.querySelectorAll('.restore-item').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.dataset.index);
                    restoreFromRecycleBin(index);
                });
            });
            
            // 绑定彻底删除事件
            itemsContainer.querySelectorAll('.delete-forever').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const index = parseInt(this.dataset.index);
                    deleteForeverFromRecycleBin(index);
                });
            });
        }
        
        function restoreFromRecycleBin(index) {
            if (index >= 0 && index < recycleBin.length) {
                const item = recycleBin[index];
                delete item.deletedAt;
                
                // 检查是否已存在同名数据
                const existingIndex = savedData.findIndex(savedItem => savedItem.id === item.id);
                if (existingIndex !== -1) {
                    // 如果存在，询问是否覆盖
                    if (confirm('已存在同名数据，是否覆盖？')) {
                        savedData[existingIndex] = item;
                    } else {
                        // 不覆盖，添加新的
                        item.id = Date.now().toString();
                        savedData.unshift(item);
                    }
                } else {
                    savedData.unshift(item);
                }
                
                // 从回收站移除
                recycleBin.splice(index, 1);
                
                // 保存到本地存储
                localStorage.setItem('savedData', JSON.stringify(savedData));
                localStorage.setItem('recycleBin', JSON.stringify(recycleBin));
                
                // 更新界面
                updateRecycleBinCount();
                renderRecycleBin();
                searchSavedData();
                
                showToast('成功', '数据已恢复', 'success');
            }
        }
        
        function deleteForeverFromRecycleBin(index) {
            if (index >= 0 && index < recycleBin.length) {
                if (confirm('确定要彻底删除这个数据吗？此操作不可撤销。')) {
                    recycleBin.splice(index, 1);
                    localStorage.setItem('recycleBin', JSON.stringify(recycleBin));
                    updateRecycleBinCount();
                    renderRecycleBin();
                    showToast('成功', '数据已彻底删除', 'success');
                }
            }
        }
        
        // 数据保存相关函数
        function saveCurrentData() {
            if (productData.length === 0) {
                showToast('错误', '没有可保存的数据', 'error');
                return;
            }
            
            const saveNameInput = document.getElementById('save-name');
            const reportMonth = document.getElementById('report-month').value;
            
            let saveName = saveNameInput.value.trim();
            if (!saveName) {
                saveName = reportMonth || `数据_${new Date().toISOString().split('T')[0]}`;
            }
            
            const dataToSave = {
                id: Date.now().toString(),
                name: saveName,
                reportMonth: reportMonth,
                productData: JSON.parse(JSON.stringify(productData)),
                excelData: JSON.parse(JSON.stringify(excelData)),
                skuCosts: JSON.parse(JSON.stringify(skuCosts)),
                costRecords: JSON.parse(JSON.stringify(costRecords)),
                createdAt: new Date().toISOString()
            };
            
            // 将新保存的数据添加到开头
            savedData.unshift(dataToSave);
            
            // 使用LZ-String压缩数据后保存到本地存储
            try {
                const dataString = JSON.stringify(savedData);
                const compressedData = LZString.compress(dataString);
                if (compressedData) {
                    localStorage.setItem('savedData', compressedData);
                    console.log('数据压缩并保存成功。原始大小:', dataString.length, '字符, 压缩后大小:', compressedData.length, '字符');
                } else {
                    throw new Error('数据压缩失败，结果为空');
                }
            } catch (error) {
                console.error('保存压缩数据时出错:', error);
                // 如果压缩失败，尝试直接保存未压缩的数据
                try {
                    localStorage.setItem('savedData', JSON.stringify(savedData));
                } catch (saveError) {
                    console.error('Failed to save data:', saveError);
                    showToast('错误', '保存数据失败，请检查存储空间', 'error');
                    return;
                }
            }
            
            // 同时保存回收站数据
            try {
                localStorage.setItem('recycleBin', JSON.stringify(recycleBin));
                console.log('回收站数据保存成功');
            } catch (error) {
                console.error('保存回收站数据失败:', error);
            }
            
            // 清空输入框
            saveNameInput.value = '';
            
            // 重新渲染保存的数据列表
            searchSavedData();
            
            showToast('成功', '数据保存成功');
        }
        
        function loadSavedData(dataId) {
            const data = savedData.find(item => item.id === dataId);
            if (!data) {
                showToast('错误', '未找到保存的数据', 'error');
                return;
            }
            
            // 加载数据，但不覆盖当前的规格成本和成本记录
            // 这样新上传的文件仍然可以使用最新的规格成本
            productData = JSON.parse(JSON.stringify(data.productData));
            excelData = JSON.parse(JSON.stringify(data.excelData));
            // 不覆盖skuCosts和costRecords，保持使用当前最新的数据
            
            // 为加载的保存数据添加标识和使用保存的成本
            productData = productData.map(product => {
                // 为每个SKU保存原始成本
                Object.values(product.skus).forEach(sku => {
                    sku.originalCost = sku.cost; // 保存SKU的原始成本
                    sku.isSavedData = true; // 标记为保存的SKU数据
                });
                
                return {
                    ...product,
                    isSavedData: true, // 标记为保存的数据
                    savedUnitCost: product.unitCost, // 使用保存时的单件成本
                    savedTotalCost: product.totalCost // 使用保存时的总成本
                };
            });
            
            // 设置报表年月
            document.getElementById('report-month').value = data.reportMonth;
            
            // 清零快递续重费
            document.getElementById('additional-shipping-fee').value = '';
            
            // 重新渲染结果
            renderResults();
            
            // 启用保存按钮
            document.getElementById('save-data').disabled = false;
            
            showToast('成功', '数据加载成功，使用保存时的成本数据');
        }
        
        function deleteSavedData(dataId) {
            const deleteBtn = event.target.closest('.delete-btn');
            if (!deleteBtn) return;
            
            // 检查是否在冷却期
            if (deleteBtn.dataset.cooling === 'true') {
                return; // 冷却期内忽略重复点击
            }
            
            // 保存原始状态
            const originalHTML = deleteBtn.innerHTML;
            const originalDisabled = deleteBtn.disabled;
            
            // 进入冷却期
            deleteBtn.dataset.cooling = 'true';
            deleteBtn.disabled = true;
            deleteBtn.textContent = '3秒';
            
            let countdown = 3;
            const timer = setInterval(() => {
                countdown--;
                if (countdown > 0) {
                    deleteBtn.textContent = `${countdown}秒`;
                } else {
                    clearInterval(timer);
                    // 冷却期结束，自动显示确认模态框
                    showDeleteConfirmation(dataId, deleteBtn, originalHTML, originalDisabled);
                }
            }, 1000);
            
            // 显示提示信息
            showToast('提示', '为防止误操作，将在3秒后自动弹出确认窗口', 'info');
        }
        
        // 显示删除确认模态框
        function showDeleteConfirmation(dataId, deleteBtn, originalHTML, originalDisabled) {
            // 创建模态框
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.id = 'delete-confirmation-modal';
            
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-lg w-full max-w-md">
                    <div class="p-6">
                        <div class="text-center mb-6">
                            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-red-100 text-red-500 mb-4">
                                <i class="fa fa-exclamation-triangle text-2xl"></i>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">确认删除</h3>
                            <p class="text-gray-600">确定要删除这个保存的数据吗？</p>
                            <p class="text-sm text-gray-500 mt-2">删除后将移至回收站</p>
                        </div>
                        
                        <div class="flex space-x-3">
                            <button id="cancel-delete" class="flex-1 btn btn-secondary h-10">
                                取消
                            </button>
                            <button id="confirm-delete" class="flex-1 btn btn-danger h-10">
                                确认删除
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // 添加到页面
            document.body.appendChild(modal);
            
            // 绑定事件
            document.getElementById('cancel-delete').onclick = function() {
                document.body.removeChild(modal);
                showToast('提示', '删除操作已取消', 'info');
                
                // 完全恢复按钮状态
                deleteBtn.disabled = false;
                deleteBtn.innerHTML = originalHTML;
                deleteBtn.classList.remove('bg-gray-200', 'text-gray-800', 'hover:bg-gray-300', 'editing-breathing-bg');
                deleteBtn.classList.add('btn-danger');
                deleteBtn.dataset.cooling = 'false';
                deleteBtn.dataset.confirming = 'false';
                deleteBtn.dataset.deleting = 'false';
            };
            
            document.getElementById('confirm-delete').onclick = function() {
                // 移除模态框
                document.body.removeChild(modal);
                
                // 执行删除操作
                performDelete(dataId, deleteBtn, originalHTML, originalDisabled);
            };
            
            // 点击背景关闭
            modal.onclick = function(e) {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                    showToast('提示', '删除操作已取消', 'info');
                    
                    // 恢复按钮状态
                    deleteBtn.disabled = originalDisabled;
                    deleteBtn.innerHTML = originalHTML;
                    deleteBtn.classList.remove('bg-gray-200 text-gray-800 hover:bg-gray-300');
                    deleteBtn.dataset.cooling = 'false';
                }
            };
        }
        
        // 执行删除操作
        function performDelete(dataId, deleteBtn, originalHTML, originalDisabled) {
            try {
                // 找到要删除的数据
                const deletedItem = savedData.find(item => item.id === dataId);
                if (deletedItem) {
                    // 添加到回收站
                    deletedItem.deletedAt = new Date().toISOString();
                    recycleBin.unshift(deletedItem);
                    
                    // 从保存数据中移除
                    savedData = savedData.filter(item => item.id !== dataId);
                    
                    // 保存到本地存储
                    const savedDataString = JSON.stringify(savedData);
                    const compressedSavedData = LZString.compress(savedDataString);
                    if (compressedSavedData) {
                        localStorage.setItem('savedData', compressedSavedData);
                    } else {
                        localStorage.setItem('savedData', savedDataString);
                    }
                    
                    const recycleBinString = JSON.stringify(recycleBin);
                    const compressedRecycleBin = LZString.compress(recycleBinString);
                    if (compressedRecycleBin) {
                        localStorage.setItem('recycleBin', compressedRecycleBin);
                    } else {
                        localStorage.setItem('recycleBin', recycleBinString);
                    }
                    
                    // 更新回收站计数
                    updateRecycleBinCount();
                    
                    // 重新渲染保存的数据列表
                    searchSavedData();
                    
                    showToast('成功', '数据已移至回收站', 'success');
                }
            } catch (error) {
                console.error('删除数据时出错:', error);
                showToast('错误', '删除失败，请重试', 'error');
            } finally {
                // 恢复按钮状态
                deleteBtn.disabled = false;
                deleteBtn.innerHTML = originalHTML;
                deleteBtn.classList.remove('bg-gray-200 text-gray-800 hover:bg-gray-300');
                deleteBtn.dataset.cooling = 'false';
            }
        }
        
        function searchSavedData() {
            const searchTerm = document.getElementById('search-saved-data').value.toLowerCase().trim();
            
            if (searchTerm) {
                filteredSavedData = savedData.filter(item => 
                    item.name.toLowerCase().includes(searchTerm)
                );
            } else {
                filteredSavedData = [...savedData];
            }
            
            currentPage = 1;
            renderSavedData();
        }
        
        function renderSavedData() {
            const container = document.getElementById('saved-data-list');
            const empty = document.getElementById('saved-data-empty');
            const pagination = document.getElementById('pagination');
            
            if (filteredSavedData.length === 0) {
                container.innerHTML = '';
                empty.classList.remove('hidden');
                pagination.classList.add('hidden');
                return;
            }
            
            empty.classList.add('hidden');
            
            // 计算分页
            const totalPages = Math.ceil(filteredSavedData.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, filteredSavedData.length);
            const pageData = filteredSavedData.slice(startIndex, endIndex);
            
            let html = '';
            pageData.forEach((item, index) => {
                const date = new Date(item.createdAt);
                const formattedTime = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} | ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
                
                html += `
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-md">
                        <div class="flex items-center">
                            <i class="fa fa-database text-primary mr-3"></i>
                            <div>
                                <p class="font-medium text-gray-800">${item.name}</p>
                                <p class="text-xs text-gray-500">${formattedTime}</p>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <button class="btn btn-sm btn-secondary p-2 hover:bg-secondary/80 transition-colors" onclick="loadSavedData('${item.id}')" title="加载数据">
                                <i class="fa fa-folder-open"></i>
                            </button>
                            <button class="btn btn-sm btn-danger delete-btn" onclick="deleteSavedData('${item.id}')" data-cooling="false">
                                <i class="fa fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // 更新分页信息
            document.getElementById('page-info').textContent = `第 ${currentPage} 页，共 ${totalPages} 页`;
            document.getElementById('prev-page').disabled = currentPage === 1;
            document.getElementById('next-page').disabled = currentPage === totalPages;
            
            pagination.classList.remove('hidden');
        }
        
        function updateSaveButtonState() {
            const saveButton = document.getElementById('save-data');
            saveButton.disabled = productData.length === 0;
        }
        
        // 处理文件上传
        function handleFileUpload(file) {
            document.getElementById('file-name').textContent = file.name;
            document.getElementById('file-info').classList.remove('hidden');
            
            // 完全重置数据状态，确保新上传的数据可以重新关联最新的规格成本
            productData = [];
            excelData = [];
            
            // 清零快递续重费
            document.getElementById('additional-shipping-fee').value = '';
            
            // 确保所有状态被重置
            currentPage = 1;
            filteredSavedData = [];
            
            console.log('File uploaded, data reset. Ready to calculate with latest SKU costs.');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    
                    // 将Excel数据转换为JSON
                    excelData = XLSX.utils.sheet_to_json(worksheet);
                    
                    if (excelData.length === 0) {
                        showToast('错误', 'Excel文件中没有数据', 'error');
                        return;
                    }
                    
                    showToast('成功', '文件上传成功，共 ' + excelData.length + ' 条记录', 'success');
                } catch (error) {
                    console.error('Excel解析错误:', error);
                    showToast('错误', 'Excel文件解析失败，请检查文件格式', 'error');
                }
            };
            
            reader.onerror = function() {
                showToast('错误', '文件读取失败', 'error');
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        // 计算净利润
        function calculateProfit() {
            // 清零快递续重费
            document.getElementById('additional-shipping-fee').value = '';
            
            // 显示加载状态
            document.getElementById('results-container').innerHTML = `
                <div class="text-center py-8">
                    <i class="fa fa-spinner fa-spin text-primary text-3xl mb-2"></i>
                    <p class="text-gray-600">正在计算中...</p>
                </div>
            `;
            
            // 模拟计算延迟
            setTimeout(() => {
                try {
                    // 处理数据，按商品ID分组
                    const groupedByProduct = {};
                    
                    excelData.forEach(row => {
                        // 尝试识别字段名（支持不同的列名）
                        const productId = findProductIdField(row);
                        const skuCode = findSkuCodeField(row);
                        const quantity = findQuantityField(row);
                        const revenue = findRevenueField(row);
                        
                        if (!productId || !skuCode || quantity === null || revenue === null) {
                            return; // 跳过无效行
                        }
                        
                        if (!groupedByProduct[productId]) {
                            groupedByProduct[productId] = {
                                id: productId,
                                totalQuantity: 0,
                                totalRevenue: 0,
                                advertisingFee: 0,
                                totalCost: 0,
                                netProfit: 0,
                                skus: {}
                            };
                        }
                        
                        // 累加数量和收入
                        groupedByProduct[productId].totalQuantity += quantity;
                        groupedByProduct[productId].totalRevenue += revenue;
                        
                        // 记录SKU信息
                        if (!groupedByProduct[productId].skus[skuCode]) {
                            // 从最新的规格成本中获取成本
                            let skuCost = 0;
                            
                            // 优先从当前的规格成本中获取最新成本
                            if (skuCosts && skuCosts[skuCode]) {
                                skuCost = skuCosts[skuCode].totalCost || skuCosts[skuCode].cost || 0;
                                console.log(`Found SKU cost for ${skuCode}: ¥${skuCost.toFixed(2)}`);
                            } else {
                                console.log(`No SKU cost found for ${skuCode}, using ¥0.00`);
                            }
                            
                            groupedByProduct[productId].skus[skuCode] = {
                                code: skuCode,
                                quantity: 0,
                                revenue: 0,
                                cost: skuCost,
                                originalCost: skuCost, // 保存当前使用的成本
                                isSavedData: false, // 标记为新计算的数据
                                isNewCalculation: true // 明确标记为新上传文件的计算数据
                            };
                        }
                        
                        groupedByProduct[productId].skus[skuCode].quantity += quantity;
                        groupedByProduct[productId].skus[skuCode].revenue += revenue;
                    });
                    
                    // 转换为数组
                    productData = Object.values(groupedByProduct);
                    
                    // 计算成本和利润
                    productData.forEach(product => {
                        // 计算SKU成本
                        let skuTotalCost = 0;
                        Object.values(product.skus).forEach(sku => {
                            // 重构的成本计算逻辑：
                            // 1. 对于新上传文件的计算数据，总是使用最新的规格成本
                            // 2. 对于加载的保存数据，使用保存时的成本
                            let costPerUnit;
                            
                            if (sku.isNewCalculation) {
                                // 新上传文件的数据，总是使用最新的规格成本
                                if (skuCosts && skuCosts[sku.code]) {
                                    costPerUnit = skuCosts[sku.code].totalCost || skuCosts[sku.code].cost || 0;
                                    console.log(`NEW CALC - Using latest SKU cost for ${sku.code}: ¥${costPerUnit.toFixed(2)}`);
                                } else {
                                    costPerUnit = 0;
                                    console.log(`NEW CALC - No SKU cost found for ${sku.code}, using ¥0.00`);
                                }
                                // 更新原始成本为最新的规格成本
                                sku.originalCost = costPerUnit;
                            } else if ((product.isSavedData || sku.isSavedData) && sku.originalCost !== undefined) {
                                // 保存的数据使用原始成本
                                costPerUnit = sku.originalCost;
                                console.log(`SAVED DATA - Using saved cost for SKU ${sku.code}: ¥${costPerUnit.toFixed(2)}`);
                            } else {
                                // 其他情况，尝试使用最新的规格成本
                                if (skuCosts && skuCosts[sku.code]) {
                                    costPerUnit = skuCosts[sku.code].totalCost || skuCosts[sku.code].cost || 0;
                                    console.log(`FALLBACK - Using current SKU cost for ${sku.code}: ¥${costPerUnit.toFixed(2)}`);
                                } else {
                                    costPerUnit = sku.cost || 0;
                                    console.log(`FALLBACK - Using existing cost for ${sku.code}: ¥${costPerUnit.toFixed(2)}`);
                                }
                            }
                            
                            const skuCost = costPerUnit * sku.quantity;
                            skuTotalCost += skuCost;
                            
                            // 更新显示的成本
                            sku.displayCost = costPerUnit;
                            // 同时更新实际成本字段
                            sku.cost = costPerUnit;
                        });
                        
                        product.totalCost = skuTotalCost;
                        
                        // 暂时将广告费设为0（用户可以在界面上修改）
                        product.advertisingFee = 0;
                        
                        // 计算净利润
                        product.netProfit = product.totalRevenue - product.totalCost - product.advertisingFee;
                    });
                    
                    // 渲染结果
                    renderResults();
                    
                    // 更新数据看板
                    updateDashboard();
                    
                    // 更新保存按钮状态
                    updateSaveButtonState();
                    
                    // 初始化快递续重费
                    window.additionalShippingFee = 0;
                    
                    // 显示成功消息，包含成本关联信息
                    const totalSkus = productData.reduce((sum, product) => sum + Object.keys(product.skus).length, 0);
                    const associatedSkus = productData.reduce((sum, product) => {
                        return sum + Object.values(product.skus).filter(sku => sku.displayCost > 0).length;
                    }, 0);
                    
                    // 显示详细的成功消息，包含成本关联统计信息
                    const newCalculationSkus = productData.reduce((sum, product) => {
                        return sum + Object.values(product.skus).filter(sku => sku.isNewCalculation).length;
                    }, 0);
                    
                    showToast('成功', `计算完成！共 ${totalSkus} 个SKU（新计算：${newCalculationSkus}个），其中 ${associatedSkus} 个已关联最新规格成本`, 'success');
                } catch (error) {
                    console.error('计算错误:', error);
                    showToast('错误', '计算过程中出现错误', 'error');
                    document.getElementById('results-container').innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fa fa-exclamation-circle text-3xl mb-2"></i>
                            <p>计算过程中出现错误，请检查文件格式</p>
                        </div>
                    `;
                }
            }, 1000);
        }
        
        // 尝试识别商品ID字段
        function findProductIdField(row) {
            const possibleFields = ['商品ID', '商品id', '商品编号', '商品编码', 'item_id', 'product_id'];
            
            for (const field of possibleFields) {
                if (row[field]) {
                    return row[field];
                }
            }
            
            // 如果没找到，尝试第一个非空字段
            for (const key in row) {
                if (row[key]) {
                    return row[key];
                }
            }
            
            return null;
        }
        
        // 查找规格成本的辅助函数
        function findSkuCost(skuCode) {
            // 首先尝试从规格成本中查找
            if (skuCosts && skuCosts[skuCode]) {
                return skuCosts[skuCode].totalCost || skuCosts[skuCode].cost || 0;
            }
            
            // 如果找不到，返回0
            return 0;
        }
        
        // 尝试识别规格编码字段
        function findSkuCodeField(row) {
            const possibleFields = ['规格编码', '规格id', 'SKU', 'sku', 'sku_code', '规格'];
            
            for (const field of possibleFields) {
                if (row[field]) {
                    return row[field];
                }
            }
            
            return '未知规格';
        }
        
        // 尝试识别数量字段
        function findQuantityField(row) {
            const possibleFields = ['数量', '销量', '件数', 'quantity', 'num'];
            
            for (const field of possibleFields) {
                if (row[field] !== undefined && !isNaN(parseFloat(row[field]))) {
                    return parseFloat(row[field]);
                }
            }
            
            return 0;
        }
        
        // 尝试识别收入字段
        function findRevenueField(row) {
            const possibleFields = ['实收', '实收(元)', '收入', '金额', '实收款', 'revenue', 'amount', 'price'];
            
            for (const field of possibleFields) {
                if (row[field] !== undefined) {
                    // 智能处理文本型数字
                    let value = row[field];
                    
                    // 如果是字符串，进行清理和转换
                    if (typeof value === 'string') {
                        // 去除货币符号、千分位分隔符和空格
                        value = value.replace(/[¥$￥,，\s]/g, '');
                        
                        // 去除中文金额单位
                        value = value.replace(/[元角分整]/g, '');
                        
                        // 处理百分比（如果需要）
                        if (value.includes('%')) {
                            value = value.replace('%', '') / 100;
                        }
                    }
                    
                    // 转换为数字
                    const numValue = parseFloat(value);
                    
                    if (!isNaN(numValue)) {
                        return numValue;
                    }
                }
            }
            
            return 0;
        }
        
        // 渲染计算结果
        function renderResults() {
            if (productData.length === 0) {
                document.getElementById('results-container').innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fa fa-info-circle text-3xl mb-2"></i>
                        <p>未找到有效数据，请检查文件格式</p>
                    </div>
                `;
                return;
            }
            
            // 获取排序选择
            const sortSelect = document.getElementById('results-sort');
            const sortBy = sortSelect ? sortSelect.value : 'profit-desc';
            
            // 创建数据副本进行排序
            const sortedData = [...productData];
            
            // 根据选择的排序方式进行排序
            switch (sortBy) {
                case 'profit-desc':
                    sortedData.sort((a, b) => b.netProfit - a.netProfit);
                    break;
                case 'profit-asc':
                    sortedData.sort((a, b) => a.netProfit - b.netProfit);
                    break;
                case 'quantity-desc':
                    sortedData.sort((a, b) => b.totalQuantity - a.totalQuantity);
                    break;
                case 'quantity-asc':
                    sortedData.sort((a, b) => a.totalQuantity - b.totalQuantity);
                    break;
            }
            
            let html = '';
            
            sortedData.forEach((product, index) => {
                const profitPercentage = product.totalRevenue > 0 
                    ? ((product.netProfit / product.totalRevenue) * 100).toFixed(2) 
                    : '0.00';
                
                // 计算平均每件利润
                const avgProfitPerUnit = product.totalQuantity > 0 
                    ? (product.netProfit / product.totalQuantity) 
                    : 0;
                
                const profitClass = product.netProfit >= 0 ? 'text-success' : 'text-danger';
                const profitIcon = product.netProfit >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';
                
                // 获取店铺名称
                const shopName = getShopNameByProductId(product.id);
                
                html += `
                    <div class="product-card">
                        <div class="flex justify-between items-center cursor-pointer toggle-collapse">
                            <div class="flex items-center">
                                <div class="flex items-center">
                                    <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-4 py-2 rounded-l-lg shadow-md flex items-center space-x-2 border-r-0">
                                        <i class="fa fa-barcode text-lg"></i>
                                        <span class="font-bold tracking-wide">商品ID</span>
                                    </div>
                                    <div class="bg-white border-2 border-l-0 border-gray-300 rounded-r-lg px-4 py-2 shadow-sm font-mono font-bold text-gray-800 tracking-tight">
                                        ${product.id}
                                    </div>
                                </div>
                                ${shopName !== '未分类' ? `<span class="ml-2 inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-gradient-to-r from-primary to-blue-500 text-white shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105">
                                    ${shopName}
                                </span>` : ''}
                                <span class="ml-2 badge ${product.netProfit >= 0 ? 'badge-success' : 'badge-danger'}">
                                    ${product.netProfit >= 0 ? '盈利' : '亏损'}
                                </span>
                            </div>
                            <div class="flex items-center space-x-4">
                                <div class="profit-display ${product.netProfit >= 0 ? 'positive' : 'negative'}">
                                    <i class="fa ${profitIcon} ${profitClass} text-xl"></i>
                                    <div>
                                        <p class="text-xs font-medium text-gray-600">净利润</p>
                                        <p class="text-2xl font-bold ${profitClass}">¥${product.netProfit.toLocaleString('zh-CN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
                                    </div>
                                </div>
                                <button class="toggle-btn text-gray-500 hover:text-primary">
                                    <i class="fa fa-chevron-down"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="collapse-content mt-4 hidden">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
                                <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-4 shadow-sm hover:shadow-md transition-all duration-300 border border-blue-200 transform hover:-translate-y-0.5">
                                    <p class="text-xs font-medium text-blue-700 mb-1">总销量</p>
                                    <p class="text-xl font-bold text-blue-900">${product.totalQuantity.toLocaleString()}</p>
                                </div>
                                
                                <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-lg p-4 shadow-sm hover:shadow-md transition-all duration-300 border border-green-200 transform hover:-translate-y-0.5">
                                    <p class="text-xs font-medium text-green-700 mb-1">总实收</p>
                                    <p class="text-xl font-bold text-green-900">¥${product.totalRevenue.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
                                </div>
                                
                                <div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-lg p-4 shadow-sm hover:shadow-md transition-all duration-300 border border-gray-200 transform hover:-translate-y-0.5">
                                    <p class="text-xs font-medium text-gray-700 mb-1">快递续重费</p>
                                    <p class="text-xl font-bold text-gray-900">¥${(product.allocatedShippingFee || 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
                                </div>
                                
                                <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg p-4 shadow-sm hover:shadow-md transition-all duration-300 border border-purple-200 transform hover:-translate-y-0.5">
                                    <p class="text-xs font-medium text-purple-700 mb-1">平均每件利润</p>
                                    <p class="text-xl font-bold ${profitClass === 'text-success' ? 'text-purple-900' : profitClass}">¥${avgProfitPerUnit.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
                                </div>
                                
                                <div class="bg-gradient-to-br from-indigo-50 to-indigo-100 rounded-lg p-4 shadow-sm hover:shadow-md transition-all duration-300 border border-indigo-200 transform hover:-translate-y-0.5">
                                    <p class="text-xs font-medium text-indigo-700 mb-1">毛利率</p>
                                    <p class="text-xl font-bold ${profitClass === 'text-success' ? 'text-indigo-900' : profitClass}">${profitPercentage}%</p>
                                </div>
                            </div>
                            

                            
                            <div class="border-t-4 border-indigo-500 pt-6 mt-6 bg-gradient-to-b from-white to-indigo-50 rounded-2xl p-6 shadow-xl animate-fadeIn">
                                <div class="flex items-center justify-between mb-6">
                                    <h4 class="text-2xl font-bold text-indigo-800 flex items-center">
                                        <i class="fa fa-cubes mr-3 text-indigo-600 text-2xl"></i>
                                        规格明细
                                    </h4>
                                    <div class="flex items-center space-x-2">
                                        <span class="text-base font-semibold text-gray-800 whitespace-nowrap">广告费:</span>
                                        <input type="number" id="advertising-fee-${product.id}" 
                                            class="w-32 px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-200" 
                                            step="0.01" min="0" 
                                            value="${product.advertisingFee}" 
                                            data-product-id="${product.id}">
                                        <button class="btn btn-primary text-sm py-2 px-3 update-advertising hover:shadow-md transition-all duration-200" 
                                            data-product-id="${product.id}" title="更新广告费">
                                            <i class="fa fa-refresh"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="max-h-[calc(100vh-300px)] overflow-y-auto overflow-x-auto rounded-2xl border-2 border-indigo-400 shadow-lg" style="scrollbar-width: thin; scrollbar-color: #6366f1 #e0e7ff;">
                                    <table class="min-w-full divide-y divide-indigo-200 bg-white" style="min-width: 800px;">
                                        <thead class="sticky top-0 z-20 bg-gradient-to-r from-indigo-600 to-purple-600 text-white shadow-lg whitespace-nowrap">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-sm font-bold uppercase tracking-wider min-w-[150px]">规格编码</th>
                                                <th class="px-4 py-3 text-right text-sm font-bold uppercase tracking-wider min-w-[100px]">数量</th>
                                                <th class="px-4 py-3 text-right text-sm font-bold uppercase tracking-wider min-w-[100px]">实收</th>
                                                <th class="px-4 py-3 text-right text-sm font-bold uppercase tracking-wider min-w-[120px]">平均单价</th>
                                                <th class="px-4 py-3 text-right text-sm font-bold uppercase tracking-wider min-w-[120px]">单件成本</th>
                                                <th class="px-4 py-3 text-right text-sm font-bold uppercase tracking-wider min-w-[120px]">成本总额</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-indigo-100">
                                `;
                
                Object.values(product.skus).forEach(sku => {
                    // 使用计算时确定的显示成本，确保保存的数据不被重新关联
                    const displayCost = sku.displayCost !== undefined ? sku.displayCost : 
                                      ((product.isSavedData || sku.isSavedData) && sku.originalCost !== undefined ? sku.originalCost : sku.cost);
                    const skuTotalCost = displayCost * sku.quantity;
                    
                    // 计算平均单价
                    const avgPrice = sku.quantity > 0 ? (sku.revenue / sku.quantity) : 0;
                    
                    // 检查是否为保存的数据
                    const isSavedData = product.isSavedData || sku.isSavedData;
                    
                    html += `
                        <tr class="hover:bg-indigo-50">
                            <td class="px-4 py-3 whitespace-nowrap text-sm font-bold text-indigo-900">${sku.code}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-right text-indigo-900 font-bold">${sku.quantity.toLocaleString()}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-right text-indigo-800 font-semibold">¥${sku.revenue.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-right text-indigo-800 font-semibold">¥${avgPrice.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-right ${isSavedData ? 'text-emerald-600 font-bold' : 'text-indigo-600 font-semibold'}">
                                ¥${displayCost.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                                ${isSavedData ? '<span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-800">已保存</span>' : ''}
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-right ${isSavedData ? 'text-emerald-600 font-bold' : 'text-indigo-600 font-semibold'}">¥${skuTotalCost.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        </tr>
                    `;
                });
                
                html += `
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('results-container').innerHTML = html;
            
            // 添加折叠/展开事件
            document.querySelectorAll('.toggle-collapse').forEach(collapse => {
                collapse.addEventListener('click', function() {
                    const content = this.nextElementSibling;
                    const icon = this.querySelector('.toggle-btn i');
                    
                    content.classList.toggle('hidden');
                    icon.className = content.classList.contains('hidden') ? 'fa fa-chevron-down' : 'fa fa-chevron-up';
                });
            });
            
            // 移除之前的事件监听器，避免重复绑定
            document.querySelectorAll('.update-advertising').forEach(btn => {
                btn.replaceWith(btn.cloneNode(true));
            });
            
            // 添加广告费更新事件
            document.querySelectorAll('.update-advertising').forEach(btn => {
                btn.addEventListener('click', function() {
                    const productId = this.getAttribute('data-product-id');
                    const input = document.getElementById(`advertising-fee-${productId}`);
                    
                    if (!input) {
                        console.error(`输入框未找到: advertising-fee-${productId}`);
                        showToast('错误', '输入框未找到', 'error');
                        return;
                    }
                    
                    const value = parseFloat(input.value) || 0;
                    
                    const product = productData.find(p => p.id === productId);
                    if (product) {
                        // 更新广告费
                        product.advertisingFee = value;
                        
                        // 重新计算净利润，考虑快递续重费
                        const additionalShippingFee = parseFloat(document.getElementById('additional-shipping-fee').value) || 0;
                        if (additionalShippingFee > 0) {
                            const totalQuantity = productData.reduce((sum, p) => sum + p.totalQuantity, 0);
                            if (totalQuantity > 0) {
                                const allocatedShippingFee = (product.totalQuantity / totalQuantity) * additionalShippingFee;
                                product.allocatedShippingFee = allocatedShippingFee;
                                product.netProfit = product.totalRevenue - product.totalCost - value - allocatedShippingFee;
                            } else {
                                product.allocatedShippingFee = 0;
                                product.netProfit = product.totalRevenue - product.totalCost - value;
                            }
                        } else {
                            product.allocatedShippingFee = 0;
                            product.netProfit = product.totalRevenue - product.totalCost - value;
                        }
                        
                        // 重新渲染结果
                        renderResults();
                        
                        // 更新数据看板
                        updateDashboard();
                        
                        showToast('成功', '广告费已更新', 'success');
                    } else {
                        console.error(`商品未找到: ${productId}`);
                        showToast('错误', '商品数据未找到', 'error');
                    }
                });
            });

        }


        
        // 店铺管理相关函数
        function showAddShopModal(shopId = null) {
            const modal = document.getElementById('add-shop-modal');
            const title = document.getElementById('shop-modal-title');
            const form = document.getElementById('add-shop-form');
            
            if (shopId) {
                const shop = shops.find(s => s.id === shopId);
                title.textContent = '编辑店铺';
                document.getElementById('shop-id').value = shop.id;
                document.getElementById('shop-name').value = shop.name;
                document.getElementById('shop-display-id').value = shop.displayId || '';
                document.getElementById('shop-products').value = shop.productIds.join('\n');
            } else {
                title.textContent = '添加店铺';
                form.reset();
                document.getElementById('shop-id').value = '';
            }
            
            modal.classList.remove('hidden');
        }
        
        function hideAddShopModal() {
            document.getElementById('add-shop-modal').classList.add('hidden');
        }
        
        function saveShop() {
            const shopId = document.getElementById('shop-id').value;
            const shopName = document.getElementById('shop-name').value.trim();
            const shopDisplayId = document.getElementById('shop-display-id').value.trim();
            const shopProducts = document.getElementById('shop-products').value.trim();
            
            if (!shopName) {
                showToast('错误', '请输入店铺名称', 'error');
                return;
            }
            
            const productIds = shopProducts ? shopProducts.split('\n').map(id => id.trim()).filter(id => id) : [];
            
            if (shopId) {
                // 编辑现有店铺
                const shopIndex = shops.findIndex(s => s.id === shopId);
                shops[shopIndex] = {
                    ...shops[shopIndex],
                    name: shopName,
                    displayId: shopDisplayId,
                    productIds: productIds
                };
                showToast('成功', '店铺更新成功');
            } else {
                // 添加新店铺
                shops.push({
                    id: Date.now().toString(),
                    name: shopName,
                    displayId: shopDisplayId,
                    productIds: productIds,
                    createdAt: new Date().toISOString()
                });
                showToast('成功', '店铺添加成功');
            }
            
            // 保存到本地存储
            localStorage.setItem('shops', JSON.stringify(shops));
            
            // 重新渲染店铺列表
            renderShops();
            
            // 更新数据计算区店铺筛选器
            updateCalculationShopFilter();
            
            // 隐藏模态框
            hideAddShopModal();
            
            // 更新数据计算区的店铺显示
            if (!document.getElementById('data-calculation').classList.contains('hidden')) {
                renderDataCalculation();
            }
        }
        
        function deleteShop(shopId) {
            const shop = shops.find(s => s.id === shopId);
            if (!shop) return;
            
            // 显示删除确认模态框
            openDeleteConfirmModal(
                '确认删除店铺',
                `确定要删除"${shop.name}"店铺吗？此操作无法撤销。`,
                function() {
                    shops = shops.filter(s => s.id !== shopId);
                    localStorage.setItem('shops', JSON.stringify(shops));
                    renderShops();
                    showToast('成功', '店铺删除成功');
                    
                    // 更新数据计算区的店铺显示
                    if (!document.getElementById('data-calculation').classList.contains('hidden')) {
                        renderDataCalculation();
                    }
                }
            );
        }
        
        function renderShops() {
            const container = document.getElementById('shops-container');
            const empty = document.getElementById('shops-empty');
            
            // 更新店铺数量显示
            const shopCountElement = document.getElementById('shop-count-number');
            if (shopCountElement) {
                shopCountElement.textContent = shops.length;
            }
            
            if (shops.length === 0) {
                container.innerHTML = '';
                empty.classList.remove('hidden');
                return;
            }
            
            empty.classList.add('hidden');
            
            container.innerHTML = shops.map(shop => `
                <div class="bg-white rounded-xl border border-gray-100 p-6 mb-6 shadow-sm hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1">
                    <div class="flex justify-between items-center mb-6">
                        <div class="flex items-center space-x-4">
                            <h3 class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-4 py-3 rounded-lg shadow-md text-lg font-bold">${shop.name}</h3>
                            <span class="inline-flex items-center px-3 py-1.5 rounded-full text-sm font-medium bg-blue-100 text-blue-800 border border-blue-200">
                                <i class="fa fa-cubes mr-1.5"></i> ${shop.productIds.length} 个商品
                            </span>
                        </div>
                        <div class="flex space-x-2">
                            <button class="btn btn-sm btn-secondary hover:bg-gray-200 transition-colors duration-300" onclick="showAddShopModal('${shop.id}')" title="编辑店铺">
                                <i class="fa fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger hover:bg-red-600 transition-colors duration-300" onclick="deleteShop('${shop.id}')" title="删除店铺">
                                <i class="fa fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <label class="block text-sm font-semibold text-gray-700">关联商品ID</label>
                            <span class="text-xs text-gray-500">点击标签可移除</span>
                        </div>
                        <div class="flex flex-wrap gap-2 max-h-40 overflow-y-auto p-2 border border-gray-100 rounded-lg bg-gray-50" style="scrollbar-width: thin; scrollbar-color: #cbd5e1 #f8fafc;">
                            ${shop.productIds.length > 0 ? shop.productIds.map(productId => `
                                <span class="inline-flex items-center px-3 py-1.5 rounded-full text-sm font-medium bg-blue-100 text-blue-800 hover:bg-blue-200 transition-colors duration-200">
                                    <i class="fa fa-tag mr-1.5"></i> ${productId}
                                    <i class="fa fa-times ml-1.5 text-blue-600 hover:text-blue-800 cursor-pointer hover:bg-blue-300 hover:rounded-full p-0.5 transition-colors duration-200" onclick="removeProductFromShop('${shop.id}', '${productId}'); event.stopPropagation();" title="移除商品ID"></i>
                                </span>
                            `).join('') : '<span class="text-sm text-gray-500 italic">暂无关联商品</span>'}
                        </div>
                    </div>
                    
                    <div class="flex justify-between items-center pt-4 border-t border-gray-100">
                        <button class="btn btn-sm btn-secondary hover:bg-gray-500 transition-colors duration-300 flex items-center space-x-1" onclick="showAddShopModal('${shop.id}')">
                            <i class="fa fa-plus"></i>
                            <span>添加商品ID</span>
                        </button>
                        <div class="text-xs text-gray-400">
                            ID: ${shop.displayId || shop.id}
                        </div>
                    </div>
                </div>


            `).join('');
        }
        
        function removeProductFromShop(shopId, productId) {
            const shop = shops.find(s => s.id === shopId);
            if (shop) {
                shop.productIds = shop.productIds.filter(id => id !== productId);
                localStorage.setItem('shops', JSON.stringify(shops));
                renderShops();
                
                // 更新数据计算区的店铺显示
                if (!document.getElementById('data-calculation').classList.contains('hidden')) {
                    renderDataCalculation();
                }
            }
        }
        
        // 根据商品ID获取店铺名称
        function getShopNameByProductId(productId) {
            for (const shop of shops) {
                if (shop.productIds.includes(productId)) {
                    return shop.name;
                }
            }
            return '未分类';
        }
        
        // 回收站相关函数
        function bindRecycleBinEvents() {
            const recycleBinBtn = document.getElementById('recycle-bin-btn');
            const recycleBinList = document.getElementById('recycle-bin-list');
            const recycleBinContainer = document.getElementById('recycle-bin-container');
            const emptyRecycleBinBtn = document.getElementById('empty-recycle-bin');
            
            // 点击回收站按钮显示/隐藏列表
            recycleBinBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                recycleBinList.classList.toggle('hidden');
                if (!recycleBinList.classList.contains('hidden')) {
                    renderRecycleBin();
                }
            });
            
            // 点击清空回收站
            emptyRecycleBinBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                if (recycleBin.length > 0) {
                    if (confirm('确定要清空回收站吗？此操作不可撤销。')) {
                        recycleBin = [];
                        localStorage.setItem('recycleBin', JSON.stringify(recycleBin));
                        updateRecycleBinCount();
                        renderRecycleBin();
                        showToast('成功', '回收站已清空', 'success');
                    }
                }
            });
            
            // 点击其他地方隐藏回收站列表
            document.addEventListener('click', function(e) {
                if (!recycleBinContainer.contains(e.target)) {
                    recycleBinList.classList.add('hidden');
                }
            });
        }
        
        function updateRecycleBinCount() {
            const countElement = document.getElementById('recycle-bin-count');
            const count = recycleBin.length;
            countElement.textContent = count;
            countElement.style.display = count > 0 ? 'flex' : 'none';
        }
        
        function renderRecycleBin() {
            const itemsContainer = document.getElementById('recycle-bin-items');
            const emptyContainer = document.getElementById('recycle-bin-empty');
            
            if (recycleBin.length === 0) {
                itemsContainer.innerHTML = '';
                itemsContainer.classList.add('hidden');
                emptyContainer.classList.remove('hidden');
                return;
            }
            
            itemsContainer.classList.remove('hidden');
            emptyContainer.classList.add('hidden');
            
            let html = '';
            recycleBin.forEach((item, index) => {
                const deletedDate = new Date(item.deletedAt).toLocaleString('zh-CN');
                html += `
                    <div class="recycle-bin-item p-3 border-b border-gray-100 hover:bg-gray-50">
                        <div class="flex items-center justify-between mb-1">
                            <span class="font-medium text-gray-800 text-sm cursor-pointer hover:text-primary restore-item" data-index="${index}">
                                ${item.name}
                            </span>
                            <button class="text-gray-400 hover:text-danger delete-forever" data-index="${index}" title="彻底删除">
                                <i class="fa fa-times"></i>
                            </button>
                        </div>
                        <div class="flex items-center justify-between text-xs text-gray-500">
                            <span>删除时间: ${deletedDate}</span>
                            <span class="text-primary cursor-pointer hover:underline restore-item" data-index="${index}">
                                恢复
                            </span>
                        </div>
                    </div>
                `;
            });
            
            itemsContainer.innerHTML = html;
            
            // 绑定恢复事件
            itemsContainer.querySelectorAll('.restore-item').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.dataset.index);
                    restoreFromRecycleBin(index);
                });
            });
            
            // 绑定彻底删除事件
            itemsContainer.querySelectorAll('.delete-forever').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const index = parseInt(this.dataset.index);
                    deleteForeverFromRecycleBin(index);
                });
            });
        }
        
        function restoreFromRecycleBin(index) {
            if (index >= 0 && index < recycleBin.length) {
                const item = recycleBin[index];
                delete item.deletedAt;
                
                // 检查是否已存在同名数据
                const existingIndex = savedData.findIndex(savedItem => savedItem.id === item.id);
                if (existingIndex !== -1) {
                    // 如果存在，询问是否覆盖
                    if (confirm('已存在同名数据，是否覆盖？')) {
                        savedData[existingIndex] = item;
                    } else {
                        // 不覆盖，添加新的
                        item.id = Date.now().toString();
                        savedData.unshift(item);
                    }
                } else {
                    savedData.unshift(item);
                }
                
                // 从回收站移除
                recycleBin.splice(index, 1);
                
                // 保存到本地存储
                localStorage.setItem('savedData', JSON.stringify(savedData));
                localStorage.setItem('recycleBin', JSON.stringify(recycleBin));
                
                // 更新界面
                updateRecycleBinCount();
                renderRecycleBin();
                searchSavedData();
                
                showToast('成功', '数据已恢复', 'success');
            }
        }
        
        function deleteForeverFromRecycleBin(index) {
            if (index >= 0 && index < recycleBin.length) {
                if (confirm('确定要彻底删除这个数据吗？此操作不可撤销。')) {
                    recycleBin.splice(index, 1);
                    localStorage.setItem('recycleBin', JSON.stringify(recycleBin));
                    updateRecycleBinCount();
                    renderRecycleBin();
                    showToast('成功', '数据已彻底删除', 'success');
                }
            }
        }
        
        // 数据保存相关函数
        function saveCurrentData() {
            if (productData.length === 0) {
                showToast('错误', '没有可保存的数据', 'error');
                return;
            }
            
            const saveNameInput = document.getElementById('save-name');
            const reportMonth = document.getElementById('report-month').value;
            
            let saveName = saveNameInput.value.trim();
            if (!saveName) {
                saveName = reportMonth || `数据_${new Date().toISOString().split('T')[0]}`;
            }
            
            const dataToSave = {
                id: Date.now().toString(),
                name: saveName,
                reportMonth: reportMonth,
                productData: JSON.parse(JSON.stringify(productData)),
                excelData: JSON.parse(JSON.stringify(excelData)),
                skuCosts: JSON.parse(JSON.stringify(skuCosts)),
                costRecords: JSON.parse(JSON.stringify(costRecords)),
                createdAt: new Date().toISOString()
            };
            
            // 将新保存的数据添加到开头
            savedData.unshift(dataToSave);
            
            // 使用LZ-String压缩数据后保存到本地存储
            try {
                const dataString = JSON.stringify(savedData);
                const compressedData = LZString.compress(dataString);
                if (compressedData) {
                    localStorage.setItem('savedData', compressedData);
                    console.log('数据压缩并保存成功。原始大小:', dataString.length, '字符, 压缩后大小:', compressedData.length, '字符');
                } else {
                    throw new Error('数据压缩失败，结果为空');
                }
            } catch (error) {
                console.error('保存压缩数据时出错:', error);
                // 如果压缩失败，尝试直接保存未压缩的数据
                try {
                    localStorage.setItem('savedData', JSON.stringify(savedData));
                } catch (saveError) {
                    console.error('Failed to save data:', saveError);
                    showToast('错误', '保存数据失败，请检查存储空间', 'error');
                    return;
                }
            }
            
            // 同时保存回收站数据
            try {
                localStorage.setItem('recycleBin', JSON.stringify(recycleBin));
                console.log('回收站数据保存成功');
            } catch (error) {
                console.error('保存回收站数据失败:', error);
            }
            
            // 清空输入框
            saveNameInput.value = '';
            
            // 重新渲染保存的数据列表
            searchSavedData();
            
            showToast('成功', '数据保存成功');
        }
        
        function loadSavedData(dataId) {
            const data = savedData.find(item => item.id === dataId);
            if (!data) {
                showToast('错误', '未找到保存的数据', 'error');
                return;
            }
            
            // 加载数据，但不覆盖当前的规格成本和成本记录
            // 这样新上传的文件仍然可以使用最新的规格成本
            productData = JSON.parse(JSON.stringify(data.productData));
            excelData = JSON.parse(JSON.stringify(data.excelData));
            // 不覆盖skuCosts和costRecords，保持使用当前最新的数据
            
            // 为加载的保存数据添加标识和使用保存的成本
            productData = productData.map(product => {
                // 为每个SKU保存原始成本
                Object.values(product.skus).forEach(sku => {
                    sku.originalCost = sku.cost; // 保存SKU的原始成本
                    sku.isSavedData = true; // 标记为保存的SKU数据
                });
                
                return {
                    ...product,
                    isSavedData: true, // 标记为保存的数据
                    savedUnitCost: product.unitCost, // 使用保存时的单件成本
                    savedTotalCost: product.totalCost // 使用保存时的总成本
                };
            });
            
            // 设置报表年月
            document.getElementById('report-month').value = data.reportMonth;
            
            // 清零快递续重费
            document.getElementById('additional-shipping-fee').value = '';
            
            // 重新渲染结果
            renderResults();
            
            // 启用保存按钮
            document.getElementById('save-data').disabled = false;
            
            showToast('成功', '数据加载成功，使用保存时的成本数据');
        }
        
        function deleteSavedData(dataId) {
            const deleteBtn = event.target.closest('.delete-btn');
            if (!deleteBtn) return;
            
            // 检查是否在冷却期
            if (deleteBtn.dataset.cooling === 'true') {
                return; // 冷却期内忽略重复点击
            }
            
            // 保存原始状态
            const originalHTML = deleteBtn.innerHTML;
            const originalDisabled = deleteBtn.disabled;
            
            // 进入冷却期
            deleteBtn.dataset.cooling = 'true';
            deleteBtn.disabled = true;
            deleteBtn.textContent = '3秒';
            
            let countdown = 3;
            const timer = setInterval(() => {
                countdown--;
                if (countdown > 0) {
                    deleteBtn.textContent = `${countdown}秒`;
                } else {
                    clearInterval(timer);
                    // 冷却期结束，自动显示确认模态框
                    showDeleteConfirmation(dataId, deleteBtn, originalHTML, originalDisabled);
                }
            }, 1000);
            
            // 显示提示信息
            showToast('提示', '为防止误操作，将在3秒后自动弹出确认窗口', 'info');
        }
        
        // 显示删除确认模态框
        function showDeleteConfirmation(dataId, deleteBtn, originalHTML, originalDisabled) {
            // 创建模态框
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.id = 'delete-confirmation-modal';
            
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-lg w-full max-w-md">
                    <div class="p-6">
                        <div class="text-center mb-6">
                            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-red-100 text-red-500 mb-4">
                                <i class="fa fa-exclamation-triangle text-2xl"></i>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">确认删除</h3>
                            <p class="text-gray-600">确定要删除这个保存的数据吗？</p>
                            <p class="text-sm text-gray-500 mt-2">删除后将移至回收站</p>
                        </div>
                        
                        <div class="flex space-x-3">
                            <button id="cancel-delete" class="flex-1 btn btn-secondary h-10">
                                取消
                            </button>
                            <button id="confirm-delete" class="flex-1 btn btn-danger h-10">
                                确认删除
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // 添加到页面
            document.body.appendChild(modal);
            
            // 绑定事件
            document.getElementById('cancel-delete').onclick = function() {
                document.body.removeChild(modal);
                showToast('提示', '删除操作已取消', 'info');
                
                // 完全恢复按钮状态
                deleteBtn.disabled = false;
                deleteBtn.innerHTML = originalHTML;
                deleteBtn.classList.remove('bg-gray-200', 'text-gray-800', 'hover:bg-gray-300', 'editing-breathing-bg');
                deleteBtn.classList.add('btn-danger');
                deleteBtn.dataset.cooling = 'false';
                deleteBtn.dataset.confirming = 'false';
                deleteBtn.dataset.deleting = 'false';
            };
            
            document.getElementById('confirm-delete').onclick = function() {
                // 移除模态框
                document.body.removeChild(modal);
                
                // 执行删除操作
                performDelete(dataId, deleteBtn, originalHTML, originalDisabled);
            };
            
            // 点击背景关闭
            modal.onclick = function(e) {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                    showToast('提示', '删除操作已取消', 'info');
                    
                    // 恢复按钮状态
                    deleteBtn.disabled = originalDisabled;
                    deleteBtn.innerHTML = originalHTML;
                    deleteBtn.classList.remove('bg-gray-200 text-gray-800 hover:bg-gray-300');
                    deleteBtn.dataset.cooling = 'false';
                }
            };
        }
        
        // 执行删除操作
        function performDelete(dataId, deleteBtn, originalHTML, originalDisabled) {
            try {
                // 找到要删除的数据
                const deletedItem = savedData.find(item => item.id === dataId);
                if (deletedItem) {
                    // 添加到回收站
                    deletedItem.deletedAt = new Date().toISOString();
                    recycleBin.unshift(deletedItem);
                    
                    // 从保存数据中移除
                    savedData = savedData.filter(item => item.id !== dataId);
                    
                    // 保存到本地存储
                    const savedDataString = JSON.stringify(savedData);
                    const compressedSavedData = LZString.compress(savedDataString);
                    if (compressedSavedData) {
                        localStorage.setItem('savedData', compressedSavedData);
                    } else {
                        localStorage.setItem('savedData', savedDataString);
                    }
                    
                    const recycleBinString = JSON.stringify(recycleBin);
                    const compressedRecycleBin = LZString.compress(recycleBinString);
                    if (compressedRecycleBin) {
                        localStorage.setItem('recycleBin', compressedRecycleBin);
                    } else {
                        localStorage.setItem('recycleBin', recycleBinString);
                    }
                    
                    // 更新回收站计数
                    updateRecycleBinCount();
                    
                    // 重新渲染保存的数据列表
                    searchSavedData();
                    
                    showToast('成功', '数据已移至回收站', 'success');
                }
            } catch (error) {
                console.error('删除数据时出错:', error);
                showToast('错误', '删除失败，请重试', 'error');
            } finally {
                // 恢复按钮状态
                deleteBtn.disabled = false;
                deleteBtn.innerHTML = originalHTML;
                deleteBtn.classList.remove('bg-gray-200 text-gray-800 hover:bg-gray-300');
                deleteBtn.dataset.cooling = 'false';
            }
        }
        
        function searchSavedData() {
            const searchTerm = document.getElementById('search-saved-data').value.toLowerCase().trim();
            
            if (searchTerm) {
                filteredSavedData = savedData.filter(item => 
                    item.name.toLowerCase().includes(searchTerm)
                );
            } else {
                filteredSavedData = [...savedData];
            }
            
            currentPage = 1;
            renderSavedData();
        }
        
        function renderSavedData() {
            const container = document.getElementById('saved-data-list');
            const empty = document.getElementById('saved-data-empty');
            const pagination = document.getElementById('pagination');
            
            if (filteredSavedData.length === 0) {
                container.innerHTML = '';
                empty.classList.remove('hidden');
                pagination.classList.add('hidden');
                return;
            }
            
            empty.classList.add('hidden');
            
            // 计算分页
            const totalPages = Math.ceil(filteredSavedData.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, filteredSavedData.length);
            const pageData = filteredSavedData.slice(startIndex, endIndex);
            
            let html = '';
            pageData.forEach((item, index) => {
                const date = new Date(item.createdAt);
                const formattedTime = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} | ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
                
                html += `
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-md">
                        <div class="flex items-center">
                            <i class="fa fa-database text-primary mr-3"></i>
                            <div>
                                <p class="font-medium text-gray-800">${item.name}</p>
                                <p class="text-xs text-gray-500">${formattedTime}</p>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <button class="btn btn-sm btn-secondary p-2 hover:bg-secondary/80 transition-colors" onclick="loadSavedData('${item.id}')" title="加载数据">
                                <i class="fa fa-folder-open"></i>
                            </button>
                            <button class="btn btn-sm btn-danger delete-btn" onclick="deleteSavedData('${item.id}')" data-cooling="false">
                                <i class="fa fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // 更新分页信息
            document.getElementById('page-info').textContent = `第 ${currentPage} 页，共 ${totalPages} 页`;
            document.getElementById('prev-page').disabled = currentPage === 1;
            document.getElementById('next-page').disabled = currentPage === totalPages;
            
            pagination.classList.remove('hidden');
        }
        
        function updateSaveButtonState() {
            const saveButton = document.getElementById('save-data');
            saveButton.disabled = productData.length === 0;
        }
        
        // 渲染规格成本表格
        function renderSkuCosts() {
            const tableBody = document.getElementById('sku-costs-table');
            const emptyState = document.getElementById('sku-costs-empty');
            const searchInput = document.getElementById('sku-search');
            const searchTerm = searchInput ? searchInput.value.toLowerCase().trim() : '';
            
            // 过滤规格
            const filteredSkus = searchTerm 
                ? Object.keys(skuCosts).filter(code => code.toLowerCase().includes(searchTerm))
                : Object.keys(skuCosts);
            
            if (filteredSkus.length === 0) {
                tableBody.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            
            let html = '';
            
            filteredSkus.forEach(code => {
                const sku = skuCosts[code];
                
                // 计算引用成本总和
                const referencedTotal = calculateReferencedCostTotal(sku.referencedCosts || []);
                const totalCost = sku.cost + referencedTotal;
                
                html += `
                    <tr class="hover:bg-gray-50 transition-colors duration-150 group">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <input type="checkbox" class="sku-checkbox h-4 w-4 text-primary focus:ring-primary" data-sku="${code}">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${code}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 text-right">¥${sku.cost.toFixed(2)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 text-right">¥${referencedTotal.toFixed(2)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-blue-600 text-right">¥${totalCost.toFixed(2)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                            <div class="max-w-[120px] truncate relative" data-tooltip="${sku.note || ''}">
                                ${sku.note || '-'}
                                ${sku.note ? `
                                    <div class="tooltip absolute z-50 invisible opacity-0 group-hover:visible group-hover:opacity-100 transition-all duration-200 bg-gray-900 text-white text-xs rounded-md py-2 px-3 max-w-xs whitespace-normal break-words shadow-lg bottom-full left-1/2 transform -translate-x-1/2 mb-2 pointer-events-none">
                                        ${sku.note}
                                    </div>
                                ` : ''}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button class="text-gray-500 hover:text-primary transition-colors duration-150 mr-3 edit-sku" data-sku="${code}" title="编辑">
                                <i class="fa fa-pencil"></i>
                            </button>
                            <button class="text-gray-500 hover:text-danger transition-colors duration-150 delete-sku" data-sku="${code}" title="删除">
                                <i class="fa fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
            
            // 更新数量统计
            document.getElementById('sku-count').textContent = filteredSkus.length;
            
            // 添加批量删除事件处理
            const selectAllCheckbox = document.getElementById('select-all-skus');
            const batchDeleteBtn = document.getElementById('batch-delete-skus');
            const skuCheckboxes = document.querySelectorAll('.sku-checkbox');
            
            // 更新批量删除按钮状态
            function updateBatchDeleteButton() {
                const selectedCount = document.querySelectorAll('.sku-checkbox:checked').length;
                batchDeleteBtn.disabled = selectedCount === 0;
                batchDeleteBtn.textContent = selectedCount > 0 ? `批量删除 (${selectedCount})` : '批量删除';
                batchDeleteBtn.innerHTML = selectedCount > 0 ? `<i class="fa fa-trash"></i> 批量删除 (${selectedCount})` : '<i class="fa fa-trash"></i> 批量删除';
            }
            
            // 全选/取消全选
            if (selectAllCheckbox) {
                selectAllCheckbox.addEventListener('change', function() {
                    skuCheckboxes.forEach(checkbox => {
                        checkbox.checked = this.checked;
                    });
                    updateBatchDeleteButton();
                });
            }
            
            // 单个复选框变化
            skuCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    // 检查是否所有复选框都被选中
                    const allChecked = Array.from(skuCheckboxes).every(cb => cb.checked);
                    selectAllCheckbox.checked = allChecked;
                    updateBatchDeleteButton();
                });
            });
            
            // 批量删除按钮点击
            if (batchDeleteBtn) {
                let isBatchDeleteOnCooldown = false;
                
                batchDeleteBtn.addEventListener('click', function() {
                    const selectedSkus = Array.from(document.querySelectorAll('.sku-checkbox:checked')).map(cb => cb.getAttribute('data-sku'));
                    
                    if (selectedSkus.length === 0) {
                        showToast('提示', '请先选择要删除的规格编码', 'info');
                        return;
                    }
                    
                    // 检查是否在冷却中
                    if (isBatchDeleteOnCooldown) {
                        showToast('提示', '批量删除功能正在冷却中，请稍后再试', 'warning');
                        return;
                    }
                    
                    // 设置冷却状态
                    isBatchDeleteOnCooldown = true;
                    const originalText = batchDeleteBtn.innerHTML;
                    let countdown = 3;
                    
                    // 更新按钮显示
                    batchDeleteBtn.innerHTML = `<i class="fa fa-clock-o"></i> 批量删除(${countdown}s)`;
                    batchDeleteBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    
                    // 倒计时
                    const timer = setInterval(() => {
                        countdown--;
                        if (countdown > 0) {
                            batchDeleteBtn.innerHTML = `<i class="fa fa-clock-o"></i> 批量删除(${countdown}s)`;
                        } else {
                            clearInterval(timer);
                            
                            // 显示删除确认模态框
                            openDeleteConfirmModal(
                                '批量删除确认',
                                `确定要删除选中的 ${selectedSkus.length} 个规格编码吗？此操作无法撤销。`,
                                function() {
                                    // 删除选中的规格编码
                                    selectedSkus.forEach(skuCode => {
                                        delete skuCosts[skuCode];
                                        console.log(`已删除规格编码: ${skuCode}`);
                                    });
                                    
                                    // 保存数据
                                    saveData();
                                    
                                    // 重新渲染表格
                                    renderSkuCosts();
                                    
                                    // 手动重置全选复选框状态
                                    setTimeout(() => {
                                        const selectAllCheckbox = document.getElementById('select-all-skus');
                                        const batchDeleteBtn = document.getElementById('batch-delete-skus');
                                        if (selectAllCheckbox) {
                                            selectAllCheckbox.checked = false;
                                        }
                                        if (batchDeleteBtn) {
                                            batchDeleteBtn.disabled = true;
                                            batchDeleteBtn.innerHTML = '<i class="fa fa-trash"></i> 批量删除';
                                        }
                                    }, 100);
                                    
                                    // 显示成功提示
                                    showToast('成功', `已成功删除 ${selectedSkus.length} 个规格编码`, 'success');
                                    
                                    // 重新计算产品利润
                                    if (typeof calculateProfit === 'function' && productData.length > 0) {
                                        calculateProfit();
                                    }
                                }
                            );
                            
                            // 恢复按钮状态
                            batchDeleteBtn.innerHTML = originalText;
                            batchDeleteBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                            isBatchDeleteOnCooldown = false;
                        }
                    }, 1000);
                });
            }
            
            // 添加编辑和删除事件
            document.querySelectorAll('.edit-sku').forEach(btn => {
                btn.addEventListener('click', function() {
                    const skuCode = this.getAttribute('data-sku');
                    const sku = skuCosts[skuCode];
                    
                    // 填充表单
                    document.getElementById('sku-code').value = skuCode;
                    document.getElementById('sku-cost').value = sku.cost;
                    document.getElementById('sku-note').value = sku.note || '';
                    
                    // 显示模态框
                    document.getElementById('add-sku-modal').classList.remove('hidden');
                    
                    // 清空引用成本项目容器
                    document.getElementById('referenced-costs-container').innerHTML = '';
                    
                    // 填充已有的引用成本项目
                    console.log('Editing SKU:', skuCode, 'Referenced Costs:', sku.referencedCosts);
                    if (sku.referencedCosts && sku.referencedCosts.length > 0) {
                        console.log('Loading referenced costs:', sku.referencedCosts);
                        // 清空容器
                        document.getElementById('referenced-costs-container').innerHTML = '';
                        // 重新添加所有引用项目
                        sku.referencedCosts.forEach((ref, index) => {
                            console.log('Loading ref cost:', index, ref);
                            // 添加新项目而不是更新现有项目
                            addReferencedCostItem(ref.costType, ref.costId, ref.quantity);
                        });
                    } else {
                        console.log('No referenced costs found for SKU:', skuCode);
                    }
                    
                    // 更新总成本预览
                    updateTotalCostPreview();
                    
                    // 修改提交事件，使其更新而不是添加
                    const originalSubmitHandler = document.getElementById('add-sku-form').onsubmit;
                    
                    document.getElementById('add-sku-form').onsubmit = function(e) {
                        e.preventDefault();
                        
                        const newCode = document.getElementById('sku-code').value.trim();
                        const newCost = parseFloat(document.getElementById('sku-cost').value);
                        const newNote = document.getElementById('sku-note').value.trim();
                        
                        if (newCode && !isNaN(newCost)) {
                            // 收集引用的成本项目
                            const referencedCosts = [];
                            const container = document.getElementById('referenced-costs-container');
                            
                            for (let i = 0; i < container.children.length; i++) {
                                const item = container.children[i];
                                const costType = item.querySelector('.cost-type-select').value;
                                const costId = item.querySelector('.cost-item-select').value;
                                const quantity = parseInt(item.querySelector('.quantity-input').value) || 0;
                                
                                if (costType && costId && quantity > 0) {
                                    const costItem = findCostItemById(costType, costId);
                                    if (costItem) {
                                        referencedCosts.push({
                                            costType: costType,
                                            costId: costId,
                                            quantity: quantity,
                                            unitCost: costItem.amount,
                                            totalCost: costItem.amount * quantity
                                        });
                                    }
                                }
                            }
                            
                            // 计算总成本
                            const referencedTotal = calculateReferencedCostTotal(referencedCosts);
                            const totalCost = newCost + referencedTotal;
                            
                            // 如果编码改变，需要删除旧的
                            if (newCode !== skuCode) {
                                delete skuCosts[skuCode];
                            }
                            
                            // 添加新的
                            skuCosts[newCode] = {
                                cost: newCost,
                                referencedCosts: referencedCosts,
                                totalCost: totalCost,
                                note: newNote
                            };
                            
                            console.log('Updated SKU:', newCode, skuCosts[newCode]);
                            
                            saveData();
                            renderSkuCosts();
                            closeModal('add-sku-modal');
                            resetForm('add-sku-form');
                            
                            // 恢复原始提交处理程序
                            document.getElementById('add-sku-form').onsubmit = originalSubmitHandler;
                            
                            showToast('成功', '规格成本已更新', 'success');
                            
                            // 重新计算产品利润
                            if (productData.length > 0) {
                                calculateProfit();
                            }
                        }
                    };
                });
            });
            
            // 为删除按钮添加直接的点击处理
            document.querySelectorAll('.delete-sku').forEach(btn => {
                // 使用立即执行函数确保每个按钮都有自己的闭包
                (function(button) {
                    // 清除所有可能的事件监听器
                    button.onclick = null;
                    
                    // 添加冷却状态变量
                    let isOnCooldown = false;
                    
                    // 添加新的点击处理函数
                    button.onclick = function(e) {
                        e = e || window.event;
                        e.stopPropagation ? e.stopPropagation() : (e.cancelBubble = true);
                        
                        const skuCode = this.getAttribute('data-sku');
                        
                        // 检查是否在冷却中
                        if (isOnCooldown) {
                            showToast('提示', '删除功能正在冷却中，请稍后再试', 'warning');
                            return;
                        }
                        
                        // 设置冷却状态
                        isOnCooldown = true;
                        const originalText = button.innerHTML;
                        let countdown = 3;
                        
                        // 更新按钮显示
                        button.innerHTML = `<i class="fa fa-clock-o"></i> ${countdown}s`;
                        button.classList.add('text-gray-400', 'cursor-not-allowed');
                        button.disabled = true;
                        
                        // 倒计时
                        const timer = setInterval(() => {
                            countdown--;
                            if (countdown > 0) {
                                button.innerHTML = `<i class="fa fa-clock-o"></i> ${countdown}s`;
                            } else {
                                clearInterval(timer);
                                
                                // 显示删除确认模态框
                                openDeleteConfirmModal(
                                    '确认删除',
                                    `确定要删除规格 ${skuCode} 的成本记录吗？此操作无法撤销。`,
                                    function() {
                                        delete skuCosts[skuCode];
                                        
                                        saveData();
                                        renderSkuCosts();
                                        
                                        showToast('成功', '规格成本已删除', 'success');
                                    }
                                );
                                
                                // 恢复按钮状态
                                button.innerHTML = originalText;
                                button.classList.remove('text-gray-400', 'cursor-not-allowed');
                                button.disabled = false;
                                isOnCooldown = false;
                            }
                        }, 1000);
                    };
                })(btn);
            });
        }
        
        // 店铺管理相关函数
        function showAddShopModal(shopId = null) {
            const modal = document.getElementById('add-shop-modal');
            const title = document.getElementById('shop-modal-title');
            const form = document.getElementById('add-shop-form');
            
            if (shopId) {
                const shop = shops.find(s => s.id === shopId);
                title.textContent = '编辑店铺';
                document.getElementById('shop-id').value = shop.id;
                document.getElementById('shop-name').value = shop.name;
                document.getElementById('shop-display-id').value = shop.displayId || '';
                document.getElementById('shop-products').value = shop.productIds.join('\n');
            } else {
                title.textContent = '添加店铺';
                form.reset();
                document.getElementById('shop-id').value = '';
            }
            
            modal.classList.remove('hidden');
        }
        
        function hideAddShopModal() {
            document.getElementById('add-shop-modal').classList.add('hidden');
        }
        
        function saveShop() {
            const shopId = document.getElementById('shop-id').value;
            const shopName = document.getElementById('shop-name').value.trim();
            const shopDisplayId = document.getElementById('shop-display-id').value.trim();
            const shopProducts = document.getElementById('shop-products').value.trim();
            
            if (!shopName) {
                showToast('错误', '请输入店铺名称', 'error');
                return;
            }
            
            const productIds = shopProducts ? shopProducts.split('\n').map(id => id.trim()).filter(id => id) : [];
            
            if (shopId) {
                // 编辑现有店铺
                const shopIndex = shops.findIndex(s => s.id === shopId);
                shops[shopIndex] = {
                    ...shops[shopIndex],
                    name: shopName,
                    displayId: shopDisplayId,
                    productIds: productIds
                };
                showToast('成功', '店铺更新成功');
            } else {
                // 添加新店铺
                shops.push({
                    id: Date.now().toString(),
                    name: shopName,
                    displayId: shopDisplayId,
                    productIds: productIds,
                    createdAt: new Date().toISOString()
                });
                showToast('成功', '店铺添加成功');
            }
            
            // 保存到本地存储
            localStorage.setItem('shops', JSON.stringify(shops));
            
            // 重新渲染店铺列表
            renderShops();
            
            // 更新数据计算区店铺筛选器
            updateCalculationShopFilter();
            
            // 隐藏模态框
            hideAddShopModal();
            
            // 更新数据计算区的店铺显示
            if (!document.getElementById('data-calculation').classList.contains('hidden')) {
                renderDataCalculation();
            }
        }
        
        function deleteShop(shopId) {
            const shop = shops.find(s => s.id === shopId);
            if (!shop) return;
            
            // 显示删除确认模态框
            openDeleteConfirmModal(
                '确认删除店铺',
                `确定要删除"${shop.name}"店铺吗？此操作无法撤销。`,
                function() {
                    shops = shops.filter(s => s.id !== shopId);
                    localStorage.setItem('shops', JSON.stringify(shops));
                    renderShops();
                    showToast('成功', '店铺删除成功');
                    
                    // 更新数据计算区的店铺显示
                    if (!document.getElementById('data-calculation').classList.contains('hidden')) {
                        renderDataCalculation();
                    }
                }
            );
        }
        
        function renderShops() {
            const container = document.getElementById('shops-container');
            const empty = document.getElementById('shops-empty');
            
            // 更新店铺数量显示
            const shopCountElement = document.getElementById('shop-count-number');
            if (shopCountElement) {
                shopCountElement.textContent = shops.length;
            }
            
            if (shops.length === 0) {
                container.innerHTML = '';
                empty.classList.remove('hidden');
                return;
            }
            
            empty.classList.add('hidden');
            
            container.innerHTML = shops.map(shop => `
                <div class="bg-white rounded-xl border border-gray-100 p-6 mb-6 shadow-sm hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1">
                    <div class="flex justify-between items-center mb-6">
                        <div class="flex items-center space-x-4">
                            <h3 class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-4 py-3 rounded-lg shadow-md text-lg font-bold">${shop.name}</h3>
                            <span class="inline-flex items-center px-3 py-1.5 rounded-full text-sm font-medium bg-blue-100 text-blue-800 border border-blue-200">
                                <i class="fa fa-cubes mr-1.5"></i> ${shop.productIds.length} 个商品
                            </span>
                        </div>
                        <div class="flex space-x-2">
                            <button class="btn btn-sm btn-secondary hover:bg-gray-200 transition-colors duration-300" onclick="showAddShopModal('${shop.id}')" title="编辑店铺">
                                <i class="fa fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger hover:bg-red-600 transition-colors duration-300" onclick="deleteShop('${shop.id}')" title="删除店铺">
                                <i class="fa fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <label class="block text-sm font-semibold text-gray-700">关联商品ID</label>
                            <span class="text-xs text-gray-500">点击标签可移除</span>
                        </div>
                        <div class="flex flex-wrap gap-2 max-h-40 overflow-y-auto p-2 border border-gray-100 rounded-lg bg-gray-50" style="scrollbar-width: thin; scrollbar-color: #cbd5e1 #f8fafc;">
                            ${shop.productIds.length > 0 ? shop.productIds.map(productId => `
                                <span class="inline-flex items-center px-3 py-1.5 rounded-full text-sm font-medium bg-blue-100 text-blue-800 hover:bg-blue-200 transition-colors duration-200">
                                    <i class="fa fa-tag mr-1.5"></i> ${productId}
                                    <i class="fa fa-times ml-1.5 text-blue-600 hover:text-blue-800 cursor-pointer hover:bg-blue-300 hover:rounded-full p-0.5 transition-colors duration-200" onclick="removeProductFromShop('${shop.id}', '${productId}'); event.stopPropagation();" title="移除商品ID"></i>
                                </span>
                            `).join('') : '<span class="text-sm text-gray-500 italic">暂无关联商品</span>'}
                        </div>
                    </div>
                    
                    <div class="flex justify-between items-center pt-4 border-t border-gray-100">
                        <button class="btn btn-sm btn-secondary hover:bg-gray-500 transition-colors duration-300 flex items-center space-x-1" onclick="showAddShopModal('${shop.id}')">
                            <i class="fa fa-plus"></i>
                            <span>添加商品ID</span>
                        </button>
                        <div class="text-xs text-gray-400">
                            ID: ${shop.displayId || shop.id}
                        </div>
                    </div>
                </div>


            `).join('');
        }
        
        function removeProductFromShop(shopId, productId) {
            const shop = shops.find(s => s.id === shopId);
            if (shop) {
                shop.productIds = shop.productIds.filter(id => id !== productId);
                localStorage.setItem('shops', JSON.stringify(shops));
                renderShops();
                
                // 更新数据计算区的店铺显示
                if (!document.getElementById('data-calculation').classList.contains('hidden')) {
                    renderDataCalculation();
                }
            }
        }
        
        // 根据商品ID获取店铺名称
        function getShopNameByProductId(productId) {
            for (const shop of shops) {
                if (shop.productIds.includes(productId)) {
                    return shop.name;
                }
            }
            return '未分类';
        }
        
        // 回收站相关函数
        function bindRecycleBinEvents() {
            const recycleBinBtn = document.getElementById('recycle-bin-btn');
            const recycleBinList = document.getElementById('recycle-bin-list');
            const recycleBinContainer = document.getElementById('recycle-bin-container');
            const emptyRecycleBinBtn = document.getElementById('empty-recycle-bin');
            
            // 点击回收站按钮显示/隐藏列表
            recycleBinBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                recycleBinList.classList.toggle('hidden');
                if (!recycleBinList.classList.contains('hidden')) {
                    renderRecycleBin();
                }
            });
            
            // 点击清空回收站
            emptyRecycleBinBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                if (recycleBin.length > 0) {
                    if (confirm('确定要清空回收站吗？此操作不可撤销。')) {
                        recycleBin = [];
                        localStorage.setItem('recycleBin', JSON.stringify(recycleBin));
                        updateRecycleBinCount();
                        renderRecycleBin();
                        showToast('成功', '回收站已清空', 'success');
                    }
                }
            });
            
            // 点击其他地方隐藏回收站列表
            document.addEventListener('click', function(e) {
                if (!recycleBinContainer.contains(e.target)) {
                    recycleBinList.classList.add('hidden');
                }
            });
        }
        
        function updateRecycleBinCount() {
            const countElement = document.getElementById('recycle-bin-count');
            const count = recycleBin.length;
            countElement.textContent = count;
            countElement.style.display = count > 0 ? 'flex' : 'none';
        }
        
        function renderRecycleBin() {
            const itemsContainer = document.getElementById('recycle-bin-items');
            const emptyContainer = document.getElementById('recycle-bin-empty');
            
            if (recycleBin.length === 0) {
                itemsContainer.innerHTML = '';
                itemsContainer.classList.add('hidden');
                emptyContainer.classList.remove('hidden');
                return;
            }
            
            itemsContainer.classList.remove('hidden');
            emptyContainer.classList.add('hidden');
            
            let html = '';
            recycleBin.forEach((item, index) => {
                const deletedDate = new Date(item.deletedAt).toLocaleString('zh-CN');
                html += `
                    <div class="recycle-bin-item p-3 border-b border-gray-100 hover:bg-gray-50">
                        <div class="flex items-center justify-between mb-1">
                            <span class="font-medium text-gray-800 text-sm cursor-pointer hover:text-primary restore-item" data-index="${index}">
                                ${item.name}
                            </span>
                            <button class="text-gray-400 hover:text-danger delete-forever" data-index="${index}" title="彻底删除">
                                <i class="fa fa-times"></i>
                            </button>
                        </div>
                        <div class="flex items-center justify-between text-xs text-gray-500">
                            <span>删除时间: ${deletedDate}</span>
                            <span class="text-primary cursor-pointer hover:underline restore-item" data-index="${index}">
                                恢复
                            </span>
                        </div>
                    </div>
                `;
            });
            
            itemsContainer.innerHTML = html;
            
            // 绑定恢复事件
            itemsContainer.querySelectorAll('.restore-item').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.dataset.index);
                    restoreFromRecycleBin(index);
                });
            });
            
            // 绑定彻底删除事件
            itemsContainer.querySelectorAll('.delete-forever').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const index = parseInt(this.dataset.index);
                    deleteForeverFromRecycleBin(index);
                });
            });
        }
        
        function restoreFromRecycleBin(index) {
            if (index >= 0 && index < recycleBin.length) {
                const item = recycleBin[index];
                delete item.deletedAt;
                
                // 检查是否已存在同名数据
                const existingIndex = savedData.findIndex(savedItem => savedItem.id === item.id);
                if (existingIndex !== -1) {
                    // 如果存在，询问是否覆盖
                    if (confirm('已存在同名数据，是否覆盖？')) {
                        savedData[existingIndex] = item;
                    } else {
                        // 不覆盖，添加新的
                        item.id = Date.now().toString();
                        savedData.unshift(item);
                    }
                } else {
                    savedData.unshift(item);
                }
                
                // 从回收站移除
                recycleBin.splice(index, 1);
                
                // 保存到本地存储
                localStorage.setItem('savedData', JSON.stringify(savedData));
                localStorage.setItem('recycleBin', JSON.stringify(recycleBin));
                
                // 更新界面
                updateRecycleBinCount();
                renderRecycleBin();
                searchSavedData();
                
                showToast('成功', '数据已恢复', 'success');
            }
        }
        
        function deleteForeverFromRecycleBin(index) {
            if (index >= 0 && index < recycleBin.length) {
                if (confirm('确定要彻底删除这个数据吗？此操作不可撤销。')) {
                    recycleBin.splice(index, 1);
                    localStorage.setItem('recycleBin', JSON.stringify(recycleBin));
                    updateRecycleBinCount();
                    renderRecycleBin();
                    showToast('成功', '数据已彻底删除', 'success');
                }
            }
        }
        
        // 数据保存相关函数
        function saveCurrentData() {
            if (productData.length === 0) {
                showToast('错误', '没有可保存的数据', 'error');
                return;
            }
            
            const saveNameInput = document.getElementById('save-name');
            const reportMonth = document.getElementById('report-month').value;
            
            let saveName = saveNameInput.value.trim();
            if (!saveName) {
                saveName = reportMonth || `数据_${new Date().toISOString().split('T')[0]}`;
            }
            
            const dataToSave = {
                id: Date.now().toString(),
                name: saveName,
                reportMonth: reportMonth,
                productData: JSON.parse(JSON.stringify(productData)),
                excelData: JSON.parse(JSON.stringify(excelData)),
                skuCosts: JSON.parse(JSON.stringify(skuCosts)),
                costRecords: JSON.parse(JSON.stringify(costRecords)),
                createdAt: new Date().toISOString()
            };
            
            // 将新保存的数据添加到开头
            savedData.unshift(dataToSave);
            
            // 使用LZ-String压缩数据后保存到本地存储
            try {
                const dataString = JSON.stringify(savedData);
                const compressedData = LZString.compress(dataString);
                if (compressedData) {
                    localStorage.setItem('savedData', compressedData);
                    console.log('数据压缩并保存成功。原始大小:', dataString.length, '字符, 压缩后大小:', compressedData.length, '字符');
                } else {
                    throw new Error('数据压缩失败，结果为空');
                }
            } catch (error) {
                console.error('保存压缩数据时出错:', error);
                // 如果压缩失败，尝试直接保存未压缩的数据
                try {
                    localStorage.setItem('savedData', JSON.stringify(savedData));
                } catch (saveError) {
                    console.error('Failed to save data:', saveError);
                    showToast('错误', '保存数据失败，请检查存储空间', 'error');
                    return;
                }
            }
            
            // 同时保存回收站数据
            try {
                localStorage.setItem('recycleBin', JSON.stringify(recycleBin));
                console.log('回收站数据保存成功');
            } catch (error) {
                console.error('保存回收站数据失败:', error);
            }
            
            // 清空输入框
            saveNameInput.value = '';
            
            // 重新渲染保存的数据列表
            searchSavedData();
            
            showToast('成功', '数据保存成功');
        }
        
        function loadSavedData(dataId) {
            const data = savedData.find(item => item.id === dataId);
            if (!data) {
                showToast('错误', '未找到保存的数据', 'error');
                return;
            }
            
            // 加载数据，但不覆盖当前的规格成本和成本记录
            // 这样新上传的文件仍然可以使用最新的规格成本
            productData = JSON.parse(JSON.stringify(data.productData));
            excelData = JSON.parse(JSON.stringify(data.excelData));
            // 不覆盖skuCosts和costRecords，保持使用当前最新的数据
            
            // 为加载的保存数据添加标识和使用保存的成本
            productData = productData.map(product => {
                // 为每个SKU保存原始成本
                Object.values(product.skus).forEach(sku => {
                    sku.originalCost = sku.cost; // 保存SKU的原始成本
                    sku.isSavedData = true; // 标记为保存的SKU数据
                });
                
                return {
                    ...product,
                    isSavedData: true, // 标记为保存的数据
                    savedUnitCost: product.unitCost, // 使用保存时的单件成本
                    savedTotalCost: product.totalCost // 使用保存时的总成本
                };
            });
            
            // 设置报表年月
            document.getElementById('report-month').value = data.reportMonth;
            
            // 清零快递续重费
            document.getElementById('additional-shipping-fee').value = '';
            
            // 重新渲染结果
            renderResults();
            
            // 启用保存按钮
            document.getElementById('save-data').disabled = false;
            
            showToast('成功', '数据加载成功，使用保存时的成本数据');
        }
        
        function deleteSavedData(dataId) {
            const deleteBtn = event.target.closest('.delete-btn');
            if (!deleteBtn) return;
            
            // 检查是否在冷却期
            if (deleteBtn.dataset.cooling === 'true') {
                return; // 冷却期内忽略重复点击
            }
            
            // 保存原始状态
            const originalHTML = deleteBtn.innerHTML;
            const originalDisabled = deleteBtn.disabled;
            
            // 进入冷却期
            deleteBtn.dataset.cooling = 'true';
            deleteBtn.disabled = true;
            deleteBtn.textContent = '3秒';
            
            let countdown = 3;
            const timer = setInterval(() => {
                countdown--;
                if (countdown > 0) {
                    deleteBtn.textContent = `${countdown}秒`;
                } else {
                    clearInterval(timer);
                    // 冷却期结束，自动显示确认模态框
                    showDeleteConfirmation(dataId, deleteBtn, originalHTML, originalDisabled);
                }
            }, 1000);
            
            // 显示提示信息
            showToast('提示', '为防止误操作，将在3秒后自动弹出确认窗口', 'info');
        }
        
        // 显示删除确认模态框
        function showDeleteConfirmation(dataId, deleteBtn, originalHTML, originalDisabled) {
            // 创建模态框
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.id = 'delete-confirmation-modal';
            
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-lg w-full max-w-md">
                    <div class="p-6">
                        <div class="text-center mb-6">
                            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-red-100 text-red-500 mb-4">
                                <i class="fa fa-exclamation-triangle text-2xl"></i>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">确认删除</h3>
                            <p class="text-gray-600">确定要删除这个保存的数据吗？</p>
                            <p class="text-sm text-gray-500 mt-2">删除后将移至回收站</p>
                        </div>
                        
                        <div class="flex space-x-3">
                            <button id="cancel-delete" class="flex-1 btn btn-secondary h-10">
                                取消
                            </button>
                            <button id="confirm-delete" class="flex-1 btn btn-danger h-10">
                                确认删除
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // 添加到页面
            document.body.appendChild(modal);
            
            // 绑定事件
            document.getElementById('cancel-delete').onclick = function() {
                document.body.removeChild(modal);
                showToast('提示', '删除操作已取消', 'info');
                
                // 完全恢复按钮状态
                deleteBtn.disabled = false;
                deleteBtn.innerHTML = originalHTML;
                deleteBtn.classList.remove('bg-gray-200', 'text-gray-800', 'hover:bg-gray-300', 'editing-breathing-bg');
                deleteBtn.classList.add('btn-danger');
                deleteBtn.dataset.cooling = 'false';
                deleteBtn.dataset.confirming = 'false';
                deleteBtn.dataset.deleting = 'false';
            };
            
            document.getElementById('confirm-delete').onclick = function() {
                // 移除模态框
                document.body.removeChild(modal);
                
                // 执行删除操作
                performDelete(dataId, deleteBtn, originalHTML, originalDisabled);
            };
            
            // 点击背景关闭
            modal.onclick = function(e) {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                    showToast('提示', '删除操作已取消', 'info');
                    
                    // 恢复按钮状态
                    deleteBtn.disabled = originalDisabled;
                    deleteBtn.innerHTML = originalHTML;
                    deleteBtn.classList.remove('bg-gray-200 text-gray-800 hover:bg-gray-300');
                    deleteBtn.dataset.cooling = 'false';
                }
            };
        }
        
        // 执行删除操作
        function performDelete(dataId, deleteBtn, originalHTML, originalDisabled) {
            try {
                // 找到要删除的数据
                const deletedItem = savedData.find(item => item.id === dataId);
                if (deletedItem) {
                    // 添加到回收站
                    deletedItem.deletedAt = new Date().toISOString();
                    recycleBin.unshift(deletedItem);
                    
                    // 从保存数据中移除
                    savedData = savedData.filter(item => item.id !== dataId);
                    
                    // 保存到本地存储
                    const savedDataString = JSON.stringify(savedData);
                    const compressedSavedData = LZString.compress(savedDataString);
                    if (compressedSavedData) {
                        localStorage.setItem('savedData', compressedSavedData);
                    } else {
                        localStorage.setItem('savedData', savedDataString);
                    }
                    
                    const recycleBinString = JSON.stringify(recycleBin);
                    const compressedRecycleBin = LZString.compress(recycleBinString);
                    if (compressedRecycleBin) {
                        localStorage.setItem('recycleBin', compressedRecycleBin);
                    } else {
                        localStorage.setItem('recycleBin', recycleBinString);
                    }
                    
                    // 更新回收站计数
                    updateRecycleBinCount();
                    
                    // 重新渲染保存的数据列表
                    searchSavedData();
                    
                    showToast('成功', '数据已移至回收站', 'success');
                }
            } catch (error) {
                console.error('删除数据时出错:', error);
                showToast('错误', '删除失败，请重试', 'error');
            } finally {
                // 恢复按钮状态
                deleteBtn.disabled = false;
                deleteBtn.innerHTML = originalHTML;
                deleteBtn.classList.remove('bg-gray-200 text-gray-800 hover:bg-gray-300');
                deleteBtn.dataset.cooling = 'false';
            }
        }
        
        function searchSavedData() {
            const searchTerm = document.getElementById('search-saved-data').value.toLowerCase().trim();
            
            if (searchTerm) {
                filteredSavedData = savedData.filter(item => 
                    item.name.toLowerCase().includes(searchTerm)
                );
            } else {
                filteredSavedData = [...savedData];
            }
            
            currentPage = 1;
            renderSavedData();
        }
        
        function renderSavedData() {
            const container = document.getElementById('saved-data-list');
            const empty = document.getElementById('saved-data-empty');
            const pagination = document.getElementById('pagination');
            
            if (filteredSavedData.length === 0) {
                container.innerHTML = '';
                empty.classList.remove('hidden');
                pagination.classList.add('hidden');
                return;
            }
            
            empty.classList.add('hidden');
            
            // 计算分页
            const totalPages = Math.ceil(filteredSavedData.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, filteredSavedData.length);
            const pageData = filteredSavedData.slice(startIndex, endIndex);
            
            let html = '';
            pageData.forEach((item, index) => {
                const date = new Date(item.createdAt);
                const formattedTime = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} | ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
                
                html += `
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-md">
                        <div class="flex items-center">
                            <i class="fa fa-database text-primary mr-3"></i>
                            <div>
                                <p class="font-medium text-gray-800">${item.name}</p>
                                <p class="text-xs text-gray-500">${formattedTime}</p>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <button class="btn btn-sm btn-secondary p-2 hover:bg-secondary/80 transition-colors" onclick="loadSavedData('${item.id}')" title="加载数据">
                                <i class="fa fa-folder-open"></i>
                            </button>
                            <button class="btn btn-sm btn-danger delete-btn" onclick="deleteSavedData('${item.id}')" data-cooling="false">
                                <i class="fa fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // 更新分页信息
            document.getElementById('page-info').textContent = `第 ${currentPage} 页，共 ${totalPages} 页`;
            document.getElementById('prev-page').disabled = currentPage === 1;
            document.getElementById('next-page').disabled = currentPage === totalPages;
            
            pagination.classList.remove('hidden');
        }
        
        function updateSaveButtonState() {
            const saveButton = document.getElementById('save-data');
            saveButton.disabled = productData.length === 0;
        }
        
        // 获取分类颜色
        function getCategoryColor(costType, categoryName) {
            const categories = costCategories[costType] || [];
            const category = categories.find(cat => 
                typeof cat === 'string' ? cat === categoryName : cat.name === categoryName
            );
            return category && typeof category === 'object' && category.color ? category.color : '#3B82F6';
        }

        // 渲染成本记录
        function renderCostRecords() {
            // 渲染快递成本
            renderCostSection('express-costs', costRecords.express, '快递公司');
            
            // 渲染包装成本
            renderCostSection('packaging-costs', costRecords.packaging, '包装材料');
            
            // 渲染平台服务成本
            renderCostSection('platform-costs', costRecords.platform, '服务项目');
            
            // 渲染配件成本
            renderCostSection('accessory-costs', costRecords.accessory, '配件名称');
        }
        
        // 更新成本项目数量统计
        function updateCostCount(costType, count) {
            const countElement = document.getElementById(`${costType}-count`);
            if (countElement) {
                // 直接设置为传入的count值，不做任何最小值处理
                countElement.textContent = `${count} 项`;
            }
        }
        
        // 渲染成本记录部分
        function renderCostSection(containerId, costItems, itemType) {
            const container = document.getElementById(containerId);
            const costType = containerId.replace('-costs', '');
            
            // 获取当前筛选的分类
            let selectedCategory = '';
            const filterSelect = document.getElementById(`${costType}-category-filter`);
            if (filterSelect) {
                selectedCategory = filterSelect.value;
            }
            
            // 获取搜索关键词
            const searchKeyword = document.getElementById('cost-search')?.value.toLowerCase() || '';
            
            // 根据分类和搜索关键词筛选项目
            let filteredItems = costItems;
            
            // 先按分类筛选
            if (selectedCategory) {
                filteredItems = filteredItems.filter(item => item.category === selectedCategory);
            }
            
            // 再按搜索关键词筛选（模糊搜索）
            if (searchKeyword) {
                filteredItems = filteredItems.filter(item => 
                    item.name.toLowerCase().includes(searchKeyword) || 
                    (item.note && item.note.toLowerCase().includes(searchKeyword)) ||
                    (item.category && item.category.toLowerCase().includes(searchKeyword))
                );
            }
            
            if (filteredItems.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4 text-gray-500">
                        <p>暂无${selectedCategory ? selectedCategory + '分类的' : ''}${itemType}成本记录</p>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="grid grid-cols-1 md:grid-cols-3 gap-4">';
            
            filteredItems.forEach((item, index) => {
                // 找到原始数组中的索引
                const originalIndex = costItems.indexOf(item);
                
                // 根据成本类型选择图标和颜色
                let icon = 'fa-circle';
                let bgColor = 'bg-blue-50';
                let textColor = 'text-blue-600';
                
                switch(costType) {
                    case 'express':
                        icon = 'fa-truck';
                        bgColor = 'bg-green-50';
                        textColor = 'text-green-600';
                        break;
                    case 'packaging':
                        icon = 'fa-cube';
                        bgColor = 'bg-purple-50';
                        textColor = 'text-purple-600';
                        break;
                    case 'platform':
                        icon = 'fa-handshake-o';
                        bgColor = 'bg-yellow-50';
                        textColor = 'text-yellow-600';
                        break;
                    case 'accessory':
                        icon = 'fa-puzzle-piece';
                        bgColor = 'bg-red-50';
                        textColor = 'text-red-600';
                        break;
                }
                
                html += `
                    <div class="bg-white rounded-xl shadow-card border border-gray-100 hover:shadow-lg transition-all-300 overflow-hidden group">
                        <div class="p-5">
                            <div class="flex items-start justify-between mb-4">
                                <div class="flex items-center space-x-3 flex-1 min-w-0">
                                    <div class="${bgColor} ${textColor} p-3 rounded-lg flex-shrink-0">
                                        <i class="fa ${icon} text-xl"></i>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center">
                                            <h4 class="font-semibold text-gray-800 text-lg leading-tight">${item.name}</h4>
                                        </div>
                                        ${item.note ? `
                                        <div class="relative mt-1">
                                            <p class="text-sm text-gray-500 line-clamp-2 cursor-help" 
                                               data-tooltip="${item.note.replace(/"/g, '&quot;')}">
                                                ${item.note}
                                            </p>
                                        </div>
                                        ` : ''}
                                    </div>
                                </div>
                                <div class="bg-gray-50 rounded-lg px-4 py-3 text-right flex-shrink-0 ml-4">
                                    <p class="text-xs font-medium text-gray-500">金额</p>
                                    <p class="text-xl font-bold text-gray-800">¥${item.amount.toFixed(2)}</p>
                                </div>
                            </div>
                            <div class="flex justify-between items-center">
                                ${item.category ? `
                                <span class="px-3 py-1 text-xs font-medium rounded-full flex items-center"
                                      style="background-color: ${getCategoryColor(costType, item.category)}33; color: ${getCategoryColor(costType, item.category)}">
                                    <i class="fa fa-tag mr-1"></i> ${item.category}
                                </span>` : '<span></span>'}
                                <div class="opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                                    <button class="btn btn-outline-primary btn-sm mr-2 edit-cost" 
                                        data-type="${costType}" 
                                        data-index="${index}">
                                        <i class="fa fa-pencil"></i> 编辑
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm delete-cost" 
                                        data-type="${costType}" 
                                        data-index="${index}">
                                        <i class="fa fa-trash"></i> 删除
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
            
            // 更新数量统计
            updateCostCount(costType, filteredItems.length);
            
            // 添加编辑和删除事件
            document.querySelectorAll('.edit-cost').forEach(btn => {
                btn.addEventListener('click', function() {
                    const costType = this.getAttribute('data-type');
                    const index = parseInt(this.getAttribute('data-index'));
                    const item = costRecords[costType][index];
                    
                    // 填充表单
                    document.getElementById('cost-type').value = costType;
                    document.getElementById('cost-name').value = item.name;
                    document.getElementById('cost-amount').value = item.amount;
                    document.getElementById('cost-note').value = item.note || '';
                    document.getElementById('cost-unit').value = item.unit || '';
                    
                    // 处理分类
                    const categoryContainer = document.getElementById('cost-category-container');
                    const categorySelect = document.getElementById('cost-category');
                    
                    if (costType === 'packaging' || costType === 'accessory') {
                        categoryContainer.classList.remove('hidden');
                        
                        // 清空并重新填充分类选项
                        categorySelect.innerHTML = '<option value="">无分类</option>';
                        
                        // 创建一个包含所有分类名称的集合
                        const allCategories = new Set();
                        
                        // 添加已有的分类
                        costCategories[costType].forEach(categoryObj => {
                            const categoryName = typeof categoryObj === 'string' ? categoryObj : categoryObj.name;
                            allCategories.add(categoryName);
                        });
                        
                        // 如果当前项目有分类且不在已有分类中，也添加进来
                        if (item.category && item.category.trim() !== '') {
                            allCategories.add(item.category.trim());
                        }
                        
                        // 填充分类选项
                        Array.from(allCategories).sort().forEach(categoryName => {
                            const option = document.createElement('option');
                            option.value = categoryName;
                            option.textContent = categoryName;
                            categorySelect.appendChild(option);
                        });
                        
                        // 在所有选项添加完成后，设置选中值
                        setTimeout(() => {
                            if (item.category && item.category.trim() !== '') {
                                categorySelect.value = item.category.trim();
                            } else {
                                categorySelect.value = '';
                            }
                        }, 0);
                    } else {
                        categoryContainer.classList.add('hidden');
                    }
                    
                    // 设置标题
                    const typeNames = {
                        'express': '快递公司',
                        'packaging': '包装材料',
                        'platform': '服务项目',
                        'accessory': '配件名称'
                    };
                    
                    document.getElementById('cost-modal-title').textContent = `编辑${typeNames[costType]}`;
                    document.getElementById('cost-name-label').textContent = typeNames[costType];
                    
                    // 显示模态框
                    document.getElementById('add-cost-modal').classList.remove('hidden');
                    
                    // 设置编辑模式状态
                    isEditMode = true;
                    currentEditIndex = index;
                    currentEditCostType = costType;
                });
            });
            
            // 为删除按钮添加直接的点击处理（带冷却时间和模态框确认）
            document.querySelectorAll('.delete-cost').forEach(btn => {
                // 使用立即执行函数确保每个按钮都有自己的闭包
                (function(button) {
                    // 清除所有可能的事件监听器
                    button.onclick = null;
                    
                    // 添加冷却状态变量
                    let isOnCooldown = false;
                    
                    // 添加新的点击处理函数
                    button.onclick = function(e) {
                        e = e || window.event;
                        e.stopPropagation ? e.stopPropagation() : (e.cancelBubble = true);
                        
                        const costType = this.getAttribute('data-type');
                        const index = parseInt(this.getAttribute('data-index'));
                        const item = costRecords[costType][index];
                        
                        // 检查是否在冷却中
                        if (isOnCooldown) {
                            showToast('提示', '删除功能正在冷却中，请稍后再试', 'warning');
                            return;
                        }
                        
                        // 设置冷却状态
                        isOnCooldown = true;
                        const originalText = button.innerHTML;
                        let countdown = 3;
                        
                        // 更新按钮显示
                        button.innerHTML = `<i class="fa fa-clock-o"></i> ${countdown}s`;
                        button.classList.add('opacity-50', 'cursor-not-allowed');
                        button.disabled = true;
                        
                        // 倒计时
                        const timer = setInterval(() => {
                            countdown--;
                            if (countdown > 0) {
                                button.innerHTML = `<i class="fa fa-clock-o"></i> ${countdown}s`;
                            } else {
                                clearInterval(timer);
                                
                                // 显示删除确认模态框
                                openDeleteConfirmModal(
                                    '确认删除成本记录',
                                    `确定要删除"${item.name}"的成本记录吗？此操作无法撤销。`,
                                    function() {
                                        // 触发成本项目删除事件
                                        const event = new CustomEvent('costItemDeleted', {
                                            detail: {
                                                costType: costType,
                                                costId: item.id
                                            }
                                        });
                                        document.dispatchEvent(event);
                                        
                                        costRecords[costType].splice(index, 1);
                                        
                                        saveData();
                                        // 强制重新渲染所有成本记录，确保数量统计正确更新
                                        renderCostRecords();
                                        // 手动更新当前删除项目所在类别的数量统计
                                        const containerId = `${costType}-costs`;
                                        const container = document.getElementById(containerId);
                                        const filteredItems = costRecords[costType];
                                        updateCostCount(costType, filteredItems.length);
                                        
                                        showToast('成功', '成本记录已删除', 'success');
                                    }
                                );
                                
                                // 恢复按钮状态
                                button.innerHTML = originalText;
                                button.classList.remove('opacity-50', 'cursor-not-allowed');
                                button.disabled = false;
                                isOnCooldown = false;
                            }
                        }, 1000);
                    };
                })(btn);
            });
        }
        
        // 店铺管理相关函数
        function showAddShopModal(shopId = null) {
            const modal = document.getElementById('add-shop-modal');
            const title = document.getElementById('shop-modal-title');
            const form = document.getElementById('add-shop-form');
            
            if (shopId) {
                const shop = shops.find(s => s.id === shopId);
                title.textContent = '编辑店铺';
                document.getElementById('shop-id').value = shop.id;
                document.getElementById('shop-name').value = shop.name;
                document.getElementById('shop-display-id').value = shop.displayId || '';
                document.getElementById('shop-products').value = shop.productIds.join('\n');
            } else {
                title.textContent = '添加店铺';
                form.reset();
                document.getElementById('shop-id').value = '';
            }
            
            modal.classList.remove('hidden');
        }
        
        function hideAddShopModal() {
            document.getElementById('add-shop-modal').classList.add('hidden');
        }
        
        function saveShop() {
            const shopId = document.getElementById('shop-id').value;
            const shopName = document.getElementById('shop-name').value.trim();
            const shopDisplayId = document.getElementById('shop-display-id').value.trim();
            const shopProducts = document.getElementById('shop-products').value.trim();
            
            if (!shopName) {
                showToast('错误', '请输入店铺名称', 'error');
                return;
            }
            
            const productIds = shopProducts ? shopProducts.split('\n').map(id => id.trim()).filter(id => id) : [];
            
            if (shopId) {
                // 编辑现有店铺
                const shopIndex = shops.findIndex(s => s.id === shopId);
                shops[shopIndex] = {
                    ...shops[shopIndex],
                    name: shopName,
                    displayId: shopDisplayId,
                    productIds: productIds
                };
                showToast('成功', '店铺更新成功');
            } else {
                // 添加新店铺
                shops.push({
                    id: Date.now().toString(),
                    name: shopName,
                    displayId: shopDisplayId,
                    productIds: productIds,
                    createdAt: new Date().toISOString()
                });
                showToast('成功', '店铺添加成功');
            }
            
            // 保存到本地存储
            localStorage.setItem('shops', JSON.stringify(shops));
            
            // 重新渲染店铺列表
            renderShops();
            
            // 更新数据计算区店铺筛选器
            updateCalculationShopFilter();
            
            // 隐藏模态框
            hideAddShopModal();
            
            // 更新数据计算区的店铺显示
            if (!document.getElementById('data-calculation').classList.contains('hidden')) {
                renderDataCalculation();
            }
        }
        
        function deleteShop(shopId) {
            const shop = shops.find(s => s.id === shopId);
            if (!shop) return;
            
            // 显示删除确认模态框
            openDeleteConfirmModal(
                '确认删除店铺',
                `确定要删除"${shop.name}"店铺吗？此操作无法撤销。`,
                function() {
                    shops = shops.filter(s => s.id !== shopId);
                    localStorage.setItem('shops', JSON.stringify(shops));
                    renderShops();
                    showToast('成功', '店铺删除成功');
                    
                    // 更新数据计算区的店铺显示
                    if (!document.getElementById('data-calculation').classList.contains('hidden')) {
                        renderDataCalculation();
                    }
                }
            );
        }
        
        function renderShops() {
            const container = document.getElementById('shops-container');
            const empty = document.getElementById('shops-empty');
            
            // 更新店铺数量显示
            const shopCountElement = document.getElementById('shop-count-number');
            if (shopCountElement) {
                shopCountElement.textContent = shops.length;
            }
            
            if (shops.length === 0) {
                container.innerHTML = '';
                empty.classList.remove('hidden');
                return;
            }
            
            empty.classList.add('hidden');
            
            container.innerHTML = shops.map(shop => `
                <div class="bg-white rounded-xl border border-gray-100 p-6 mb-6 shadow-sm hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1">
                    <div class="flex justify-between items-center mb-6">
                        <div class="flex items-center space-x-4">
                            <h3 class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-4 py-3 rounded-lg shadow-md text-lg font-bold">${shop.name}</h3>
                            <span class="inline-flex items-center px-3 py-1.5 rounded-full text-sm font-medium bg-blue-100 text-blue-800 border border-blue-200">
                                <i class="fa fa-cubes mr-1.5"></i> ${shop.productIds.length} 个商品
                            </span>
                        </div>
                        <div class="flex space-x-2">
                            <button class="btn btn-sm btn-secondary hover:bg-gray-200 transition-colors duration-300" onclick="showAddShopModal('${shop.id}')" title="编辑店铺">
                                <i class="fa fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger hover:bg-red-600 transition-colors duration-300" onclick="deleteShop('${shop.id}')" title="删除店铺">
                                <i class="fa fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <label class="block text-sm font-semibold text-gray-700">关联商品ID</label>
                            <span class="text-xs text-gray-500">点击标签可移除</span>
                        </div>
                        <div class="flex flex-wrap gap-2 max-h-40 overflow-y-auto p-2 border border-gray-100 rounded-lg bg-gray-50" style="scrollbar-width: thin; scrollbar-color: #cbd5e1 #f8fafc;">
                            ${shop.productIds.length > 0 ? shop.productIds.map(productId => `
                                <span class="inline-flex items-center px-3 py-1.5 rounded-full text-sm font-medium bg-blue-100 text-blue-800 hover:bg-blue-200 transition-colors duration-200">
                                    <i class="fa fa-tag mr-1.5"></i> ${productId}
                                    <i class="fa fa-times ml-1.5 text-blue-600 hover:text-blue-800 cursor-pointer hover:bg-blue-300 hover:rounded-full p-0.5 transition-colors duration-200" onclick="removeProductFromShop('${shop.id}', '${productId}'); event.stopPropagation();" title="移除商品ID"></i>
                                </span>
                            `).join('') : '<span class="text-sm text-gray-500 italic">暂无关联商品</span>'}
                        </div>
                    </div>
                    
                    <div class="flex justify-between items-center pt-4 border-t border-gray-100">
                        <button class="btn btn-sm btn-secondary hover:bg-gray-500 transition-colors duration-300 flex items-center space-x-1" onclick="showAddShopModal('${shop.id}')">
                            <i class="fa fa-plus"></i>
                            <span>添加商品ID</span>
                        </button>
                        <div class="text-xs text-gray-400">
                            ID: ${shop.displayId || shop.id}
                        </div>
                    </div>
                </div>


            `).join('');
        }
        
        function removeProductFromShop(shopId, productId) {
            const shop = shops.find(s => s.id === shopId);
            if (shop) {
                shop.productIds = shop.productIds.filter(id => id !== productId);
                localStorage.setItem('shops', JSON.stringify(shops));
                renderShops();
                
                // 更新数据计算区的店铺显示
                if (!document.getElementById('data-calculation').classList.contains('hidden')) {
                    renderDataCalculation();
                }
            }
        }
        
        // 根据商品ID获取店铺名称
        function getShopNameByProductId(productId) {
            for (const shop of shops) {
                if (shop.productIds.includes(productId)) {
                    return shop.name;
                }
            }
            return '未分类';
        }
        
        // 回收站相关函数
        function bindRecycleBinEvents() {
            const recycleBinBtn = document.getElementById('recycle-bin-btn');
            const recycleBinList = document.getElementById('recycle-bin-list');
            const recycleBinContainer = document.getElementById('recycle-bin-container');
            const emptyRecycleBinBtn = document.getElementById('empty-recycle-bin');
            
            // 点击回收站按钮显示/隐藏列表
            recycleBinBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                recycleBinList.classList.toggle('hidden');
                if (!recycleBinList.classList.contains('hidden')) {
                    renderRecycleBin();
                }
            });
            
            // 点击清空回收站
            emptyRecycleBinBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                if (recycleBin.length > 0) {
                    if (confirm('确定要清空回收站吗？此操作不可撤销。')) {
                        recycleBin = [];
                        localStorage.setItem('recycleBin', JSON.stringify(recycleBin));
                        updateRecycleBinCount();
                        renderRecycleBin();
                        showToast('成功', '回收站已清空', 'success');
                    }
                }
            });
            
            // 点击其他地方隐藏回收站列表
            document.addEventListener('click', function(e) {
                if (!recycleBinContainer.contains(e.target)) {
                    recycleBinList.classList.add('hidden');
                }
            });
        }
        
        function updateRecycleBinCount() {
            const countElement = document.getElementById('recycle-bin-count');
            const count = recycleBin.length;
            countElement.textContent = count;
            countElement.style.display = count > 0 ? 'flex' : 'none';
        }
        
        function renderRecycleBin() {
            const itemsContainer = document.getElementById('recycle-bin-items');
            const emptyContainer = document.getElementById('recycle-bin-empty');
            
            if (recycleBin.length === 0) {
                itemsContainer.innerHTML = '';
                itemsContainer.classList.add('hidden');
                emptyContainer.classList.remove('hidden');
                return;
            }
            
            itemsContainer.classList.remove('hidden');
            emptyContainer.classList.add('hidden');
            
            let html = '';
            recycleBin.forEach((item, index) => {
                const deletedDate = new Date(item.deletedAt).toLocaleString('zh-CN');
                html += `
                    <div class="recycle-bin-item p-3 border-b border-gray-100 hover:bg-gray-50">
                        <div class="flex items-center justify-between mb-1">
                            <span class="font-medium text-gray-800 text-sm cursor-pointer hover:text-primary restore-item" data-index="${index}">
                                ${item.name}
                            </span>
                            <button class="text-gray-400 hover:text-danger delete-forever" data-index="${index}" title="彻底删除">
                                <i class="fa fa-times"></i>
                            </button>
                        </div>
                        <div class="flex items-center justify-between text-xs text-gray-500">
                            <span>删除时间: ${deletedDate}</span>
                            <span class="text-primary cursor-pointer hover:underline restore-item" data-index="${index}">
                                恢复
                            </span>
                        </div>
                    </div>
                `;
            });
            
            itemsContainer.innerHTML = html;
            
            // 绑定恢复事件
            itemsContainer.querySelectorAll('.restore-item').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.dataset.index);
                    restoreFromRecycleBin(index);
                });
            });
            
            // 绑定彻底删除事件
            itemsContainer.querySelectorAll('.delete-forever').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const index = parseInt(this.dataset.index);
                    deleteForeverFromRecycleBin(index);
                });
            });
        }
        
        function restoreFromRecycleBin(index) {
            if (index >= 0 && index < recycleBin.length) {
                const item = recycleBin[index];
                delete item.deletedAt;
                
                // 检查是否已存在同名数据
                const existingIndex = savedData.findIndex(savedItem => savedItem.id === item.id);
                if (existingIndex !== -1) {
                    // 如果存在，询问是否覆盖
                    if (confirm('已存在同名数据，是否覆盖？')) {
                        savedData[existingIndex] = item;
                    } else {
                        // 不覆盖，添加新的
                        item.id = Date.now().toString();
                        savedData.unshift(item);
                    }
                } else {
                    savedData.unshift(item);
                }
                
                // 从回收站移除
                recycleBin.splice(index, 1);
                
                // 保存到本地存储
                localStorage.setItem('savedData', JSON.stringify(savedData));
                localStorage.setItem('recycleBin', JSON.stringify(recycleBin));
                
                // 更新界面
                updateRecycleBinCount();
                renderRecycleBin();
                searchSavedData();
                
                showToast('成功', '数据已恢复', 'success');
            }
        }
        
        function deleteForeverFromRecycleBin(index) {
            if (index >= 0 && index < recycleBin.length) {
                if (confirm('确定要彻底删除这个数据吗？此操作不可撤销。')) {
                    recycleBin.splice(index, 1);
                    localStorage.setItem('recycleBin', JSON.stringify(recycleBin));
                    updateRecycleBinCount();
                    renderRecycleBin();
                    showToast('成功', '数据已彻底删除', 'success');
                }
            }
        }
        
        // 数据保存相关函数
        function saveCurrentData() {
            if (productData.length === 0) {
                showToast('错误', '没有可保存的数据', 'error');
                return;
            }
            
            const saveNameInput = document.getElementById('save-name');
            const reportMonth = document.getElementById('report-month').value;
            
            let saveName = saveNameInput.value.trim();
            if (!saveName) {
                saveName = reportMonth || `数据_${new Date().toISOString().split('T')[0]}`;
            }
            
            const dataToSave = {
                id: Date.now().toString(),
                name: saveName,
                reportMonth: reportMonth,
                productData: JSON.parse(JSON.stringify(productData)),
                excelData: JSON.parse(JSON.stringify(excelData)),
                skuCosts: JSON.parse(JSON.stringify(skuCosts)),
                costRecords: JSON.parse(JSON.stringify(costRecords)),
                createdAt: new Date().toISOString()
            };
            
            // 将新保存的数据添加到开头
            savedData.unshift(dataToSave);
            
            // 使用LZ-String压缩数据后保存到本地存储
            try {
                const dataString = JSON.stringify(savedData);
                const compressedData = LZString.compress(dataString);
                if (compressedData) {
                    localStorage.setItem('savedData', compressedData);
                    console.log('数据压缩并保存成功。原始大小:', dataString.length, '字符, 压缩后大小:', compressedData.length, '字符');
                } else {
                    throw new Error('数据压缩失败，结果为空');
                }
            } catch (error) {
                console.error('保存压缩数据时出错:', error);
                // 如果压缩失败，尝试直接保存未压缩的数据
                try {
                    localStorage.setItem('savedData', JSON.stringify(savedData));
                } catch (saveError) {
                    console.error('Failed to save data:', saveError);
                    showToast('错误', '保存数据失败，请检查存储空间', 'error');
                    return;
                }
            }
            
            // 同时保存回收站数据
            try {
                localStorage.setItem('recycleBin', JSON.stringify(recycleBin));
                console.log('回收站数据保存成功');
            } catch (error) {
                console.error('保存回收站数据失败:', error);
            }
            
            // 清空输入框
            saveNameInput.value = '';
            
            // 重新渲染保存的数据列表
            searchSavedData();
            
            showToast('成功', '数据保存成功');
        }
        
        function loadSavedData(dataId) {
            const data = savedData.find(item => item.id === dataId);
            if (!data) {
                showToast('错误', '未找到保存的数据', 'error');
                return;
            }
            
            // 加载数据，但不覆盖当前的规格成本和成本记录
            // 这样新上传的文件仍然可以使用最新的规格成本
            productData = JSON.parse(JSON.stringify(data.productData));
            excelData = JSON.parse(JSON.stringify(data.excelData));
            // 不覆盖skuCosts和costRecords，保持使用当前最新的数据
            
            // 为加载的保存数据添加标识和使用保存的成本
            productData = productData.map(product => {
                // 为每个SKU保存原始成本
                Object.values(product.skus).forEach(sku => {
                    sku.originalCost = sku.cost; // 保存SKU的原始成本
                    sku.isSavedData = true; // 标记为保存的SKU数据
                });
                
                return {
                    ...product,
                    isSavedData: true, // 标记为保存的数据
                    savedUnitCost: product.unitCost, // 使用保存时的单件成本
                    savedTotalCost: product.totalCost // 使用保存时的总成本
                };
            });
            
            // 设置报表年月
            document.getElementById('report-month').value = data.reportMonth;
            
            // 清零快递续重费
            document.getElementById('additional-shipping-fee').value = '';
            
            // 重新渲染结果
            renderResults();
            
            // 启用保存按钮
            document.getElementById('save-data').disabled = false;
            
            showToast('成功', '数据加载成功，使用保存时的成本数据');
        }
        
        function deleteSavedData(dataId) {
            const deleteBtn = event.target.closest('.delete-btn');
            if (!deleteBtn) return;
            
            // 检查是否在冷却期
            if (deleteBtn.dataset.cooling === 'true') {
                return; // 冷却期内忽略重复点击
            }
            
            // 保存原始状态
            const originalHTML = deleteBtn.innerHTML;
            const originalDisabled = deleteBtn.disabled;
            
            // 进入冷却期
            deleteBtn.dataset.cooling = 'true';
            deleteBtn.disabled = true;
            deleteBtn.textContent = '3秒';
            
            let countdown = 3;
            const timer = setInterval(() => {
                countdown--;
                if (countdown > 0) {
                    deleteBtn.textContent = `${countdown}秒`;
                } else {
                    clearInterval(timer);
                    // 冷却期结束，自动显示确认模态框
                    showDeleteConfirmation(dataId, deleteBtn, originalHTML, originalDisabled);
                }
            }, 1000);
            
            // 显示提示信息
            showToast('提示', '为防止误操作，将在3秒后自动弹出确认窗口', 'info');
        }
        
        // 显示删除确认模态框
        function showDeleteConfirmation(dataId, deleteBtn, originalHTML, originalDisabled) {
            // 创建模态框
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.id = 'delete-confirmation-modal';
            
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-lg w-full max-w-md">
                    <div class="p-6">
                        <div class="text-center mb-6">
                            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-red-100 text-red-500 mb-4">
                                <i class="fa fa-exclamation-triangle text-2xl"></i>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">确认删除</h3>
                            <p class="text-gray-600">确定要删除这个保存的数据吗？</p>
                            <p class="text-sm text-gray-500 mt-2">删除后将移至回收站</p>
                        </div>
                        
                        <div class="flex space-x-3">
                            <button id="cancel-delete" class="flex-1 btn btn-secondary h-10">
                                取消
                            </button>
                            <button id="confirm-delete" class="flex-1 btn btn-danger h-10">
                                确认删除
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // 添加到页面
            document.body.appendChild(modal);
            
            // 绑定事件
            document.getElementById('cancel-delete').onclick = function() {
                document.body.removeChild(modal);
                showToast('提示', '删除操作已取消', 'info');
                
                // 完全恢复按钮状态
                deleteBtn.disabled = false;
                deleteBtn.innerHTML = originalHTML;
                deleteBtn.classList.remove('bg-gray-200', 'text-gray-800', 'hover:bg-gray-300', 'editing-breathing-bg');
                deleteBtn.classList.add('btn-danger');
                deleteBtn.dataset.cooling = 'false';
                deleteBtn.dataset.confirming = 'false';
                deleteBtn.dataset.deleting = 'false';
            };
            
            document.getElementById('confirm-delete').onclick = function() {
                // 移除模态框
                document.body.removeChild(modal);
                
                // 执行删除操作
                performDelete(dataId, deleteBtn, originalHTML, originalDisabled);
            };
            
            // 点击背景关闭
            modal.onclick = function(e) {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                    showToast('提示', '删除操作已取消', 'info');
                    
                    // 恢复按钮状态
                    deleteBtn.disabled = originalDisabled;
                    deleteBtn.innerHTML = originalHTML;
                    deleteBtn.classList.remove('bg-gray-200 text-gray-800 hover:bg-gray-300');
                    deleteBtn.dataset.cooling = 'false';
                }
            };
        }
        
        // 执行删除操作
        function performDelete(dataId, deleteBtn, originalHTML, originalDisabled) {
            try {
                // 找到要删除的数据
                const deletedItem = savedData.find(item => item.id === dataId);
                if (deletedItem) {
                    // 添加到回收站
                    deletedItem.deletedAt = new Date().toISOString();
                    recycleBin.unshift(deletedItem);
                    
                    // 从保存数据中移除
                    savedData = savedData.filter(item => item.id !== dataId);
                    
                    // 保存到本地存储
                    const savedDataString = JSON.stringify(savedData);
                    const compressedSavedData = LZString.compress(savedDataString);
                    if (compressedSavedData) {
                        localStorage.setItem('savedData', compressedSavedData);
                    } else {
                        localStorage.setItem('savedData', savedDataString);
                    }
                    
                    const recycleBinString = JSON.stringify(recycleBin);
                    const compressedRecycleBin = LZString.compress(recycleBinString);
                    if (compressedRecycleBin) {
                        localStorage.setItem('recycleBin', compressedRecycleBin);
                    } else {
                        localStorage.setItem('recycleBin', recycleBinString);
                    }
                    
                    // 更新回收站计数
                    updateRecycleBinCount();
                    
                    // 重新渲染保存的数据列表
                    searchSavedData();
                    
                    showToast('成功', '数据已移至回收站', 'success');
                }
            } catch (error) {
                console.error('删除数据时出错:', error);
                showToast('错误', '删除失败，请重试', 'error');
            } finally {
                // 恢复按钮状态
                deleteBtn.disabled = false;
                deleteBtn.innerHTML = originalHTML;
                deleteBtn.classList.remove('bg-gray-200 text-gray-800 hover:bg-gray-300');
                deleteBtn.dataset.cooling = 'false';
            }
        }
        
        function searchSavedData() {
            const searchTerm = document.getElementById('search-saved-data').value.toLowerCase().trim();
            
            if (searchTerm) {
                filteredSavedData = savedData.filter(item => 
                    item.name.toLowerCase().includes(searchTerm)
                );
            } else {
                filteredSavedData = [...savedData];
            }
            
            currentPage = 1;
            renderSavedData();
        }
        
        function renderSavedData() {
            const container = document.getElementById('saved-data-list');
            const empty = document.getElementById('saved-data-empty');
            const pagination = document.getElementById('pagination');
            
            if (filteredSavedData.length === 0) {
                container.innerHTML = '';
                empty.classList.remove('hidden');
                pagination.classList.add('hidden');
                return;
            }
            
            empty.classList.add('hidden');
            
            // 计算分页
            const totalPages = Math.ceil(filteredSavedData.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, filteredSavedData.length);
            const pageData = filteredSavedData.slice(startIndex, endIndex);
            
            let html = '';
            pageData.forEach((item, index) => {
                const date = new Date(item.createdAt);
                const formattedTime = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} | ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
                
                html += `
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-md">
                        <div class="flex items-center">
                            <i class="fa fa-database text-primary mr-3"></i>
                            <div>
                                <p class="font-medium text-gray-800">${item.name}</p>
                                <p class="text-xs text-gray-500">${formattedTime}</p>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <button class="btn btn-sm btn-secondary p-2 hover:bg-secondary/80 transition-colors" onclick="loadSavedData('${item.id}')" title="加载数据">
                                <i class="fa fa-folder-open"></i>
                            </button>
                            <button class="btn btn-sm btn-danger delete-btn" onclick="deleteSavedData('${item.id}')" data-cooling="false">
                                <i class="fa fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // 更新分页信息
            document.getElementById('page-info').textContent = `第 ${currentPage} 页，共 ${totalPages} 页`;
            document.getElementById('prev-page').disabled = currentPage === 1;
            document.getElementById('next-page').disabled = currentPage === totalPages;
            
            pagination.classList.remove('hidden');
        }
        
        function updateSaveButtonState() {
            const saveButton = document.getElementById('save-data');
            saveButton.disabled = productData.length === 0;
        }
        
        // 更新数据看板
        function updateDashboard(shopId = '') {
            // 无论是否有数据，都先重置所有显示
            document.getElementById('total-quantity').textContent = '0';
            document.getElementById('total-revenue').textContent = '¥0.00';
            document.getElementById('total-advertising').textContent = '¥0.00';
            document.getElementById('total-profit').textContent = '¥0.00';
            document.getElementById('total-express-fee').textContent = '¥0.00';
            
            // 重置变化率显示
            document.getElementById('profit-change').innerHTML = '<i class="fa fa-minus mr-1"></i><span>0.00%</span>';
            document.getElementById('quantity-change').innerHTML = '<i class="fa fa-minus mr-1"></i><span>0.00%</span>';
            document.getElementById('revenue-change').innerHTML = '<i class="fa fa-minus mr-1"></i><span>0.00%</span>';
            document.getElementById('advertising-change').innerHTML = '<i class="fa fa-minus mr-1"></i><span>0.00%</span>';
            document.getElementById('express-fee-change').innerHTML = '<i class="fa fa-minus mr-1"></i><span>0.00%</span>';
            
            // 重置排行榜
            const rankingTable = document.getElementById('ranking-table');
            const rankingEmpty = document.getElementById('ranking-empty');
            rankingTable.innerHTML = '';
            
            if (productData.length === 0) {
                // 清空店铺统计
                document.getElementById('shop-stats-grid').innerHTML = `
                    <div class="text-center py-4 text-gray-500 col-span-full">
                        <i class="fa fa-info-circle text-2xl mb-2"></i>
                        <p>暂无数据</p>
                    </div>
                `;
                
                rankingEmpty.classList.remove('hidden');
                return;
            }
            
            // 根据店铺ID筛选产品数据
            let filteredProducts = productData;
            if (shopId) {
                if (shopId === 'uncategorized') {
                    // 筛选未分类的产品
                    filteredProducts = productData.filter(product => {
                        const productShop = getShopNameByProductId(product.id);
                        return productShop === '未分类';
                    });
                } else {
                    // 筛选特定店铺的产品
                    const shop = shops.find(s => s.id === shopId);
                    if (shop) {
                        filteredProducts = productData.filter(product => 
                            shop.productIds.includes(product.id)
                        );
                    }
                }
            }
            
            // 计算总计
            const totalQuantity = filteredProducts.reduce((sum, product) => sum + product.totalQuantity, 0);
            const totalRevenue = filteredProducts.reduce((sum, product) => sum + product.totalRevenue, 0);
            const totalAdvertising = filteredProducts.reduce((sum, product) => sum + product.advertisingFee, 0);
            const totalProfit = filteredProducts.reduce((sum, product) => sum + product.netProfit, 0);
            const totalExpressFee = filteredProducts.reduce((sum, product) => sum + (product.allocatedShippingFee || 0), 0);
            
            // 获取上期数据（模拟，实际应从历史数据中获取）
            const previousTotalQuantity = totalQuantity * 0.9; // 模拟上期数据
            const previousTotalRevenue = totalRevenue * 0.95;
            const previousTotalAdvertising = totalAdvertising * 1.1;
            const previousTotalProfit = previousTotalRevenue - previousTotalAdvertising - (totalQuantity * 10); // 简化计算
            const previousTotalExpressFee = totalExpressFee * 0.95; // 模拟上期数据
            
            // 计算环比变化
            const profitChange = calculateChangeRate(totalProfit, previousTotalProfit);
            const quantityChange = calculateChangeRate(totalQuantity, previousTotalQuantity);
            const revenueChange = calculateChangeRate(totalRevenue, previousTotalRevenue);
            const advertisingChange = calculateChangeRate(totalAdvertising, previousTotalAdvertising);
            const expressFeeChange = calculateChangeRate(totalExpressFee, previousTotalExpressFee);
            
            // 更新显示
            document.getElementById('total-quantity').textContent = totalQuantity;
            document.getElementById('total-revenue').textContent = `¥${totalRevenue.toFixed(2)}`;
            document.getElementById('total-advertising').textContent = `¥${totalAdvertising.toFixed(2)}`;
            document.getElementById('total-profit').textContent = `¥${totalProfit.toFixed(2)}`;
            document.getElementById('total-express-fee').textContent = `¥${totalExpressFee.toFixed(2)}`;
            
            // 更新变化率显示
            updateChangeRateDisplay('profit-change', profitChange);
            updateChangeRateDisplay('quantity-change', quantityChange);
            updateChangeRateDisplay('revenue-change', revenueChange);
            updateChangeRateDisplay('advertising-change', advertisingChange);
            updateChangeRateDisplay('express-fee-change', expressFeeChange);
            
            // 更新图表和排行榜（使用筛选后的数据）
            updateCharts(filteredProducts);
            updateRanking(filteredProducts);
            
            // 更新店铺统计
            updateShopStats();
            
            // 更新排行榜
            updateRanking(filteredProducts);
        }
        
        // 计算变化率
        function calculateChangeRate(current, previous) {
            if (previous === 0) return current > 0 ? 100 : 0;
            return ((current - previous) / previous) * 100;
        }
        
        // 更新变化率显示
        function updateChangeRateDisplay(elementId, changeRate) {
            const element = document.getElementById(elementId);
            const isPositive = changeRate > 0;
            const isNegative = changeRate < 0;
            const icon = isPositive ? 'fa-arrow-up' : isNegative ? 'fa-arrow-down' : 'fa-minus';
            const colorClass = isPositive ? 'text-success' : isNegative ? 'text-danger' : 'text-gray-400';
            
            element.innerHTML = `
                <i class="fa ${icon} mr-1"></i>
                <span>${Math.abs(changeRate).toFixed(2)}%</span>
            `;
            element.className = `flex items-center ${colorClass}`;
        }
        
        // 更新排行榜
        function updateRanking(filteredProducts = productData) {
            const rankingTable = document.getElementById('ranking-table');
            const rankingEmpty = document.getElementById('ranking-empty');
            const sortBy = document.getElementById('ranking-sort').value;
            const limit = document.getElementById('ranking-limit').value;
            
            if (filteredProducts.length === 0) {
                rankingTable.innerHTML = '';
                rankingEmpty.classList.remove('hidden');
                return;
            }
            
            rankingEmpty.classList.add('hidden');
            
            // 复制数据以避免修改原始数据
            let sortedProducts = [...filteredProducts];
            
            // 根据选择的排序方式进行排序
            switch (sortBy) {
                case 'profit-desc':
                    sortedProducts.sort((a, b) => b.netProfit - a.netProfit);
                    break;
                case 'profit-asc':
                    sortedProducts.sort((a, b) => a.netProfit - b.netProfit);
                    break;
                case 'quantity-desc':
                    sortedProducts.sort((a, b) => b.totalQuantity - a.totalQuantity);
                    break;
                case 'revenue-desc':
                    sortedProducts.sort((a, b) => b.totalRevenue - a.totalRevenue);
                    break;
                case 'profit-rate-desc':
                    sortedProducts.sort((a, b) => {
                        const rateA = a.totalRevenue > 0 ? (a.netProfit / a.totalRevenue) : -Infinity;
                        const rateB = b.totalRevenue > 0 ? (b.netProfit / b.totalRevenue) : -Infinity;
                        return rateB - rateA;
                    });
                    break;
            }
            
            // 限制显示数量
            if (limit !== 'all') {
                sortedProducts = sortedProducts.slice(0, parseInt(limit));
            }
            
            // 渲染排行榜
            let html = '';
            sortedProducts.forEach((product, index) => {
                const shopName = getShopNameByProductId(product.id);
                const grossProfitRate = product.totalRevenue > 0 
                    ? ((product.netProfit / product.totalRevenue) * 100).toFixed(2) 
                    : '0.00';
                
                // 根据排名设置不同的样式
                let rankBgClass = '';
                let rankTextClass = '';
                let rankIconClass = '';
                let borderLeftClass = '';
                
                if (index === 0) {
                    rankBgClass = 'bg-gradient-to-r from-yellow-400 to-yellow-600';
                    rankTextClass = 'text-white';
                    rankIconClass = 'text-white';
                    borderLeftClass = 'border-l-4 border-yellow-400';
                } else if (index === 1) {
                    rankBgClass = 'bg-gradient-to-r from-gray-300 to-gray-400';
                    rankTextClass = 'text-white';
                    rankIconClass = 'text-white';
                    borderLeftClass = 'border-l-4 border-gray-300';
                } else if (index === 2) {
                    rankBgClass = 'bg-gradient-to-r from-orange-400 to-orange-500';
                    rankTextClass = 'text-white';
                    rankIconClass = 'text-white';
                    borderLeftClass = 'border-l-4 border-orange-400';
                } else {
                    rankBgClass = 'bg-gray-100';
                    rankTextClass = 'text-gray-700';
                    borderLeftClass = '';
                }
                
                const isPositive = product.netProfit >= 0;
                
                html += `
                    <tr class="hover:bg-blue-50 ${borderLeftClass}">
                        <td class="px-6 py-5 whitespace-nowrap">
                            <span class="inline-flex items-center justify-center w-8 h-8 rounded-full text-sm font-bold ${rankBgClass} ${rankTextClass} shadow-lg">
                                ${index < 3 ? `<i class="fa fa-trophy"></i>` : `${index + 1}`}
                            </span>
                        </td>
                        <td class="px-6 py-5 whitespace-nowrap text-base font-semibold text-gray-900">${product.id}</td>
                        <td class="px-6 py-5 whitespace-nowrap">
                            <span class="badge badge-shop">
                                ${shopName}
                            </span>
                        </td>
                        <td class="px-6 py-5 whitespace-nowrap text-base font-medium text-gray-800">${product.totalQuantity.toLocaleString()}</td>
                        <td class="px-6 py-5 whitespace-nowrap text-base font-medium text-gray-800">¥${product.totalRevenue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td class="px-6 py-5 whitespace-nowrap">
                            <span class="px-3 py-1.5 text-sm font-bold ${isPositive ? 'bg-gradient-to-r from-green-100 to-green-200 text-green-800' : 'bg-gradient-to-r from-red-100 to-red-200 text-red-800'} rounded-full shadow-sm">
                                ¥${product.netProfit.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                            </span>
                        </td>
                        <td class="px-6 py-5 whitespace-nowrap text-base font-bold ${isPositive ? 'text-green-600' : 'text-red-600'}">
                            ${grossProfitRate}%
                        </td>
                        <td class="px-6 py-5 whitespace-nowrap text-base font-medium">
                            <button class="flex items-center px-3 py-1 text-sm bg-gray-200 text-gray-800 rounded-lg shadow-md hover:shadow-lg hover:bg-gray-300 active:bg-gray-400 view-details" data-product-id="${product.id}">
                                <i class="fa fa-eye mr-2"></i> 查看详情
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            rankingTable.innerHTML = html;
            
            // 添加查看详情事件
            document.querySelectorAll('.view-details').forEach(btn => {
                btn.addEventListener('click', function() {
                    const productId = this.getAttribute('data-product-id');
                    viewProductDetails(productId);
                });
            });
        }
        
        // 查看商品详情
        function viewProductDetails(productId) {
            // 找到对应的商品数据
            const product = productData.find(p => p.id === productId);
            if (!product) return;
            
            // 切换到数据计算区
            const dataCalculationTab = document.querySelector('[data-tab="data-calculation"]');
            if (dataCalculationTab) {
                dataCalculationTab.click();
            }
            
            // 等待页面切换完成后查找并展开卡片
            setTimeout(() => {
                // 直接查找包含商品ID的卡片
                const productCards = document.querySelectorAll('.product-card');
                let targetCard = null;
                
                productCards.forEach(card => {
                    // 查找包含商品ID的元素
                    const idElement = card.querySelector(`[data-product-id="${productId}"]`) || 
                                     card.querySelector(`#advertising-fee-${productId}`);
                    
                    if (idElement) {
                        targetCard = card;
                    }
                });
                
                if (targetCard) {
                    // 滚动到该卡片
                    targetCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                    // 高亮显示
                    targetCard.classList.add('ring-2', 'ring-primary', 'ring-offset-2');
                    setTimeout(() => {
                        targetCard.classList.remove('ring-2', 'ring-primary', 'ring-offset-2');
                    }, 2000);
                    
                    // 直接展开卡片内容
                    const collapseContent = targetCard.querySelector('.collapse-content');
                    const toggleIcon = targetCard.querySelector('.toggle-btn i');
                    
                    if (collapseContent && toggleIcon) {
                        // 确保内容可见
                        collapseContent.classList.remove('hidden');
                        // 更新图标为向上箭头
                        toggleIcon.className = 'fa fa-chevron-up';
                    }
                }
            }, 500); // 增加延迟确保页面完全切换
        }
        
        // 应用数据计算区筛选
        function applyCalculationFilters() {
            if (productData.length === 0) {
                showToast('提示', '暂无数据可筛选', 'info');
                return;
            }
            
            const shopFilter = document.getElementById('calculation-shop-filter').value;
            const profitStatusFilter = document.getElementById('profit-status-filter').value;
            const productIdSearch = document.getElementById('product-id-search').value.trim();
            
            // 复制原始数据
            let filteredProducts = [...productData];
            
            // 应用店铺筛选
            if (shopFilter) {
                if (shopFilter === 'uncategorized') {
                    // 筛选未分类的产品
                    filteredProducts = filteredProducts.filter(product => {
                        const productShop = getShopNameByProductId(product.id);
                        return productShop === '未分类';
                    });
                } else {
                    // 筛选特定店铺的产品
                    const shop = shops.find(s => s.id === shopFilter);
                    if (shop) {
                        filteredProducts = filteredProducts.filter(product => 
                            shop.productIds.includes(product.id)
                        );
                    }
                }
            }
            
            // 应用盈利状态筛选
            if (profitStatusFilter === 'profit') {
                filteredProducts = filteredProducts.filter(product => product.netProfit >= 0);
            } else if (profitStatusFilter === 'loss') {
                filteredProducts = filteredProducts.filter(product => product.netProfit < 0);
            }
            
            // 应用商品ID搜索
            if (productIdSearch) {
                filteredProducts = filteredProducts.filter(product => 
                    product.id.toLowerCase().includes(productIdSearch.toLowerCase())
                );
            }
            
            // 重新渲染结果
            renderFilteredResults(filteredProducts);
            
            // 显示筛选结果统计
            const totalFiltered = filteredProducts.length;
            const totalOriginal = productData.length;
            
            if (totalFiltered === totalOriginal) {
                showToast('筛选结果', `共找到 ${totalFiltered} 条记录`, 'info');
            } else {
                showToast('筛选结果', `共找到 ${totalFiltered} 条记录（筛选前共 ${totalOriginal} 条）`, 'info');
            }
        }
        
        // 清除数据计算区筛选
        function clearCalculationFilters() {
            document.getElementById('calculation-shop-filter').value = '';
            document.getElementById('profit-status-filter').value = '';
            document.getElementById('product-id-search').value = '';
            
            // 重新渲染原始结果
            renderResults();
            
            showToast('提示', '筛选条件已清除', 'info');
        }
        
        // 更新数据计算区店铺筛选器
        function updateCalculationShopFilter() {
            const shopFilter = document.getElementById('calculation-shop-filter');
            if (!shopFilter) return;
            
            // 清空现有选项（保留"全部店铺"和"未分类"）
            shopFilter.innerHTML = `
                <option value="">全部店铺</option>
                <option value="uncategorized">未分类</option>
            `;
            
            // 添加已有的店铺选项
            shops.forEach(shop => {
                const option = document.createElement('option');
                option.value = shop.id;
                option.textContent = shop.name;
                shopFilter.appendChild(option);
            });
        }
        
        // 渲染筛选后的结果
        function renderFilteredResults(filteredProducts) {
            if (filteredProducts.length === 0) {
                document.getElementById('results-container').innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fa fa-search text-3xl mb-2"></i>
                        <p>未找到符合条件的数据</p>
                        <button id="reset-filters" class="btn btn-secondary mt-4">
                            <i class="fa fa-refresh mr-1"></i> 重置筛选条件
                        </button>
                    </div>
                `;
                
                // 添加重置按钮事件
                document.getElementById('reset-filters').addEventListener('click', function() {
                    clearCalculationFilters();
                });
                
                return;
            }
            
            let html = '';
            
            filteredProducts.forEach((product, index) => {
                const profitPercentage = product.totalRevenue > 0 
                    ? ((product.netProfit / product.totalRevenue) * 100).toFixed(2) 
                    : '0.00';
                
                // 计算平均每件利润
                const avgProfitPerUnit = product.totalQuantity > 0 
                    ? (product.netProfit / product.totalQuantity) 
                    : 0;
                
                const profitClass = product.netProfit >= 0 ? 'text-success' : 'text-danger';
                const profitIcon = product.netProfit >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';
                
                // 获取店铺名称
                const shopName = getShopNameByProductId(product.id);
                
                html += `
                    <div class="product-card">
                        <div class="flex justify-between items-center cursor-pointer toggle-collapse">
                            <div class="flex items-center">
                                <div class="flex items-center">
                                    <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-4 py-2 rounded-l-lg shadow-md flex items-center space-x-2 border-r-0">
                                        <i class="fa fa-barcode text-lg"></i>
                                        <span class="font-bold tracking-wide">商品ID</span>
                                    </div>
                                    <div class="bg-white border-2 border-l-0 border-gray-300 rounded-r-lg px-4 py-2 shadow-sm font-mono font-bold text-gray-800 tracking-tight">
                                        ${product.id}
                                    </div>
                                </div>
                                ${shopName !== '未分类' ? `<span class="ml-2 inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-gradient-to-r from-primary to-blue-500 text-white shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105">
                                    ${shopName}
                                </span>` : ''}
                                <span class="ml-2 badge ${product.netProfit >= 0 ? 'badge-success' : 'badge-danger'}">
                                    ${product.netProfit >= 0 ? '盈利' : '亏损'}
                                </span>
                            </div>
                            <div class="flex items-center space-x-4">
                                <div class="profit-display ${product.netProfit >= 0 ? 'positive' : 'negative'}">
                                    <i class="fa ${profitIcon} ${profitClass} text-xl"></i>
                                    <div>
                                        <p class="text-xs font-medium text-gray-600">净利润</p>
                                        <p class="text-2xl font-bold ${profitClass}">¥${product.netProfit.toLocaleString('zh-CN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
                                    </div>
                                </div>
                                <button class="toggle-btn text-gray-500 hover:text-primary">
                                    <i class="fa fa-chevron-down"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="collapse-content mt-4 hidden">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
                                <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-4 shadow-sm hover:shadow-md transition-all duration-300 border border-blue-200 transform hover:-translate-y-0.5">
                                    <p class="text-xs font-medium text-blue-700 mb-1">总销量</p>
                                    <p class="text-xl font-bold text-blue-900">${product.totalQuantity.toLocaleString()}</p>
                                </div>
                                
                                <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-lg p-4 shadow-sm hover:shadow-md transition-all duration-300 border border-green-200 transform hover:-translate-y-0.5">
                                    <p class="text-xs font-medium text-green-700 mb-1">总实收</p>
                                    <p class="text-xl font-bold text-green-900">¥${product.totalRevenue.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
                                </div>
                                
                                <div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-lg p-4 shadow-sm hover:shadow-md transition-all duration-300 border border-gray-200 transform hover:-translate-y-0.5">
                                    <p class="text-xs font-medium text-gray-700 mb-1">快递续重费</p>
                                    <p class="text-xl font-bold text-gray-900">¥${(product.allocatedShippingFee || 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
                                </div>
                                
                                <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg p-4 shadow-sm hover:shadow-md transition-all duration-300 border border-purple-200 transform hover:-translate-y-0.5">
                                    <p class="text-xs font-medium text-purple-700 mb-1">平均每件利润</p>
                                    <p class="text-xl font-bold ${profitClass === 'text-success' ? 'text-purple-900' : profitClass}">¥${avgProfitPerUnit.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
                                </div>
                                
                                <div class="bg-gradient-to-br from-indigo-50 to-indigo-100 rounded-lg p-4 shadow-sm hover:shadow-md transition-all duration-300 border border-indigo-200 transform hover:-translate-y-0.5">
                                    <p class="text-xs font-medium text-indigo-700 mb-1">毛利率</p>
                                    <p class="text-xl font-bold ${profitClass === 'text-success' ? 'text-indigo-900' : profitClass}">${profitPercentage}%</p>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <label for="advertising-fee-filtered-${product.id}" class="block text-sm font-medium text-gray-700 mb-1">广告费 (元)</label>
                                <div class="flex">
                                    <input type="number" id="advertising-fee-filtered-${product.id}" 
                                        class="input-field" step="0.01" min="0" 
                                        value="${product.advertisingFee}" 
                                        data-product-id="${product.id}">
                                    <button class="btn btn-primary ml-2 update-advertising-filtered" 
                                        data-product-id="${product.id}">更新</button>
                                </div>
                            </div>
                            
                            <div class="border-t-4 border-indigo-500 pt-6 mt-6 bg-gradient-to-b from-white to-indigo-50 rounded-2xl p-6 shadow-xl animate-fadeIn">
                                <div class="flex items-center justify-between mb-6">
                                    <h4 class="text-2xl font-bold text-indigo-800 flex items-center">
                                        <i class="fa fa-cubes mr-3 text-indigo-600 text-2xl"></i>
                                        规格明细
                                    </h4>
                                    <div class="flex items-center space-x-2">
                                        <span class="text-base font-semibold text-gray-800 whitespace-nowrap">广告费:</span>
                                        <input type="number" id="advertising-fee-${product.id}" 
                                            class="w-32 px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-200" 
                                            step="0.01" min="0" 
                                            value="${product.advertisingFee}" 
                                            data-product-id="${product.id}">
                                        <button class="btn btn-primary text-sm py-2 px-3 update-advertising hover:shadow-md transition-all duration-200" 
                                            data-product-id="${product.id}" title="更新广告费">
                                            <i class="fa fa-refresh"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="max-h-[calc(100vh-300px)] overflow-y-auto overflow-x-auto rounded-2xl border-2 border-indigo-400 shadow-lg" style="scrollbar-width: thin; scrollbar-color: #6366f1 #e0e7ff;">
                                    <table class="min-w-full divide-y divide-indigo-200 bg-white" style="min-width: 800px;">
                                        <thead class="sticky top-0 z-20 bg-gradient-to-r from-indigo-600 to-purple-600 text-white shadow-lg whitespace-nowrap">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-sm font-bold uppercase tracking-wider min-w-[150px]">规格编码</th>
                                                <th class="px-4 py-3 text-right text-sm font-bold uppercase tracking-wider min-w-[100px]">数量</th>
                                                <th class="px-4 py-3 text-right text-sm font-bold uppercase tracking-wider min-w-[100px]">实收</th>
                                                <th class="px-4 py-3 text-right text-sm font-bold uppercase tracking-wider min-w-[120px]">平均单价</th>
                                                <th class="px-4 py-3 text-right text-sm font-bold uppercase tracking-wider min-w-[120px]">单件成本</th>
                                                <th class="px-4 py-3 text-right text-sm font-bold uppercase tracking-wider min-w-[120px]">成本总额</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-indigo-100">
                                `;
                
                Object.values(product.skus).forEach(sku => {
                    // 使用计算时确定的显示成本，确保保存的数据不被重新关联
                    const displayCost = sku.displayCost !== undefined ? sku.displayCost : 
                                      ((product.isSavedData || sku.isSavedData) && sku.originalCost !== undefined ? sku.originalCost : sku.cost);
                    const skuTotalCost = displayCost * sku.quantity;
                    
                    // 计算平均单价
                    const avgPrice = sku.quantity > 0 ? (sku.revenue / sku.quantity) : 0;
                    
                    // 检查是否为保存的数据
                    const isSavedData = product.isSavedData || sku.isSavedData;
                    
                    html += `
                        <tr class="hover:bg-indigo-50">
                            <td class="px-4 py-3 whitespace-nowrap text-sm font-bold text-indigo-900">${sku.code}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-right text-indigo-900 font-bold">${sku.quantity.toLocaleString()}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-right text-indigo-800 font-semibold">¥${sku.revenue.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-right text-indigo-800 font-semibold">¥${avgPrice.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-right ${isSavedData ? 'text-emerald-600 font-bold' : 'text-indigo-600 font-semibold'}">
                                ¥${displayCost.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                                ${isSavedData ? '<span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-800">已保存</span>' : ''}
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-right ${isSavedData ? 'text-emerald-600 font-bold' : 'text-indigo-600 font-semibold'}">¥${skuTotalCost.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        </tr>
                    `;
                });
                
                html += `
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('results-container').innerHTML = html;
            
            // 添加折叠/展开事件
            document.querySelectorAll('.toggle-collapse').forEach(collapse => {
                collapse.addEventListener('click', function() {
                    const content = this.nextElementSibling;
                    const icon = this.querySelector('.toggle-btn i');
                    
                    content.classList.toggle('hidden');
                    icon.className = content.classList.contains('hidden') ? 'fa fa-chevron-down' : 'fa fa-chevron-up';
                });
            });
            
            // 移除之前的事件监听器，避免重复绑定
            document.querySelectorAll('.update-advertising-filtered').forEach(btn => {
                btn.replaceWith(btn.cloneNode(true));
            });
            
            // 添加广告费更新事件（筛选模式）
            document.querySelectorAll('.update-advertising-filtered').forEach(btn => {
                btn.addEventListener('click', function() {
                    const productId = this.getAttribute('data-product-id');
                    const input = document.getElementById(`advertising-fee-filtered-${productId}`);
                    
                    if (!input) {
                        console.error(`输入框未找到: advertising-fee-filtered-${productId}`);
                        showToast('错误', '输入框未找到', 'error');
                        return;
                    }
                    
                    const value = parseFloat(input.value) || 0;
                    
                    const product = productData.find(p => p.id === productId);
                    if (product) {
                        // 更新广告费
                        product.advertisingFee = value;
                        
                        // 重新计算净利润，考虑快递续重费
                        const additionalShippingFee = parseFloat(document.getElementById('additional-shipping-fee').value) || 0;
                        if (additionalShippingFee > 0) {
                            const totalQuantity = productData.reduce((sum, p) => sum + p.totalQuantity, 0);
                            if (totalQuantity > 0) {
                                const allocatedShippingFee = (product.totalQuantity / totalQuantity) * additionalShippingFee;
                                product.allocatedShippingFee = allocatedShippingFee;
                                product.netProfit = product.totalRevenue - product.totalCost - value - allocatedShippingFee;
                            } else {
                                product.allocatedShippingFee = 0;
                                product.netProfit = product.totalRevenue - product.totalCost - value;
                            }
                        } else {
                            product.allocatedShippingFee = 0;
                            product.netProfit = product.totalRevenue - product.totalCost - value;
                        }
                        
                        // 重新应用筛选
                        applyCalculationFilters();
                        
                        // 更新数据看板
                        updateDashboard();
                        
                        showToast('成功', '广告费已更新', 'success');
                    } else {
                        console.error(`商品未找到: ${productId}`);
                        showToast('错误', '商品数据未找到', 'error');
                    }
                });
            });

        }
        
        // 更新店铺统计
        function updateShopStats() {
            const shopStatsGrid = document.getElementById('shop-stats-grid');
            
            if (productData.length === 0 || shops.length === 0) {
                shopStatsGrid.innerHTML = `
                    <div class="text-center py-4 text-gray-500 col-span-full">
                        <i class="fa fa-info-circle text-2xl mb-2"></i>
                        <p>暂无店铺数据</p>
                    </div>
                `;
                return;
            }
            
            // 计算每个店铺的统计数据
            const shopStats = [];
            
            // 添加每个店铺的统计
            shops.forEach(shop => {
                const shopProducts = productData.filter(product => 
                    shop.productIds.includes(product.id)
                );
                
                if (shopProducts.length > 0) {
                    const quantity = shopProducts.reduce((sum, product) => sum + product.totalQuantity, 0);
                    const revenue = shopProducts.reduce((sum, product) => sum + product.totalRevenue, 0);
                    const advertising = shopProducts.reduce((sum, product) => sum + product.advertisingFee, 0);
                    const profit = shopProducts.reduce((sum, product) => sum + product.netProfit, 0);
                    
                    const profitMargin = revenue > 0 ? (profit / revenue * 100) : 0;
                    shopStats.push({
                        name: shop.name,
                        quantity,
                        revenue,
                        advertising,
                        profit,
                        profitMargin
                    });
                }


            });
            
            // 添加未分类产品的统计
            const uncategorizedProducts = productData.filter(product => {
                const productShop = getShopNameByProductId(product.id);
                return productShop === '未分类';
            });
            
            if (uncategorizedProducts.length > 0) {
                const quantity = uncategorizedProducts.reduce((sum, product) => sum + product.totalQuantity, 0);
                const revenue = uncategorizedProducts.reduce((sum, product) => sum + product.totalRevenue, 0);
                const advertising = uncategorizedProducts.reduce((sum, product) => sum + product.advertisingFee, 0);
                const profit = uncategorizedProducts.reduce((sum, product) => sum + product.netProfit, 0);
                
                const profitMargin = revenue > 0 ? (profit / revenue * 100) : 0;
                shopStats.push({
                    name: '未分类',
                    quantity,
                    revenue,
                    advertising,
                    profit,
                    profitMargin
                });
            }
            
            // 渲染店铺统计卡片
            if (shopStats.length === 0) {
                shopStatsGrid.innerHTML = `
                    <div class="text-center py-4 text-gray-500 col-span-full">
                        <i class="fa fa-info-circle text-2xl mb-2"></i>
                        <p>暂无店铺数据</p>
                    </div>
                `;
            } else {
                shopStatsGrid.innerHTML = shopStats.map(shop => `
                    <div class="card border border-gray-200 hover:shadow-md transition-all-300 bg-white">
                        <div class="flex items-center justify-between mb-4 pb-2 border-b border-gray-100">
                            <div class="flex items-center">
                                <h3 class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-4 py-3 rounded-lg shadow-md text-lg font-bold">
                                    ${shop.name}
                                </h3>
                            </div>
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${shop.profit >= 0 ? 'bg-success/20 text-success' : 'bg-danger/20 text-danger'}">
                                ${shop.profit >= 0 ? '盈利' : '亏损'}
                            </span>
                        </div>
                        <div class="space-y-3 mb-4">
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-medium text-gray-600">销售数量</span>
                                <span class="text-base font-semibold text-gray-800">${shop.quantity}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-medium text-gray-600">实收金额</span>
                                <span class="text-base font-semibold text-gray-800">¥${shop.revenue.toFixed(2)}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-medium text-gray-600">广告费</span>
                                <span class="text-base font-semibold text-gray-800">¥${shop.advertising.toFixed(2)}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-medium text-gray-600">毛利率</span>
                                <span class="text-base font-semibold ${shop.profitMargin >= 0 ? 'text-success' : 'text-danger'}">${shop.profitMargin.toFixed(2)}%</span>
                            </div>
                        </div>
                        <div class="profit-display ${shop.profit >= 0 ? 'positive' : 'negative'}">
                            <i class="fa ${shop.profit >= 0 ? 'fa-arrow-up' : 'fa-arrow-down'} ${shop.profit >= 0 ? 'text-success' : 'text-danger'} text-lg"></i>
                            <div>
                                <p class="text-xs text-gray-500">净利润</p>
                                <p class="text-xl font-bold ${shop.profit >= 0 ? 'text-success' : 'text-danger'}">¥${shop.profit.toFixed(2)}</p>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }
        
        // 初始化图表（已移除利润趋势和产品表现图表）
        function initCharts() {
            // 图表已移除
        }
        
        // 店铺管理相关函数
        function showAddShopModal(shopId = null) {
            const modal = document.getElementById('add-shop-modal');
            const title = document.getElementById('shop-modal-title');
            const form = document.getElementById('add-shop-form');
            
            if (shopId) {
                const shop = shops.find(s => s.id === shopId);
                title.textContent = '编辑店铺';
                document.getElementById('shop-id').value = shop.id;
                document.getElementById('shop-name').value = shop.name;
                document.getElementById('shop-display-id').value = shop.displayId || '';
                document.getElementById('shop-products').value = shop.productIds.join('\n');
            } else {
                title.textContent = '添加店铺';
                form.reset();
                document.getElementById('shop-id').value = '';
            }
            
            modal.classList.remove('hidden');
        }
        
        function hideAddShopModal() {
            document.getElementById('add-shop-modal').classList.add('hidden');
        }
        
        function saveShop() {
            const shopId = document.getElementById('shop-id').value;
            const shopName = document.getElementById('shop-name').value.trim();
            const shopDisplayId = document.getElementById('shop-display-id').value.trim();
            const shopProducts = document.getElementById('shop-products').value.trim();
            
            if (!shopName) {
                showToast('错误', '请输入店铺名称', 'error');
                return;
            }
            
            const productIds = shopProducts ? shopProducts.split('\n').map(id => id.trim()).filter(id => id) : [];
            
            if (shopId) {
                // 编辑现有店铺
                const shopIndex = shops.findIndex(s => s.id === shopId);
                shops[shopIndex] = {
                    ...shops[shopIndex],
                    name: shopName,
                    displayId: shopDisplayId,
                    productIds: productIds
                };
                showToast('成功', '店铺更新成功');
            } else {
                // 添加新店铺
                shops.push({
                    id: Date.now().toString(),
                    name: shopName,
                    displayId: shopDisplayId,
                    productIds: productIds,
                    createdAt: new Date().toISOString()
                });
                showToast('成功', '店铺添加成功');
            }
            
            // 保存到本地存储
            localStorage.setItem('shops', JSON.stringify(shops));
            
            // 重新渲染店铺列表
            renderShops();
            
            // 更新数据计算区店铺筛选器
            updateCalculationShopFilter();
            
            // 隐藏模态框
            hideAddShopModal();
            
            // 更新数据计算区的店铺显示
            if (!document.getElementById('data-calculation').classList.contains('hidden')) {
                renderDataCalculation();
            }
        }
        
        function deleteShop(shopId) {
            const shop = shops.find(s => s.id === shopId);
            if (!shop) return;
            
            // 显示删除确认模态框
            openDeleteConfirmModal(
                '确认删除店铺',
                `确定要删除"${shop.name}"店铺吗？此操作无法撤销。`,
                function() {
                    shops = shops.filter(s => s.id !== shopId);
                    localStorage.setItem('shops', JSON.stringify(shops));
                    renderShops();
                    showToast('成功', '店铺删除成功');
                    
                    // 更新数据计算区的店铺显示
                    if (!document.getElementById('data-calculation').classList.contains('hidden')) {
                        renderDataCalculation();
                    }
                }
            );
        }
        
        function renderShops() {
            const container = document.getElementById('shops-container');
            const empty = document.getElementById('shops-empty');
            
            // 更新店铺数量显示
            const shopCountElement = document.getElementById('shop-count-number');
            if (shopCountElement) {
                shopCountElement.textContent = shops.length;
            }
            
            if (shops.length === 0) {
                container.innerHTML = '';
                empty.classList.remove('hidden');
                return;
            }
            
            empty.classList.add('hidden');
            
            container.innerHTML = shops.map(shop => `
                <div class="bg-white rounded-xl border border-gray-100 p-6 mb-6 shadow-sm hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1">
                    <div class="flex justify-between items-center mb-6">
                        <div class="flex items-center space-x-4">
                            <h3 class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-4 py-3 rounded-lg shadow-md text-lg font-bold">${shop.name}</h3>
                            <span class="inline-flex items-center px-3 py-1.5 rounded-full text-sm font-medium bg-blue-100 text-blue-800 border border-blue-200">
                                <i class="fa fa-cubes mr-1.5"></i> ${shop.productIds.length} 个商品
                            </span>
                        </div>
                        <div class="flex space-x-2">
                            <button class="btn btn-sm btn-secondary hover:bg-gray-200 transition-colors duration-300" onclick="showAddShopModal('${shop.id}')" title="编辑店铺">
                                <i class="fa fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger hover:bg-red-600 transition-colors duration-300" onclick="deleteShop('${shop.id}')" title="删除店铺">
                                <i class="fa fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <label class="block text-sm font-semibold text-gray-700">关联商品ID</label>
                            <span class="text-xs text-gray-500">点击标签可移除</span>
                        </div>
                        <div class="flex flex-wrap gap-2 max-h-40 overflow-y-auto p-2 border border-gray-100 rounded-lg bg-gray-50" style="scrollbar-width: thin; scrollbar-color: #cbd5e1 #f8fafc;">
                            ${shop.productIds.length > 0 ? shop.productIds.map(productId => `
                                <span class="inline-flex items-center px-3 py-1.5 rounded-full text-sm font-medium bg-blue-100 text-blue-800 hover:bg-blue-200 transition-colors duration-200">
                                    <i class="fa fa-tag mr-1.5"></i> ${productId}
                                    <i class="fa fa-times ml-1.5 text-blue-600 hover:text-blue-800 cursor-pointer hover:bg-blue-300 hover:rounded-full p-0.5 transition-colors duration-200" onclick="removeProductFromShop('${shop.id}', '${productId}'); event.stopPropagation();" title="移除商品ID"></i>
                                </span>
                            `).join('') : '<span class="text-sm text-gray-500 italic">暂无关联商品</span>'}
                        </div>
                    </div>
                    
                    <div class="flex justify-between items-center pt-4 border-t border-gray-100">
                        <button class="btn btn-sm btn-secondary hover:bg-gray-500 transition-colors duration-300 flex items-center space-x-1" onclick="showAddShopModal('${shop.id}')">
                            <i class="fa fa-plus"></i>
                            <span>添加商品ID</span>
                        </button>
                        <div class="text-xs text-gray-400">
                            ID: ${shop.displayId || shop.id}
                        </div>
                    </div>
                </div>


            `).join('');
        }
        
        function removeProductFromShop(shopId, productId) {
            const shop = shops.find(s => s.id === shopId);
            if (shop) {
                shop.productIds = shop.productIds.filter(id => id !== productId);
                localStorage.setItem('shops', JSON.stringify(shops));
                renderShops();
                
                // 更新数据计算区的店铺显示
                if (!document.getElementById('data-calculation').classList.contains('hidden')) {
                    renderDataCalculation();
                }
            }
        }
        
        // 根据商品ID获取店铺名称
        function getShopNameByProductId(productId) {
            for (const shop of shops) {
                if (shop.productIds.includes(productId)) {
                    return shop.name;
                }
            }
            return '未分类';
        }
        
        // 回收站相关函数
        function bindRecycleBinEvents() {
            const recycleBinBtn = document.getElementById('recycle-bin-btn');
            const recycleBinList = document.getElementById('recycle-bin-list');
            const recycleBinContainer = document.getElementById('recycle-bin-container');
            const emptyRecycleBinBtn = document.getElementById('empty-recycle-bin');
            
            // 点击回收站按钮显示/隐藏列表
            recycleBinBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                recycleBinList.classList.toggle('hidden');
                if (!recycleBinList.classList.contains('hidden')) {
                    renderRecycleBin();
                }
            });
            
            // 点击清空回收站
            emptyRecycleBinBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                if (recycleBin.length > 0) {
                    if (confirm('确定要清空回收站吗？此操作不可撤销。')) {
                        recycleBin = [];
                        localStorage.setItem('recycleBin', JSON.stringify(recycleBin));
                        updateRecycleBinCount();
                        renderRecycleBin();
                        showToast('成功', '回收站已清空', 'success');
                    }
                }
            });
            
            // 点击其他地方隐藏回收站列表
            document.addEventListener('click', function(e) {
                if (!recycleBinContainer.contains(e.target)) {
                    recycleBinList.classList.add('hidden');
                }
            });
        }
        
        function updateRecycleBinCount() {
            const countElement = document.getElementById('recycle-bin-count');
            const count = recycleBin.length;
            countElement.textContent = count;
            countElement.style.display = count > 0 ? 'flex' : 'none';
        }
        
        function renderRecycleBin() {
            const itemsContainer = document.getElementById('recycle-bin-items');
            const emptyContainer = document.getElementById('recycle-bin-empty');
            
            if (recycleBin.length === 0) {
                itemsContainer.innerHTML = '';
                itemsContainer.classList.add('hidden');
                emptyContainer.classList.remove('hidden');
                return;
            }
            
            itemsContainer.classList.remove('hidden');
            emptyContainer.classList.add('hidden');
            
            let html = '';
            recycleBin.forEach((item, index) => {
                const deletedDate = new Date(item.deletedAt).toLocaleString('zh-CN');
                html += `
                    <div class="recycle-bin-item p-3 border-b border-gray-100 hover:bg-gray-50">
                        <div class="flex items-center justify-between mb-1">
                            <span class="font-medium text-gray-800 text-sm cursor-pointer hover:text-primary restore-item" data-index="${index}">
                                ${item.name}
                            </span>
                            <button class="text-gray-400 hover:text-danger delete-forever" data-index="${index}" title="彻底删除">
                                <i class="fa fa-times"></i>
                            </button>
                        </div>
                        <div class="flex items-center justify-between text-xs text-gray-500">
                            <span>删除时间: ${deletedDate}</span>
                            <span class="text-primary cursor-pointer hover:underline restore-item" data-index="${index}">
                                恢复
                            </span>
                        </div>
                    </div>
                `;
            });
            
            itemsContainer.innerHTML = html;
            
            // 绑定恢复事件
            itemsContainer.querySelectorAll('.restore-item').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.dataset.index);
                    restoreFromRecycleBin(index);
                });
            });
            
            // 绑定彻底删除事件
            itemsContainer.querySelectorAll('.delete-forever').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const index = parseInt(this.dataset.index);
                    deleteForeverFromRecycleBin(index);
                });
            });
        }
        
        function restoreFromRecycleBin(index) {
            if (index >= 0 && index < recycleBin.length) {
                const item = recycleBin[index];
                delete item.deletedAt;
                
                // 检查是否已存在同名数据
                const existingIndex = savedData.findIndex(savedItem => savedItem.id === item.id);
                if (existingIndex !== -1) {
                    // 如果存在，询问是否覆盖
                    if (confirm('已存在同名数据，是否覆盖？')) {
                        savedData[existingIndex] = item;
                    } else {
                        // 不覆盖，添加新的
                        item.id = Date.now().toString();
                        savedData.unshift(item);
                    }
                } else {
                    savedData.unshift(item);
                }
                
                // 从回收站移除
                recycleBin.splice(index, 1);
                
                // 保存到本地存储
                localStorage.setItem('savedData', JSON.stringify(savedData));
                localStorage.setItem('recycleBin', JSON.stringify(recycleBin));
                
                // 更新界面
                updateRecycleBinCount();
                renderRecycleBin();
                searchSavedData();
                
                showToast('成功', '数据已恢复', 'success');
            }
        }
        
        function deleteForeverFromRecycleBin(index) {
            if (index >= 0 && index < recycleBin.length) {
                if (confirm('确定要彻底删除这个数据吗？此操作不可撤销。')) {
                    recycleBin.splice(index, 1);
                    localStorage.setItem('recycleBin', JSON.stringify(recycleBin));
                    updateRecycleBinCount();
                    renderRecycleBin();
                    showToast('成功', '数据已彻底删除', 'success');
                }
            }
        }
        
        // 数据保存相关函数
        function saveCurrentData() {
            if (productData.length === 0) {
                showToast('错误', '没有可保存的数据', 'error');
                return;
            }
            
            const saveNameInput = document.getElementById('save-name');
            const reportMonth = document.getElementById('report-month').value;
            
            let saveName = saveNameInput.value.trim();
            if (!saveName) {
                saveName = reportMonth || `数据_${new Date().toISOString().split('T')[0]}`;
            }
            
            const dataToSave = {
                id: Date.now().toString(),
                name: saveName,
                reportMonth: reportMonth,
                productData: JSON.parse(JSON.stringify(productData)),
                excelData: JSON.parse(JSON.stringify(excelData)),
                skuCosts: JSON.parse(JSON.stringify(skuCosts)),
                costRecords: JSON.parse(JSON.stringify(costRecords)),
                createdAt: new Date().toISOString()
            };
            
            // 将新保存的数据添加到开头
            savedData.unshift(dataToSave);
            
            // 使用LZ-String压缩数据后保存到本地存储
            try {
                const dataString = JSON.stringify(savedData);
                const compressedData = LZString.compress(dataString);
                if (compressedData) {
                    localStorage.setItem('savedData', compressedData);
                    console.log('数据压缩并保存成功。原始大小:', dataString.length, '字符, 压缩后大小:', compressedData.length, '字符');
                } else {
                    throw new Error('数据压缩失败，结果为空');
                }
            } catch (error) {
                console.error('保存压缩数据时出错:', error);
                // 如果压缩失败，尝试直接保存未压缩的数据
                try {
                    localStorage.setItem('savedData', JSON.stringify(savedData));
                } catch (saveError) {
                    console.error('Failed to save data:', saveError);
                    showToast('错误', '保存数据失败，请检查存储空间', 'error');
                    return;
                }
            }
            
            // 同时保存回收站数据
            try {
                localStorage.setItem('recycleBin', JSON.stringify(recycleBin));
                console.log('回收站数据保存成功');
            } catch (error) {
                console.error('保存回收站数据失败:', error);
            }
            
            // 清空输入框
            saveNameInput.value = '';
            
            // 重新渲染保存的数据列表
            searchSavedData();
            
            showToast('成功', '数据保存成功');
        }
        
        function loadSavedData(dataId) {
            const data = savedData.find(item => item.id === dataId);
            if (!data) {
                showToast('错误', '未找到保存的数据', 'error');
                return;
            }
            
            // 加载数据，但不覆盖当前的规格成本和成本记录
            // 这样新上传的文件仍然可以使用最新的规格成本
            productData = JSON.parse(JSON.stringify(data.productData));
            excelData = JSON.parse(JSON.stringify(data.excelData));
            // 不覆盖skuCosts和costRecords，保持使用当前最新的数据
            
            // 为加载的保存数据添加标识和使用保存的成本
            productData = productData.map(product => {
                // 为每个SKU保存原始成本
                Object.values(product.skus).forEach(sku => {
                    sku.originalCost = sku.cost; // 保存SKU的原始成本
                    sku.isSavedData = true; // 标记为保存的SKU数据
                });
                
                return {
                    ...product,
                    isSavedData: true, // 标记为保存的数据
                    savedUnitCost: product.unitCost, // 使用保存时的单件成本
                    savedTotalCost: product.totalCost // 使用保存时的总成本
                };
            });
            
            // 设置报表年月
            document.getElementById('report-month').value = data.reportMonth;
            
            // 清零快递续重费
            document.getElementById('additional-shipping-fee').value = '';
            
            // 重新渲染结果
            renderResults();
            
            // 启用保存按钮
            document.getElementById('save-data').disabled = false;
            
            showToast('成功', '数据加载成功，使用保存时的成本数据');
        }
        
        function deleteSavedData(dataId) {
            const deleteBtn = event.target.closest('.delete-btn');
            if (!deleteBtn) return;
            
            // 检查是否在冷却期
            if (deleteBtn.dataset.cooling === 'true') {
                return; // 冷却期内忽略重复点击
            }
            
            // 保存原始状态
            const originalHTML = deleteBtn.innerHTML;
            const originalDisabled = deleteBtn.disabled;
            
            // 进入冷却期
            deleteBtn.dataset.cooling = 'true';
            deleteBtn.disabled = true;
            deleteBtn.textContent = '3秒';
            
            let countdown = 3;
            const timer = setInterval(() => {
                countdown--;
                if (countdown > 0) {
                    deleteBtn.textContent = `${countdown}秒`;
                } else {
                    clearInterval(timer);
                    // 冷却期结束，自动显示确认模态框
                    showDeleteConfirmation(dataId, deleteBtn, originalHTML, originalDisabled);
                }
            }, 1000);
            
            // 显示提示信息
            showToast('提示', '为防止误操作，将在3秒后自动弹出确认窗口', 'info');
        }
        
        // 显示删除确认模态框
        function showDeleteConfirmation(dataId, deleteBtn, originalHTML, originalDisabled) {
            // 创建模态框
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.id = 'delete-confirmation-modal';
            
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-lg w-full max-w-md">
                    <div class="p-6">
                        <div class="text-center mb-6">
                            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-red-100 text-red-500 mb-4">
                                <i class="fa fa-exclamation-triangle text-2xl"></i>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">确认删除</h3>
                            <p class="text-gray-600">确定要删除这个保存的数据吗？</p>
                            <p class="text-sm text-gray-500 mt-2">删除后将移至回收站</p>
                        </div>
                        
                        <div class="flex space-x-3">
                            <button id="cancel-delete" class="flex-1 btn btn-secondary h-10">
                                取消
                            </button>
                            <button id="confirm-delete" class="flex-1 btn btn-danger h-10">
                                确认删除
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // 添加到页面
            document.body.appendChild(modal);
            
            // 绑定事件
            document.getElementById('cancel-delete').onclick = function() {
                document.body.removeChild(modal);
                showToast('提示', '删除操作已取消', 'info');
                
                // 完全恢复按钮状态
                deleteBtn.disabled = false;
                deleteBtn.innerHTML = originalHTML;
                deleteBtn.classList.remove('bg-gray-200', 'text-gray-800', 'hover:bg-gray-300', 'editing-breathing-bg');
                deleteBtn.classList.add('btn-danger');
                deleteBtn.dataset.cooling = 'false';
                deleteBtn.dataset.confirming = 'false';
                deleteBtn.dataset.deleting = 'false';
            };
            
            document.getElementById('confirm-delete').onclick = function() {
                // 移除模态框
                document.body.removeChild(modal);
                
                // 执行删除操作
                performDelete(dataId, deleteBtn, originalHTML, originalDisabled);
            };
            
            // 点击背景关闭
            modal.onclick = function(e) {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                    showToast('提示', '删除操作已取消', 'info');
                    
                    // 恢复按钮状态
                    deleteBtn.disabled = originalDisabled;
                    deleteBtn.innerHTML = originalHTML;
                    deleteBtn.classList.remove('bg-gray-200 text-gray-800 hover:bg-gray-300');
                    deleteBtn.dataset.cooling = 'false';
                }
            };
        }
        
        // 执行删除操作
        function performDelete(dataId, deleteBtn, originalHTML, originalDisabled) {
            try {
                // 找到要删除的数据
                const deletedItem = savedData.find(item => item.id === dataId);
                if (deletedItem) {
                    // 添加到回收站
                    deletedItem.deletedAt = new Date().toISOString();
                    recycleBin.unshift(deletedItem);
                    
                    // 从保存数据中移除
                    savedData = savedData.filter(item => item.id !== dataId);
                    
                    // 保存到本地存储
                    const savedDataString = JSON.stringify(savedData);
                    const compressedSavedData = LZString.compress(savedDataString);
                    if (compressedSavedData) {
                        localStorage.setItem('savedData', compressedSavedData);
                    } else {
                        localStorage.setItem('savedData', savedDataString);
                    }
                    
                    const recycleBinString = JSON.stringify(recycleBin);
                    const compressedRecycleBin = LZString.compress(recycleBinString);
                    if (compressedRecycleBin) {
                        localStorage.setItem('recycleBin', compressedRecycleBin);
                    } else {
                        localStorage.setItem('recycleBin', recycleBinString);
                    }
                    
                    // 更新回收站计数
                    updateRecycleBinCount();
                    
                    // 重新渲染保存的数据列表
                    searchSavedData();
                    
                    showToast('成功', '数据已移至回收站', 'success');
                }
            } catch (error) {
                console.error('删除数据时出错:', error);
                showToast('错误', '删除失败，请重试', 'error');
            } finally {
                // 恢复按钮状态
                deleteBtn.disabled = false;
                deleteBtn.innerHTML = originalHTML;
                deleteBtn.classList.remove('bg-gray-200 text-gray-800 hover:bg-gray-300');
                deleteBtn.dataset.cooling = 'false';
            }
        }
        
        function searchSavedData() {
            const searchTerm = document.getElementById('search-saved-data').value.toLowerCase().trim();
            
            if (searchTerm) {
                filteredSavedData = savedData.filter(item => 
                    item.name.toLowerCase().includes(searchTerm)
                );
            } else {
                filteredSavedData = [...savedData];
            }
            
            currentPage = 1;
            renderSavedData();
        }
        
        function renderSavedData() {
            const container = document.getElementById('saved-data-list');
            const empty = document.getElementById('saved-data-empty');
            const pagination = document.getElementById('pagination');
            
            if (filteredSavedData.length === 0) {
                container.innerHTML = '';
                empty.classList.remove('hidden');
                pagination.classList.add('hidden');
                return;
            }
            
            empty.classList.add('hidden');
            
            // 计算分页
            const totalPages = Math.ceil(filteredSavedData.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, filteredSavedData.length);
            const pageData = filteredSavedData.slice(startIndex, endIndex);
            
            let html = '';
            pageData.forEach((item, index) => {
                const date = new Date(item.createdAt);
                const formattedTime = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} | ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
                
                html += `
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-md">
                        <div class="flex items-center">
                            <i class="fa fa-database text-primary mr-3"></i>
                            <div>
                                <p class="font-medium text-gray-800">${item.name}</p>
                                <p class="text-xs text-gray-500">${formattedTime}</p>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <button class="btn btn-sm btn-secondary p-2 hover:bg-secondary/80 transition-colors" onclick="loadSavedData('${item.id}')" title="加载数据">
                                <i class="fa fa-folder-open"></i>
                            </button>
                            <button class="btn btn-sm btn-danger delete-btn" onclick="deleteSavedData('${item.id}')" data-cooling="false">
                                <i class="fa fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // 更新分页信息
            document.getElementById('page-info').textContent = `第 ${currentPage} 页，共 ${totalPages} 页`;
            document.getElementById('prev-page').disabled = currentPage === 1;
            document.getElementById('next-page').disabled = currentPage === totalPages;
            
            pagination.classList.remove('hidden');
        }
        
        function updateSaveButtonState() {
            const saveButton = document.getElementById('save-data');
            saveButton.disabled = productData.length === 0;
        }
        
        // 更新图表（已移除图表更新逻辑）
        function updateCharts(filteredProducts = productData) {
            // 图表已移除，无需更新
        }
        
        // 导出为PDF
        function exportToPDF() {
            showToast('提示', '正在生成PDF...', 'info');
            
            // 使用html2canvas和jsPDF生成PDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            
            // 获取报表年月
            const reportMonth = document.getElementById('report-month').value || '未指定';
            
            // 添加标题
            doc.setFontSize(18);
            doc.text('电商净利润计算报告', 105, 20, { align: 'center' });
            
            doc.setFontSize(12);
            doc.text(`报表年月: ${reportMonth}`, 105, 30, { align: 'center' });
            
            // 添加生成日期
            const today = new Date();
            const dateStr = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;
            doc.setFontSize(10);
            doc.text(`生成日期: ${dateStr}`, 105, 40, { align: 'center' });
            
            // 添加汇总信息
            doc.setFontSize(14);
            doc.text('汇总信息', 20, 50);
            
            doc.setFontSize(12);
            const totalQuantity = document.getElementById('total-quantity').textContent;
            const totalRevenue = document.getElementById('total-revenue').textContent;
            const totalAdvertising = document.getElementById('total-advertising').textContent;
            const totalProfit = document.getElementById('total-profit').textContent;
            
            doc.text(`总销售数量: ${totalQuantity}`, 30, 60);
            doc.text(`总实收金额: ${totalRevenue}`, 30, 68);
            doc.text(`总广告费: ${totalAdvertising}`, 30, 76);
            doc.text(`总净利润: ${totalProfit}`, 30, 84);
            
            // 添加产品明细
            doc.setFontSize(14);
            doc.text('产品明细', 20, 95);
            
            // 准备表格数据
            const tableColumn = ["商品ID", "数量", "实收", "广告费", "成本", "净利润"];
            const tableRows = [];
            
            productData.forEach(product => {
                tableRows.push([
                    product.id,
                    product.totalQuantity.toString(),
                    product.totalRevenue.toFixed(2),
                    product.advertisingFee.toFixed(2),
                    product.totalCost.toFixed(2),
                    product.netProfit.toFixed(2)
                ]);
            });
            
            // 添加规格明细
            doc.setFontSize(14);
            doc.text('规格明细', 20, doc.internal.pageSize.height - 100);
            
            // 准备规格表格数据
            const skuTableColumn = ["商品ID", "规格编码", "数量", "实收", "平均单价", "单件成本", "成本总额"];
            const skuTableRows = [];
            
            productData.forEach(product => {
                Object.values(product.skus).forEach(sku => {
                    const avgPrice = sku.quantity > 0 ? (sku.revenue / sku.quantity) : 0;
                    const skuTotalCost = sku.cost * sku.quantity;
                    
                    skuTableRows.push([
                        product.id,
                        sku.code,
                        sku.quantity.toString(),
                        sku.revenue.toFixed(2),
                        avgPrice.toFixed(2),
                        sku.cost.toFixed(2),
                        skuTotalCost.toFixed(2)
                    ]);
                });
            });
            
            // 创建产品表格
            doc.autoTable({
                head: [tableColumn],
                body: tableRows,
                startY: 105,
                theme: 'grid',
                styles: {
                    fontSize: 10
                },
                headStyles: {
                    fillColor: [26, 86, 219]
                }
            });
            
            // 创建规格表格
            doc.autoTable({
                head: [skuTableColumn],
                body: skuTableRows,
                startY: doc.internal.pageSize.height - 90,
                theme: 'grid',
                styles: {
                    fontSize: 10
                },
                headStyles: {
                    fillColor: [26, 86, 219]
                }
            });
            
            // 保存PDF
            doc.save(`电商净利润报告_${reportMonth}.pdf`);
            
            showToast('成功', 'PDF导出成功', 'success');
        }
        
        // 导出为Excel
        function exportToExcel() {
            showToast('提示', '正在生成Excel...', 'info');
            
            // 准备数据
            const reportMonth = document.getElementById('report-month').value || '未指定';
            const today = new Date();
            const dateStr = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;
            
            // 创建工作簿
            const wb = XLSX.utils.book_new();
            
            // 创建汇总工作表
            const summaryData = [
                ['电商净利润计算报告'],
                [`报表年月: ${reportMonth}`],
                [`生成日期: ${dateStr}`],
                [],
                ['汇总信息'],
                ['总销售数量', document.getElementById('total-quantity').textContent],
                ['总实收金额', document.getElementById('total-revenue').textContent],
                ['总广告费', document.getElementById('total-advertising').textContent],
                ['总净利润', document.getElementById('total-profit').textContent]
            ];
            
            const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, summaryWs, '汇总');
            
            // 创建产品明细工作表
            const productData = [
                ['商品ID', '数量', '实收', '广告费', '成本', '净利润']
            ];
            
            window.productData.forEach(product => {
                productData.push([
                    product.id,
                    product.totalQuantity,
                    product.totalRevenue.toFixed(2),
                    product.advertisingFee.toFixed(2),
                    product.totalCost.toFixed(2),
                    product.netProfit.toFixed(2)
                ]);
            });
            
            const productWs = XLSX.utils.aoa_to_sheet(productData);
            XLSX.utils.book_append_sheet(wb, productWs, '产品明细');
            
            // 创建规格明细工作表
            const skuDetailData = [
                ['商品ID', '规格编码', '数量', '实收', '平均单价', '单件成本', '成本总额']
            ];
            
            window.productData.forEach(product => {
                Object.values(product.skus).forEach(sku => {
                    const avgPrice = sku.quantity > 0 ? (sku.revenue / sku.quantity) : 0;
                    const skuTotalCost = sku.cost * sku.quantity;
                    
                    skuDetailData.push([
                        product.id,
                        sku.code,
                        sku.quantity,
                        sku.revenue.toFixed(2),
                        avgPrice.toFixed(2),
                        sku.cost.toFixed(2),
                        skuTotalCost.toFixed(2)
                    ]);
                });
            });
            
            const skuDetailWs = XLSX.utils.aoa_to_sheet(skuDetailData);
            XLSX.utils.book_append_sheet(wb, skuDetailWs, '规格明细');
            
            // 创建规格成本工作表
            const skuData = [
                ['规格编码', '成本金额', '备注']
            ];
            
            Object.keys(skuCosts).forEach(code => {
                const sku = skuCosts[code];
                skuData.push([code, sku.cost.toFixed(2), sku.note || '']);
            });
            
            const skuWs = XLSX.utils.aoa_to_sheet(skuData);
            XLSX.utils.book_append_sheet(wb, skuWs, '规格成本');
            
            // 保存Excel文件
            XLSX.writeFile(wb, `电商净利润报告_${reportMonth}.xlsx`);
            
            showToast('成功', 'Excel导出成功', 'success');
        }
        
        // 全局变量，用于存储当前待删除的操作信息
        let currentDeleteOperation = null;

        // 打开删除确认模态框
        function openDeleteConfirmModal(title, message, onConfirm) {
            document.getElementById('delete-modal-title').textContent = title;
            document.getElementById('delete-modal-message').textContent = message;
            
            // 保存确认回调函数
            currentDeleteOperation = onConfirm;
            
            // 显示模态框
            document.getElementById('delete-confirm-modal').classList.remove('hidden');
        }

        // 关闭删除确认模态框
        function closeDeleteConfirmModal() {
            document.getElementById('delete-confirm-modal').classList.add('hidden');
            currentDeleteOperation = null;
        }

        // 绑定删除确认模态框事件
        document.getElementById('delete-cancel-btn').addEventListener('click', closeDeleteConfirmModal);
        document.getElementById('delete-confirm-btn').addEventListener('click', function() {
            if (currentDeleteOperation && typeof currentDeleteOperation === 'function') {
                currentDeleteOperation();
            }
            closeDeleteConfirmModal();
        });

        // 打开成本模态框
        function openCostModal(costType, typeName) {
            // 重置编辑模式状态
            isEditMode = false;
            currentEditIndex = -1;
            currentEditCostType = '';
            
            // 设置成本类型和标题
            const costTypeSelect = document.getElementById('cost-type');
            costTypeSelect.value = costType;
            costTypeSelect.setAttribute('data-original-type', costType); // 保存原始类型用于验证
            
            document.getElementById('cost-modal-title').textContent = `添加${typeName}`;
            document.getElementById('cost-name-label').textContent = typeName;
            
            // 显示或隐藏分类选择器
            const categoryContainer = document.getElementById('cost-category-container');
            const categorySelect = document.getElementById('cost-category');
            
            if (costType === 'packaging' || costType === 'accessory') {
                categoryContainer.classList.remove('hidden');
                
                // 清空并重新填充分类选项
                categorySelect.innerHTML = '<option value="">无分类</option>';
                costCategories[costType].forEach(categoryObj => {
                    // 确保正确处理分类对象
                    const category = typeof categoryObj === 'string' ? categoryObj : categoryObj.name;
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    categorySelect.appendChild(option);
                });
            } else {
                categoryContainer.classList.add('hidden');
            }
            
            // 重置表单字段
            document.getElementById('cost-name').value = '';
            document.getElementById('cost-amount').value = '';
            document.getElementById('cost-note').value = '';
            document.getElementById('cost-unit').value = '';
            
            // 显示模态框
            document.getElementById('add-cost-modal').classList.remove('hidden');
            
            console.log(`打开成本模态框: ${costType} (${typeName})`);
        }
        
        // 关闭模态框
        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }
        
        // 重置表单
        function resetForm(formId) {
            const form = document.getElementById(formId);
            
            // 对于成本编辑表单，特殊处理以保留分类选择
            if (formId === 'add-cost-form') {
                // 手动重置除分类字段外的所有字段
                const inputs = form.querySelectorAll('input, textarea');
                inputs.forEach(input => {
                    input.value = '';
                });
                // 保留select字段的值
            } else {
                form.reset();
                // 如果是规格成本表单，清空引用成本项目
                if (formId === 'add-sku-form') {
                    document.getElementById('referenced-costs-container').innerHTML = '';
                    updateTotalCostPreview();
                }
            }
        }
        
        // 查找成本项目
        function findCostItemById(costType, costId) {
            const costItems = costRecords[costType] || [];
            return costItems.find(item => item.id === costId);
        }
        
        // 计算引用成本总和
        function calculateReferencedCostTotal(referencedCosts) {
            return referencedCosts.reduce((total, ref) => {
                const costItem = findCostItemById(ref.costType, ref.costId);
                const currentUnitCost = costItem ? costItem.amount : ref.unitCost;
                return total + (currentUnitCost * ref.quantity);
            }, 0);
        }
        
        // 更新总成本预览
        function updateTotalCostPreview() {
            const container = document.getElementById('referenced-costs-container');
            const baseCost = parseFloat(document.getElementById('sku-cost').value) || 0;
            
            let referencedTotal = 0;
            for (let i = 0; i < container.children.length; i++) {
                const item = container.children[i];
                const totalText = item.querySelector('.item-total-cost').textContent;
                const itemTotal = parseFloat(totalText.replace('¥', '')) || 0;
                referencedTotal += itemTotal;
            }
            
            const totalCost = baseCost + referencedTotal;
            document.getElementById('total-cost-preview').textContent = `¥${totalCost.toFixed(2)}`;
        }
        
        // 添加引用成本项目
        function addReferencedCostItem(costType = 'packaging', costId = '', quantity = 1, index = null) {
            const container = document.getElementById('referenced-costs-container');
            const itemIndex = index !== null ? index : container.children.length;
            
            const costTypeOptions = `
                <option value="express">快递成本</option>
                <option value="platform">管理成本</option>
                <option value="packaging">包装成本</option>
                <option value="accessory">产品成本</option>
            `;
            
            const html = `
                <div class="referenced-cost-item flex items-center space-x-2 mb-2" data-index="${itemIndex}">
                    <select class="cost-type-select input-field" onchange="onCostTypeChange(this, ${itemIndex})">
                        ${costTypeOptions}
                    </select>
                    <span class="category-label hidden"></span>
                    <select class="category-select input-field hidden" onchange="onCategoryChange(this, ${itemIndex})">
                        <option value="">选择类目</option>
                    </select>
                    <select class="cost-item-select input-field" data-cost-type="${costType}" onchange="onCostItemChange(this, ${itemIndex})">
                        <option value="">选择项目</option>
                    </select>
                    <input type="number" class="quantity-input input-field w-20" value="${quantity}" min="1" onchange="onQuantityChange(this, ${itemIndex})" placeholder="数量">
                    <span class="item-total-cost text-sm font-medium">¥0.00</span>
                    <button type="button" class="btn btn-sm btn-danger" onclick="removeReferencedCostItem(${itemIndex})">
                        <i class="fa fa-trash"></i>
                    </button>
                </div>
            `;
            
            if (index !== null) {
                const existingItem = container.children[index];
                existingItem.outerHTML = html;
                // 重新索引所有项目
                for (let i = 0; i < container.children.length; i++) {
                    const item = container.children[i];
                    item.setAttribute('data-index', i);
                    // 更新所有相关的事件处理函数中的索引
                    const typeSelect = item.querySelector('.cost-type-select');
                    const itemSelect = item.querySelector('.cost-item-select');
                    const quantityInput = item.querySelector('.quantity-input');
                    const deleteBtn = item.querySelector('button');
                    
                    if (typeSelect) typeSelect.setAttribute('onchange', `onCostTypeChange(this, ${i})`);
                    if (itemSelect) itemSelect.setAttribute('onchange', `onCostItemChange(this, ${i})`);
                    if (quantityInput) quantityInput.setAttribute('onchange', `onQuantityChange(this, ${i})`);
                    if (deleteBtn) deleteBtn.setAttribute('onclick', `removeReferencedCostItem(${i})`);
                }
            } else {
                // 使用appendChild而不是innerHTML来避免丢失现有元素的状态
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                const newItem = tempDiv.firstElementChild;
                container.appendChild(newItem);
            }
            
            // 初始化成本类型选择
            const typeSelect = container.children[itemIndex].querySelector('.cost-type-select');
            typeSelect.value = costType;
            
            // 加载成本项目
            loadCostItems(costType, itemIndex, costId);
            
            // 更新单项总成本
            updateItemTotalCost(itemIndex);
        }
        
        // 加载成本项目
        function loadCostItems(costType, index, selectedCostId = '') {
            const container = document.getElementById('referenced-costs-container');
            const item = container.children[index];
            const categoryLabel = item.querySelector('.category-label');
            const categorySelect = item.querySelector('.category-select');
            const itemSelect = item.querySelector('.cost-item-select');
            
            // 重置项目选择框
            itemSelect.innerHTML = '<option value="">选择项目</option>';
            itemSelect.setAttribute('data-cost-type', costType);
            
            // 根据成本类型决定是否显示类目选择
            if (costType === 'packaging' || costType === 'accessory') {
                categoryLabel.classList.remove('hidden');
                categorySelect.classList.remove('hidden');
                
                // 加载唯一的类目列表
                const costItems = costRecords[costType] || [];
                const categories = [...new Set(costItems.map(item => item.category).filter(cat => cat))];
                
                // 清空并添加类目选项
                categorySelect.innerHTML = '<option value="">选择类目</option>';
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    categorySelect.appendChild(option);
                });
                
                // 如果有选中的成本项目，先找到对应的分类
                let selectedCategory = '';
                if (selectedCostId) {
                    const selectedItem = costItems.find(item => item.id === selectedCostId);
                    if (selectedItem && selectedItem.category) {
                        selectedCategory = selectedItem.category;
                        categorySelect.value = selectedCategory;
                    }
                }
                
                // 根据分类过滤项目
                const filteredItems = selectedCategory ? costItems.filter(item => item.category === selectedCategory) : costItems;
                filteredItems.forEach(costItem => {
                    const option = document.createElement('option');
                    option.value = costItem.id;
                    option.textContent = `${costItem.name} - ¥${costItem.amount.toFixed(2)}`;
                    if (costItem.id === selectedCostId) {
                        option.selected = true;
                    }
                    itemSelect.appendChild(option);
                });
            } else {
                // 隐藏类目选择
                categoryLabel.classList.add('hidden');
                categorySelect.classList.add('hidden');
                
                // 直接加载所有项目
                const costItems = costRecords[costType] || [];
                costItems.forEach(costItem => {
                    const option = document.createElement('option');
                    option.value = costItem.id;
                    option.textContent = `${costItem.name} - ¥${costItem.amount.toFixed(2)}`;
                    if (costItem.id === selectedCostId) {
                        option.selected = true;
                    }
                    itemSelect.appendChild(option);
                });
            }
        }
        
        // 更新单项总成本
        function updateItemTotalCost(index) {
            const container = document.getElementById('referenced-costs-container');
            const item = container.children[index];
            
            const costType = item.querySelector('.cost-type-select').value;
            const costId = item.querySelector('.cost-item-select').value;
            const quantity = parseInt(item.querySelector('.quantity-input').value) || 0;
            
            let itemTotal = 0;
            if (costType && costId && quantity > 0) {
                const costItem = findCostItemById(costType, costId);
                if (costItem) {
                    itemTotal = costItem.amount * quantity;
                }
            }
            
            const totalElement = item.querySelector('.item-total-cost');
            totalElement.textContent = `¥${itemTotal.toFixed(2)}`;
            
            // 更新总成本预览
            updateTotalCostPreview();
        }
        
        // 事件处理函数
        window.onCostTypeChange = function(select, index) {
            const costType = select.value;
            loadCostItems(costType, index);
            updateItemTotalCost(index);
        };
        
        window.onCostItemChange = function(select, index) {
            updateItemTotalCost(index);
        };
        
        window.onCategoryChange = function(select, index) {
            const category = select.value;
            const container = document.getElementById('referenced-costs-container');
            const item = container.children[index];
            const costTypeSelect = item.querySelector('.cost-type-select');
            const costType = costTypeSelect.value;
            const itemSelect = item.querySelector('.cost-item-select');
            
            // 清空项目选择框
            itemSelect.innerHTML = '<option value="">选择项目</option>';
            
            // 根据选择的类目过滤项目
            const costItems = costRecords[costType] || [];
            const filteredItems = category ? costItems.filter(item => item.category === category) : costItems;
            
            filteredItems.forEach(costItem => {
                const option = document.createElement('option');
                option.value = costItem.id;
                option.textContent = `${costItem.name} - ¥${costItem.amount.toFixed(2)}`;
                itemSelect.appendChild(option);
            });
            
            // 更新总成本
            updateItemTotalCost(index);
        };
        
        window.onQuantityChange = function(input, index) {
            updateItemTotalCost(index);
        };
        
        window.removeReferencedCostItem = function(index) {
            const container = document.getElementById('referenced-costs-container');
            container.children[index].remove();
            
            // 重新索引剩余项目
            for (let i = 0; i < container.children.length; i++) {
                container.children[i].setAttribute('data-index', i);
                const inputs = container.children[i].querySelectorAll('select, input');
                inputs.forEach(input => {
                    const onchange = input.getAttribute('onchange');
                    if (onchange) {
                        input.setAttribute('onchange', onchange.replace(/\d+/, i));
                    }
                    const onclick = input.getAttribute('onclick');
                    if (onclick) {
                        input.setAttribute('onclick', onclick.replace(/\d+/, i));
                    }
                });
            }
            
            updateTotalCostPreview();
        };
        
        // 显示提示框
        function showToast(title, message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastTitle = document.getElementById('toast-title');
            const toastMessage = document.getElementById('toast-message');
            const toastIcon = document.getElementById('toast-icon');
            
            toastTitle.textContent = title;
            toastMessage.textContent = message;
            
            // 设置图标和颜色
            if (type === 'success') {
                toastIcon.innerHTML = '<i class="fa fa-check-circle text-xl"></i>';
                toastIcon.className = 'flex-shrink-0 text-success mr-3';
            } else if (type === 'error') {
                toastIcon.innerHTML = '<i class="fa fa-exclamation-circle text-xl"></i>';
                toastIcon.className = 'flex-shrink-0 text-danger mr-3';
            } else if (type === 'info') {
                toastIcon.innerHTML = '<i class="fa fa-info-circle text-xl"></i>';
                toastIcon.className = 'flex-shrink-0 text-primary mr-3';
            }
            
            // 显示提示框
            toast.classList.remove('hidden');
            setTimeout(() => {
                toast.classList.remove('translate-y-10', 'opacity-0');
            }, 10);
            
            // 3秒后自动隐藏
            setTimeout(() => {
                hideToast();
            }, 3000);
        }
        
        // 隐藏提示框
        function hideToast() {
            const toast = document.getElementById('toast');
            toast.classList.add('translate-y-10', 'opacity-0');
            
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 300);
        }
        
        // 打开分类管理模态框
        function openCategoryManagementModal(costType, typeName) {
            document.getElementById('category-modal-title').textContent = `${typeName}分类管理`;
            document.getElementById('add-category').setAttribute('data-cost-type', costType);
            document.getElementById('cost-category-name').value = '';
            document.getElementById('cost-category-color').value = '#3B82F6';
            
            renderCategoriesList(costType);
            document.getElementById('category-management-modal').classList.remove('hidden');
        }
        
        // 渲染分类列表
        function renderCategoriesList(costType) {
            const categoriesList = document.getElementById('categories-list');
            const categories = costCategories[costType];
            
            if (categories.length === 0) {
                categoriesList.innerHTML = '<p class="text-center py-4 text-gray-500">暂无分类，请添加</p>';
                return;
            }
            
            let html = '<div class="space-y-2">';
            categories.forEach((categoryObj, index) => {
                // 确保categoryObj是对象格式
                const category = typeof categoryObj === 'string' ? { name: categoryObj, color: '#3B82F6' } : categoryObj;
                html += `
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-md">
                        <div class="flex items-center space-x-2">
                            <div class="w-4 h-4 rounded-full" style="background-color: ${category.color}"></div>
                            <span class="font-medium text-gray-800 category-name" data-cost-type="${costType}" data-index="${index}">${category.name}</span>
                        </div>
                        <div class="flex space-x-2">
                            <button class="text-primary hover:text-primary-dark edit-category p-1 rounded hover:bg-primary/10 transition-colors" 
                                data-cost-type="${costType}" 
                                data-index="${index}"
                                style="cursor: pointer; z-index: 10;">
                                <i class="fa fa-pencil"></i>
                            </button>
                            <button class="text-danger hover:text-danger-dark delete-category p-1 rounded hover:bg-danger/10 transition-colors" 
                                data-cost-type="${costType}" 
                                data-index="${index}"
                                style="cursor: pointer; z-index: 10;">
                                <i class="fa fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            categoriesList.innerHTML = html;
            
            // 添加编辑分类事件
            document.querySelectorAll('.edit-category').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation(); // 阻止事件冒泡
                    const type = this.getAttribute('data-cost-type');
                    const index = parseInt(this.getAttribute('data-index'));
                    console.log('Edit button clicked:', type, index);
                    editCategoryName(type, index);
                });
            });

            // 添加删除分类事件
            document.querySelectorAll('.delete-category').forEach(btn => {
                btn.addEventListener('click', function() {
                    const type = this.getAttribute('data-cost-type');
                    const index = parseInt(this.getAttribute('data-index'));
                    
                    // 获取分类名称
                    const categoryObj = categories[index];
                    const categoryName = typeof categoryObj === 'string' ? categoryObj : categoryObj.name;
                    
                    if (confirm(`确定要删除分类 "${categoryName}" 吗？`)) {
                        // 移除分类
                        costCategories[type].splice(index, 1);
                        
                        // 将使用该分类的成本项设为无分类
                        costRecords[type].forEach(item => {
                            if (item.category === categoryName) {
                                item.category = '';
                            }
                        });
                        
                        saveData();
                        renderCategoriesList(type);
                        updateCategoryFilters();
                        renderCostRecords();
                        
                        showToast('成功', '分类已删除', 'success');
                    }
                });
            });

            // 添加分类名称点击事件（支持直接点击分类名称进行编辑）
            document.querySelectorAll('.category-name').forEach(span => {
                span.addEventListener('click', function() {
                    const type = this.getAttribute('data-cost-type');
                    const index = parseInt(this.getAttribute('data-index'));
                    editCategoryName(type, index);
                });
            });

        }

        // 编辑分类名称（内联编辑方式）
        function editCategoryName(costType, index) {
            const categoryNameSpan = document.querySelector(`.category-name[data-cost-type="${costType}"][data-index="${index}"]`);
            if (!categoryNameSpan) return;

            // 获取当前分类信息
            const categoryObj = costCategories[costType][index];
            const currentName = typeof categoryObj === 'string' ? categoryObj : categoryObj.name;
            const currentColor = typeof categoryObj === 'object' && categoryObj.color ? categoryObj.color : '#3B82F6';
            
            const parentDiv = categoryNameSpan.parentElement;
            const buttonsDiv = parentDiv.nextElementSibling;
            
            // 隐藏按钮
            buttonsDiv.style.display = 'none';
            
            // 创建内联编辑界面
            const editHtml = `
                <div class="flex items-center space-x-2 w-full">
                    <input type="text" value="${currentName}" 
                        class="input-field text-sm py-1 flex-1" 
                        id="edit-category-input-${costType}-${index}">
                    <input type="color" value="${currentColor}"
                        class="w-8 h-8 rounded border-0 cursor-pointer"
                        id="edit-category-color-${costType}-${index}">
                    <button class="btn btn-success btn-sm py-1 px-2 save-category" 
                        data-cost-type="${costType}" data-index="${index}">
                        <i class="fa fa-check"></i>
                    </button>
                    <button class="btn btn-secondary btn-sm py-1 px-2 cancel-category" 
                        data-cost-type="${costType}" data-index="${index}">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
            `;
            
            // 替换为编辑界面
            categoryNameSpan.outerHTML = editHtml;
            
            // 聚焦输入框
            const input = document.getElementById(`edit-category-input-${costType}-${index}`);
            input.focus();
            input.select();
            
            // 添加事件监听
            document.querySelector(`.save-category[data-cost-type="${costType}"][data-index="${index}"]`).addEventListener('click', function(e) {
                e.stopPropagation();
                saveCategoryName(costType, index);
            });
            
            document.querySelector(`.cancel-category[data-cost-type="${costType}"][data-index="${index}"]`).addEventListener('click', function(e) {
                e.stopPropagation();
                cancelEditCategory(costType, index);
            });
            
            // 按Enter保存，按Esc取消
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    saveCategoryName(costType, index);
                }
            });
            
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    cancelEditCategory(costType, index);
                }
            });
        }

        // 保存分类名称和颜色
        function saveCategoryName(costType, index) {
            const nameInput = document.getElementById(`edit-category-input-${costType}-${index}`);
            const colorInput = document.getElementById(`edit-category-color-${costType}-${index}`);
            const newName = nameInput.value.trim();
            const newColor = colorInput.value;
            
            if (!newName) {
                showToast('错误', '分类名称不能为空', 'error');
                nameInput.focus();
                return;
            }
            
            if (newName.length > 20) {
                showToast('错误', '分类名称不能超过20个字符', 'error');
                nameInput.focus();
                return;
            }
            
            // 获取当前分类对象
            const currentCategory = costCategories[costType][index];
            const oldName = typeof currentCategory === 'string' ? currentCategory : currentCategory.name;
            
            // 检查名称是否重复
            const nameExists = costCategories[costType].some((cat, i) => {
                if (i === index) return false;
                const catName = typeof cat === 'string' ? cat : cat.name;
                return catName === newName;
            });
            
            if (nameExists) {
                showToast('错误', '分类名称已存在', 'error');
                nameInput.focus();
                return;
            }
            
            // 更新分类名称和颜色
            if (typeof currentCategory === 'string') {
                // 如果是旧格式的字符串，转换为对象格式
                costCategories[costType][index] = { name: newName, color: newColor };
            } else {
                // 如果已经是对象格式，更新名称和颜色
                currentCategory.name = newName;
                currentCategory.color = newColor;
            }
            
            // 更新使用该分类的成本记录
            costRecords[costType].forEach(item => {
                if (item.category === oldName) {
                    item.category = newName;
                }
            });
            
            saveData();
            renderCategoriesList(costType);
            updateCategoryFilters();
            renderCostRecords();
            
            showToast('成功', '分类已更新', 'success');
        }

        // 取消编辑分类名称
        function cancelEditCategory(costType, index) {
            renderCategoriesList(costType);
        }


        
        // 店铺管理相关函数
        function showAddShopModal(shopId = null) {
            const modal = document.getElementById('add-shop-modal');
            const title = document.getElementById('shop-modal-title');
            const form = document.getElementById('add-shop-form');
            
            if (shopId) {
                const shop = shops.find(s => s.id === shopId);
                title.textContent = '编辑店铺';
                document.getElementById('shop-id').value = shop.id;
                document.getElementById('shop-name').value = shop.name;
                document.getElementById('shop-display-id').value = shop.displayId || '';
                document.getElementById('shop-products').value = shop.productIds.join('\n');
            } else {
                title.textContent = '添加店铺';
                form.reset();
                document.getElementById('shop-id').value = '';
            }
            
            modal.classList.remove('hidden');
        }
        
        function hideAddShopModal() {
            document.getElementById('add-shop-modal').classList.add('hidden');
        }
        
        function saveShop() {
            const shopId = document.getElementById('shop-id').value;
            const shopName = document.getElementById('shop-name').value.trim();
            const shopDisplayId = document.getElementById('shop-display-id').value.trim();
            const shopProducts = document.getElementById('shop-products').value.trim();
            
            if (!shopName) {
                showToast('错误', '请输入店铺名称', 'error');
                return;
            }
            
            const productIds = shopProducts ? shopProducts.split('\n').map(id => id.trim()).filter(id => id) : [];
            
            if (shopId) {
                // 编辑现有店铺
                const shopIndex = shops.findIndex(s => s.id === shopId);
                shops[shopIndex] = {
                    ...shops[shopIndex],
                    name: shopName,
                    displayId: shopDisplayId,
                    productIds: productIds
                };
                showToast('成功', '店铺更新成功');
            } else {
                // 添加新店铺
                shops.push({
                    id: Date.now().toString(),
                    name: shopName,
                    displayId: shopDisplayId,
                    productIds: productIds,
                    createdAt: new Date().toISOString()
                });
                showToast('成功', '店铺添加成功');
            }
            
            // 保存到本地存储
            localStorage.setItem('shops', JSON.stringify(shops));
            
            // 重新渲染店铺列表
            renderShops();
            
            // 更新数据计算区店铺筛选器
            updateCalculationShopFilter();
            
            // 隐藏模态框
            hideAddShopModal();
            
            // 更新数据计算区的店铺显示
            if (!document.getElementById('data-calculation').classList.contains('hidden')) {
                renderDataCalculation();
            }
        }
        
        function deleteShop(shopId) {
            const shop = shops.find(s => s.id === shopId);
            if (!shop) return;
            
            // 显示删除确认模态框
            openDeleteConfirmModal(
                '确认删除店铺',
                `确定要删除"${shop.name}"店铺吗？此操作无法撤销。`,
                function() {
                    shops = shops.filter(s => s.id !== shopId);
                    localStorage.setItem('shops', JSON.stringify(shops));
                    renderShops();
                    showToast('成功', '店铺删除成功');
                    
                    // 更新数据计算区的店铺显示
                    if (!document.getElementById('data-calculation').classList.contains('hidden')) {
                        renderDataCalculation();
                    }
                }
            );
        }
        
        function renderShops() {
            const container = document.getElementById('shops-container');
            const empty = document.getElementById('shops-empty');
            
            // 更新店铺数量显示
            const shopCountElement = document.getElementById('shop-count-number');
            if (shopCountElement) {
                shopCountElement.textContent = shops.length;
            }
            
            if (shops.length === 0) {
                container.innerHTML = '';
                empty.classList.remove('hidden');
                return;
            }
            
            empty.classList.add('hidden');
            
            container.innerHTML = shops.map(shop => `
                <div class="bg-white rounded-xl border border-gray-100 p-6 mb-6 shadow-sm hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1">
                    <div class="flex justify-between items-center mb-6">
                        <div class="flex items-center space-x-4">
                            <h3 class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-4 py-3 rounded-lg shadow-md text-lg font-bold">${shop.name}</h3>
                            <span class="inline-flex items-center px-3 py-1.5 rounded-full text-sm font-medium bg-blue-100 text-blue-800 border border-blue-200">
                                <i class="fa fa-cubes mr-1.5"></i> ${shop.productIds.length} 个商品
                            </span>
                        </div>
                        <div class="flex space-x-2">
                            <button class="btn btn-sm btn-secondary hover:bg-gray-200 transition-colors duration-300" onclick="showAddShopModal('${shop.id}')" title="编辑店铺">
                                <i class="fa fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger hover:bg-red-600 transition-colors duration-300" onclick="deleteShop('${shop.id}')" title="删除店铺">
                                <i class="fa fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <label class="block text-sm font-semibold text-gray-700">关联商品ID</label>
                            <span class="text-xs text-gray-500">点击标签可移除</span>
                        </div>
                        <div class="flex flex-wrap gap-2 max-h-40 overflow-y-auto p-2 border border-gray-100 rounded-lg bg-gray-50" style="scrollbar-width: thin; scrollbar-color: #cbd5e1 #f8fafc;">
                            ${shop.productIds.length > 0 ? shop.productIds.map(productId => `
                                <span class="inline-flex items-center px-3 py-1.5 rounded-full text-sm font-medium bg-blue-100 text-blue-800 hover:bg-blue-200 transition-colors duration-200">
                                    <i class="fa fa-tag mr-1.5"></i> ${productId}
                                    <i class="fa fa-times ml-1.5 text-blue-600 hover:text-blue-800 cursor-pointer hover:bg-blue-300 hover:rounded-full p-0.5 transition-colors duration-200" onclick="removeProductFromShop('${shop.id}', '${productId}'); event.stopPropagation();" title="移除商品ID"></i>
                                </span>
                            `).join('') : '<span class="text-sm text-gray-500 italic">暂无关联商品</span>'}
                        </div>
                    </div>
                    
                    <div class="flex justify-between items-center pt-4 border-t border-gray-100">
                        <button class="btn btn-sm btn-secondary hover:bg-gray-500 transition-colors duration-300 flex items-center space-x-1" onclick="showAddShopModal('${shop.id}')">
                            <i class="fa fa-plus"></i>
                            <span>添加商品ID</span>
                        </button>
                        <div class="text-xs text-gray-400">
                            ID: ${shop.displayId || shop.id}
                        </div>
                    </div>
                </div>


            `).join('');
        }
        
        function removeProductFromShop(shopId, productId) {
            const shop = shops.find(s => s.id === shopId);
            if (shop) {
                shop.productIds = shop.productIds.filter(id => id !== productId);
                localStorage.setItem('shops', JSON.stringify(shops));
                renderShops();
                
                // 更新数据计算区的店铺显示
                if (!document.getElementById('data-calculation').classList.contains('hidden')) {
                    renderDataCalculation();
                }
            }
        }
        
        // 根据商品ID获取店铺名称
        function getShopNameByProductId(productId) {
            for (const shop of shops) {
                if (shop.productIds.includes(productId)) {
                    return shop.name;
                }
            }
            return '未分类';
        }
        
        // 回收站相关函数
        function bindRecycleBinEvents() {
            const recycleBinBtn = document.getElementById('recycle-bin-btn');
            const recycleBinList = document.getElementById('recycle-bin-list');
            const recycleBinContainer = document.getElementById('recycle-bin-container');
            const emptyRecycleBinBtn = document.getElementById('empty-recycle-bin');
            
            // 点击回收站按钮显示/隐藏列表
            recycleBinBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                recycleBinList.classList.toggle('hidden');
                if (!recycleBinList.classList.contains('hidden')) {
                    renderRecycleBin();
                }
            });
            
            // 点击清空回收站
            emptyRecycleBinBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                if (recycleBin.length > 0) {
                    if (confirm('确定要清空回收站吗？此操作不可撤销。')) {
                        recycleBin = [];
                        localStorage.setItem('recycleBin', JSON.stringify(recycleBin));
                        updateRecycleBinCount();
                        renderRecycleBin();
                        showToast('成功', '回收站已清空', 'success');
                    }
                }
            });
            
            // 点击其他地方隐藏回收站列表
            document.addEventListener('click', function(e) {
                if (!recycleBinContainer.contains(e.target)) {
                    recycleBinList.classList.add('hidden');
                }
            });
        }
        
        function updateRecycleBinCount() {
            const countElement = document.getElementById('recycle-bin-count');
            const count = recycleBin.length;
            countElement.textContent = count;
            countElement.style.display = count > 0 ? 'flex' : 'none';
        }
        
        function renderRecycleBin() {
            const itemsContainer = document.getElementById('recycle-bin-items');
            const emptyContainer = document.getElementById('recycle-bin-empty');
            
            if (recycleBin.length === 0) {
                itemsContainer.innerHTML = '';
                itemsContainer.classList.add('hidden');
                emptyContainer.classList.remove('hidden');
                return;
            }
            
            itemsContainer.classList.remove('hidden');
            emptyContainer.classList.add('hidden');
            
            let html = '';
            recycleBin.forEach((item, index) => {
                const deletedDate = new Date(item.deletedAt).toLocaleString('zh-CN');
                html += `
                    <div class="recycle-bin-item p-3 border-b border-gray-100 hover:bg-gray-50">
                        <div class="flex items-center justify-between mb-1">
                            <span class="font-medium text-gray-800 text-sm cursor-pointer hover:text-primary restore-item" data-index="${index}">
                                ${item.name}
                            </span>
                            <button class="text-gray-400 hover:text-danger delete-forever" data-index="${index}" title="彻底删除">
                                <i class="fa fa-times"></i>
                            </button>
                        </div>
                        <div class="flex items-center justify-between text-xs text-gray-500">
                            <span>删除时间: ${deletedDate}</span>
                            <span class="text-primary cursor-pointer hover:underline restore-item" data-index="${index}">
                                恢复
                            </span>
                        </div>
                    </div>
                `;
            });
            
            itemsContainer.innerHTML = html;
            
            // 绑定恢复事件
            itemsContainer.querySelectorAll('.restore-item').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.dataset.index);
                    restoreFromRecycleBin(index);
                });
            });
            
            // 绑定彻底删除事件
            itemsContainer.querySelectorAll('.delete-forever').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const index = parseInt(this.dataset.index);
                    deleteForeverFromRecycleBin(index);
                });
            });
        }
        
        function restoreFromRecycleBin(index) {
            if (index >= 0 && index < recycleBin.length) {
                const item = recycleBin[index];
                delete item.deletedAt;
                
                // 检查是否已存在同名数据
                const existingIndex = savedData.findIndex(savedItem => savedItem.id === item.id);
                if (existingIndex !== -1) {
                    // 如果存在，询问是否覆盖
                    if (confirm('已存在同名数据，是否覆盖？')) {
                        savedData[existingIndex] = item;
                    } else {
                        // 不覆盖，添加新的
                        item.id = Date.now().toString();
                        savedData.unshift(item);
                    }
                } else {
                    savedData.unshift(item);
                }
                
                // 从回收站移除
                recycleBin.splice(index, 1);
                
                // 保存到本地存储
                localStorage.setItem('savedData', JSON.stringify(savedData));
                localStorage.setItem('recycleBin', JSON.stringify(recycleBin));
                
                // 更新界面
                updateRecycleBinCount();
                renderRecycleBin();
                searchSavedData();
                
                showToast('成功', '数据已恢复', 'success');
            }
        }
        
        function deleteForeverFromRecycleBin(index) {
            if (index >= 0 && index < recycleBin.length) {
                if (confirm('确定要彻底删除这个数据吗？此操作不可撤销。')) {
                    recycleBin.splice(index, 1);
                    localStorage.setItem('recycleBin', JSON.stringify(recycleBin));
                    updateRecycleBinCount();
                    renderRecycleBin();
                    showToast('成功', '数据已彻底删除', 'success');
                }
            }
        }
        
        // 数据保存相关函数
        function saveCurrentData() {
            if (productData.length === 0) {
                showToast('错误', '没有可保存的数据', 'error');
                return;
            }
            
            const saveNameInput = document.getElementById('save-name');
            const reportMonth = document.getElementById('report-month').value;
            
            let saveName = saveNameInput.value.trim();
            if (!saveName) {
                saveName = reportMonth || `数据_${new Date().toISOString().split('T')[0]}`;
            }
            
            const dataToSave = {
                id: Date.now().toString(),
                name: saveName,
                reportMonth: reportMonth,
                productData: JSON.parse(JSON.stringify(productData)),
                excelData: JSON.parse(JSON.stringify(excelData)),
                skuCosts: JSON.parse(JSON.stringify(skuCosts)),
                costRecords: JSON.parse(JSON.stringify(costRecords)),
                createdAt: new Date().toISOString()
            };
            
            // 将新保存的数据添加到开头
            savedData.unshift(dataToSave);
            
            // 使用LZ-String压缩数据后保存到本地存储
            try {
                const dataString = JSON.stringify(savedData);
                const compressedData = LZString.compress(dataString);
                if (compressedData) {
                    localStorage.setItem('savedData', compressedData);
                    console.log('数据压缩并保存成功。原始大小:', dataString.length, '字符, 压缩后大小:', compressedData.length, '字符');
                } else {
                    throw new Error('数据压缩失败，结果为空');
                }
            } catch (error) {
                console.error('保存压缩数据时出错:', error);
                // 如果压缩失败，尝试直接保存未压缩的数据
                try {
                    localStorage.setItem('savedData', JSON.stringify(savedData));
                } catch (saveError) {
                    console.error('Failed to save data:', saveError);
                    showToast('错误', '保存数据失败，请检查存储空间', 'error');
                    return;
                }
            }
            
            // 同时保存回收站数据
            try {
                localStorage.setItem('recycleBin', JSON.stringify(recycleBin));
                console.log('回收站数据保存成功');
            } catch (error) {
                console.error('保存回收站数据失败:', error);
            }
            
            // 清空输入框
            saveNameInput.value = '';
            
            // 重新渲染保存的数据列表
            searchSavedData();
            
            showToast('成功', '数据保存成功');
        }
        
        function loadSavedData(dataId) {
            const data = savedData.find(item => item.id === dataId);
            if (!data) {
                showToast('错误', '未找到保存的数据', 'error');
                return;
            }
            
            // 加载数据，但不覆盖当前的规格成本和成本记录
            // 这样新上传的文件仍然可以使用最新的规格成本
            productData = JSON.parse(JSON.stringify(data.productData));
            excelData = JSON.parse(JSON.stringify(data.excelData));
            // 不覆盖skuCosts和costRecords，保持使用当前最新的数据
            
            // 为加载的保存数据添加标识和使用保存的成本
            productData = productData.map(product => {
                // 为每个SKU保存原始成本
                Object.values(product.skus).forEach(sku => {
                    sku.originalCost = sku.cost; // 保存SKU的原始成本
                    sku.isSavedData = true; // 标记为保存的SKU数据
                });
                
                return {
                    ...product,
                    isSavedData: true, // 标记为保存的数据
                    savedUnitCost: product.unitCost, // 使用保存时的单件成本
                    savedTotalCost: product.totalCost // 使用保存时的总成本
                };
            });
            
            // 设置报表年月
            document.getElementById('report-month').value = data.reportMonth;
            
            // 清零快递续重费
            document.getElementById('additional-shipping-fee').value = '';
            
            // 重新渲染结果
            renderResults();
            
            // 启用保存按钮
            document.getElementById('save-data').disabled = false;
            
            showToast('成功', '数据加载成功，使用保存时的成本数据');
        }
        
        function deleteSavedData(dataId) {
            const deleteBtn = event.target.closest('.delete-btn');
            if (!deleteBtn) return;
            
            // 检查是否在冷却期
            if (deleteBtn.dataset.cooling === 'true') {
                return; // 冷却期内忽略重复点击
            }
            
            // 保存原始状态
            const originalHTML = deleteBtn.innerHTML;
            const originalDisabled = deleteBtn.disabled;
            
            // 进入冷却期
            deleteBtn.dataset.cooling = 'true';
            deleteBtn.disabled = true;
            deleteBtn.textContent = '3秒';
            
            let countdown = 3;
            const timer = setInterval(() => {
                countdown--;
                if (countdown > 0) {
                    deleteBtn.textContent = `${countdown}秒`;
                } else {
                    clearInterval(timer);
                    // 冷却期结束，自动显示确认模态框
                    showDeleteConfirmation(dataId, deleteBtn, originalHTML, originalDisabled);
                }
            }, 1000);
            
            // 显示提示信息
            showToast('提示', '为防止误操作，将在3秒后自动弹出确认窗口', 'info');
        }
        
        // 显示删除确认模态框
        function showDeleteConfirmation(dataId, deleteBtn, originalHTML, originalDisabled) {
            // 创建模态框
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.id = 'delete-confirmation-modal';
            
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-lg w-full max-w-md">
                    <div class="p-6">
                        <div class="text-center mb-6">
                            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-red-100 text-red-500 mb-4">
                                <i class="fa fa-exclamation-triangle text-2xl"></i>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">确认删除</h3>
                            <p class="text-gray-600">确定要删除这个保存的数据吗？</p>
                            <p class="text-sm text-gray-500 mt-2">删除后将移至回收站</p>
                        </div>
                        
                        <div class="flex space-x-3">
                            <button id="cancel-delete" class="flex-1 btn btn-secondary h-10">
                                取消
                            </button>
                            <button id="confirm-delete" class="flex-1 btn btn-danger h-10">
                                确认删除
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // 添加到页面
            document.body.appendChild(modal);
            
            // 绑定事件
            document.getElementById('cancel-delete').onclick = function() {
                document.body.removeChild(modal);
                showToast('提示', '删除操作已取消', 'info');
                
                // 完全恢复按钮状态
                deleteBtn.disabled = false;
                deleteBtn.innerHTML = originalHTML;
                deleteBtn.classList.remove('bg-gray-200', 'text-gray-800', 'hover:bg-gray-300', 'editing-breathing-bg');
                deleteBtn.classList.add('btn-danger');
                deleteBtn.dataset.cooling = 'false';
                deleteBtn.dataset.confirming = 'false';
                deleteBtn.dataset.deleting = 'false';
            };
            
            document.getElementById('confirm-delete').onclick = function() {
                // 移除模态框
                document.body.removeChild(modal);
                
                // 执行删除操作
                performDelete(dataId, deleteBtn, originalHTML, originalDisabled);
            };
            
            // 点击背景关闭
            modal.onclick = function(e) {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                    showToast('提示', '删除操作已取消', 'info');
                    
                    // 恢复按钮状态
                    deleteBtn.disabled = originalDisabled;
                    deleteBtn.innerHTML = originalHTML;
                    deleteBtn.classList.remove('bg-gray-200 text-gray-800 hover:bg-gray-300');
                    deleteBtn.dataset.cooling = 'false';
                }
            };
        }
        
        // 执行删除操作
        function performDelete(dataId, deleteBtn, originalHTML, originalDisabled) {
            try {
                // 找到要删除的数据
                const deletedItem = savedData.find(item => item.id === dataId);
                if (deletedItem) {
                    // 添加到回收站
                    deletedItem.deletedAt = new Date().toISOString();
                    recycleBin.unshift(deletedItem);
                    
                    // 从保存数据中移除
                    savedData = savedData.filter(item => item.id !== dataId);
                    
                    // 保存到本地存储
                    const savedDataString = JSON.stringify(savedData);
                    const compressedSavedData = LZString.compress(savedDataString);
                    if (compressedSavedData) {
                        localStorage.setItem('savedData', compressedSavedData);
                    } else {
                        localStorage.setItem('savedData', savedDataString);
                    }
                    
                    const recycleBinString = JSON.stringify(recycleBin);
                    const compressedRecycleBin = LZString.compress(recycleBinString);
                    if (compressedRecycleBin) {
                        localStorage.setItem('recycleBin', compressedRecycleBin);
                    } else {
                        localStorage.setItem('recycleBin', recycleBinString);
                    }
                    
                    // 更新回收站计数
                    updateRecycleBinCount();
                    
                    // 重新渲染保存的数据列表
                    searchSavedData();
                    
                    showToast('成功', '数据已移至回收站', 'success');
                }
            } catch (error) {
                console.error('删除数据时出错:', error);
                showToast('错误', '删除失败，请重试', 'error');
            } finally {
                // 恢复按钮状态
                deleteBtn.disabled = false;
                deleteBtn.innerHTML = originalHTML;
                deleteBtn.classList.remove('bg-gray-200 text-gray-800 hover:bg-gray-300');
                deleteBtn.dataset.cooling = 'false';
            }
        }
        
        function searchSavedData() {
            const searchTerm = document.getElementById('search-saved-data').value.toLowerCase().trim();
            
            if (searchTerm) {
                filteredSavedData = savedData.filter(item => 
                    item.name.toLowerCase().includes(searchTerm)
                );
            } else {
                filteredSavedData = [...savedData];
            }
            
            currentPage = 1;
            renderSavedData();
        }
        
        function renderSavedData() {
            const container = document.getElementById('saved-data-list');
            const empty = document.getElementById('saved-data-empty');
            const pagination = document.getElementById('pagination');
            
            if (filteredSavedData.length === 0) {
                container.innerHTML = '';
                empty.classList.remove('hidden');
                pagination.classList.add('hidden');
                return;
            }
            
            empty.classList.add('hidden');
            
            // 计算分页
            const totalPages = Math.ceil(filteredSavedData.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, filteredSavedData.length);
            const pageData = filteredSavedData.slice(startIndex, endIndex);
            
            let html = '';
            pageData.forEach((item, index) => {
                const date = new Date(item.createdAt);
                const formattedTime = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} | ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
                
                html += `
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-md">
                        <div class="flex items-center">
                            <i class="fa fa-database text-primary mr-3"></i>
                            <div>
                                <p class="font-medium text-gray-800">${item.name}</p>
                                <p class="text-xs text-gray-500">${formattedTime}</p>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <button class="btn btn-sm btn-secondary p-2 hover:bg-secondary/80 transition-colors" onclick="loadSavedData('${item.id}')" title="加载数据">
                                <i class="fa fa-folder-open"></i>
                            </button>
                            <button class="btn btn-sm btn-danger delete-btn" onclick="deleteSavedData('${item.id}')" data-cooling="false">
                                <i class="fa fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // 更新分页信息
            document.getElementById('page-info').textContent = `第 ${currentPage} 页，共 ${totalPages} 页`;
            document.getElementById('prev-page').disabled = currentPage === 1;
            document.getElementById('next-page').disabled = currentPage === totalPages;
            
            pagination.classList.remove('hidden');
        }
        
        function updateSaveButtonState() {
            const saveButton = document.getElementById('save-data');
            saveButton.disabled = productData.length === 0;
        }
        
        // 更新分类筛选器
        function updateCategoryFilters() {
            // 更新包装材料分类筛选器
            updateCategoryFilter('packaging');
            
            // 更新配件分类筛选器
            updateCategoryFilter('accessory');
        }
        
        // 更新单个分类筛选器
        function updateCategoryFilter(costType) {
            const filterSelect = document.getElementById(`${costType}-category-filter`);
            if (!filterSelect) return;
            
            const categories = costCategories[costType];
            const currentValue = filterSelect.value;
            
            // 清空并重新填充选项
            filterSelect.innerHTML = '<option value="">全部分类</option>';
            categories.forEach(categoryObj => {
                // 确保正确处理分类对象
                const category = typeof categoryObj === 'string' ? categoryObj : categoryObj.name;
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                if (currentValue === category) {
                    option.selected = true;
                }
                filterSelect.appendChild(option);
            });
        }
        
        // 店铺管理相关函数
        function showAddShopModal(shopId = null) {
            const modal = document.getElementById('add-shop-modal');
            const title = document.getElementById('shop-modal-title');
            const form = document.getElementById('add-shop-form');
            
            if (shopId) {
                const shop = shops.find(s => s.id === shopId);
                title.textContent = '编辑店铺';
                document.getElementById('shop-id').value = shop.id;
                document.getElementById('shop-name').value = shop.name;
                document.getElementById('shop-display-id').value = shop.displayId || '';
                document.getElementById('shop-products').value = shop.productIds.join('\n');
            } else {
                title.textContent = '添加店铺';
                form.reset();
                document.getElementById('shop-id').value = '';
            }
            
            modal.classList.remove('hidden');
        }
        
        function hideAddShopModal() {
            document.getElementById('add-shop-modal').classList.add('hidden');
        }
        
        function saveShop() {
            const shopId = document.getElementById('shop-id').value;
            const shopName = document.getElementById('shop-name').value.trim();
            const shopDisplayId = document.getElementById('shop-display-id').value.trim();
            const shopProducts = document.getElementById('shop-products').value.trim();
            
            if (!shopName) {
                showToast('错误', '请输入店铺名称', 'error');
                return;
            }
            
            const productIds = shopProducts ? shopProducts.split('\n').map(id => id.trim()).filter(id => id) : [];
            
            if (shopId) {
                // 编辑现有店铺
                const shopIndex = shops.findIndex(s => s.id === shopId);
                shops[shopIndex] = {
                    ...shops[shopIndex],
                    name: shopName,
                    displayId: shopDisplayId,
                    productIds: productIds
                };
                showToast('成功', '店铺更新成功');
            } else {
                // 添加新店铺
                shops.push({
                    id: Date.now().toString(),
                    name: shopName,
                    displayId: shopDisplayId,
                    productIds: productIds,
                    createdAt: new Date().toISOString()
                });
                showToast('成功', '店铺添加成功');
            }
            
            // 保存到本地存储
            localStorage.setItem('shops', JSON.stringify(shops));
            
            // 重新渲染店铺列表
            renderShops();
            
            // 更新数据计算区店铺筛选器
            updateCalculationShopFilter();
            
            // 隐藏模态框
            hideAddShopModal();
            
            // 更新数据计算区的店铺显示
            if (!document.getElementById('data-calculation').classList.contains('hidden')) {
                renderDataCalculation();
            }
        }
        
        function deleteShop(shopId) {
            const shop = shops.find(s => s.id === shopId);
            if (!shop) return;
            
            // 显示删除确认模态框
            openDeleteConfirmModal(
                '确认删除店铺',
                `确定要删除"${shop.name}"店铺吗？此操作无法撤销。`,
                function() {
                    shops = shops.filter(s => s.id !== shopId);
                    localStorage.setItem('shops', JSON.stringify(shops));
                    renderShops();
                    showToast('成功', '店铺删除成功');
                    
                    // 更新数据计算区的店铺显示
                    if (!document.getElementById('data-calculation').classList.contains('hidden')) {
                        renderDataCalculation();
                    }
                }
            );
        }
        
        function renderShops() {
            const container = document.getElementById('shops-container');
            const empty = document.getElementById('shops-empty');
            
            // 更新店铺数量显示
            const shopCountElement = document.getElementById('shop-count-number');
            if (shopCountElement) {
                shopCountElement.textContent = shops.length;
            }
            
            if (shops.length === 0) {
                container.innerHTML = '';
                empty.classList.remove('hidden');
                return;
            }
            
            empty.classList.add('hidden');
            
            container.innerHTML = shops.map(shop => `
                <div class="bg-white rounded-xl border border-gray-100 p-6 mb-6 shadow-sm hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1">
                    <div class="flex justify-between items-center mb-6">
                        <div class="flex items-center space-x-4">
                            <h3 class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-4 py-3 rounded-lg shadow-md text-lg font-bold">${shop.name}</h3>
                            <span class="inline-flex items-center px-3 py-1.5 rounded-full text-sm font-medium bg-blue-100 text-blue-800 border border-blue-200">
                                <i class="fa fa-cubes mr-1.5"></i> ${shop.productIds.length} 个商品
                            </span>
                        </div>
                        <div class="flex space-x-2">
                            <button class="btn btn-sm btn-secondary hover:bg-gray-200 transition-colors duration-300" onclick="showAddShopModal('${shop.id}')" title="编辑店铺">
                                <i class="fa fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger hover:bg-red-600 transition-colors duration-300" onclick="deleteShop('${shop.id}')" title="删除店铺">
                                <i class="fa fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <label class="block text-sm font-semibold text-gray-700">关联商品ID</label>
                            <span class="text-xs text-gray-500">点击标签可移除</span>
                        </div>
                        <div class="flex flex-wrap gap-2 max-h-40 overflow-y-auto p-2 border border-gray-100 rounded-lg bg-gray-50" style="scrollbar-width: thin; scrollbar-color: #cbd5e1 #f8fafc;">
                            ${shop.productIds.length > 0 ? shop.productIds.map(productId => `
                                <span class="inline-flex items-center px-3 py-1.5 rounded-full text-sm font-medium bg-blue-100 text-blue-800 hover:bg-blue-200 transition-colors duration-200">
                                    <i class="fa fa-tag mr-1.5"></i> ${productId}
                                    <i class="fa fa-times ml-1.5 text-blue-600 hover:text-blue-800 cursor-pointer hover:bg-blue-300 hover:rounded-full p-0.5 transition-colors duration-200" onclick="removeProductFromShop('${shop.id}', '${productId}'); event.stopPropagation();" title="移除商品ID"></i>
                                </span>
                            `).join('') : '<span class="text-sm text-gray-500 italic">暂无关联商品</span>'}
                        </div>
                    </div>
                    
                    <div class="flex justify-between items-center pt-4 border-t border-gray-100">
                        <button class="btn btn-sm btn-secondary hover:bg-gray-500 transition-colors duration-300 flex items-center space-x-1" onclick="showAddShopModal('${shop.id}')">
                            <i class="fa fa-plus"></i>
                            <span>添加商品ID</span>
                        </button>
                        <div class="text-xs text-gray-400">
                            ID: ${shop.displayId || shop.id}
                        </div>
                    </div>
                </div>


            `).join('');
        }
        
        function removeProductFromShop(shopId, productId) {
            const shop = shops.find(s => s.id === shopId);
            if (shop) {
                shop.productIds = shop.productIds.filter(id => id !== productId);
                localStorage.setItem('shops', JSON.stringify(shops));
                renderShops();
                
                // 更新数据计算区的店铺显示
                if (!document.getElementById('data-calculation').classList.contains('hidden')) {
                    renderDataCalculation();
                }
            }
        }
        
        // 根据商品ID获取店铺名称
        function getShopNameByProductId(productId) {
            for (const shop of shops) {
                if (shop.productIds.includes(productId)) {
                    return shop.name;
                }
            }
            return '未分类';
        }
        
        // 回收站相关函数
        function bindRecycleBinEvents() {
            const recycleBinBtn = document.getElementById('recycle-bin-btn');
            const recycleBinList = document.getElementById('recycle-bin-list');
            const recycleBinContainer = document.getElementById('recycle-bin-container');
            const emptyRecycleBinBtn = document.getElementById('empty-recycle-bin');
            
            // 点击回收站按钮显示/隐藏列表
            recycleBinBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                recycleBinList.classList.toggle('hidden');
                if (!recycleBinList.classList.contains('hidden')) {
                    renderRecycleBin();
                }
            });
            
            // 点击清空回收站
            emptyRecycleBinBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                if (recycleBin.length > 0) {
                    if (confirm('确定要清空回收站吗？此操作不可撤销。')) {
                        recycleBin = [];
                        localStorage.setItem('recycleBin', JSON.stringify(recycleBin));
                        updateRecycleBinCount();
                        renderRecycleBin();
                        showToast('成功', '回收站已清空', 'success');
                    }
                }
            });
            
            // 点击其他地方隐藏回收站列表
            document.addEventListener('click', function(e) {
                if (!recycleBinContainer.contains(e.target)) {
                    recycleBinList.classList.add('hidden');
                }
            });
        }
        
        function updateRecycleBinCount() {
            const countElement = document.getElementById('recycle-bin-count');
            const count = recycleBin.length;
            countElement.textContent = count;
            countElement.style.display = count > 0 ? 'flex' : 'none';
        }
        
        function renderRecycleBin() {
            const itemsContainer = document.getElementById('recycle-bin-items');
            const emptyContainer = document.getElementById('recycle-bin-empty');
            
            if (recycleBin.length === 0) {
                itemsContainer.innerHTML = '';
                itemsContainer.classList.add('hidden');
                emptyContainer.classList.remove('hidden');
                return;
            }
            
            itemsContainer.classList.remove('hidden');
            emptyContainer.classList.add('hidden');
            
            let html = '';
            recycleBin.forEach((item, index) => {
                const deletedDate = new Date(item.deletedAt).toLocaleString('zh-CN');
                html += `
                    <div class="recycle-bin-item p-3 border-b border-gray-100 hover:bg-gray-50">
                        <div class="flex items-center justify-between mb-1">
                            <span class="font-medium text-gray-800 text-sm cursor-pointer hover:text-primary restore-item" data-index="${index}">
                                ${item.name}
                            </span>
                            <button class="text-gray-400 hover:text-danger delete-forever" data-index="${index}" title="彻底删除">
                                <i class="fa fa-times"></i>
                            </button>
                        </div>
                        <div class="flex items-center justify-between text-xs text-gray-500">
                            <span>删除时间: ${deletedDate}</span>
                            <span class="text-primary cursor-pointer hover:underline restore-item" data-index="${index}">
                                恢复
                            </span>
                        </div>
                    </div>
                `;
            });
            
            itemsContainer.innerHTML = html;
            
            // 绑定恢复事件
            itemsContainer.querySelectorAll('.restore-item').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.dataset.index);
                    restoreFromRecycleBin(index);
                });
            });
            
            // 绑定彻底删除事件
            itemsContainer.querySelectorAll('.delete-forever').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const index = parseInt(this.dataset.index);
                    deleteForeverFromRecycleBin(index);
                });
            });
        }
        
        function restoreFromRecycleBin(index) {
            if (index >= 0 && index < recycleBin.length) {
                const item = recycleBin[index];
                delete item.deletedAt;
                
                // 检查是否已存在同名数据
                const existingIndex = savedData.findIndex(savedItem => savedItem.id === item.id);
                if (existingIndex !== -1) {
                    // 如果存在，询问是否覆盖
                    if (confirm('已存在同名数据，是否覆盖？')) {
                        savedData[existingIndex] = item;
                    } else {
                        // 不覆盖，添加新的
                        item.id = Date.now().toString();
                        savedData.unshift(item);
                    }
                } else {
                    savedData.unshift(item);
                }
                
                // 从回收站移除
                recycleBin.splice(index, 1);
                
                // 保存到本地存储
                localStorage.setItem('savedData', JSON.stringify(savedData));
                localStorage.setItem('recycleBin', JSON.stringify(recycleBin));
                
                // 更新界面
                updateRecycleBinCount();
                renderRecycleBin();
                searchSavedData();
                
                showToast('成功', '数据已恢复', 'success');
            }
        }
        
        function deleteForeverFromRecycleBin(index) {
            if (index >= 0 && index < recycleBin.length) {
                if (confirm('确定要彻底删除这个数据吗？此操作不可撤销。')) {
                    recycleBin.splice(index, 1);
                    localStorage.setItem('recycleBin', JSON.stringify(recycleBin));
                    updateRecycleBinCount();
                    renderRecycleBin();
                    showToast('成功', '数据已彻底删除', 'success');
                }
            }
        }
        
        // 数据保存相关函数
        function saveCurrentData() {
            if (productData.length === 0) {
                showToast('错误', '没有可保存的数据', 'error');
                return;
            }
            
            const saveNameInput = document.getElementById('save-name');
            const reportMonth = document.getElementById('report-month').value;
            
            let saveName = saveNameInput.value.trim();
            if (!saveName) {
                saveName = reportMonth || `数据_${new Date().toISOString().split('T')[0]}`;
            }
            
            const dataToSave = {
                id: Date.now().toString(),
                name: saveName,
                reportMonth: reportMonth,
                productData: JSON.parse(JSON.stringify(productData)),
                excelData: JSON.parse(JSON.stringify(excelData)),
                skuCosts: JSON.parse(JSON.stringify(skuCosts)),
                costRecords: JSON.parse(JSON.stringify(costRecords)),
                createdAt: new Date().toISOString()
            };
            
            // 将新保存的数据添加到开头
            savedData.unshift(dataToSave);
            
            // 使用LZ-String压缩数据后保存到本地存储
            try {
                const dataString = JSON.stringify(savedData);
                const compressedData = LZString.compress(dataString);
                if (compressedData) {
                    localStorage.setItem('savedData', compressedData);
                    console.log('数据压缩并保存成功。原始大小:', dataString.length, '字符, 压缩后大小:', compressedData.length, '字符');
                } else {
                    throw new Error('数据压缩失败，结果为空');
                }
            } catch (error) {
                console.error('保存压缩数据时出错:', error);
                // 如果压缩失败，尝试直接保存未压缩的数据
                try {
                    localStorage.setItem('savedData', JSON.stringify(savedData));
                } catch (saveError) {
                    console.error('Failed to save data:', saveError);
                    showToast('错误', '保存数据失败，请检查存储空间', 'error');
                    return;
                }
            }
            
            // 同时保存回收站数据
            try {
                localStorage.setItem('recycleBin', JSON.stringify(recycleBin));
                console.log('回收站数据保存成功');
            } catch (error) {
                console.error('保存回收站数据失败:', error);
            }
            
            // 清空输入框
            saveNameInput.value = '';
            
            // 重新渲染保存的数据列表
            searchSavedData();
            
            showToast('成功', '数据保存成功');
        }
        
        function loadSavedData(dataId) {
            const data = savedData.find(item => item.id === dataId);
            if (!data) {
                showToast('错误', '未找到保存的数据', 'error');
                return;
            }
            
            // 加载数据，但不覆盖当前的规格成本和成本记录
            // 这样新上传的文件仍然可以使用最新的规格成本
            productData = JSON.parse(JSON.stringify(data.productData));
            excelData = JSON.parse(JSON.stringify(data.excelData));
            // 不覆盖skuCosts和costRecords，保持使用当前最新的数据
            
            // 为加载的保存数据添加标识和使用保存的成本
            productData = productData.map(product => {
                // 为每个SKU保存原始成本
                Object.values(product.skus).forEach(sku => {
                    sku.originalCost = sku.cost; // 保存SKU的原始成本
                    sku.isSavedData = true; // 标记为保存的SKU数据
                });
                
                return {
                    ...product,
                    isSavedData: true, // 标记为保存的数据
                    savedUnitCost: product.unitCost, // 使用保存时的单件成本
                    savedTotalCost: product.totalCost // 使用保存时的总成本
                };
            });
            
            // 设置报表年月
            document.getElementById('report-month').value = data.reportMonth;
            
            // 清零快递续重费
            document.getElementById('additional-shipping-fee').value = '';
            
            // 重新渲染结果
            renderResults();
            
            // 启用保存按钮
            document.getElementById('save-data').disabled = false;
            
            showToast('成功', '数据加载成功，使用保存时的成本数据');
        }
        
        function deleteSavedData(dataId) {
            const deleteBtn = event.target.closest('.delete-btn');
            if (!deleteBtn) return;
            
            // 检查是否在冷却期
            if (deleteBtn.dataset.cooling === 'true') {
                return; // 冷却期内忽略重复点击
            }
            
            // 保存原始状态
            const originalHTML = deleteBtn.innerHTML;
            const originalDisabled = deleteBtn.disabled;
            
            // 进入冷却期
            deleteBtn.dataset.cooling = 'true';
            deleteBtn.disabled = true;
            deleteBtn.textContent = '3秒';
            
            let countdown = 3;
            const timer = setInterval(() => {
                countdown--;
                if (countdown > 0) {
                    deleteBtn.textContent = `${countdown}秒`;
                } else {
                    clearInterval(timer);
                    // 冷却期结束，自动显示确认模态框
                    showDeleteConfirmation(dataId, deleteBtn, originalHTML, originalDisabled);
                }
            }, 1000);
            
            // 显示提示信息
            showToast('提示', '为防止误操作，将在3秒后自动弹出确认窗口', 'info');
        }
        
        // 显示删除确认模态框
        function showDeleteConfirmation(dataId, deleteBtn, originalHTML, originalDisabled) {
            // 创建模态框
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.id = 'delete-confirmation-modal';
            
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-lg w-full max-w-md">
                    <div class="p-6">
                        <div class="text-center mb-6">
                            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-red-100 text-red-500 mb-4">
                                <i class="fa fa-exclamation-triangle text-2xl"></i>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">确认删除</h3>
                            <p class="text-gray-600">确定要删除这个保存的数据吗？</p>
                            <p class="text-sm text-gray-500 mt-2">删除后将移至回收站</p>
                        </div>
                        
                        <div class="flex space-x-3">
                            <button id="cancel-delete" class="flex-1 btn btn-secondary h-10">
                                取消
                            </button>
                            <button id="confirm-delete" class="flex-1 btn btn-danger h-10">
                                确认删除
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // 添加到页面
            document.body.appendChild(modal);
            
            // 绑定事件
            document.getElementById('cancel-delete').onclick = function() {
                document.body.removeChild(modal);
                showToast('提示', '删除操作已取消', 'info');
                
                // 完全恢复按钮状态
                deleteBtn.disabled = false;
                deleteBtn.innerHTML = originalHTML;
                deleteBtn.classList.remove('bg-gray-200', 'text-gray-800', 'hover:bg-gray-300', 'editing-breathing-bg');
                deleteBtn.classList.add('btn-danger');
                deleteBtn.dataset.cooling = 'false';
                deleteBtn.dataset.confirming = 'false';
                deleteBtn.dataset.deleting = 'false';
            };
            
            document.getElementById('confirm-delete').onclick = function() {
                // 移除模态框
                document.body.removeChild(modal);
                
                // 执行删除操作
                performDelete(dataId, deleteBtn, originalHTML, originalDisabled);
            };
            
            // 点击背景关闭
            modal.onclick = function(e) {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                    showToast('提示', '删除操作已取消', 'info');
                    
                    // 恢复按钮状态
                    deleteBtn.disabled = originalDisabled;
                    deleteBtn.innerHTML = originalHTML;
                    deleteBtn.classList.remove('bg-gray-200 text-gray-800 hover:bg-gray-300');
                    deleteBtn.dataset.cooling = 'false';
                }
            };
        }
        
        // 执行删除操作
        function performDelete(dataId, deleteBtn, originalHTML, originalDisabled) {
            try {
                // 找到要删除的数据
                const deletedItem = savedData.find(item => item.id === dataId);
                if (deletedItem) {
                    // 添加到回收站
                    deletedItem.deletedAt = new Date().toISOString();
                    recycleBin.unshift(deletedItem);
                    
                    // 从保存数据中移除
                    savedData = savedData.filter(item => item.id !== dataId);
                    
                    // 保存到本地存储
                    const savedDataString = JSON.stringify(savedData);
                    const compressedSavedData = LZString.compress(savedDataString);
                    if (compressedSavedData) {
                        localStorage.setItem('savedData', compressedSavedData);
                    } else {
                        localStorage.setItem('savedData', savedDataString);
                    }
                    
                    const recycleBinString = JSON.stringify(recycleBin);
                    const compressedRecycleBin = LZString.compress(recycleBinString);
                    if (compressedRecycleBin) {
                        localStorage.setItem('recycleBin', compressedRecycleBin);
                    } else {
                        localStorage.setItem('recycleBin', recycleBinString);
                    }
                    
                    // 更新回收站计数
                    updateRecycleBinCount();
                    
                    // 重新渲染保存的数据列表
                    searchSavedData();
                    
                    showToast('成功', '数据已移至回收站', 'success');
                }
            } catch (error) {
                console.error('删除数据时出错:', error);
                showToast('错误', '删除失败，请重试', 'error');
            } finally {
                // 恢复按钮状态
                deleteBtn.disabled = false;
                deleteBtn.innerHTML = originalHTML;
                deleteBtn.classList.remove('bg-gray-200 text-gray-800 hover:bg-gray-300');
                deleteBtn.dataset.cooling = 'false';
            }
        }
        
        function searchSavedData() {
            const searchTerm = document.getElementById('search-saved-data').value.toLowerCase().trim();
            
            if (searchTerm) {
                filteredSavedData = savedData.filter(item => 
                    item.name.toLowerCase().includes(searchTerm)
                );
            } else {
                filteredSavedData = [...savedData];
            }
            
            currentPage = 1;
            renderSavedData();
        }
        
        function renderSavedData() {
            const container = document.getElementById('saved-data-list');
            const empty = document.getElementById('saved-data-empty');
            const pagination = document.getElementById('pagination');
            
            if (filteredSavedData.length === 0) {
                container.innerHTML = '';
                empty.classList.remove('hidden');
                pagination.classList.add('hidden');
                return;
            }
            
            empty.classList.add('hidden');
            
            // 计算分页
            const totalPages = Math.ceil(filteredSavedData.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, filteredSavedData.length);
            const pageData = filteredSavedData.slice(startIndex, endIndex);
            
            let html = '';
            pageData.forEach((item, index) => {
                const date = new Date(item.createdAt);
                const formattedTime = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} | ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
                
                html += `
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-md">
                        <div class="flex items-center">
                            <i class="fa fa-database text-primary mr-3"></i>
                            <div>
                                <p class="font-medium text-gray-800">${item.name}</p>
                                <p class="text-xs text-gray-500">${formattedTime}</p>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <button class="btn btn-sm btn-secondary p-2 hover:bg-secondary/80 transition-colors" onclick="loadSavedData('${item.id}')" title="加载数据">
                                <i class="fa fa-folder-open"></i>
                            </button>
                            <button class="btn btn-sm btn-danger delete-btn" onclick="deleteSavedData('${item.id}')" data-cooling="false">
                                <i class="fa fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // 更新分页信息
            document.getElementById('page-info').textContent = `第 ${currentPage} 页，共 ${totalPages} 页`;
            document.getElementById('prev-page').disabled = currentPage === 1;
            document.getElementById('next-page').disabled = currentPage === totalPages;
            
            pagination.classList.remove('hidden');
        }
        
        function updateSaveButtonState() {
            const saveButton = document.getElementById('save-data');
            saveButton.disabled = productData.length === 0;
        }
        
        // 保存数据到本地存储
        function saveData() {
            console.log('Saving data - skuCosts:', JSON.stringify(skuCosts, null, 2));
            
            // 为保存的数据添加标识
            const savedProductData = productData.map(product => ({
                ...product,
                isSavedData: true, // 标记为保存的数据
                savedUnitCost: product.unitCost, // 保存当前的单件成本
                savedTotalCost: product.totalCost // 保存当前的总成本
            }));
            
            localStorage.setItem('skuCosts', JSON.stringify(skuCosts));
            localStorage.setItem('costRecords', JSON.stringify(costRecords));
            localStorage.setItem('costCategories', JSON.stringify(costCategories));
            localStorage.setItem('savedProductData', JSON.stringify(savedProductData));
            
            console.log('Data saved successfully with saved data flag');
            
            // 自动更新关联的成本数据
            // 检查是否在规格成本管理页面或有规格成本数据变化
            const currentTab = document.querySelector('.tab-active');
            if (currentTab && currentTab.getAttribute('data-tab') === 'sku-costs') {
                console.log('检测到在规格成本管理页面保存数据，自动更新关联成本');
                // 使用setTimeout确保数据完全保存后再更新
                setTimeout(() => {
                    updateLinkedCosts();
                }, 100);
            }
        }
        
        // 从本地存储加载数据
        function loadData() {
            const savedSkuCosts = localStorage.getItem('skuCosts');
            const savedCostRecords = localStorage.getItem('costRecords');
            const savedCostCategories = localStorage.getItem('costCategories');
            const savedProductData = localStorage.getItem('savedProductData');
            
            if (savedSkuCosts) {
                console.log('Loading saved skuCosts:', savedSkuCosts);
                skuCosts = JSON.parse(savedSkuCosts);
                console.log('Loaded skuCosts:', JSON.stringify(skuCosts, null, 2));
            }
            
            // 加载保存的产品数据（如果有）
            if (savedProductData) {
                console.log('Loading saved product data with saved costs');
                const loadedSavedData = JSON.parse(savedProductData);
                
                // 替换当前产品数据为保存的数据（使用保存时的成本）
                productData = loadedSavedData.map(product => ({
                    ...product,
                    // 对于保存的数据，使用保存时的成本，不重新计算
                    unitCost: product.savedUnitCost || product.unitCost,
                    totalCost: product.savedTotalCost || product.totalCost
                }));
                
                console.log('Loaded saved product data:', JSON.stringify(productData, null, 2));
            }
            
            if (savedCostRecords) {
                costRecords = JSON.parse(savedCostRecords);
                
                // 删除快递成本中1.3元的邮政小包
                costRecords.express = costRecords.express.filter(item => 
                    !(item.name === '邮政小包' && item.amount === 1.3)
                );
            }
            
            if (savedCostCategories) {
                costCategories = JSON.parse(savedCostCategories);
            }
            
            // 确保成本记录中的分类字段存在
            Object.keys(costRecords).forEach(type => {
                costRecords[type].forEach(item => {
                    if (!item.category) {
                        item.category = '';
                    }
                });
            });

            
            // 保存更新后的数据
            saveData();
            
            // 更新分类筛选器
            updateCategoryFilters();
            
            // 设置成本项目变更监听器
            function setupCostReferenceListeners() {
                // 在成本项目编辑后更新引用该项目的规格成本
                document.addEventListener('costItemUpdated', function(e) {
                    const { costType, costId } = e.detail;
                    updateReferencingSkus(costType, costId);
                });
                
                // 在成本项目删除后更新引用该项目的规格成本
                document.addEventListener('costItemDeleted', function(e) {
                    const { costType, costId } = e.detail;
                    removeCostReference(costType, costId);
                });
            }
            
            function updateReferencingSkus(costType, costId) {
                console.log('成本项目更新事件触发:', costType, costId);
                let hasChanges = false;
                
                // 遍历所有规格成本
                Object.keys(skuCosts).forEach(skuCode => {
                    const sku = skuCosts[skuCode];
                    if (sku.referencedCosts && sku.referencedCosts.length > 0) {
                        let skuHasChanges = false;
                        
                        console.log(`检查规格 ${skuCode} 的引用成本...`);
                        
                        // 更新每个引用的成本项目
                        sku.referencedCosts.forEach((ref, refIndex) => {
                            console.log(`引用成本 ${refIndex}:`, ref);
                            
                            if (ref.costType === costType && ref.costId === costId) {
                                console.log(`找到匹配的引用成本项目`);
                                
                                // 获取最新的成本项目金额
                                const costItem = findCostItemById(costType, costId);
                                if (costItem) {
                                    console.log(`成本项目最新金额: ¥${costItem.amount.toFixed(2)}`);
                                    
                                    // 更新单位成本和总成本
                                    const oldUnitCost = ref.unitCost || 0;
                                    const oldTotalCost = ref.totalCost || 0;
                                    
                                    ref.unitCost = costItem.amount;
                                    ref.totalCost = costItem.amount * ref.quantity;
                                    
                                    console.log(`更新前: 单位成本 ¥${oldUnitCost.toFixed(2)}, 总成本 ¥${oldTotalCost.toFixed(2)}`);
                                    console.log(`更新后: 单位成本 ¥${ref.unitCost.toFixed(2)}, 总成本 ¥${ref.totalCost.toFixed(2)}`);
                                    
                                    if (oldUnitCost !== ref.unitCost || oldTotalCost !== ref.totalCost) {
                                        skuHasChanges = true;
                                    }
                                } else {
                                    console.log('未找到成本项目');
                                }
                            }
                        });
                        
                        if (skuHasChanges) {
                            console.log(`规格 ${skuCode} 有更新`);
                            
                            // 重新计算引用成本总和和总成本
                            const referencedTotal = calculateReferencedCostTotal(sku.referencedCosts);
                            const oldTotalCost = sku.totalCost || (sku.cost + 0);
                            
                            sku.totalCost = sku.cost + referencedTotal;
                            
                            console.log(`规格 ${skuCode} 总成本更新: 从 ¥${oldTotalCost.toFixed(2)} 到 ¥${sku.totalCost.toFixed(2)}`);
                            
                            hasChanges = true;
                        }
                    }
                });
                
                if (hasChanges) {
                    console.log('保存数据并重新渲染...');
                    saveData();
                    renderSkuCosts();
                    
                    // 重新计算产品利润
                    if (productData.length > 0) {
                        console.log('重新计算产品利润...');
                        calculateProfit();
                    }
                } else {
                    console.log('没有检测到需要更新的引用成本');
                }
            }
            
            function removeCostReference(costType, costId) {
                let hasChanges = false;
                Object.keys(skuCosts).forEach(skuCode => {
                    const sku = skuCosts[skuCode];
                    if (sku.referencedCosts) {
                        // 移除引用
                        const originalLength = sku.referencedCosts.length;
                        sku.referencedCosts = sku.referencedCosts.filter(ref => 
                            !(ref.costType === costType && ref.costId === costId));
                        
                        if (sku.referencedCosts.length !== originalLength) {
                            // 重新计算成本
                            const referencedTotal = calculateReferencedCostTotal(sku.referencedCosts);
                            sku.totalCost = sku.cost + referencedTotal;
                            hasChanges = true;
                        }
                    }
                });
                
                if (hasChanges) {
                    saveData();
                    renderSkuCosts();
                    
                    // 重新计算产品利润
                    if (productData.length > 0) {
                        calculateProfit();
                    }
                }
            }
            
            // 渲染数据
            renderSkuCosts();
            renderCostRecords();
            setupCostReferenceListeners();
            
            // 设置导入Excel按钮事件监听
            document.getElementById('import-sku-excel').addEventListener('click', function() {
                document.getElementById('import-modal').classList.remove('hidden');
            });
            
            // 设置关闭导入模态框按钮事件监听
            document.getElementById('close-import-modal').addEventListener('click', function() {
                document.getElementById('import-modal').classList.add('hidden');
            });
            
            // 设置开始导入按钮事件监听
            document.getElementById('start-import').addEventListener('click', function() {
                importSkuCostsFromExcel();
            });
            
            // 设置文件输入变化事件监听，更新文件名显示
            document.getElementById('import-file-input').addEventListener('change', function(e) {
                const fileNameDisplay = document.getElementById('file-name-display');
                const clearFileBtn = document.getElementById('clear-file-btn');
                
                if (e.target.files.length > 0) {
                    fileNameDisplay.textContent = e.target.files[0].name;
                    fileNameDisplay.classList.remove('text-gray-600');
                    fileNameDisplay.classList.add('text-primary', 'font-medium');
                    clearFileBtn.classList.remove('hidden');
                } else {
                    fileNameDisplay.textContent = '未选择文件';
                    fileNameDisplay.classList.remove('text-primary', 'font-medium');
                    fileNameDisplay.classList.add('text-gray-600');
                    clearFileBtn.classList.add('hidden');
                }
            });
            
            // 设置清除文件按钮事件监听
            document.getElementById('clear-file-btn').addEventListener('click', function() {
                const fileInput = document.getElementById('import-file-input');
                const fileNameDisplay = document.getElementById('file-name-display');
                const clearFileBtn = document.getElementById('clear-file-btn');
                
                // 重置文件输入
                fileInput.value = '';
                
                // 重置显示状态
                fileNameDisplay.textContent = '未选择文件';
                fileNameDisplay.classList.remove('text-primary', 'font-medium');
                fileNameDisplay.classList.add('text-gray-600');
                clearFileBtn.classList.add('hidden');
            });
            
            // 设置取消导入按钮事件监听
            document.getElementById('cancel-import').addEventListener('click', function() {
                document.getElementById('import-modal').classList.add('hidden');
            });
            
            // 设置确认导入按钮事件监听
            document.getElementById('import-confirm-btn').addEventListener('click', function() {
                confirmImportSkuCosts();
            });
        }
    </script>

    <!-- Import SKU Costs Modal -->
    <div id="import-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">导入规格编码成本</h3>
                    <button id="close-import-modal" class="text-gray-400 hover:text-gray-600">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">选择Excel文件</label>
                    <div class="flex items-center space-x-2">
                        <!-- 美化的文件输入框 -->
                        <div class="relative flex-1">
                            <input type="file" id="import-file-input" accept=".xlsx, .xls" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                            <div class="flex items-center justify-between px-4 py-2 border border-gray-300 rounded-md bg-white h-10">
                                <span id="file-name-display" class="text-sm text-gray-600 truncate flex-1">未选择文件</span>
                                <div class="flex items-center space-x-2">
                                    <span class="text-xs bg-primary/10 text-primary px-2 py-1 rounded">.xlsx, .xls</span>
                                    <button id="clear-file-btn" class="text-gray-400 hover:text-gray-600 transition-colors duration-200 hidden">
                                        <i class="fa fa-times-circle"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <button id="start-import" class="btn btn-primary h-10 px-4">
                            <i class="fa fa-upload"></i> 开始导入
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">支持 .xlsx 和 .xls 格式，请确保文件包含"规格编码"和"成本"列</p>
                </div>
                
                <!-- Loading State -->
                <div id="import-loading" class="hidden mb-6">
                    <div class="flex items-center justify-center py-4">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
                        <span class="ml-3 text-gray-600">正在解析文件...</span>
                    </div>
                </div>


                
                <!-- Preview Section -->
                <div id="import-preview-section" class="mb-6 hidden">
                    <h4 class="text-md font-medium text-gray-700 mb-3">数据预览</h4>
                    <div id="import-preview" class="max-h-60 overflow-y-auto border border-gray-200 rounded-lg">
                        <!-- Preview table will be inserted here -->
                    </div>
                    <div id="import-stats" class="mt-2">
                        <!-- Stats will be inserted here -->
                    </div>
                </div>


                
                <!-- Import Mode Selection -->
                <div id="import-mode-section" class="mb-6 hidden">
                    <h4 class="text-md font-medium text-gray-700 mb-3">导入模式</h4>
                    <div class="space-y-3">
                        <label class="flex items-center space-x-2">
                            <input type="radio" name="import-mode" value="merge" checked="" class="text-primary focus:ring-primary">
                            <span class="text-sm text-gray-700">合并模式：新增不存在的规格编码，更新已存在的规格编码</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="radio" name="import-mode" value="insert" class="text-primary focus:ring-primary">
                            <span class="text-sm text-gray-700">仅新增：只添加不存在的规格编码，跳过已存在的</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="radio" name="import-mode" value="update" class="text-primary focus:ring-primary">
                            <span class="text-sm text-gray-700">仅更新：只更新已存在的规格编码，跳过不存在的</span>
                        </label>
                    </div>
                </div>


                
                <!-- Confirmation Section -->
                <div id="import-confirm-section" class="flex justify-end space-x-3 hidden">
                    <button id="cancel-import" class="btn btn-secondary">取消</button>
                    <button id="import-confirm-btn" class="btn btn-primary">
                        <i class="fa fa-check"></i> 确认导入
                    </button>
                </div>
                
                <!-- Hidden field to store import data -->
                <input type="hidden" id="import-data">
            </div>
        </div>
    </div>





    
    <div id="cost-export-fields-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">选择导出成本类型</h3>
                    <button class="text-gray-400 hover:text-gray-600 close-modal" data-modal="cost-export-fields-modal">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
                <div class="space-y-3">
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" class="cost-type-checkbox rounded text-primary focus:ring-primary" value="express" checked="">
                        <span class="text-sm font-medium text-gray-700">快递成本</span>
                    </label>
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" class="cost-type-checkbox rounded text-primary focus:ring-primary" value="platform" checked="">
                        <span class="text-sm font-medium text-gray-700">服务费售后人力成本</span>
                    </label>
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" class="cost-type-checkbox rounded text-primary focus:ring-primary" value="packaging" checked="">
                        <span class="text-sm font-medium text-gray-700">包装成本</span>
                    </label>
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" class="cost-type-checkbox rounded text-primary focus:ring-primary" value="accessory" checked="">
                        <span class="text-sm font-medium text-gray-700">产品成本</span>
                    </label>
                </div>
                <div class="mt-6 flex space-x-3">
                    <button id="select-all-cost-types" class="btn btn-secondary text-sm flex-1">
                        <i class="fa fa-check-square-o"></i> 全选
                    </button>
                    <button id="select-none-cost-types" class="btn btn-secondary text-sm flex-1">
                        <i class="fa fa-square-o"></i> 全不选
                    </button>
                </div>
                <div class="mt-4 flex space-x-3">
                    <button class="btn btn-secondary text-sm flex-1 close-modal" data-modal="cost-export-fields-modal">
                        取消
                    </button>
                    <button id="confirm-cost-export" class="btn btn-primary text-sm flex-1">
                        <i class="fa fa-file-excel-o"></i> 确认导出
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 导出成本到Excel

    </script>

    <script>
        // 格式化SKU（只限制32位长度，不再限制字符类型）
        function formatSKU(input) {
            // 限制最大长度32位
            if (input.value.length > 32) {
                input.value = input.value.substring(0, 32);
            }
            // 实时显示/隐藏清空按钮
            const clearBtn = input.parentElement.querySelector('button');
            if (clearBtn) {
                clearBtn.style.display = input.value ? 'block' : 'none';
            }
        }

        // 清空SKU输入框
        function clearSKU(btn, linkIndex, productIndex, specIndex) {
            const input = btn.parentElement.querySelector('.sku-input');
            input.value = '';
            // 更新数据模型
            updateSpecField(linkIndex, productIndex, specIndex, 'skuCode', '');
            // 隐藏清空按钮
            btn.style.display = 'none';
        }

        // 全局监听SKU输入框（仅用于主列表中的SKU输入框，避免影响编辑模态框）
        document.addEventListener('input', function(e) {
            // 检查是否为主列表中的SKU输入框（通过检查父元素结构）
            if (e.target.classList.contains('sku-input') && e.target.closest('#display-links-container')) {
                formatSKU(e.target); // 实时格式化
            }
        });
    </script>

</body></html>